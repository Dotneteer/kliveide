# SAVENEX Pragma Reference

The `.savenex` pragma provides a declarative way to configure ZX Spectrum Next NEX file generation parameters directly in your assembly source code. This pragma is only available when targeting the ZX Spectrum Next (Model 4).

## Overview

The `.savenex` pragma uses a subcommand syntax where each subcommand configures a specific aspect of the NEX file. You can use multiple `.savenex` pragmas throughout your source code, and the compiler will collect and merge all declarations into a complete NEX file configuration.

**Syntax:**

```z80klive
.savenex <subcommand> <parameters>
```

The pragma is case-insensitive, so `.savenex`, `.SAVENEX`, and `.SaveNex` are all valid.

## Subcommands

### FILE - Set Output Filename

Specifies the name of the NEX file to be generated.

**Syntax:**

```z80klive
.savenex file <filename>
```

- **filename**: String literal or expression that evaluates to a string

**Example:**

```z80klive
.savenex file "myprogram.nex"
```

### RAM - Set RAM Configuration

Specifies the amount of RAM required by the program.

**Syntax:**

```z80klive
.savenex ram <size>
```

- **size**: Must be either 768 (for 768K RAM) or 1792 (for 1792K RAM)

**Examples:**

```z80klive
.savenex ram 768    ; 768K RAM
.savenex ram 1792   ; 1792K RAM
```

### BORDER - Set Border Color

Specifies the border color to be set when the program loads.

**Syntax:**

```z80klive
.savenex border <color>
```

- **color**: Integer value from 0 to 7

**Example:**

```z80klive
.savenex border 5   ; Cyan border
```

### CORE - Specify Required Core Version

Specifies the minimum ZX Spectrum Next core version required to run the program.

**Syntax:**

```z80klive
.savenex core <major>, <minor>, <subminor>
; or
.savenex core <version-string>
```

- **major**: Integer value from 0 to 255
- **minor**: Integer value from 0 to 255
- **subminor**: Integer value from 0 to 255
- **version-string**: String literal in the format "major.minor.subminor"

**Examples:**

```z80klive
.savenex core 3, 1, 10       ; Requires core version 3.1.10 or higher
.savenex core "3.1.10"       ; Alternative string format
```

> **Note**: Both formats are supported. The string format is convenient when the version comes from a constant or macro, while the comma-separated format allows for calculated values.

### STACKADDR - Set Stack Pointer Address

Specifies the initial stack pointer address.

**Syntax:**

```z80klive
.savenex stackaddr <address>
```

- **address**: Integer value from 0 to 0xFFFF

**Example:**

```z80klive
.savenex stackaddr 0xFF00
```

### ENTRYADDR - Set Entry Point Address

Specifies the program's entry point address.

**Syntax:**

```z80klive
.savenex entryaddr <address>
```

- **address**: Integer value from 0 to 0xFFFF

**Example:**

```z80klive
.savenex entryaddr 0x8000
```

### ENTRYBANK - Set Entry Bank

Specifies the bank number to be paged in when the program starts.

**Syntax:**

```z80klive
.savenex entrybank <bank>
```

- **bank**: Integer value from 0 to 111

**Example:**

```z80klive
.savenex entrybank 5
```

### FILEHANDLE - Set File Handle Mode

Specifies whether to close or keep open the NEX file handle after loading.

**Syntax:**

```z80klive
.savenex filehandle <mode>
```

- **mode**: Either "close" or "open"

**Examples:**

```z80klive
.savenex filehandle "close"
.savenex filehandle "open"
```

### PRESERVE - Preserve Next Registers

Specifies whether to preserve the Next hardware registers after loading.

**Syntax:**

```z80klive
.savenex preserve <value>
```

- **value**: "on"/"off" or 1/0

**Examples:**

```z80klive
.savenex preserve "on"
.savenex preserve 1
.savenex preserve "off"
.savenex preserve 0
```

### SCREEN - Configure Loading Screen

Specifies a loading screen to display while the program loads.

**Syntax:**

```z80klive
.savenex screen <type> [, <filename> [, <palette-offset>]]
```

- **type**: Screen type - one of: "layer2", "ula", "lores", "hires-color", "hires-mono"
- **filename**: (Optional) Filename of the screen data
- **palette-offset**: (Optional) Offset in the palette file (0-255)

**Examples:**

```z80klive
.savenex screen "layer2"
.savenex screen "layer2", "loading.scr"
.savenex screen "layer2", "loading.scr", 0
```

### PALETTE - Set Palette File

Specifies a palette file to load.

**Syntax:**

```z80klive
.savenex palette <filename>
```

- **filename**: String literal with the palette filename

**Example:**

```z80klive
.savenex palette "colors.nxp"
```

### COPPER - Set Copper Code File

Specifies a copper code file to load and execute.

**Syntax:**

```z80klive
.savenex copper <filename>
```

- **filename**: String literal with the copper code filename

**Example:**

```z80klive
.savenex copper "effects.cu"
```

### BAR - Configure Loading Bar

Configures the loading bar display.

**Syntax:**

```z80klive
.savenex bar <enabled> [, <color> [, <delay> [, <start-delay>]]]
```

- **enabled**: "on"/"off" or 1/0
- **color**: (Optional) Bar color (0-255)
- **delay**: (Optional) Delay per bar step (0-255)
- **start-delay**: (Optional) Delay before starting (0-255)

**Examples:**

```z80klive
.savenex bar "on"
.savenex bar "on", 2
.savenex bar "on", 2, 50
.savenex bar "on", 2, 50, 100
```

## Complete Example

Here's a complete example showing various `.savenex` configurations:

```z80klive
    ; Basic NEX file configuration
    .savenex file "demo.nex"
    .savenex ram 768
    .savenex border 5
    
    ; Core requirements (both formats shown for illustration)
    .savenex core 3, 1, 10      ; Comma-separated format
    ; .savenex core "3.1.10"    ; Alternative string format
    
    ; Entry point configuration
    .savenex stackaddr 0xFF00
    .savenex entryaddr Start
    .savenex entrybank 5
    
    ; File handling
    .savenex filehandle "close"
    .savenex preserve "on"
    
    ; Loading screen
    .savenex screen "layer2", "loader.scr"
    .savenex palette "colors.nxp"
    
    ; Loading bar
    .savenex bar "on", 2, 50, 100
    
    ; Your program code
    .org 0x8000
Start:
    ld a, 7
    out (0xFE), a
    ret
```

## NEX File Format

The NEX file format is the native executable format for the ZX Spectrum Next. It's a container format that includes:

- **Header Information**: File version, RAM requirements, entry points, etc.
- **Screen Data**: Optional loading screen in various formats
- **Palette Data**: Optional palette information
- **Copper Code**: Optional copper coprocessor code
- **Loading Bar**: Optional visual feedback during loading
- **Program Banks**: The actual program code and data organized in 16K banks

### NEX File Version

The `.savenex` pragma targets NEX file format version 1.2, which is the current standard for ZX Spectrum Next executables.

### Bank Organization

The NEX file organizes code and data into 16K banks that correspond to the Next's memory management system. Banks 5-111 are available for user programs, with bank 5 typically used for the initial code.

### Loading Process

When a NEX file loads on the ZX Spectrum Next:

1. The NEX loader reads the header to determine requirements
2. If specified, the loading screen is displayed
3. If enabled, the loading bar provides visual feedback
4. Program banks are loaded into the specified memory locations
5. Hardware registers are configured according to the NEX header
6. Control is transferred to the entry point address with the entry bank paged in

## Default Values

If you don't specify certain `.savenex` parameters, these defaults are used:

- **ramSize**: 768 (768K RAM)
- **borderColor**: 0 (Black)
- **entryBank**: 0 (Bank 0)
- **fileHandle**: "close"
- **preserveRegs**: false (off)

## Error Handling

The assembler will generate errors if:

- You use `.savenex` when not targeting the ZX Spectrum Next (Model 4)
- Invalid values are provided (e.g., border color > 7, bank > 111)
- Required parameters are missing
- Invalid screen types or modes are specified
- Version numbers exceed 255

## Notes

- The `.savenex` pragma only configures the NEX file parameters; it doesn't generate the actual NEX file. The file generation happens during the export process.
- Multiple `.savenex` pragmas with the same subcommand will use the last value specified.
- Expression support allows you to use symbols, calculations, and other expressions for numeric parameters.
- String parameters can be string literals or expressions that evaluate to strings.

## See Also

- [Pragmas](./pragmas) - Complete pragma reference
- [ZX Spectrum Next Documentation](https://www.specnext.com/) - Official Next documentation
