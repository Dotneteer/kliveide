; ZX Spectrum Next ROM Disassembly (ROM 0)
; =======================================================================================================================
; File: enNextZX.rom
; Source ROM Block: ROM 0 (file bytes 0x0000-0x3FFF)
;=======================================================================================================================

0000 F3                         di                         ; Disable interrupts during the cold start
0001 C3 EF 00                   jp ColdStart               ; Continue with the cold start boot
0004 45 44 08 02                .defb $45, $44, $08, $02   ; "E", "D", 08, 02
;
; RST $08:
;
0008 C3 E0 15                   jp L15E0
000B 2A 2E 2A FF                .defb $2A, $2E, $2A, $FF.  ; "*", ".", "*", copyright
000F 00                         .defb $00                  ; 00
; 
; RST $08: Page in RAM bank 7 and switch to work area stack
; This routine pages RAM bank 7 into slot 7 ($C000-$FFFF) and switches the stack pointer
; to the work area near system variables (TMPSP, typically $5BFF). This provides a workspace
; with RAM at $C000 and a stack below the system variables area at $5C00.
; Entry: None
; Exit: RAM bank 7 paged at $C000, SP switched to TMPSP area, continues at L15E0
;
0010 EF                         rst $28
0011 10 00                      .defw $0010;
0013 C9            L0013:       ret
0014 C3 EF 00                   jp ColdStart
0017 00                         .defb $00
;
; RST $18: Call ROM1 routine. The address to call is specified in the stack.
;                      nop
0018 C3 80 3E                   jp Rom1Call
001B 3C 44 49 52                .defb $3C, $44, $49, $52   ; Filler bytes: "<DIR"
001F BE                         .defb $BE                  ; $BE
;
; RST $20: Call ROM2 routine. The address to call is specified in the stack.
;
0020 C3 00 3E                   jp Rom2Call
0023 14 00 04 98                .defb $14, $00, $04, $98   ; 
0027 00                         .defb $00
;
; RST $28: Call ROM3 routine. The address to call is specified in the stack.
;
0028 ED 43 54 5B                ld (TMPBC),bc              ; Save the value of BC temporarily
002C E3                         ex (sp),hl                 ; Move the return address to HL
002D C3 80 00                   jp Rom3Cont
;
; RST $30
;
0030 C3 C9 15                   jp L15C9
0033 CD D7 04                   call L04D7
0036 77                         ld (hl),a
0037 C9                         ret
;
; RST $38: IRQ handler
;
0038 F5            IRQ:         push af
0039 E5                         push hl                    ; Save used registers (AF, HL)
003A 26 00                      ld h,$00                   ; DivMMC value at return
003C 3E 80                      ld a,$80                   ; DivMMC value at start
003E C3 46 00                   jp `Irq1
;
; Unused filler bytes
;
0041 3C 52 55 4E                .defb $3C, $52, $55, $4E   ; Fillers bytes "<RUN"
0045 BE                         .defb $BE
; Continuation of IRQ handler
;
0046 D3 E3         `Irq1:       out ($E3),a                ; Turns on DivMMC ROM and RAM page 0
;
; Unused filler bytes
;
0048 05 1A 17 FF                .defb $05, $1a, $17, $ff
004C 07 87 00 00                .defb $07, $87, $00, $00
0050 00 00 00 00                .defb $00, $00, $00, $00
0054 00 00 00 00                .defb $00, $00, $00, $00
0058 00 00 00 00                .defb $00, $00, $00, $00
005C 00 00 00 00                .defb $00, $00, $00, $00
;
; With DivMMC ROM turned off, this will be the address
;
0060 E1            `Irq2:       pop hl                     ; Restore used registers
0061 F1                         pop af
0062 FB                         ei                         ; Enable the IRQ again
0063 C9                         ret                        ; Done
;
; Filler bytes
;
0064 00 00                      .defb $00, $00
;
; NMI routine
;
0066 ED 45         NMI:         retn                       ; ROM0 does not do anything with NMI
;
; Call Alternate ROM Routine
; Similar to ROM3 call mechanism, but switches to the alternate ROM. The address to call
; follows the CALL instruction (inline parameter). Saves BC, reads the target address,
; enables AltROM via nextreg $8C,$80, and executes the routine.
; Entry: (SP) = return address, (SP+0,SP+1) = target routine address in AltROM
; Exit: Returns after executing AltROM routine, BC preserved
;
0068 ED 43 54 5B   L0068:       ld (TMPBC),bc              ; Save the value of BC temporarily
006C E3                         ex (sp),hl                 ; HL := Return address
006D 4E                         ld c,(hl)
006E 23                         inc hl
006F 46                         ld b,(hl)                  ; Read the 16-bit value from the stack into BC
0070 23                         inc hl                     ; Set the return address
0071 E3                         ex (sp),hl                 ; to the next one
0072 ED 8A 00 7B   L0072:       push $007B                 ; Use the $007B address of the alternate ROM to return
0076 C5                         push bc                    ; Execute routine addressed with BC in the alternate ROM
0077 ED 4B 54 5B                ld bc,(TMPBC)              ; Restore the original value of BC
007B ED 91 8C 80                nextreg $8C,$80            ; Enable AltROM (for reads)
007F C9                         ret    
;
; RST $28 Continuation: Call ROM3 Routine
; This is the target of RST $28 (JP Rom3Cont at $002D). RST $28 has already saved BC to TMPBC
; and loaded HL with the return address. This routine reads the inline 16-bit target address,
; adjusts the return address, and jumps to L5B48 (RAM routine) which switches to ROM3 and
; executes the target routine. Returns via $5B4D which switches back to ROM0.
; Entry: HL = return address (pointing to inline target address), BC saved in TMPBC
; Exit: Executes ROM3 routine and returns to adjusted return address, BC preserved
;                 
0080 4E            Rom3Cont:    ld c,(hl)                  ; When entering, HL is the return addrss of the caller
0081 23                         inc hl
0082 46                         ld b,(hl)                  ; Read the 16-bit value from the stack into BC 
0083 23                         inc hl                     ; Set the return address
0084 E3                         ex (sp),hl                 ; to the next one
0085 ED 8A 5B 4D   L0085:       push $5B4D                 ; Return to the RAM routine that switches back ROM0
0089 C5                         push bc                    ; Push the original return address to the stack
008A ED 4B 54 5B                ld bc,(TMPBC)              ; Restore the original value of BC
008E C3 48 5B                   jp L5B48                   ; Jump to the RAM routine that turns on ROM3
;
; Pager subroutines
; The CopyPages subroutine moves these routines to $5B00-$5B51
;
; PagerStart: ZX Spectrum +2/+3 type paging flips ROMs:
; ROM0 -> ROM3
; ROM1 -> ROM2
; ROM2 -> ROM1
; ROM3 -> ROM0
;
; Address in RAM: $5B00
;
0091 F5            PagerStart:  push af                
0092 C5                         push bc                    ; Save used registers (AF, BC)
0093 01 FD 7F                   ld bc,$7FFD                ; ZX Spectrum 128 port
0096 3A 5C 5B                   ld a,($5B5C)               ; Get the last value written to $7FFD
0099 EE 10                      xor $10                    ; Flip ROM bit low
009B F3                         di                         ; No interrupt while paging
009C 32 5C 5B                   ld ($5B5C),a               ; Store the last value written back
009F ED 79                      out (c),a                  ; Switch ROM bit high
00A1 01 FD 1F      RomHSw:      ld bc,$1FFD                ; ZX Spectrum +2/+3 port
00A4 3A 67 5B                   ld a,($5B67)               ; Get the last value written to $1FFD
00A7 EE 04                      xor $04                    ; Fip ROM bit high
00A9 32 67 5B                   ld ($5B67),a               ; Store the last value written back         
00AC ED 79                      out (c),a                  ; Switch ROM bit low
00AE FB                         ei                         ; Enable interrupt again
00AF C1                         pop bc                     ; Restore used registers
00B0 F1                         pop af
00B1 C9                         ret                        ; Done
;
; This subroutine ($5B21) switches the current ROM and returns th the 
; address stored in $5B5A. Set's the contents of HL as the next return address.
;
; Address in RAM: $5B21
;
00B2 CD 00 5B                   call L5B00                 ; Calls PagerStart in RAM
00B5 E5                         push hl                    ; Save HL on stack
00B6 2A 5A 5B                   ld hl,($5B5A)              ; Load return address from system variable
00B9 E3                         ex (sp),hl                 ; Swap HL with top of stack
00BA C9                         ret                        ; Return to the address now in HL
;
; Address in RAM: $5B2A
;
00BB E5                         push hl                    ; Save HL on stack
00BC 21 34 5B                   ld hl,$5B34                ; Set return address to $5B34 (RetFromSw)
00BF E3                         ex (sp),hl                 ; Swap HL with top of stack
00C0 F5                         push af                     
00C1 C5                         push bc                    ; Save used registers (AF, BC)
00C2 C3 10 5B                   jp L5B10                   ; Jump to paging routine at $5B10 (RomHSw)
;
; Returns from the swith
; Address in RAM: $5B34
;
00C5 E5            RetFromSw:   push hl                    ; Save HL on stack
00C6 2A 5A 5B                   ld hl,($5B5A)              ; Load return address from system variable
00C9 E3                         ex (sp),hl                 ; Swap HL with top of stack
00CA C9                         ret                        ; Return to the address now in HL
;
; This subroutine jumps to $0AB0 in ROM1. It is used widely in ROM1
; Address in RAM: $5B3A
;
00CB ED 8A 0A B0                push $0AB0                 ; Push return address $0AB0 onto stack
00CF ED 91 8E 01                nextreg $8E,$01            ; Set Next register $8E to $01 (Transparency fallback color)
00D3 C9                         ret                        ; Done
;
; This subroutine turns to ROM2 and jumps to the top stack address
; Address in RAM: $5B43
;
00D4 ED 91 8E 02                nextreg $8E,$02            ; Set Next register $8E to $02 (Transparency fallback color)
00D8 C9                         ret
;
; This subroutine turns to ROM3 and jumps to the top stack address.
; It is used widely in ROM3.
; Address in RAM: $5B48
;
00D9 ED 91 8E 03                nextreg $8E,$03
00DD C9                         ret
;
; This subroutine turns to ROM0 and jumps to the top stack address.
; Address in RAM: $5B4D
;
00DE ED 91 8E 00                nextreg $8E,$00
00E2 C9                         ret
;
; Copies the pager routines to $5B00-$5B51
;
00E3 21 91 00      CopyPager:   ld hl,$0091
00E6 11 00 5B                   ld de,$5B00
;
; Moves $52 bytes
;
00E9 01 52 00                   ld bc,CopyPager - PagerStart
00EC ED B0                      ldir
00EE C9                         ret
;
; ---------------------------------------------------------------------------------------------------------------------
; This is the cold start routine
; ---------------------------------------------------------------------------------------------------------------------
;
00EF ED 91 07 03   ColdStart:   nextreg $07,$03            ; Set CPU speed to 28 MHz (bits 1:0 = 11)
00F3 ED 91 03 B0                nextreg $03,$B0            ; Set machine type: enable changes (bit 7=1), +2A/+2B/+3 timing (bits 6:4=011), ZX 48K (bits 2:0=000)
00F7 ED 91 C0 08                nextreg $C0,$08            ; Interrupt control: stackless NMI enabled (bit 3=1), pulse mode (bit 0=0)
00FB 3E FF                      ld a,$FF                   ; Load $FF into A for port decoding setup
00FD ED 92 82                   nextreg $82,a              ; Internal Port Decoding: Enable all internal ports (all bits = 1)
0100 ED 92 83                   nextreg $83,a              ; Internal Port Decoding byte 2: Enable all (all bits = 1)
0103 ED 92 84                   nextreg $84,a              ; Internal Port Decoding byte 3: Enable all (all bits = 1)
0106 ED 92 85                   nextreg $85,a              ; Internal Port Decoding byte 4 (MSB): Enable all (all bits = 1)
0109 AF                         xor a                      ; Clear A (set to $00)
010A ED 92 80                   nextreg $80,a              ; Expansion Bus: Disable expansion bus and all overrides
010D ED 92 81                   nextreg $81,a              ; Expansion Bus Control: Default settings (3.5MHz max)
0110 ED 92 8A                   nextreg $8A,a              ; Expansion Bus IO Propagate: No port propagation to expansion bus
0113 ED 92 8F                   nextreg $8F,a              ; Memory Mapping Mode: Standard ZX 128K +3 mode (bits 1:0 = 00)
;
; Keep only the PS/2 mode and DivMMC automap flags (REG 0x06)
;
0116 01 3B 24                   ld bc,$243B                ; BC = $243B (nextreg select port)
0119 16 06                      ld d,$06                   ; D = $06 for peripheral settings
011B ED 51                      out (c),d                  ; Select nextreg $06
011D 04                         inc b                      ; BC = $253B (nextreg data port)
011E ED 78                      in a,(c)                   ; Read current peripheral 2 settings
0120 E6 44                      and $44                    ; Mask bits 6 and 2 (PS/2 mode and DivMMC automap)
0122 ED 79                      out (c),a                  ; Write back masked settings
;
; Set BLACK paper and BLACK ink for the entire screen
;
0124 21 00 58                   ld hl,$5800                ; HL = start of screen attributes
0127 11 01 58                   ld de,$5801                ; DE = second byte of attributes
012A 75                         ld (hl),l                  ; Fill first attribute byte with $00
012B 01 FF 02                   ld bc,$02FF                ; BC = 767 bytes to copy
012E ED B0                      ldir                       ; Clear all screen attributes to $00
;
; Memory test
; Map each physical 8K page into MMU slots 6/7 using nextreg $56/$57 for access.
; Page index is derived from C (A:=C; A*=2 for mapping, then A>>=1 to restore index).
; Perform read-modify-write checks on the mapped page and write test patterns
; (conditional $00 clears or $BB pattern) to exercise different cases per page.
; Use block moves (LDDR/LDIR variants) for efficient large-region testing and fills.
; Loop uses BC=$7000 and DJNZ to iterate through page sets until all banks are covered.
; Purpose: initialize and validate RAM pages via the display window before boot continues.
; For pages with index >=12, does not zero the page contents.
;
; B represents the index of the 16K bank to test.
; C represents the 16K page to map to MMU Slot 6/7 during the test
; 
0130 01 00 70                   ld bc,$7000                ; BC = $7000 (loop counter for RAM exercise)
0133 21 00 40                   ld hl,$4000                ; HL = display memory window start
; 
; Page the 16K bank indexed by C into MMU slot 6/7
;
0136 79            `BANK_LOOP:  ld a,c                     ; A := C (low byte of page index)
0137 D9                         exx                        ; Switch to alternate register set (work with HL'/DE'/BC')
0138 87                         add a,a                    ; A := A*2 -> compute 8K page number (word index)
0139 ED 92 56                   nextreg $56,a              ; Map 8K page to MMU slot 6 ($C000-$DFFF)
013C 3C                         inc a                      ; Next page (for slot 7)
013D ED 92 57                   nextreg $57,a              ; Map 8K page to MMU slot 7 ($E000-$FFFF)
0140 CB 3F                      srl a                      ; A := A >> 1 (restore original page index)
;
; Copy test data from the $FFFF address to the screen area
;
0142 21 FF FF                   ld hl,$FFFF                ; HL := $FFFF (prepare end marker)
0145 08                         ex af,af'                  ; Swap AF/AF' to use A' for data
0146 7E                         ld a,(hl)                  ; Read byte from current mapped page (test read)
0147 D9                         exx                        ; Restore original register set
0148 77                         ld (hl),a                  ; Write read byte back (test write)
;
; For banks with index <12, zero the byte in the screen memory
;
0149 79                         ld a,c                     ; A := C (page index low)
014A FE 0C                      cp $0C                     ; Compare with 12 (special-case threshold)
014C 30 02                      jr nc,`SKIP_1              ; If >=12 skip next write
014E 36 00                      ld (hl),$00                ; Otherwise write $00 (clear)
0150 23            `SKIP_1:     inc hl                     ; Advance HL pointer
0151 D9                         exx                        ; Switch to alternate registers
0152 08                         ex af,af'                  ; Swap AF/AF' back
0153 36 BB                      ld (hl),$BB                ; Set the last byte of the bank to $BB
0155 2B                         dec hl                     ; Move HL back (prepare for block op)
0156 11 FD FF                   ld de,$FFFD                ; DE := -3 (used by block ops)
0159 01 FE 3F                   ld bc,$3FFE                ; BC := $3FFE (block length marker)
;
; Special cases: 
; - Do not zero the banks for 12 and above
; - Zero only the upper half 8K for bank 8
;
015C FE 0C                      cp $0C                     ; Compare A with 12 again
015E 30 0A                      jr nc,`SKIP_3              ; If >=12 branch to `SKIP_3
0160 FE 08                      cp $08                     ; Compare A with 8
0162 20 02                      jr nz,`SKIP_2              ; If not equal to 8 skip next
0164 06 1F                      ld b,$1F                   ; Set B := $1F for special-case count
0166 36 00         `SKIP_2:     ld (hl),$00                ; Write $00 (zero) at current HL
0168 ED B8                      lddr                       ; Zero the entire bank (or in special case, the upper half)
;
; Move to the next bank
;
016A D9            `SKIP_3:     exx                        ; Restore registers
016B 0C                         inc c                      ; Increment page index
016C 10 C8                      djnz `BANK_LOOP            ; Loop until B (high counter) reaches zero
016E 18 1E                      jr BANK_TEST               ; Jump to next initialization phase
;
; At this point, the memory test failed. The border is set to the color of the error bit index.
;
0170 08            INIT_ERR:    ex af,af'                  ; Label placeholder: swap AFs (entry for next phase)
0171 3E 08                      ld a,$08                   ; load test value $08 for comparison/output
0173 93                         sub e                      ; A := $08 - E (prepare condition)
0174 6F                         ld l,a                     ; save subtraction result in L
0175 08                         ex af,af'                  ; restore original AF pair
0176 7D                         ld a,l                     ; move result back to A for the NZ test
0177 20 04                      jr nz,`BIT_ERR             ; if non-zero, display a continuous border pulse
;
; Static border means error when testing zero bit value
;
0179 D3 FE                      out ($FE),a                ; poke port $FE (ULA/control) with A
017B 18 FE         B0_TRAP:     jr B0_TRAP                 ; Stop further operation (interrupt is still disabled)
;
; Pulsing border means error when testing 1 bit value
;
017D EE 07         `BIT_ERR:    xor $07                    ; prepare output pattern (toggle/mask bits $07)
017F 67                         ld h,a                     ; store pattern in H for repeated use
0180 06 20         B1_7_TRAP:   ld b,$20                   ; set B=32 (repeat counter for the output loop)
0182 7C            `PULSE_1:    ld a,h                     ; reload pattern into A
0183 D3 FE                      out ($FE),a                ; output pattern to port $FE (repeat to initialize/pulse)
0185 10 FB                      djnz `PULSE_1              ; loop inner pulse sequence B times
0187 7D            `PULSE_2:    ld a,l                     ; load low part of current page index
0188 D3 FE                      out ($FE),a                ; pulse ULA/control port with A (short blink/ack)
018A 10 FB                      djnz `PULSE_2              ; repeat pulse sequence B times
018C 18 F2                      jr B1_7_TRAP               ; return to outer pulse setup
;
; The first test loop went through all memory banks. Now, iterate through all pages again.
;
018E AF            BANK_TEST:   xor a                      ; A=0: start mapping/test loop for pages
;
; BC: The screen area storing test result bytes of each bank
; D: Bit 0 set
; E: Bit counter
; We are going to test reads and writes for each banks
;
018F 01 00 40                   ld bc,$4000                ; BC -> source/read pointer at display window
0192 11 08 01      BANK_LOOP2:  ld de,$0108                ; DE = destination offset increment (pattern copy step)
;
; Page in the bank indexed by A
;
0195 87                         add a,a                    ; A := A*2 (compute 8K page index for nextreg)
0196 ED 92 56                   nextreg $56,a              ; map computed page into MMU slot 6
0199 3C                         inc a                      ; prepare next page for slot 7
019A ED 92 57                   nextreg $57,a              ; map next page into MMU slot 7
019D CB 3F                      srl a                      ; restore original page index (A>>=1)
019F 08                         ex af,af'                  ; Save the bank index to A'
;
; If the tested bank was a RAM (it exists), the last byte should be $BB, as set in the first loop.
; If not, we reached the last RAM bank, its index in A'
;
01A0 21 FF FF                   ld hl,$FFFF                ; HL = $FFFF (end-marker for read location)
01A3 7E                         ld a,(hl)                  ; read byte at HL (test read from mapped page end)
01A4 FE BB                      cp $BB                     ; compare with pattern $BB (test pattern check)
01A6 20 24                      jr nz,TEST_COMP            ; The last byte of the bank is not the expected value
;
; The bank is a RAM. Let's write back the byte from the screen memory
;
01A8 0A                         ld a,(bc)                  ; load a byte from source (display window)
01A9 03                         inc bc                     ; advance source pointer
01AA 77                         ld (hl),a                  ; write byte to mapped page (copy from display window)
;
; Let's use the $1CBA address of the bank for a bit pattern test.
; Save that memory value to the XL register.
;
01AB 21 BA DC                   ld hl,$DCBA                ; HL := $DCBA (source for special fill/copy)
01AE 7E                         ld a,(hl)                  ; read a byte from DCBA (seed value)
01AF DD 6F                      ld xl,a                    ; store seed into X' low (Z80N extended regs)
;
; Test the subsequent bit value 0
;
01B1 7A            `BIT_LOOP:   ld a,d                     ; A := D (work with high part of pattern/length)
01B2 77                         ld (hl),a                  ; write A into mapped page at HL
01B3 7E                         ld a,(hl)                  ; reload what we just wrote (verify/readback)
01B4 A2                         and d                      ; test bits with D (condition check)
01B5 28 B9                      jr z,INIT_ERR              ; The bit pattern in D if faulty --> sign the error
;
; Test the subsequent bit value 1
;
01B7 2F                         cpl                        ; complement A (invert pattern)
01B8 77                         ld (hl),a                  ; write inverted byte back
01B9 7E                         ld a,(hl)                  ; read back for verification
01BA A2                         and d                      ; test again with D
01BB 20 B3                      jr nz,INIT_ERR             ; The bit pattern in D if faulty --> sign the error
;
; Move to the next bit pattern
;
01BD CB 02                      rlc d                      ; rotate left D (modify pattern/length)
01BF 1D                         dec e                      ; decrement E (inner repeat counter)
01C0 20 EF                      jr nz,`BIT_LOOP            ; loop until E becomes zero
01C2 DD 7D                      ld a,xl                    ; load A from X' low (use stored seed)
01C4 77                         ld (hl),a                  ; Write back the original byte to $1CBA
;
; Loop while we 
;
01C5 08                         ex af,af'                  ; restore AF / status
01C6 3C                         inc a                      ; advance page index (A++)
01C7 FE 70                      cp $70                     ; compare with $70 (limit check for mapping/page range)
01C9 20 C7                      jr nz,BANK_LOOP2           ; if not $70 continue mapping loop
;
; We have all RAM pages successfully tested.
;
01CB 08                         ex af,af'                  ; restore AF (if $70 reached)
;
; We have found the last RAM page (stored in A')
;
01CC 08            TEST_COMP:   ex af,af'                  ; sync AF/AF' before leaving mapping/test section
01CD 3D                         dec a                      ; decrement A (prepare return value / final index)
01CE 32 69 5B                   ld (LBANK),a               ; store final A into LBANK (record last-tested page)
01D1 31 FF 5B                   ld sp,$5BFF                ; restore stack pointer for next stage
;
; Continue from here...
;
01D4 E7                         rst $20                    ; call ROM vector $20 (system/BIOS service)
01D5 DF 1E                      .defw $1EDF                ;
01D7 ED 91 8E 08                nextreg $8e,$08            ; select current bank for slot 3 to 0
01DB ED 56                      im 1                       ; set interrupt mode 1 (prepare interrupt state)
01DD CD E3 00                   call CopyPager             ; Copy page switching routines to the RAM
01E0 21 FF FF                   ld hl,$FFFF                ; HL := $FFFF (post-call sentinel)
01E3 22 B4 5C                   ld ($5CB4),hl              ; Set the VARS sytem variable to $ffff
01E6 11 AF 3E                   ld de,$3EAF                ; Sets the top of the stack ($FF58-$FFFF)
01E9 01 A8 00                   ld bc,$00A8                ; to the $A8 bytes starting at $3EA8 (in ROM3)
01EC EB                         ex de,hl
01ED EF                         rst $28                    ; by calling $1661 in ROM3
01EE 61 16                      .defw $1661
01F0 EB                         ex de,hl                   
01F1 23                         inc hl                      
01F2 22 7B 5C                   ld (UDG),hl              ; Set the UDG system variable to the beginning of the copied area
01F5 2B                         dec hl
01F6 22 B2 5C                   ld ($5CB2),hl              ; Set RAMTOP to the address before UDG
01F9 06 00                      ld b,$00                   ;
01FB FD 21 3A 5C                ld iy,$5C3A                ; Now, IY points to the beginning of the sysvars area
01FF 3A 69 5B                   ld a,(LBANK)               ; Get the index of the last available RAM bank
0202 4F                         ld c,a
0203 2A 7B 5C                   ld hl,(UDG)              ; HL := UDG address
0206 D9                         exx                        ; Save main registers
;
; Configura initial DivMMC settings
;
0207 ED 91 B8 82                nextreg $B8,$82            ; Enable DivMMC automap for $38 and $08
020B ED 91 B9 00                nextreg $B9,$00            ; Allow DivMMC only when ROM3 is present
020F ED 91 BA 00                nextreg $BA,$00            ; DivMMC mappings are delayed
0213 ED 91 BB F2                nextreg $BB,$F2            ; Enable $3Dxx automaps, 
                                                           ; Disable $1FF8-$1FFFF automap
                                                           ; Enable $056A and $04D7 automap
0217 ED 91 D8 01                nextreg $D8,$01            ; enable +3 FDC traps on ports $2FFD and $3FFD
;
; Init peripheral 1 settings (Reg $05)
;
021B 3E 05                      ld a,$05                   
021D CD DE 12                   call GetNxRegA
0220 E6 05                      and $05                    ; Keep 50/60Hz mode and scandoubler settings only
0222 F6 5A                      or $5A                     ; Set Jonstick 1 and 2 to Kempston 1 (port $1F)
0224 ED 79                      out (c),a                  ; Write out the new port value 
;
; Init peripheral 1 settings (Reg $08)
;
0226 3E 08                      ld a,$08
0228 CD DE 12                   call GetNxRegA
022B F6 4E                      or $4E                     ; Disable RAM and port contention
                                                           ; Enable 8-bit DACs (A,B,C,D)
                                                           ; Enable port $FF Timex video mode read
                                                           ; Enable turbosound
022D ED 79                      out (c),a                  ; Write out the new port value
;
; Init peripheral 2 settings (Reg $06)
;
022F 3E 06                      ld a,$06
0231 CD DE 12                   call GetNxRegA
0234 E6 44                      and $44                    ; Keep Diver Beep only and Enable multiface nmi by M1 button flags
0236 F6 AB                      or $AB                     ; Enable F8 cpu speed hotkey and F5/F6 expansion bus hotkeys
                                                           ; Enable F3 50/60 Hz hotkey, PS/2 mode, and AY audio chip mode
0238 ED 79                      out (c),a                  ; Write out the new port value
023A E6 FC                      and $FC                    ; Set YM audio chip mode
023C ED 79                      out (c),a                  ; Write out the new port value
;
; Init peripheral 2 settings (Reg $0A)
;
023E 3E 0A                      ld a,$0A
0240 CD DE 12                   call GetNxRegA
0243 F6 10                      or $10                     ; Enable divmmc automap
0245 ED 79                      out (c),a                  ; Write out the new port value
0247 CD E3 00                   call CopyPager             ; Copy page switching routines to the RAM
024A 62                         ld h,d                     ; HL := Next address after the page switching routines
024B 6B                         ld l,e
024C 71                         ld (hl),c                  ; Set TMPHL to 0
024D 13                         inc de                     ; DE := $5B53
024E 01 5F 01                   ld bc,$015F                ; BC := 351 bytes
0251 ED B0                      ldir                       ; Zero the $5B52-$5CB1 area
0253 21 FF 5B                   ld hl,$5BFF                ; 
0256 22 6A 5B                   ld (TMPSP),hl              ; Set TMPSP just below the sysvars area
0259 F9                         ld sp,hl                   ; Set SP to $5BFF
025A DF                         rst $18                    ; ROM1: $3471
025B 71 34                      .defw $3471                ; Initializes the stack
025D 3E CF                      ld a,$CF                   ;
025F 32 5D 5B                   ld ($5B5D),a               ; 
0262 21 40 00                   ld hl,$0040
0265 22 38 5C                   ld ($5C38),hl              ; Set RASp to $40 (Length of warning buzz)
0268 D9                         exx                        ; Restore the main registers
0269 79                         ld a,c                     ; A := last available RAM bank
;
; The LDIR at $251 overwrote these variable values
;
026A 32 69 5B                   ld (LBANK),a               ; Store it to LBANK
026D 22 7B 5C                   ld (UDG),hl                ; Store UDG again
;
; --- Initialize NextOS, display system and BASIC workspace ---
;
0270 C5                         push bc                    ; Save BC (B = 0 at this point)
0271 CD 29 23                   call L2329                 ; Initialize NextOS structures
0274 DF                         rst $18                    ; Call ROM1 routine
0275 B9 14                      .defw $14b9                ; ROM1: InitDisp - Initialize display system
0277 21 00 3C                   ld hl,$3C00                ; HL = $3C00 (CHARS - character set address)
027A 22 36 5C                   ld ($5C36),hl              ; Store CHARS address
027D FD CB 01 E6                set 4,(iy+$01)             ; Set FLAGS bit 4 (K mode)
0281 3E FF                      ld a,$FF                   ; A = $FF
0283 FD 77 00                   ld (iy),a                  ; Set ERR_NR = $FF (no error)
0286 32 77 5B                   ld ($5B77),a               ; Store $FF at $5B77
0289 32 78 5B                   ld ($5B78),a               ; Store $FF at $5B78
028C 32 88 5B                   ld ($5B88),a               ; Store $FF at $5B88
028F 32 89 5B                   ld ($5B89),a               ; Store $FF at $5B89
0292 3E 54                      ld a,$54                   ; A = $54
0294 32 79 5B                   ld ($5B79),a               ; Store $54 at $5B79
0297 32 7A 5B                   ld ($5B7A),a               ; Store $54 at $5B7A
029A 21 B6 5C                   ld hl,$5CB6                ; HL = $5CB6 (start of channel info area)
029D 22 4F 5C                   ld ($5C4F),hl              ; Store in CHANS (channel information)
02A0 11 AF 15                   ld de,$15AF                ; DE = $15AF (source: channel data in ROM)
02A3 01 15 00                   ld bc,$0015                ; BC = $0015 (21 bytes to copy)
02A6 EB                         ex de,hl                   ; Swap: HL = source, DE = dest
02A7 EF                         rst $28                    ; Call ROM3 routine
02A8 C3 33                      .defw $33C3                ; ROM3: LDIR - copy 21 bytes from ROM to RAM
02AA EB                         ex de,hl                   ; HL = end of copied data ($5CB6 + 21)
02AB 2B                         dec hl                     ; HL points to last byte of channel data
02AC 22 57 5C                   ld (DATADD),hl             ; Store in DATADD (end of variables)
02AF 23                         inc hl                     ; HL = start of BASIC program area
02B0 22 53 5C                   ld (PROG),hl               ; Store in PROG (start of BASIC program)
02B3 22 4B 5C                   ld (VARS),hl               ; Store in VARS (start of variables)
02B6 36 80                      ld (hl),$80                ; Write $80 (VARS end marker)
02B8 23                         inc hl                     ; Advance pointer
02B9 22 59 5C                   ld (E_LINE),hl             ; Store in E_LINE (edit line address)
02BC 36 0D                      ld (hl),$0D                ; Write $0D (ENTER character)
02BE 23                         inc hl                     ; Advance pointer
02BF 36 80                      ld (hl),$80                ; Write $80 (end marker)
02C1 23                         inc hl                     ; Advance pointer
02C2 22 61 5C                   ld (WORKSP),hl             ; Store in WORKSP (workspace address)
02C5 22 63 5C                   ld (STKBOT),hl             ; Store in STKBOT (stack bottom)
02C8 22 65 5C                   ld (STKEND),hl             ; Store in STKEND (stack end)
02CB 3E 38                      ld a,$38                   ; A = $38 (white INK, black PAPER)
02CD 32 8D 5C                   ld (ATTR_P),a              ; Store in ATTR_P (permanent attributes)
02D0 32 8F 5C                   ld (ATTR_T),a              ; Store in ATTR_T (temporary attributes)
02D3 32 61 5B                   ld ($5B61),a               ; Store $38 at $5B61
02D6 32 63 5B                   ld ($5B63),a               ; Store $38 at $5B63
02D9 32 48 5C                   ld (BORDCR),a              ; Store in BORDCR (border color)
02DC 3E 07                      ld a,$07                   ; A = $07 (white border)
02DE D3 FE                      out ($FE),a                ; Set border color via ULA port
02E0 21 23 05                   ld hl,$0523                ; HL = $0523 (REPDEL=$23, REPPER=$05)
02E3 22 09 5C                   ld (REPDEL),hl             ; Set REPDEL and REPPER (key repeat timing)
02E6 FD 35 C6                   dec (iy-$3A)               ; Decrement KSTATE+0 ($5C00): set to $FF (unused)
02E9 FD 35 CA                   dec (iy-$36)               ; Decrement KSTATE+4 ($5C04): set to $FF (unused)
02EC 21 C6 15                   ld hl,StrmIn               ; HL = $15C6 (source: stream data)
02EF 11 10 5C                   ld de,STRMS                ; DE = $5C10 (STRMS - streams data)
02F2 01 0E 00                   ld bc,$000E                ; BC = $000E (14 bytes to copy)
02F5 EF                         rst $28                    ; Call ROM3 routine
02F6 C3 33                      .defw $33C3                ; ROM3: LDIR copy routine
02F8 FD 36 31 02                ld (iy+$31),$02            ; Set DF_SZ = $02 (display file size)
02FC FB                         ei                         ; Enable interrupts
02FD EF                         rst $28                    ; Call ROM3 routine
02FE 6B 0D                      .defw $0D6B                ; CLS48: 48K compatible CLS
0300 F1                         pop af                     ; Restore AF (from PUSH BC at $0270)
0301 CF                         rst $08                    ; ERROR-1 routine
0302 F5                         push af                    ; Save AF
0303 CD 60 03                   call CpyBits               ; Call stripe pattern initialization
0306 DF                         rst $18                    ; Call ROM1 routine
0307 11 15                      .defw $1511                ; Initialize Clip Windows and Display
0309 21 5A 03                   ld hl,$035A                ; HL = $035A ???
030C 11 B8 D5                   ld de,$D5B8                ; DE = $D5B8 ???
030F 01 06 00                   ld bc,$0006                ; BC = 6
0312 ED B0                      ldir                       ; Copy 6 bytes
0314 EB                         ex de,hl                   ; HL = $D5BE (after copy destination)
0315 37                         scf                        ; Set carry flag (use nextreg read mode)
0316 CD 3C 0F                   call InitSprPat            ; Initialize sprite patterns
0319 21 20 00                   ld hl,$0020                ; HL = $0020
031C 22 3D D7                   ld ($D73D),hl              ; Store $0020 at $D73D
031F 2C                         inc l                      ; L = $21
0320 2C                         inc l                      ; L = $22
0321 2C                         inc l                      ; L = $23
0322 22 3F D7                   ld ($D73F),hl              ; Store $0023 at $D73F
0325 3E 03                      ld a,$03                   ; A = $03
0327 32 81 5C                   ld ($5C81),a               ; Store $03 at $5C81 (system variable)
032A E7                         rst $20                    ; Call ROM2 routine
032B 43 1E                      .defw $1E43                ; ROM2: Check core version and initialize
032D 21 A5 10                   ld hl,$10A5                ; HL = $10A5 (source: data table 1)
0330 11 33 D6                   ld de,$D633
0333 01 00 37                   ld bc,$3700                ; BC = $3700 (parameter for SavePal)
0336 CD D5 0F                   call SavePal               ; Copy 32 bytes and initialize
0339 21 C5 10                   ld hl,$10C5                ; HL = $10C5 (source: data table 2)
033C 11 DA D6                   ld de,$D6DA                ; DE = $D6DA (destination in upper RAM)
033F 01 60 37                   ld bc,$3760                ; BC = $3760 (parameter for SavePal)
0342 CD D5 0F      L0342:       call SavePal               ; Copy 32 bytes and initialize
0345 CD 03 10                   call SvDispState           ; Save display state to upper RAM
0348 CD 82 0F                   call InSysFlags            ; Initialize system flags
034B F1                         pop af                     ; Restore AF (from PUSH AF at $0302)
034C DF                         rst $18                    ; Call ROM1 routine
034D CA 2B                      .defw $2BCA                ; ROM1: routine at $2BCA
034F FD CB 02 50                set 2,(iy+$02)             ; Set bit 2 of FLAGS2 ($5C3C)
0353 EE FD                      xor $FD                    ; A = A XOR $FD
0355 36 31                      ld (hl),$31                ; (HL) = $31 (ASCII '1')
0357 02                         ld (bc),a                  ; (BC) = A
0358 C3 BE 11                   jp L11BE                   ; Jump to L11BE
;\n; Data Block: 6 bytes copied to $D5B8 during initialization at $030F\n; Binary configuration data for display/graphics setup\n;
035B 00                         .defb $00                  ; Byte 0
035C 00                         .defb $00                  ; Byte 1
035D 03                         .defb $03                  ; Byte 2
035E 00                         .defb $00                  ; Byte 3
035F 3C                         .defb $3C                  ; Byte 4
;
; Copy Bit Pattern Table to RAM
; Copies a 16-byte lookup table from ROM (StripePtr) to upper RAM ($D750).
; The table contains bit patterns used for graphics operations (bit masks).
; Entry: None
; Exit: 16 bytes copied to $D750
;
0360 21 F7 0D      CpyBits:     ld hl,StripePtr            ; HL := StripePtr (source: bit pattern table)
0363 11 50 D7                   ld de,$D750                ; DE := $D750 (destination in upper RAM)
0366 01 10 00                   ld bc,$0010                ; BC := 16 bytes to copy
0369 ED B0                      ldir                       ; Copy 16 bytes from ROM to RAM
036B C9                         ret                        ; Return
036C ED 34 04 00   L036C:       add hl,$0004
0370 47                         ld b,a
0371 7E                         ld a,(hl)
0372 FE 53                      cp $53
0374 20 1B                      jr nz,L0391
0376 DD E5         L0376:       push ix
0378 3A 7F 5C                   ld a,(GMODE)
037B E6 0F                      and $0F
037D C6 F2                      add a,$F2
037F DD 67                      ld xh,a
0381 DD 2E 00                   ld xl,$00
0384 78                         ld a,b
0385 CD 67 27                   call L2767
0388 DD E1                      pop ix
038A 21 FE 15      L038A:       ld hl,$15FE
038D E5                         push hl
038E C3 48 5B      L038E:       jp L5B48
0391 FE 4B         L0391:       cp $4B
0393 28 E1                      jr z,L0376
0395 2A 51 5C                   ld hl,($5C51)
0398 EB                         ex de,hl
0399 A7                         and a
039A ED 52                      sbc hl,de
039C 4D                         ld c,l
039D EB                         ex de,hl
039E ED 34 05 00                add hl,$0005
03A2 FE 44                      cp $44
03A4 28 1A                      jr z,L03C0
03A6 0D                         dec c
03A7 20 1E                      jr nz,L03C7
03A9 5E                         ld e,(hl)
03AA 23                         inc hl
03AB 66                         ld h,(hl)
03AC 6B                         ld l,e
03AD 11 FE 15                   ld de,$15FE
03B0 D5                         push de
03B1 78                         ld a,b
03B2 DD E5                      push ix
03B4 DD 2A 51 5C                ld ix,($5C51)
03B8 CD BF 03                   call L03BF
03BB DD E1                      pop ix
03BD 18 CF                      jr L038E
03BF E9            L03BF:       jp (hl)
03C0 79            L03C0:       ld a,c
03C1 3D                         dec a
03C2 CD 81 04                   call L0481
03C5 18 C3                      jr L038A
03C7 23            L03C7:       inc hl
03C8 23                         inc hl
03C9 5E                         ld e,(hl)
03CA 23                         inc hl
03CB 66                         ld h,(hl)
03CC 6B                         ld l,e
03CD 11 FE 15                   ld de,$15FE
03D0 D5                         push de
03D1 DD E5                      push ix
03D3 DD 2A 51 5C                ld ix,($5C51)
03D7 CD BF 03                   call L03BF
03DA DD E1                      pop ix
03DC 38 B0                      jr c,L038E
03DE 28 AE                      jr z,L038E
03E0 3E 07         L03E0:       ld a,$07
03E2 C3 B0 27                   jp L27B0
03E5 2A 51 5C      L03E5:       ld hl,($5C51)
03E8 E5                         push hl
03E9 DD E1                      pop ix
03EB 7E                         ld a,(hl)
03EC FE 4D                      cp $4D
03EE 20 18                      jr nz,L0408
03F0 DD 7E 01                   ld a,(ix+$01)
03F3 FE 5B                      cp $5B
03F5 20 11                      jr nz,L0408
03F7 DD 7E 04                   ld a,(ix+$04)
03FA FE 53                      cp $53
03FC 28 30                      jr z,L042E
03FE FE 4B                      cp $4B
0400 28 2C                      jr z,L042E
0402 FE 44                      cp $44
0404 28 59                      jr z,L045F
0406 18 42                      jr L044A
0408 7B            L0408:       ld a,e
0409 FE 04                      cp $04
040B CA 95 04                   jp z,L0495
040E 19                         add hl,de
040F 4E                         ld c,(hl)
0410 23                         inc hl
0411 46                         ld b,(hl)
0412 FE 02                      cp $02
0414 28 06                      jr z,L041C
0416 D9                         exx
0417 79                         ld a,c
0418 D9                         exx
0419 C3 85 00                   jp L0085
041C FD CB 02 9E   L041C:       res 3,(iy+$02)
0420 CD 85 00                   call L0085
0423 D8            L0423:       ret c
0424 20 BA                      jr nz,L03E0
0426 DF                         rst $18
0427 50                         ld d,b
0428 2B                         dec hl
0429 11 02 00                   ld de,$0002
042C 18 B7                      jr L03E5
042E 3A 7F 5C      L042E:       ld a,(GMODE)
0431 E6 0F                      and $0F
0433 C6 F2                      add a,$F2
0435 DD 67                      ld xh,a
0437 DD 2E 00                   ld xl,$00
043A 7B                         ld a,e
043B FE 02                      cp $02
043D CA E0 11                   jp z,L11E0
0440 FE 04                      cp $04
0442 D9                         exx
0443 CA 9A 2B                   jp z,L2B9A
0446 79                         ld a,c
0447 C3 5B 27                   jp L275B
044A 7B            L044A:       ld a,e
044B 19                         add hl,de
044C 1E 05                      ld e,$05
044E 19                         add hl,de
044F 5E                         ld e,(hl)
0450 23                         inc hl
0451 56                         ld d,(hl)
0452 D5                         push de
0453 FE 02                      cp $02
0455 28 03                      jr z,L045A
0457 D9                         exx
0458 79                         ld a,c
0459 C9                         ret
045A 21 23 04      L045A:       ld hl,$0423
045D E3                         ex (sp),hl
045E E9                         jp (hl)
045F 01 05 00      L045F:       ld bc,$0005
0462 09                         add hl,bc
0463 D9                         exx
0464 C5                         push bc
0465 D9                         exx
0466 C1                         pop bc
0467 7B                         ld a,e
0468 FE 04                      cp $04
046A 20 0F                      jr nz,L047B
046C 80                         add a,b
046D 80                         add a,b
046E FE 06                      cp $06
0470 20 09                      jr nz,L047B
0472 D9                         exx
0473 E5                         push hl
0474 D5                         push de
0475 D9                         exx
0476 DD E1                      pop ix
0478 D1                         pop de
0479 20 1A                      jr nz,L0495
047B 41            L047B:       ld b,c
047C CD 81 04                   call L0481
047F 18 A2                      jr L0423
0481 4E            L0481:       ld c,(hl)
0482 23                         inc hl
0483 66                         ld h,(hl)
0484 EB                         ex de,hl
0485 58                         ld e,b
0486 CB 3F                      srl a
0488 C6 FB                      add a,$FB
048A 47                         ld b,a
048B E7                         rst $20
048C CF                         rst $08
048D 01 D8 3C                   ld bc,$3CD8
0490 C8                         ret z
0491 3C                         inc a
0492 CA E0 03                   jp z,L03E0
0495 3E 12         L0495:       ld a,$12
0497 C3 B0 27                   jp L27B0
049A CD D7 04                   call L04D7
049D 7E                         ld a,(hl)
049E C9                         ret
049F 04                         inc b
04A0 10 05                      djnz L04A7
04A2 11 0F 00                   ld de,$000F
04A5 18 24                      jr L04CB
04A7 10 1F         L04A7:       djnz L04C8
04A9 7A                         ld a,d
04AA B3                         or e
04AB C2 E0 03                   jp nz,L03E0
04AE E5                         push hl
04AF 2A 51 5C                   ld hl,($5C51)
04B2 11 0D 00                   ld de,$000D
04B5 19                         add hl,de
04B6 5E                         ld e,(hl)
04B7 23                         inc hl
04B8 56                         ld d,(hl)
04B9 1B                         dec de
04BA 23                         inc hl
04BB EB                         ex de,hl
04BC C1                         pop bc
04BD A7                         and a
04BE ED 42                      sbc hl,bc
04C0 EB                         ex de,hl
04C1 DA E0 03                   jp c,L03E0
04C4 71                         ld (hl),c
04C5 23                         inc hl
04C6 70                         ld (hl),b
04C7 C9                         ret
04C8 11 0D 00      L04C8:       ld de,$000D
04CB 2A 51 5C      L04CB:       ld hl,($5C51)
04CE 19                         add hl,de
04CF 5E                         ld e,(hl)
04D0 23                         inc hl
04D1 56                         ld d,(hl)
04D2 EB                         ex de,hl
04D3 11 00 00                   ld de,$0000
04D6 C9                         ret
04D7 2A 51 5C      L04D7:       ld hl,($5C51)
04DA 11 0D 00                   ld de,$000D
04DD 19                         add hl,de
04DE 4E                         ld c,(hl)
04DF 23                         inc hl
04E0 46                         ld b,(hl)
04E1 23                         inc hl
04E2 5E                         ld e,(hl)
04E3 23                         inc hl
04E4 56                         ld d,(hl)
04E5 EB                         ex de,hl
04E6 E5                         push hl
04E7 A7                         and a
04E8 ED 42                      sbc hl,bc
04EA E1                         pop hl
04EB EB                         ex de,hl
04EC D2 E0 03                   jp nc,L03E0
04EF 13                         inc de
04F0 72                         ld (hl),d
04F1 2B                         dec hl
04F2 73                         ld (hl),e
04F3 23                         inc hl
04F4 23                         inc hl
04F5 4E                         ld c,(hl)
04F6 23                         inc hl
04F7 46                         ld b,(hl)
04F8 EB                         ex de,hl
04F9 09                         add hl,bc
04FA 2B                         dec hl
04FB 37                         scf
04FC C9                         ret
04FD 2A 51 5C      L04FD:       ld hl,($5C51)
0500 11 0D 00                   ld de,$000D
0503 19                         add hl,de
0504 46                         ld b,(hl)
0505 E1                         pop hl
0506 CF                         rst $08
0507 E9                         jp (hl)
0508 D9                         exx
0509 CD FD 04                   call L04FD
050C C5                         push bc
050D D9                         exx
050E 78                         ld a,b
050F C1                         pop bc
0510 A7                         and a
0511 28 08                      jr z,L051B
0513 3D                         dec a
0514 28 0C                      jr z,L0522
0516 E7                         rst $20
0517 39                         add hl,sp
0518 01 18 03                   ld bc,$0318
051B E7            L051B:       rst $20
051C 33                         inc sp
051D 01 16 00                   ld bc,$0016
0520 18 15                      jr L0537
0522 E7            L0522:       rst $20
0523 36 01                      ld (hl),$01
0525 18 10                      jr L0537
0527 CD FD 04                   call L04FD
052A E7                         rst $20
052B 18 01                      jr L052E
052D 79                         ld a,c
052E 18 07         L052E:       jr L0537
0530 4F                         ld c,a
0531 CD FD 04                   call L04FD
0534 E7                         rst $20
0535 1B                         dec de
0536 01 F7 D8                   ld bc,$D8F7
0539 3E 12                      ld a,$12
053B C3 B0 27                   jp L27B0
053E D9                         exx
053F E5            L053F:       push hl
0540 C5                         push bc
0541 E5                         push hl
0542 2A 5A 5B                   ld hl,($5B5A)
0545 E3                         ex (sp),hl
0546 EF                         rst $28
0547 E8                         ret pe
0548 19                         add hl,de
0549 E1                         pop hl
054A 22 5A 5B                   ld ($5B5A),hl
054D C1                         pop bc
054E E1                         pop hl
054F ED 5B 4F 5C                ld de,($5C4F)
0553 A7                         and a
0554 ED 52                      sbc hl,de
0556 E5                         push hl
0557 3E 13                      ld a,$13
0559 21 10 5C                   ld hl,STRMS
055C 5E            L055C:       ld e,(hl)
055D 23                         inc hl
055E 56                         ld d,(hl)
055F E3                         ex (sp),hl
0560 A7                         and a
0561 ED 52                      sbc hl,de
0563 19                         add hl,de
0564 30 05                      jr nc,L056B
0566 EB                         ex de,hl
0567 A7                         and a
0568 ED 42                      sbc hl,bc
056A EB                         ex de,hl
056B E3            L056B:       ex (sp),hl
056C 2B                         dec hl
056D 73                         ld (hl),e
056E 23                         inc hl
056F 72                         ld (hl),d
0570 23                         inc hl
0571 3D                         dec a
0572 20 E8                      jr nz,L055C
0574 E1                         pop hl
0575 C9                         ret
;
;
;
0576 D9                         exx                        ; Turn back to main register set (when called from another ROM)
0577 E5            L0577:       push hl                    ; Save used registers
0578 C5                         push bc
0579 E5                         push hl
057A 2A 53 5C                   ld hl,(PROG)               ; HL := Start of the program area
057D 09                         add hl,bc                  ; Calculate the potential end address
057E 7C                         ld a,h                     
057F FE C0                      cp $C0                     ; Will be this address over $C000?
0581 30 44                      jr nc,L05C7                ; If so, take an alternate path
0583 2A 5A 5B                   ld hl,($5B5A)              
0586 E3                         ex (sp),hl                 ; Save the value of $5B5A to the stack
0587 EF                         rst $28                    ; Call the "make room" routine in ROM3
0588 55 16                      .defw $1655
058A E1                         pop hl                     ; Restore the value of $5B5A from the stack
058B 22 5A 5B                   ld ($5B5A),hl              ; Save it
058E 2A 57 5C                   ld hl,(DATADD)
0591 ED 5B 53 5C                ld de,(PROG)
0595 1B                         dec de
0596 A7                         and a
0597 ED 52                      sbc hl,de
0599 30 04                      jr nc,L059F
059B ED 53 57 5C                ld (DATADD),de
059F C1            L059F:       pop bc
05A0 E1                         pop hl
05A1 ED 5B 4F 5C                ld de,($5C4F)
05A5 A7                         and a
05A6 ED 52                      sbc hl,de
05A8 E5                         push hl
05A9 3E 13                      ld a,$13
05AB 21 10 5C                   ld hl,STRMS
05AE 5E            L05AE:       ld e,(hl)
05AF 23                         inc hl
05B0 56                         ld d,(hl)
05B1 E3                         ex (sp),hl
05B2 A7                         and a
05B3 ED 52                      sbc hl,de
05B5 19                         add hl,de
05B6 30 04                      jr nc,L05BC
05B8 EB                         ex de,hl
05B9 A7                         and a
05BA 09                         add hl,bc
05BB EB                         ex de,hl
05BC E3            L05BC:       ex (sp),hl
05BD 2B                         dec hl
05BE 73                         ld (hl),e
05BF 23                         inc hl
05C0 72                         ld (hl),d
05C1 23                         inc hl
05C2 3D                         dec a
05C3 20 E9                      jr nz,L05AE
05C5 E1                         pop hl
05C6 C9                         ret
05C7 EF            L05C7:       rst $28
05C8 15                         dec d
05C9 1F                         rra
05CA 0B                         dec bc
05CB F2 05 0A                   jp p,L0A05
05CE F5                         push af
05CF 05                         dec b
05D0 07                         rlca
05D1 31 06 20                   ld sp,$2006
05D4 31 06 0D                   ld sp,$0D06
05D7 34                         inc (hl)
05D8 06 0E                      ld b,$0E
05DA 19                         add hl,de
05DB 06 37                      ld b,$37
05DD F2 05 36                   jp p,L3605
05E0 F5                         push af
05E1 05                         dec b
05E2 08                         ex af,af'
05E3 C6 3D                      add a,$3D
05E5 09                         add hl,bc
05E6 BA                         cp d
05E7 3D                         dec a
05E8 35                         dec (hl)
05E9 C6 3D                      add a,$3D
05EB 38 BA                      jr c,L05A7
05ED 3D                         dec a
05EE 30 34                      jr nc,L0624
05F0 06 FF                      ld b,$FF
05F2 37                         scf
05F3 18 01                      jr L05F6
05F5 A7                         and a
05F6 3A 00 F7      L05F6:       ld a,($F700)
05F9 CD 9E 08                   call L089E
05FC DC 0A 06                   call c,L060A
05FF D4 10 06                   call nc,L0610
0602 32 00 F7                   ld ($F700),a
0605 CD 9E 08                   call L089E
0608 37                         scf
0609 C9                         ret
060A 3D            L060A:       dec a
060B F0                         ret p
060C 3A 1F F7                   ld a,($F71F)
060F C9                         ret
0610 3C            L0610:       inc a
0611 2A 1F F7                   ld hl,($F71F)
0614 2C                         inc l
0615 BD                         cp l
0616 D8                         ret c
0617 AF                         xor a
0618 C9                         ret
0619 21 E8 58                   ld hl,$58E8
061C 3A 1F F7                   ld a,($F71F)
061F 3C                         inc a
0620 47                         ld b,a
0621 C5            L0621:       push bc
0622 11 02 04                   ld de,$0402
0625 CD B1 08                   call L08B1
0628 ED 34 10 00                add hl,$0010
062C C1                         pop bc
062D 10 F2                      djnz L0621
062F 37                         scf
0630 C9                         ret
0631 37                         scf
0632 18 04                      jr L0638
0634 3A 00 F7                   ld a,($F700)
0637 A7                         and a
0638 E1            L0638:       pop hl
0639 E1                         pop hl
063A 21 68 5B                   ld hl,$5B68
063D CB 8E                      res 1,(hl)
063F F5                         push af
0640 CD 53 08                   call L0853
0643 F1                         pop af
0644 C9                         ret
0645 F5            L0645:       push af
0646 21 20 F7                   ld hl,$F720
0649 01 00 08                   ld bc,$0800
064C 11 EA 0D                   ld de,$0DEA
064F 3E 7F                      ld a,$7F
0651 DB FE                      in a,($FE)
0653 CB 4F                      bit 1,a
0655 C4 C5 3B                   call nz,L3BC5
0658 EB                         ex de,hl
0659 21 EA 09                   ld hl,$09EA
065C 01 C3 03                   ld bc,$03C3
065F ED B0                      ldir
0661 F1                         pop af
0662 CD 75 06                   call L0675
0665 D0                         ret nc
0666 CD 9B 06      L0666:       call L069B
0669 D8                         ret c
066A CD E7 08                   call L08E7
066D 30 01                      jr nc,L0670
066F C8                         ret z
0670 D4 18 3E      L0670:       call nc,L3E18
0673 18 F1                      jr L0666
0675 21 20 F7      L0675:       ld hl,$F720
0678 4F                         ld c,a
0679 7E            L0679:       ld a,(hl)
067A FE 3D                      cp $3D
067C 20 17                      jr nz,L0695
067E 23                         inc hl
067F CD CD 09                   call L09CD
0682 30 11                      jr nc,L0695
0684 79                         ld a,c
0685 BB                         cp e
0686 20 0D                      jr nz,L0695
0688 CD 34 08                   call L0834
068B C8                         ret z
068C 79                         ld a,c
068D 32 44 D7                   ld ($D744),a
0690 22 42 D7                   ld ($D742),hl
0693 37                         scf
0694 C9                         ret
0695 CD 2E 08      L0695:       call L082E
0698 C8                         ret z
0699 18 DE                      jr L0679
069B AF            L069B:       xor a
069C 32 00 F7                   ld ($F700),a
069F AF                         xor a
06A0 DF                         rst $18
06A1 A9                         xor c
06A2 14                         inc d
06A3 CD 50 08                   call L0850
06A6 3E 02                      ld a,$02
06A8 EF                         rst $28
06A9 01 16 21                   ld bc,$2116
06AC 3C                         inc a
06AD 5C                         ld e,h
06AE CB 86                      res 0,(hl)
06B0 21 8F 5C                   ld hl,ATTR_T
06B3 3A E0 D6                   ld a,($D6E0)
06B6 77                         ld (hl),a
06B7 AF                         xor a
06B8 23                         inc hl
06B9 77                         ld (hl),a
06BA 23                         inc hl
06BB 77                         ld (hl),a
06BC 3E FE                      ld a,$FE
06BE CD B5 07                   call L07B5
06C1 2A 42 D7                   ld hl,($D742)
06C4 CD C2 07                   call L07C2
06C7 3E 20                      ld a,$20
06C9 D7                         rst $10
06CA E5                         push hl
06CB CD 2F 0E                   call L0E2F
06CE CD 6D 3D                   call L3D6D
06D1 CD 2F 0E                   call L0E2F
06D4 3E 20                      ld a,$20
06D6 D7                         rst $10
06D7 E1                         pop hl
06D8 3A E3 D6                   ld a,($D6E3)
06DB 32 8F 5C                   ld (ATTR_T),a
06DE AF            L06DE:       xor a
06DF 01 01 F7                   ld bc,$F701
06E2 11 0B F7                   ld de,$F70B
06E5 F5            L06E5:       push af
06E6 CD 2E 08                   call L082E
06E9 28 20                      jr z,L070B
06EB FE 3D                      cp $3D
06ED 28 1C                      jr z,L070B
06EF F1                         pop af
06F0 F5                         push af
06F1 C5                         push bc
06F2 D5                         push de
06F3 CD B5 07                   call L07B5
06F6 CD D9 07                   call L07D9
06F9 79                         ld a,c
06FA D1                         pop de
06FB C1                         pop bc
06FC EB                         ex de,hl
06FD 73                         ld (hl),e
06FE 23                         inc hl
06FF 72                         ld (hl),d
0700 23                         inc hl
0701 EB                         ex de,hl
0702 02                         ld (bc),a
0703 03                         inc bc
0704 F1                         pop af
0705 3C                         inc a
0706 FE 0A                      cp $0A
0708 38 DB                      jr c,L06E5
070A F5                         push af
070B F1            L070B:       pop af
070C 3D                         dec a
070D 32 1F F7                   ld ($F71F),a
0710 21 AD 0D                   ld hl,$0DAD
0713 FA DE 06                   jp m,L06DE
0716 3C                         inc a
0717 CD B5 07                   call L07B5
071A 06 09                      ld b,$09
071C CD D1 07                   call L07D1
071F 3A 69 5B                   ld a,(LBANK)
0722 A7                         and a
0723 28 1F                      jr z,L0744
0725 3C                         inc a
0726 2A 36 5C                   ld hl,($5C36)
0729 E5                         push hl
072A 23                         inc hl
072B 22 36 5C                   ld ($5C36),hl
072E 6F                         ld l,a
072F 26 00                      ld h,$00
0731 29                         add hl,hl
0732 29                         add hl,hl
0733 29                         add hl,hl
0734 29                         add hl,hl
0735 1E 20                      ld e,$20
0737 DF                         rst $18
0738 14                         inc d
0739 37                         scf
073A 3E 4B                      ld a,$4B
073C D7                         rst $10
073D 3E 20                      ld a,$20
073F D7                         rst $10
0740 E1                         pop hl
0741 22 36 5C                   ld ($5C36),hl
0744 2A E2 D6      L0744:       ld hl,($D6E2)
0747 7C                         ld a,h
0748 AD                         xor l
0749 E6 07                      and $07
074B 20 24                      jr nz,L0771
074D 21 40 77                   ld hl,$7740
0750 3A 1F F7                   ld a,($F71F)
0753 3C                         inc a
0754 3C                         inc a
0755 87                         add a,a
0756 87                         add a,a
0757 87                         add a,a
0758 3D                         dec a
0759 47                         ld b,a
075A C5                         push bc
075B 11 00 FF                   ld de,$FF00
075E CD 41 08                   call L0841
0761 06 7F                      ld b,$7F
0763 11 01 00                   ld de,$0001
0766 CD 41 08                   call L0841
0769 C1                         pop bc
076A 04                         inc b
076B 11 00 01                   ld de,$0100
076E CD 41 08                   call L0841
0771 FD CB 01 AE   L0771:       res 5,(iy+$01)
0775 21 68 5B                   ld hl,$5B68
0778 CB CE                      set 1,(hl)
077A 3A 00 F7                   ld a,($F700)
077D CD 9E 08                   call L089E
0780 AF            L0780:       xor a
0781 32 41 5C                   ld ($5C41),a
0784 CD 55 12                   call L1255
0787 21 CA 05                   ld hl,$05CA
078A CD A1 15                   call L15A1
078D 38 F1                      jr c,L0780
078F CD 14 08                   call L0814
0792 ED 4B 1E F7                ld bc,($F71E)
0796 04                         inc b
0797 0E 00                      ld c,$00
0799 21 01 F7                   ld hl,$F701
079C BE            L079C:       cp (hl)
079D 28 07                      jr z,L07A6
079F 23                         inc hl
07A0 0C                         inc c
07A1 10 F9                      djnz L079C
07A3 A7                         and a
07A4 18 0A                      jr L07B0
07A6 79            L07A6:       ld a,c
07A7 32 00 F7                   ld ($F700),a
07AA 21 34 06                   ld hl,$0634
07AD CD C1 15                   call L15C1
07B0 D4 18 3E      L07B0:       call nc,L3E18
07B3 18 CB                      jr L0780
07B5 C6 07         L07B5:       add a,$07
07B7 47                         ld b,a
07B8 0E 08                      ld c,$08
07BA 3E 16                      ld a,$16
07BC D7                         rst $10
07BD 78                         ld a,b
07BE D7                         rst $10
07BF 79                         ld a,c
07C0 D7                         rst $10
07C1 C9                         ret
07C2 06 08         L07C2:       ld b,$08
07C4 3E 20                      ld a,$20
07C6 D7                         rst $10
07C7 7E            L07C7:       ld a,(hl)
07C8 FE 20                      cp $20
07CA 38 05                      jr c,L07D1
07CC 23                         inc hl
07CD D7                         rst $10
07CE 10 F7                      djnz L07C7
07D0 C9                         ret
07D1 F5            L07D1:       push af
07D2 3E 20         L07D2:       ld a,$20
07D4 D7                         rst $10
07D5 10 FB                      djnz L07D2
07D7 F1                         pop af
07D8 C9                         ret
07D9 01 00 0F      L07D9:       ld bc,$0F00
07DC 59                         ld e,c
07DD 3E 20                      ld a,$20
07DF D7                         rst $10
07E0 7E            L07E0:       ld a,(hl)
07E1 FE 3A                      cp $3A
07E3 28 EC                      jr z,L07D1
07E5 FE 20                      cp $20
07E7 38 E8                      jr c,L07D1
07E9 23                         inc hl
07EA FE 5F                      cp $5F
07EC 28 0E                      jr z,L07FC
07EE 5F                         ld e,a
07EF D7                         rst $10
07F0 10 EE                      djnz L07E0
07F2 7E            L07F2:       ld a,(hl)
07F3 FE 3A                      cp $3A
07F5 C8                         ret z
07F6 FE 20                      cp $20
07F8 D8                         ret c
07F9 23                         inc hl
07FA 18 F6                      jr L07F2
07FC 0C            L07FC:       inc c
07FD 0D                         dec c
07FE 20 E0                      jr nz,L07E0
0800 7B                         ld a,e
0801 CD 14 08                   call L0814
0804 4F                         ld c,a
0805 E5                         push hl
0806 2A 84 5C                   ld hl,($5C84)
0809 2B                         dec hl
080A CD 25 08                   call L0825
080D 3A E5 D6                   ld a,($D6E5)
0810 77                         ld (hl),a
0811 E1                         pop hl
0812 18 CC                      jr L07E0
0814 FE 41         L0814:       cp $41
0816 D8                         ret c
0817 FE 5B                      cp $5B
0819 D0                         ret nc
081A F6 20                      or $20
081C C9                         ret
081D 7E            L081D:       ld a,(hl)
081E 23                         inc hl
081F FE FF                      cp $FF
0821 C8                         ret z
0822 D7                         rst $10
0823 18 F8                      jr L081D
0825 7C            L0825:       ld a,h
0826 0F                         rrca
0827 0F                         rrca
0828 0F                         rrca
0829 F6 50                      or $50
082B 67                         ld h,a
082C C9                         ret
082D 23            L082D:       inc hl
082E 7E            L082E:       ld a,(hl)
082F FE 20                      cp $20
0831 30 FA                      jr nc,L082D
0833 23            L0833:       inc hl
0834 7E            L0834:       ld a,(hl)
0835 FE FF                      cp $FF
0837 C8                         ret z
0838 FE 0D                      cp $0D
083A 28 F7                      jr z,L0833
083C FE 0A                      cp $0A
083E C0                         ret nz
083F 18 F2                      jr L0833
0841 C5            L0841:       push bc
0842 D5                         push de
0843 E5                         push hl
0844 44                         ld b,h
0845 4D                         ld c,l
0846 EF                         rst $28
0847 E9                         jp (hl)
0848 22 E1 D1                   ld ($D1E1),hl
084B C1                         pop bc
084C 19                         add hl,de
084D 10 F2                      djnz L0841
084F C9                         ret
0850 37            L0850:       scf
0851 18 01                      jr L0854
0853 A7            L0853:       and a
0854 21 3C 5C      L0854:       ld hl,$5C3C
0857 11 11 ED                   ld de,$ED11
085A 01 01 00                   ld bc,$0001
085D CD 94 08                   call L0894
0860 21 7D 5C                   ld hl,$5C7D
0863 01 15 00                   ld bc,$0015
0866 CD 93 08                   call L0893
0869 01 13 0E                   ld bc,$0E13
086C C5            L086C:       push bc
086D D5                         push de
086E 41                         ld b,c
086F EF                         rst $28
0870 9B                         sbc a,e
0871 0E ED                      ld c,$ED
0873 34                         inc (hl)
0874 08                         ex af,af'
0875 00                         nop
0876 D1                         pop de
0877 CD 7F 08                   call L087F
087A C1                         pop bc
087B 0D                         dec c
087C 10 EE                      djnz L086C
087E C9                         ret
087F 01 10 08      L087F:       ld bc,$0810
0882 E5                         push hl
0883 C5            L0883:       push bc
0884 06 00                      ld b,$00
0886 E5                         push hl
0887 CD 93 08                   call L0893
088A E1                         pop hl
088B C1                         pop bc
088C 24                         inc h
088D 10 F4                      djnz L0883
088F E1                         pop hl
0890 CD 25 08                   call L0825
0893 08            L0893:       ex af,af'
0894 38 01         L0894:       jr c,L0897
0896 EB                         ex de,hl
0897 ED B0         L0897:       ldir
0899 38 01                      jr c,L089C
089B EB                         ex de,hl
089C 08            L089C:       ex af,af'
089D C9                         ret
089E F5            L089E:       push af
089F 57                         ld d,a
08A0 1E 20                      ld e,$20
08A2 ED 30                      mul d,e
08A4 ED 35 E8 58                add de,$58E8
08A8 EB                         ex de,hl
08A9 11 01 06                   ld de,$0601
08AC CD B1 08                   call L08B1
08AF F1                         pop af
08B0 C9                         ret
08B1 0E 10         L08B1:       ld c,$10
08B3 7E            L08B3:       ld a,(hl)
08B4 E5                         push hl
08B5 21 E7 D6                   ld hl,$D6E7
08B8 42                         ld b,d
08B9 BE            L08B9:       cp (hl)
08BA 28 09                      jr z,L08C5
08BC 2B                         dec hl
08BD 10 FA                      djnz L08B9
08BF E1                         pop hl
08C0 23            L08C0:       inc hl
08C1 0D                         dec c
08C2 20 EF                      jr nz,L08B3
08C4 C9                         ret
08C5 7D            L08C5:       ld a,l
08C6 AB                         xor e
08C7 6F                         ld l,a
08C8 7E                         ld a,(hl)
08C9 E1                         pop hl
08CA 77                         ld (hl),a
08CB 18 F3                      jr L08C0
08CD FC 82 FC                   call m,LFC82
08D0 82                         add a,d
08D1 FC 82 2C                   call m,L2C82
08D4 93                         sub e
08D5 75                         ld (hl),l
08D6 93                         sub e
08D7 1B                         dec de
08D8 93                         sub e
08D9 D4 11 80                   call nc,L8011
08DC 93                         sub e
08DD 90                         sub b
08DE 93                         sub e
08DF B8                         cp b
08E0 11 E0 2B                   ld de,$2BE0
08E3 A0                         and b
08E4 93                         sub e
08E5 AA                         xor d
08E6 93                         sub e
08E7 87            L08E7:       add a,a
08E8 21 0B F7                   ld hl,$F70B
08EB ED 31                      add hl,a
08ED 5E                         ld e,(hl)
08EE 23                         inc hl
08EF 56                         ld d,(hl)
08F0 EB                         ex de,hl
08F1 7E                         ld a,(hl)
08F2 23                         inc hl
08F3 FE 3A                      cp $3A
08F5 37            L08F5:       scf
08F6 3F                         ccf
08F7 C0                         ret nz
08F8 5E                         ld e,(hl)
08F9 23                         inc hl
08FA BE                         cp (hl)
08FB 20 01                      jr nz,L08FE
08FD 23                         inc hl
08FE 7B            L08FE:       ld a,e
08FF F6 20                      or $20
0901 FE 69                      cp $69
0903 28 14                      jr z,L0919
0905 FE 67                      cp $67
0907 28 2A                      jr z,L0933
0909 FE 62                      cp $62
090B 28 37                      jr z,L0944
090D FE 6D                      cp $6D
090F 20 E4                      jr nz,L08F5
0911 CD CD 09                   call L09CD
0914 D0                         ret nc
0915 7B                         ld a,e
0916 C3 75 06                   jp L0675
0919 CD CD 09      L0919:       call L09CD
091C D0                         ret nc
091D 7B                         ld a,e
091E FE 0D                      cp $0D
0920 D0                         ret nc
0921 87                         add a,a
0922 21 CD 08                   ld hl,$08CD
0925 ED 31                      add hl,a
0927 4E                         ld c,(hl)
0928 23                         inc hl
0929 46                         ld b,(hl)
092A CB 78                      bit 7,b
092C CB B8                      res 7,b
092E C2 72 00                   jp nz,L0072
0931 C5                         push bc
0932 C9                         ret
0933 E5            L0933:       push hl
0934 11 31 DA                   ld de,$DA31
0937 7E            L0937:       ld a,(hl)
0938 ED A0                      ldi
093A 3C                         inc a
093B FE 21                      cp $21
093D 30 F8                      jr nc,L0937
093F 21 B1 0D                   ld hl,$0DB1
0942 18 08                      jr L094C
0944 3E FF         L0944:       ld a,$FF
0946 32 90 E0                   ld ($E090),a
0949 32 31 DA                   ld ($DA31),a
094C 11 B8 D5      L094C:       ld de,$D5B8
094F 1A                         ld a,(de)
0950 D6 04                      sub $04
0952 20 03                      jr nz,L0957
0954 32 B8 D5                   ld ($D5B8),a
0957 DD 2E 03      L0957:       ld xl,$03
095A 11 00 C0                   ld de,$C000
095D ED 4B 3D D7                ld bc,($D73D)
0961 CD 83 09                   call L0983
0964 AF                         xor a
0965 12            L0965:       ld (de),a
0966 13                         inc de
0967 0D                         dec c
0968 20 FB                      jr nz,L0965
096A DD 7D                      ld a,xl
096C CB 8F                      res 1,a
096E CB DF                      set 3,a
0970 12                         ld (de),a
0971 FD CB 30 C6                set 0,(iy+$30)
0975 CD 68 00                   call L0068
0978 54                         ld d,h
0979 04                         inc b
097A 0E 00                      ld c,$00
097C CD 68 00                   call L0068
097F D8                         ret c
0980 07                         rlca
0981 A7                         and a
0982 C9                         ret
0983 7E            L0983:       ld a,(hl)
0984 3C                         inc a
0985 FE 21                      cp $21
0987 D8                         ret c
0988 3D                         dec a
0989 E5                         push hl
098A 06 01                      ld b,$01
098C FE 7C                      cp $7C
098E 20 0E                      jr nz,L099E
0990 2B                         dec hl
0991 7E                         ld a,(hl)
0992 FE 22                      cp $22
0994 21 90 E0                   ld hl,$E090
0997 20 13                      jr nz,L09AC
0999 21 31 DA                   ld hl,$DA31
099C 18 0E                      jr L09AC
099E FE 60         L099E:       cp $60
09A0 21 DA 0D                   ld hl,$0DDA
09A3 28 07                      jr z,L09AC
09A5 FE 7F                      cp $7F
09A7 21 DD 0D                   ld hl,$0DDD
09AA 20 09                      jr nz,L09B5
09AC 7E            L09AC:       ld a,(hl)
09AD 23                         inc hl
09AE 3C                         inc a
09AF FE 21                      cp $21
09B1 38 16                      jr c,L09C9
09B3 3D                         dec a
09B4 04                         inc b
09B5 12            L09B5:       ld (de),a
09B6 13                         inc de
09B7 0D                         dec c
09B8 20 0D                      jr nz,L09C7
09BA DD 7D                      ld a,xl
09BC 12                         ld (de),a
09BD 13                         inc de
09BE DD 2E 02                   ld xl,$02
09C1 13                         inc de
09C2 13                         inc de
09C3 3A 3D D7                   ld a,($D73D)
09C6 4F                         ld c,a
09C7 10 E3         L09C7:       djnz L09AC
09C9 E1            L09C9:       pop hl
09CA 23                         inc hl
09CB 18 B6                      jr L0983
09CD 1E 00         L09CD:       ld e,$00
09CF 7E                         ld a,(hl)
09D0 18 06                      jr L09D8
09D2 7E            L09D2:       ld a,(hl)
09D3 CD 95 2E                   call L2E95
09D6 37                         scf
09D7 C8                         ret z
09D8 D6 30         L09D8:       sub $30
09DA 3F                         ccf
09DB D0                         ret nc
09DC 16 0A                      ld d,$0A
09DE BA                         cp d
09DF D0                         ret nc
09E0 23                         inc hl
09E1 ED 30                      mul d,e
09E3 ED 32                      add de,a
09E5 7A                         ld a,d
09E6 A7                         and a
09E7 28 E9                      jr z,L09D2
09E9 C9                         ret
09EA 0D                         dec c
09EB 3D                         dec a
09EC 30 0A                      jr nc,L09F8
09EE 4E                         ld c,(hl)
09EF 65                         ld h,l
09F0 78                         ld a,b
09F1 74                         ld (hl),h
09F2 5A                         ld e,d
09F3 58                         ld e,b
09F4 4F                         ld c,a
09F5 53                         ld d,e
09F6 0A                         ld a,(bc)
09F7 42                         ld b,d
09F8 5F            L09F8:       ld e,a
09F9 72                         ld (hl),d
09FA 6F                         ld l,a
09FB 77                         ld (hl),a
09FC 73                         ld (hl),e
09FD 65                         ld h,l
09FE 72                         ld (hl),d
09FF 3A 69 31                   ld a,($3169)
0A02 30 0A                      jr nc,L0A0E
0A04 43                         ld b,e
0A05 6F            L0A05:       ld l,a
0A06 6D                         ld l,l
0A07 6D                         ld l,l
0A08 61                         ld h,c
0A09 6E                         ld l,(hl)
0A0A 64                         ld h,h
0A0B 20 4C                      jr nz,L0A59
0A0D 5F                         ld e,a
0A0E 69            L0A0E:       ld l,c
0A0F 6E                         ld l,(hl)
0A10 65                         ld h,l
0A11 3A 69 32                   ld a,($3269)
0A14 0A                         ld a,(bc)
0A15 4E                         ld c,(hl)
0A16 5F                         ld e,a
0A17 65                         ld h,l
0A18 78                         ld a,b
0A19 74                         ld (hl),h
0A1A 42                         ld b,d
0A1B 41                         ld b,c
0A1C 53                         ld d,e
0A1D 49                         ld c,c
0A1E 43                         ld b,e
0A1F 3A 69 30                   ld a,($3069)
0A22 0A                         ld a,(bc)
0A23 43                         ld b,e
0A24 5F                         ld e,a
0A25 61                         ld h,c
0A26 6C                         ld l,h
0A27 63                         ld h,e
0A28 75                         ld (hl),l
0A29 6C                         ld l,h
0A2A 61                         ld h,c
0A2B 74                         ld (hl),h
0A2C 6F                         ld l,a
0A2D 72                         ld (hl),d
0A2E 3A 69 31                   ld a,($3169)
0A31 0A                         ld a,(bc)
0A32 47                         ld b,a
0A33 5F                         ld e,a
0A34 75                         ld (hl),l
0A35 69                         ld l,c
0A36 64                         ld h,h
0A37 65                         ld h,l
0A38 3A 67 4E                   ld a,($4E67)
0A3B 65                         ld h,l
0A3C 78                         ld a,b
0A3D 74                         ld (hl),h
0A3E 5A                         ld e,d
0A3F 58                         ld e,b
0A40 4F                         ld c,a
0A41 53                         ld d,e
0A42 0A                         ld a,(bc)
0A43 4D                         ld c,l
0A44 5F                         ld e,a
0A45 6F                         ld l,a
0A46 72                         ld (hl),d
0A47 65                         ld h,l
0A48 2E 2E                      ld l,$2E
0A4A 2E 3A                      ld l,$3A
0A4C 6D                         ld l,l
0A4D 31 0A 3D                   ld sp,$3D0A
0A50 31 0A 4E                   ld sp,$4E0A
0A53 65                         ld h,l
0A54 78                         ld a,b
0A55 74                         ld (hl),h
0A56 5A                         ld e,d
0A57 58                         ld e,b
0A58 4F                         ld c,a
0A59 53            L0A59:       ld d,e
0A5A 0A                         ld a,(bc)
0A5B 54                         ld d,h
0A5C 61                         ld h,c
0A5D 70                         ld (hl),b
0A5E 65                         ld h,l
0A5F 20 4C                      jr nz,L0AAD
0A61 5F                         ld e,a
0A62 6F                         ld l,a
0A63 61                         ld h,c
0A64 64                         ld h,h
0A65 65                         ld h,l
0A66 72                         ld (hl),d
0A67 3A 62 4C                   ld a,($4C62)
0A6A 4F                         ld c,a
0A6B 41                         ld b,c
0A6C 44                         ld b,h
0A6D 22 7F 63                   ld ($637F),hl
0A70 61                         ld h,c
0A71 73                         ld (hl),e
0A72 6C                         ld l,h
0A73 6F                         ld l,a
0A74 61                         ld h,c
0A75 64                         ld h,h
0A76 2E 62                      ld l,$62
0A78 61                         ld h,c
0A79 73                         ld (hl),e
0A7A 22 0A 54                   ld ($540A),hl
0A7D 61                         ld h,c
0A7E 70                         ld (hl),b
0A7F 65                         ld h,l
0A80 20 54                      jr nz,L0AD6
0A82 5F                         ld e,a
0A83 65                         ld h,l
0A84 73                         ld (hl),e
0A85 74                         ld (hl),h
0A86 65                         ld h,l
0A87 72                         ld (hl),d
0A88 3A 62 4C                   ld a,($4C62)
0A8B 4F                         ld c,a
0A8C 41                         ld b,c
0A8D 44                         ld b,h
0A8E 22 7F 74                   ld ($747F),hl
0A91 61                         ld h,c
0A92 70                         ld (hl),b
0A93 65                         ld h,l
0A94 74                         ld (hl),h
0A95 65                         ld h,l
0A96 73                         ld (hl),e
0A97 74                         ld (hl),h
0A98 2E 62                      ld l,$62
0A9A 61                         ld h,c
0A9B 73                         ld (hl),e
0A9C 22 0A 49                   ld ($490A),hl
0A9F 5F                         ld e,a
0AA0 6E                         ld l,(hl)
0AA1 74                         ld (hl),h
0AA2 65                         ld h,l
0AA3 72                         ld (hl),d
0AA4 66                         ld h,(hl)
0AA5 61                         ld h,c
0AA6 63                         ld h,e
0AA7 65                         ld h,l
0AA8 20 32                      jr nz,L0ADC
0AAA 3A 6D 35                   ld a,($356D)
0AAD 0A            L0AAD:       ld a,(bc)
0AAE 43                         ld b,e
0AAF 5F                         ld e,a
0AB0 50                         ld d,b
0AB1 2F                         cpl
0AB2 4D                         ld c,l
0AB3 3A 62 2E                   ld a,($2E62)
0AB6 43                         ld b,e
0AB7 50                         ld d,b
0AB8 4D                         ld c,l
0AB9 0A                         ld a,(bc)
0ABA 20 34                      jr nz,L0AF0
0ABC 5F                         ld e,a
0ABD 38 4B                      jr c,L0B0A
0ABF 20 42                      jr nz,L0B03
0AC1 41                         ld b,c
0AC2 53                         ld d,e
0AC3 49                         ld c,c
0AC4 43                         ld b,e
0AC5 3A 62 53                   ld a,($5362)
0AC8 50                         ld d,b
0AC9 45                         ld b,l
0ACA 43                         ld b,e
0ACB 54                         ld d,h
0ACC 52                         ld d,d
0ACD 55                         ld d,l
0ACE 4D                         ld c,l
0ACF 34                         inc (hl)
0AD0 38 3A                      jr c,L0B0C
0AD2 50                         ld d,b
0AD3 52                         ld d,d
0AD4 49                         ld c,c
0AD5 4E                         ld c,(hl)
0AD6 54            L0AD6:       ld d,h
0AD7 20 55                      jr nz,L0B2E
0AD9 53                         ld d,e
0ADA 52                         ld d,d
0ADB 30 0A                      jr nc,L0AE7
0ADD 31 5F 32                   ld sp,$325F
0AE0 38 4B                      jr c,L0B2D
0AE2 20 42                      jr nz,L0B26
0AE4 41                         ld b,c
0AE5 53                         ld d,e
0AE6 49                         ld c,c
0AE7 43            L0AE7:       ld b,e
0AE8 3A 62 53                   ld a,($5362)
0AEB 50                         ld d,b
0AEC 45                         ld b,l
0AED 43                         ld b,e
0AEE 54                         ld d,h
0AEF 52                         ld d,d
0AF0 55            L0AF0:       ld d,l
0AF1 4D                         ld c,l
0AF2 22 7F 31                   ld ($317F),hl
0AF5 32 38 2E                   ld ($2E38),a
0AF8 7A                         ld a,d
0AF9 38 30                      jr c,L0B2B
0AFB 22 0A 5A                   ld ($5A0A),hl
0AFE 5F                         ld e,a
0AFF 58                         ld e,b
0B00 38 30                      jr c,L0B32
0B02 20 42                      jr nz,L0B46
0B04 41                         ld b,c
0B05 53                         ld d,e
0B06 49                         ld c,c
0B07 43                         ld b,e
0B08 3A 62 53                   ld a,($5362)
0B0B 50                         ld d,b
0B0C 45            L0B0C:       ld b,l
0B0D 43                         ld b,e
0B0E 54                         ld d,h
0B0F 52                         ld d,d
0B10 55                         ld d,l
0B11 4D                         ld c,l
0B12 22 7F 38                   ld ($387F),hl
0B15 30 2E                      jr nc,L0B45
0B17 6F                         ld l,a
0B18 22 0A 5A                   ld ($5A0A),hl
0B1B 58                         ld e,b
0B1C 5F                         ld e,a
0B1D 38 31                      jr c,L0B50
0B1F 20 42                      jr nz,L0B63
0B21 41                         ld b,c
0B22 53                         ld d,e
0B23 49                         ld c,c
0B24 43                         ld b,e
0B25 3A 62 53                   ld a,($5362)
0B28 50                         ld d,b
0B29 45                         ld b,l
0B2A 43                         ld b,e
0B2B 54            L0B2B:       ld d,h
0B2C 52                         ld d,d
0B2D 55            L0B2D:       ld d,l
0B2E 4D            L0B2E:       ld c,l
0B2F 22 7F 38                   ld ($387F),hl
0B32 31 2E 70      L0B32:       ld sp,$702E
0B35 22 0A 54                   ld ($540A),hl
0B38 6F                         ld l,a
0B39 5F                         ld e,a
0B3A 6F                         ld l,a
0B3B 6C                         ld l,h
0B3C 73                         ld (hl),e
0B3D 3A 6D 36                   ld a,($366D)
0B40 0A                         ld a,(bc)
0B41 4D                         ld c,l
0B42 5F                         ld e,a
0B43 6F                         ld l,a
0B44 72                         ld (hl),d
0B45 65            L0B45:       ld h,l
0B46 2E 2E         L0B46:       ld l,$2E
0B48 2E 3A                      ld l,$3A
0B4A 6D                         ld l,l
0B4B 30 0A                      jr nc,L0B57
0B4D 3D                         dec a
0B4E 32 0A 4F                   ld ($4F0A),a
0B51 70                         ld (hl),b
0B52 74                         ld (hl),h
0B53 69                         ld l,c
0B54 6F                         ld l,a
0B55 6E                         ld l,(hl)
0B56 73                         ld (hl),e
0B57 0A            L0B57:       ld a,(bc)
0B58 4E                         ld c,(hl)
0B59 5F                         ld e,a
0B5A 65                         ld h,l
0B5B 78                         ld a,b
0B5C 74                         ld (hl),h
0B5D 42                         ld b,d
0B5E 41                         ld b,c
0B5F 53                         ld d,e
0B60 49                         ld c,c
0B61 43                         ld b,e
0B62 3A 69 33                   ld a,($3369)
0B65 0A                         ld a,(bc)
0B66 43                         ld b,e
0B67 6F                         ld l,a
0B68 6D                         ld l,l
0B69 6D                         ld l,l
0B6A 61                         ld h,c
0B6B 6E                         ld l,(hl)
0B6C 64                         ld h,h
0B6D 20 4C                      jr nz,L0BBB
0B6F 5F                         ld e,a
0B70 69                         ld l,c
0B71 6E                         ld l,(hl)
0B72 65                         ld h,l
0B73 3A 69 34                   ld a,($3469)
0B76 0A                         ld a,(bc)
0B77 33                         inc sp
0B78 32 2F 5F                   ld ($5F2F),a
0B7B 36 34                      ld (hl),$34
0B7D 2F                         cpl
0B7E 38 35                      jr c,L0BB5
0B80 3A 69 35                   ld a,($3569)
0B83 0A                         ld a,(bc)
0B84 53                         ld d,e
0B85 5F                         ld e,a
0B86 63                         ld h,e
0B87 72                         ld (hl),d
0B88 65                         ld h,l
0B89 65                         ld h,l
0B8A 6E                         ld l,(hl)
0B8B 3A 69 36                   ld a,($3669)
0B8E 0A                         ld a,(bc)
0B8F 52                         ld d,d
0B90 5F                         ld e,a
0B91 65                         ld h,l
0B92 6E                         ld l,(hl)
0B93 75                         ld (hl),l
0B94 6D                         ld l,l
0B95 62                         ld h,d
0B96 65                         ld h,l
0B97 72                         ld (hl),d
0B98 3A 69 37                   ld a,($3769)
0B9B 0A                         ld a,(bc)
0B9C 43                         ld b,e
0B9D 5F                         ld e,a
0B9E 6C                         ld l,h
0B9F 65                         ld h,l
0BA0 61                         ld h,c
0BA1 72                         ld (hl),d
0BA2 3A 69 38                   ld a,($3869)
0BA5 0A                         ld a,(bc)
0BA6 54                         ld d,h
0BA7 6F                         ld l,a
0BA8 6B                         ld l,e
0BA9 5F                         ld e,a
0BAA 65                         ld h,l
0BAB 6E                         ld l,(hl)
0BAC 20 6B                      jr nz,L0C19
0BAE 65                         ld h,l
0BAF 79                         ld a,c
0BB0 73                         ld (hl),e
0BB1 3A 69 31                   ld a,($3169)
0BB4 31 0A 53                   ld sp,$530A
0BB7 74                         ld (hl),h
0BB8 72                         ld (hl),d
0BB9 69                         ld l,c
0BBA 6E                         ld l,(hl)
0BBB 67            L0BBB:       ld h,a
0BBC 20 74                      jr nz,L0C32
0BBE 6F                         ld l,a
0BBF 5F                         ld e,a
0BC0 6B                         ld l,e
0BC1 65                         ld h,l
0BC2 6E                         ld l,(hl)
0BC3 73                         ld (hl),e
0BC4 3A 69 31                   ld a,($3169)
0BC7 32 0A 47                   ld ($470A),a
0BCA 5F                         ld e,a
0BCB 75                         ld (hl),l
0BCC 69                         ld l,c
0BCD 64                         ld h,h
0BCE 65                         ld h,l
0BCF 3A 67 4E                   ld a,($4E67)
0BD2 65                         ld h,l
0BD3 78                         ld a,b
0BD4 74                         ld (hl),h
0BD5 42                         ld b,d
0BD6 41                         ld b,c
0BD7 53                         ld d,e
0BD8 49                         ld c,c
0BD9 43                         ld b,e
0BDA 0A                         ld a,(bc)
0BDB 45                         ld b,l
0BDC 78                         ld a,b
0BDD 5F                         ld e,a
0BDE 69                         ld l,c
0BDF 74                         ld (hl),h
0BE0 3A 69 39                   ld a,($3969)
0BE3 0A                         ld a,(bc)
0BE4 3D                         dec a
0BE5 33                         inc sp
0BE6 0A                         ld a,(bc)
0BE7 4F                         ld c,a
0BE8 70                         ld (hl),b
0BE9 74                         ld (hl),h
0BEA 69                         ld l,c
0BEB 6F                         ld l,a
0BEC 6E                         ld l,(hl)
0BED 73                         ld (hl),e
0BEE 0A                         ld a,(bc)
0BEF 43                         ld b,e
0BF0 5F                         ld e,a
0BF1 61                         ld h,c
0BF2 6C                         ld l,h
0BF3 63                         ld h,e
0BF4 75                         ld (hl),l
0BF5 6C                         ld l,h
0BF6 61                         ld h,c
0BF7 74                         ld (hl),h
0BF8 6F                         ld l,a
0BF9 72                         ld (hl),d
0BFA 3A 69 33                   ld a,($3369)
0BFD 0A                         ld a,(bc)
0BFE 33                         inc sp
0BFF 32 2F 5F                   ld ($5F2F),a
0C02 36 34                      ld (hl),$34
0C04 2F                         cpl
0C05 38 35                      jr c,L0C3C
0C07 3A 69 35                   ld a,($3569)
0C0A 0A                         ld a,(bc)
0C0B 47                         ld b,a
0C0C 5F                         ld e,a
0C0D 75                         ld (hl),l
0C0E 69                         ld l,c
0C0F 64                         ld h,h
0C10 65                         ld h,l
0C11 3A 67 43                   ld a,($4367)
0C14 61                         ld h,c
0C15 6C                         ld l,h
0C16 63                         ld h,e
0C17 75                         ld (hl),l
0C18 6C                         ld l,h
0C19 61            L0C19:       ld h,c
0C1A 74                         ld (hl),h
0C1B 6F                         ld l,a
0C1C 72                         ld (hl),d
0C1D 0A                         ld a,(bc)
0C1E 45                         ld b,l
0C1F 78                         ld a,b
0C20 5F                         ld e,a
0C21 69                         ld l,c
0C22 74                         ld (hl),h
0C23 3A 69 39                   ld a,($3969)
0C26 0A                         ld a,(bc)
0C27 3D                         dec a
0C28 34                         inc (hl)
0C29 0A                         ld a,(bc)
0C2A 4F                         ld c,a
0C2B 70                         ld (hl),b
0C2C 74                         ld (hl),h
0C2D 69                         ld l,c
0C2E 6F                         ld l,a
0C2F 6E                         ld l,(hl)
0C30 73                         ld (hl),e
0C31 0A                         ld a,(bc)
0C32 43            L0C32:       ld b,e
0C33 6F                         ld l,a
0C34 6D                         ld l,l
0C35 6D                         ld l,l
0C36 61                         ld h,c
0C37 6E                         ld l,(hl)
0C38 64                         ld h,h
0C39 20 4C                      jr nz,L0C87
0C3B 5F                         ld e,a
0C3C 69            L0C3C:       ld l,c
0C3D 6E                         ld l,(hl)
0C3E 65                         ld h,l
0C3F 3A 69 33                   ld a,($3369)
0C42 0A                         ld a,(bc)
0C43 4E                         ld c,(hl)
0C44 5F                         ld e,a
0C45 65                         ld h,l
0C46 78                         ld a,b
0C47 74                         ld (hl),h
0C48 42                         ld b,d
0C49 41                         ld b,c
0C4A 53                         ld d,e
0C4B 49                         ld c,c
0C4C 43                         ld b,e
0C4D 3A 69 34                   ld a,($3469)
0C50 0A                         ld a,(bc)
0C51 33                         inc sp
0C52 32 2F 5F                   ld ($5F2F),a
0C55 36 34                      ld (hl),$34
0C57 2F                         cpl
0C58 38 35                      jr c,L0C8F
0C5A 3A 69 35                   ld a,($3569)
0C5D 0A                         ld a,(bc)
0C5E 47                         ld b,a
0C5F 5F                         ld e,a
0C60 75                         ld (hl),l
0C61 69                         ld l,c
0C62 64                         ld h,h
0C63 65                         ld h,l
0C64 3A 67 43                   ld a,($4367)
0C67 6F                         ld l,a
0C68 6D                         ld l,l
0C69 6D                         ld l,l
0C6A 61                         ld h,c
0C6B 6E                         ld l,(hl)
0C6C 64                         ld h,h
0C6D 20 4C                      jr nz,L0CBB
0C6F 69                         ld l,c
0C70 6E                         ld l,(hl)
0C71 65                         ld h,l
0C72 0A                         ld a,(bc)
0C73 45                         ld b,l
0C74 78                         ld a,b
0C75 5F                         ld e,a
0C76 69                         ld l,c
0C77 74                         ld (hl),h
0C78 3A 69 39                   ld a,($3969)
0C7B 0A                         ld a,(bc)
0C7C 3D                         dec a
0C7D 35                         dec (hl)
0C7E 0A                         ld a,(bc)
0C7F 4E                         ld c,(hl)
0C80 65                         ld h,l
0C81 78                         ld a,b
0C82 74                         ld (hl),h
0C83 5A                         ld e,d
0C84 58                         ld e,b
0C85 4F                         ld c,a
0C86 53                         ld d,e
0C87 0A            L0C87:       ld a,(bc)
0C88 20 34                      jr nz,L0CBE
0C8A 5F                         ld e,a
0C8B 38 4B                      jr c,L0CD8
0C8D 20 43                      jr nz,L0CD2
0C8F 61            L0C8F:       ld h,c
0C90 72                         ld (hl),d
0C91 74                         ld (hl),h
0C92 20 6F                      jr nz,L0D03
0C94 6E                         ld l,(hl)
0C95 6C                         ld l,h
0C96 79                         ld a,c
0C97 3A 62 53                   ld a,($5362)
0C9A 50                         ld d,b
0C9B 45                         ld b,l
0C9C 43                         ld b,e
0C9D 54                         ld d,h
0C9E 52                         ld d,d
0C9F 55                         ld d,l
0CA0 4D                         ld c,l
0CA1 22 7F 34                   ld ($347F),hl
0CA4 38 63                      jr c,L0D09
0CA6 2E 7A                      ld l,$7A
0CA8 38 30                      jr c,L0CDA
0CAA 22 0A 20                   ld ($200A),hl
0CAD 34                         inc (hl)
0CAE 38 4B                      jr c,L0CFB
0CB0 20 43                      jr nz,L0CF5
0CB2 61                         ld h,c
0CB3 72                         ld (hl),d
0CB4 74                         ld (hl),h
0CB5 2B                         dec hl
0CB6 6A                         ld l,d
0CB7 5F                         ld e,a
0CB8 6F                         ld l,a
0CB9 79                         ld a,c
0CBA 73                         ld (hl),e
0CBB 3A 62 53      L0CBB:       ld a,($5362)
0CBE 50            L0CBE:       ld d,b
0CBF 45                         ld b,l
0CC0 43                         ld b,e
0CC1 54                         ld d,h
0CC2 52                         ld d,d
0CC3 55                         ld d,l
0CC4 4D                         ld c,l
0CC5 22 7F 34                   ld ($347F),hl
0CC8 38 63                      jr c,L0D2D
0CCA 6A                         ld l,d
0CCB 2E 7A                      ld l,$7A
0CCD 38 30                      jr c,L0CFF
0CCF 22 0A 31                   ld ($310A),hl
0CD2 5F            L0CD2:       ld e,a
0CD3 32 38 4B                   ld ($4B38),a
0CD6 20 43                      jr nz,L0D1B
0CD8 61            L0CD8:       ld h,c
0CD9 72                         ld (hl),d
0CDA 74            L0CDA:       ld (hl),h
0CDB 20 6F                      jr nz,L0D4C
0CDD 6E                         ld l,(hl)
0CDE 6C                         ld l,h
0CDF 79                         ld a,c
0CE0 3A 62 53                   ld a,($5362)
0CE3 50                         ld d,b
0CE4 45                         ld b,l
0CE5 43                         ld b,e
0CE6 54                         ld d,h
0CE7 52                         ld d,d
0CE8 55                         ld d,l
0CE9 4D                         ld c,l
0CEA 22 7F 31                   ld ($317F),hl
0CED 32 38 63                   ld ($6338),a
0CF0 2E 7A                      ld l,$7A
0CF2 38 30                      jr c,L0D24
0CF4 22 0A 31                   ld ($310A),hl
0CF7 32 38 4B                   ld ($4B38),a
0CFA 20 43                      jr nz,L0D3F
0CFC 61                         ld h,c
0CFD 72                         ld (hl),d
0CFE 74                         ld (hl),h
0CFF 2B            L0CFF:       dec hl
0D00 6A                         ld l,d
0D01 6F                         ld l,a
0D02 5F                         ld e,a
0D03 79            L0D03:       ld a,c
0D04 73                         ld (hl),e
0D05 3A 62 53                   ld a,($5362)
0D08 50                         ld d,b
0D09 45            L0D09:       ld b,l
0D0A 43                         ld b,e
0D0B 54                         ld d,h
0D0C 52                         ld d,d
0D0D 55                         ld d,l
0D0E 4D                         ld c,l
0D0F 22 7F 31                   ld ($317F),hl
0D12 32 38 63                   ld ($6338),a
0D15 6A                         ld l,d
0D16 2E 7A                      ld l,$7A
0D18 38 30                      jr c,L0D4A
0D1A 22 0A 42                   ld ($420A),hl
0D1D 5F                         ld e,a
0D1E 61                         ld h,c
0D1F 63                         ld h,e
0D20 6B                         ld l,e
0D21 2E 2E                      ld l,$2E
0D23 2E 3A                      ld l,$3A
0D25 6D                         ld l,l
0D26 31 0A 3D                   ld sp,$3D0A
0D29 36 0A                      ld (hl),$0A
0D2B 54                         ld d,h
0D2C 6F                         ld l,a
0D2D 6F            L0D2D:       ld l,a
0D2E 6C                         ld l,h
0D2F 73                         ld (hl),e
0D30 0A                         ld a,(bc)
0D31 53                         ld d,e
0D32 65                         ld h,l
0D33 74                         ld (hl),h
0D34 20 43                      jr nz,L0D79
0D36 5F                         ld e,a
0D37 6C                         ld l,h
0D38 6F                         ld l,a
0D39 63                         ld h,e
0D3A 6B                         ld l,e
0D3B 3A 62 4C                   ld a,($4C62)
0D3E 4F                         ld c,a
0D3F 41            L0D3F:       ld b,c
0D40 44                         ld b,h
0D41 22 7F 73                   ld ($737F),hl
0D44 65                         ld h,l
0D45 74                         ld (hl),h
0D46 72                         ld (hl),d
0D47 74                         ld (hl),h
0D48 63                         ld h,e
0D49 2E 62                      ld l,$62
0D4B 61                         ld h,c
0D4C 73            L0D4C:       ld (hl),e
0D4D 22 0A 57                   ld ($570A),hl
0D50 5F                         ld e,a
0D51 49                         ld c,c
0D52 46                         ld b,(hl)
0D53 49                         ld c,c
0D54 20 73                      jr nz,L0DC9
0D56 65                         ld h,l
0D57 74                         ld (hl),h
0D58 75                         ld (hl),l
0D59 70                         ld (hl),b
0D5A 3A 62 4C                   ld a,($4C62)
0D5D 4F                         ld c,a
0D5E 41                         ld b,c
0D5F 44                         ld b,h
0D60 22 63 3A                   ld ($3A63),hl
0D63 2F                         cpl
0D64 61                         ld h,c
0D65 70                         ld (hl),b
0D66 70                         ld (hl),b
0D67 73                         ld (hl),e
0D68 2F                         cpl
0D69 77                         ld (hl),a
0D6A 69                         ld l,c
0D6B 66                         ld h,(hl)
0D6C 69                         ld l,c
0D6D 2F                         cpl
0D6E 73                         ld (hl),e
0D6F 65                         ld h,l
0D70 74                         ld (hl),h
0D71 75                         ld (hl),l
0D72 70                         ld (hl),b
0D73 2F                         cpl
0D74 77                         ld (hl),a
0D75 69                         ld l,c
0D76 66                         ld h,(hl)
0D77 69                         ld l,c
0D78 32 2E 62                   ld ($622E),a
0D7B 61                         ld h,c
0D7C 73                         ld (hl),e
0D7D 22 3A 52                   ld ($523A),hl
0D80 55                         ld d,l
0D81 4E                         ld c,(hl)
0D82 0A                         ld a,(bc)
0D83 55                         ld d,l
0D84 5F                         ld e,a
0D85 70                         ld (hl),b
0D86 64                         ld h,h
0D87 61                         ld h,c
0D88 74                         ld (hl),h
0D89 65                         ld h,l
0D8A 72                         ld (hl),d
0D8B 3A 62 4C                   ld a,($4C62)
0D8E 4F                         ld c,a
0D8F 41                         ld b,c
0D90 44                         ld b,h
0D91 22 7F 75                   ld ($757F),hl
0D94 70                         ld (hl),b
0D95 64                         ld h,h
0D96 61                         ld h,c
0D97 74                         ld (hl),h
0D98 65                         ld h,l
0D99 72                         ld (hl),d
0D9A 2E 62                      ld l,$62
0D9C 61                         ld h,c
0D9D 73                         ld (hl),e
0D9E 22 0A 42                   ld ($420A),hl
0DA1 5F                         ld e,a
0DA2 61                         ld h,c
0DA3 63                         ld h,e
0DA4 6B                         ld l,e
0DA5 2E 2E                      ld l,$2E
0DA7 2E 3A                      ld l,$3A
0DA9 6D                         ld l,l
0DAA 31 0A FF                   ld sp,$FF0A
0DAD 0D                         dec c
0DAE 20 0D                      jr nz,L0DBD
0DB0 FF                         rst $38
0DB1 6C                         ld l,h
0DB2 61                         ld h,c
0DB3 79                         ld a,c
0DB4 65                         ld h,l
0DB5 72                         ld (hl),d
0DB6 32 2C 30                   ld ($302C),a
0DB9 3A 6C 61                   ld a,($616C)
0DBC 79                         ld a,c
0DBD 65            L0DBD:       ld h,l
0DBE 72                         ld (hl),d
0DBF 30 3A                      jr nc,L0DFB
0DC1 73                         ld (hl),e
0DC2 70                         ld (hl),b
0DC3 72                         ld (hl),d
0DC4 69                         ld l,c
0DC5 74                         ld (hl),h
0DC6 65                         ld h,l
0DC7 20 70                      jr nz,L0E39
0DC9 72            L0DC9:       ld (hl),d
0DCA 69                         ld l,c
0DCB 6E                         ld l,(hl)
0DCC 74                         ld (hl),h
0DCD 30 3A                      jr nc,L0E09
0DCF 2E 67                      ld l,$67
0DD1 75                         ld (hl),l
0DD2 69                         ld l,c
0DD3 64                         ld h,h
0DD4 65                         ld h,l
0DD5 20 22                      jr nz,L0DF9
0DD7 7C                         ld a,h
0DD8 22 0D 65                   ld ($650D),hl
0DDB 6E                         ld l,(hl)
0DDC FF                         rst $38
0DDD 63                         ld h,e
0DDE 3A 2F 6E                   ld a,($6E2F)
0DE1 65                         ld h,l
0DE2 78                         ld a,b
0DE3 74                         ld (hl),h
0DE4 7A                         ld a,d
0DE5 78                         ld a,b
0DE6 6F                         ld l,a
0DE7 73                         ld (hl),e
0DE8 2F                         cpl
0DE9 FF                         rst $38
0DEA 7F                         ld a,a
0DEB 65                         ld h,l
0DEC 6E                         ld l,(hl)
0DED 4D                         ld c,l
0DEE 65                         ld h,l
0DEF 6E                         ld l,(hl)
0DF0 75                         ld (hl),l
0DF1 73                         ld (hl),e
0DF2 2E 63                      ld l,$63
0DF4 66                         ld h,(hl)
0DF5 67                         ld h,a
0DF6 00                         nop
;
; Bit Pattern Lookup Table (16 bytes)
; Used for graphics operations - contains progressive bit masks.
; Copied to RAM at $D750 during initialization by routine at $0360.
; Pattern: ascending bits (01,03,07,0F...) followed by descending bits (FF,FE,FC...)
;
0DF7 01                         .defb $01                  ; 00000001
0DF8 03                         .defb $03                  ; 00000011
0DF9 07                         .defb $07                  ; 00000111
0DFA 0F                         .defb $0F                  ; 00001111
0DFB 1F            L0DFB:       .defb $1F                  ; 00011111
0DFC 3F                         .defb $3F                  ; 00111111
0DFD 7F                         .defb $7F                  ; 01111111
0DFE FF                         .defb $FF                  ; 11111111
0DFF FE                         .defb $FE                  ; 11111110
0E01 F8                         .defb $F8                  ; 11111000
0E02 F0                         .defb $F0                  ; 11110000
0E03 E0                         .defb $E0                  ; 11100000
0E04 C0                         .defb $C0                  ; 11000000
0E05 80                         .defb $80                  ; 10000000
0E06 00                         .defb $00                  ; 00000000
0E07 00                         .defb $00                  ; 00000000
0E08 00                         nop
0E09 00            L0E09:       nop
0E0A 00                         nop
0E0B 00                         nop
0E0C FF                         rst $38
0E0D FF                         rst $38
0E0E FF                         rst $38
0E0F 00                         nop
0E10 FF                         rst $38
0E11 00                         nop
0E12 FF                         rst $38
0E13 00                         nop
0E14 FF                         rst $38
0E15 00                         nop
0E16 FF                         rst $38
0E17 38 38                      jr c,L0E51
0E19 38 38                      jr c,L0E53
0E1B 38 38                      jr c,L0E55
0E1D 38 38                      jr c,L0E57
0E1F FF                         rst $38
0E20 FF                         rst $38
0E21 FF                         rst $38
0E22 00                         nop
0E23 00                         nop
0E24 00                         nop
0E25 00                         nop
0E26 00                         nop
0E27 FC 84 84                   call m,L8484
0E2A 84                         add a,h
0E2B 84                         add a,h
0E2C 84                         add a,h
0E2D 84                         add a,h
0E2E FC CD 55                   call m,L55CD
0E31 0E E5                      ld c,$E5
0E33 01 90 05                   ld bc,$0590
0E36 11 DB D6                   ld de,$D6DB
0E39 1A            L0E39:       ld a,(de)
0E3A 13                         inc de
0E3B 32 8F 5C                   ld (ATTR_T),a
0E3E 79                         ld a,c
0E3F EE 01                      xor $01
0E41 4F                         ld c,a
0E42 D7                         rst $10
0E43 10 F4                      djnz L0E39
0E45 1A                         ld a,(de)
0E46 32 8F 5C                   ld (ATTR_T),a
0E49 3E 20                      ld a,$20
0E4B D7                         rst $10
0E4C D1                         pop de
0E4D C3 58 0E                   jp L0E58
0E50 11 F7 0D      L0E50:       ld de,StripePtr
0E53 18 03         L0E53:       jr L0E58
0E55 11 50 D7      L0E55:       ld de,$D750
0E58 2A 7B 5C      L0E58:       ld hl,(UDG)
0E5B ED 53 7B 5C                ld (UDG),de
0E5F C9                         ret
0E60 E1                         pop hl
0E61 E1                         pop hl
0E62 FB                         ei
0E63 76                         halt
0E64 FD CB 01 AE                res 5,(iy+$01)
0E68 CF                         rst $08
0E69 3E 02                      ld a,$02
0E6B EF                         rst $28
0E6C 01 16 CD                   ld bc,$CD16
0E6F 82                         add a,d
0E70 0F                         rrca
0E71 3A B8 D5                   ld a,($D5B8)
0E74 FE FE                      cp $FE
0E76 F5                         push af
0E77 FE 04                      cp $04
0E79 38 05                      jr c,L0E80
0E7B 3A 3A 5C                   ld a,($5C3A)
0E7E FE FF                      cp $FF
0E80 DC E0 11      L0E80:       call c,L11E0
0E83 CD 03 10                   call SvDispState
0E86 F1                         pop af
0E87 CA 1F 2C                   jp z,L2C1F
0E8A D2 B8 11                   jp nc,L11B8
0E8D CD 68 00                   call L0068
0E90 E5                         push hl
0E91 02                         ld (bc),a
0E92 CD DD 0E                   call L0EDD
0E95 AF                         xor a
0E96 DF                         rst $18
0E97 B9                         cp c
0E98 14                         inc d
0E99 C9                         ret
0E9A 3A 3D D7                   ld a,($D73D)
0E9D D6 20                      sub $20
0E9F 28 02                      jr z,L0EA3
0EA1 3E 09                      ld a,$09
0EA3 F5            L0EA3:       push af
0EA4 DF                         rst $18
0EA5 A9                         xor c
0EA6 14                         inc d
0EA7 F1                         pop af
0EA8 C8                         ret z
0EA9 DD E5                      push ix
0EAB DD 21 00 FB                ld ix,$FB00
0EAF 21 C6 0E                   ld hl,$0EC6
0EB2 CD 27 27                   call L2727
0EB5 3A 3D D7                   ld a,($D73D)
0EB8 FE 40                      cp $40
0EBA 3E 08                      ld a,$08
0EBC 28 02                      jr z,L0EC0
0EBE 3E 06                      ld a,$06
0EC0 CD 5B 27      L0EC0:       call L275B
0EC3 DD E1                      pop ix
0EC5 C9                         ret
0EC6 1A                         ld a,(de)
0EC7 17                         rla
0EC8 9E                         sbc a,(hl)
0EC9 3A 7F 5C      L0EC9:       ld a,(GMODE)
0ECC E6 0F                      and $0F
0ECE 28 05                      jr z,L0ED5
0ED0 FD CB 02 AE                res 5,(iy+$02)
0ED4 C9                         ret
0ED5 FD 36 31 02   L0ED5:       ld (iy+$31),$02
0ED9 EF                         rst $28
0EDA 6E                         ld l,(hl)
0EDB 0D                         dec c
0EDC C9                         ret
0EDD 3A B8 D5      L0EDD:       ld a,($D5B8)
0EE0 FE 04                      cp $04
0EE2 C8                         ret z
0EE3 FE 08                      cp $08
0EE5 C4 73 10                   call nz,L1073
0EE8 3A 7B 5B      L0EE8:       ld a,($5B7B)
0EEB F5                         push af
0EEC 3A 7F 5C                   ld a,(GMODE)
0EEF F5                         push af
0EF0 76                         halt
0EF1 AF                         xor a
0EF2 D3 FF                      out ($FF),a
0EF4 21 B9 D5                   ld hl,$D5B9
0EF7 7E                         ld a,(hl)
0EF8 E5                         push hl
0EF9 DF                         rst $18
0EFA A9                         xor c
0EFB 14                         inc d
0EFC E1                         pop hl
0EFD F1                         pop af
0EFE 77                         ld (hl),a
0EFF 23                         inc hl
0F00 7E                         ld a,(hl)
0F01 01 3B 12                   ld bc,$123B
0F04 32 7B 5B                   ld ($5B7B),a
0F07 ED 79                      out (c),a
0F09 F1                         pop af
0F0A 77                         ld (hl),a
0F0B 23                         inc hl
0F0C CD B1 3D                   call L3DB1
0F0F 5E                         ld e,(hl)
0F10 77                         ld (hl),a
0F11 ED 59                      out (c),e
0F13 23                         inc hl
0F14 ED 4B 36 5C                ld bc,($5C36)
0F18 5E                         ld e,(hl)
0F19 71                         ld (hl),c
0F1A 23                         inc hl
0F1B 56                         ld d,(hl)
0F1C 70                         ld (hl),b
0F1D 23                         inc hl
0F1E ED 53 36 5C                ld ($5C36),de
0F22 CD 3B 0F                   call L0F3B
0F25 3A B8 D5                   ld a,($D5B8)
0F28 FE 08                      cp $08
0F2A C8                         ret z
0F2B CD 08 27                   call L2708
0F2E 26 F7                      ld h,$F7
0F30 CD 5F 0F                   call L0F5F
0F33 26 FB                      ld h,$FB
0F35 CD 5F 0F                   call L0F5F
0F38 C3 97 27                   jp L2797
0F3B A7            L0F3B:       and a
;
; Initialize Sprite Patterns
; Writes sprite pattern data from HL to sprite pattern memory.
; Uses nextreg $1C (Clip Window) and double nested loop.
; Entry: HL = pointer to sprite pattern data (or after EX DE,HL and CF)
; Exit: Sprite patterns initialized
;
0F3C 11 18 04      InitSprPat:  ld de,$0418                ; D = $04 (outer loop: 4 iterations), E = $18 (pattern index)
0F3F ED 91 1C 0F                nextreg $1C,$0F            ; Set nextreg $1C (Clip Window Tilemap) = $0F
0F43 D5            `InitSpr1:   push de                    ; Save DE (outer loop counter and pattern index)
0F44 06 04                      ld b,$04                   ; B = $04 (inner loop: 4 iterations)
0F46 C5            `InitSpr2:   push bc                    ; Save BC (inner loop counter)
0F47 CD 70 0F                   call WSprPat               ; Call sprite pattern write routine
0F4A 1D                         dec e                      ; E = E - 1 (decrement pattern index)
0F4B C1                         pop bc                     ; Restore BC (inner loop counter)
0F4C 10 F8                      djnz `InitSpr2             ; Loop 4 times (inner loop)
0F4E D1                         pop de                     ; Restore DE (outer loop counter)
0F4F 1C                         inc e                      ; E = E + 1 (adjust pattern index)
0F50 15                         dec d                      ; D = D - 1 (decrement outer loop counter)
0F51 20 F0                      jr nz,`InitSpr1            ; Loop 4 times (outer loop)
0F53 C9                         ret                        ; Return
;
;
;
0F54 54            L0F54:       ld d,h
0F55 7D                         ld a,l
0F56 0E 30                      ld c,$30
0F58 A9                         xor c
0F59 5F                         ld e,a
0F5A 06 00                      ld b,$00
0F5C ED B0                      ldir
0F5E C9                         ret
0F5F 2E 00         L0F5F:       ld l,$00
0F61 54                         ld d,h
0F62 1E 30                      ld e,$30
0F64 43                         ld b,e
0F65 4E            L0F65:       ld c,(hl)
0F66 1A                         ld a,(de)
0F67 77                         ld (hl),a
0F68 79                         ld a,c
0F69 12                         ld (de),a
0F6A 23                         inc hl
0F6B 13                         inc de
0F6C 10 F7                      djnz L0F65
0F6E C9                         ret
0F6F A7                         and a
;
; Write Sprite Pattern Byte
; Writes a single byte to sprite pattern memory via nextreg interface.
; Uses carry flag to determine whether to use data from HL or read from nextreg.
; Entry: HL = pointer to source data, E = sprite pattern index, Carry flag
; Exit: HL incremented, E incremented, D = value read from nextreg
;
0F70 7E            WSprPat:     ld a,(hl)                  ; A = byte from source data
0F71 01 3B 24                   ld bc,$243B                ; BC = $243B (Nextreg select port)
0F74 ED 59                      out (c),e                  ; Select sprite pattern register E
0F76 04                         inc b                      ; BC = $253B (Nextreg data port)
0F77 ED 50                      in d,(c)                   ; D = read current value from nextreg
0F79 30 01                      jr nc,`WSpr1               ; If NC (carry clear), jump to write A
0F7B 7A                         ld a,d                     ; If C (carry set), A = D (use read value)
0F7C ED 79         `WSpr1:      out (c),a                  ; Write A to nextreg data port
0F7E 72                         ld (hl),d                  ; Store D back to (HL)
0F7F 23                         inc hl                     ; HL = HL + 1
0F80 1C                         inc e                      ; E = E + 1 (next pattern index)
0F81 C9                         ret                        ; Return
;
; Initialize System Flags
; Sets up system flags during initialization.
; Clears channel flags and sets FLAGS bits for keyboard/printer mode.
; Entry: None
; Exit: System flags configured
;
0F82 AF            InSysFlags:  xor a                      ; A = $00
0F83 32 41 5C                   ld ($5C41),a               ; CDFLAG = $00 (clear channel/display flags)
0F86 FD 36 D0 02                ld (iy-$30),$02            ; Set ($5C0A) = $02 (STRMS+26 offset)
0F8A 21 3B 5C                   ld hl,$5C3B                ; HL = $5C3B (FLAGS system variable)
0F8D 7E                         ld a,(hl)                  ; A = current FLAGS value
0F8E F6 0C                      or $0C                     ; Set bits 2-3 (keyboard mode, K channel)
0F90 77                         ld (hl),a                  ; Store back to FLAGS
0F91 C9                         ret                        ; Return
;
; Read Palette Data to Memory
; Reads all 32 palette entries (64 bytes) from hardware palette to memory at HL.
; Each palette entry is 2 bytes (9-bit color: RRRGGGBBB).
; Entry: HL = destination address for palette data
; Exit: HL = HL + 64, palette data saved
;
0F92 AF            L0F92:       xor a                      ; A = $00
0F93 16 20                      ld d,$20                   ; D = $20 (32 palette entries)
0F95 01 3B 24                   ld bc,$243B                ; BC = $243B (Nextreg select port)
0F98 ED 92 43                   nextreg $43,a              ; Nextreg $43 = $00 (palette control: standard palette)
0F9B 1E 00                      ld e,$00                   ; E = $00 (palette index)
0F9D 7B            L0F9D:       ld a,e                     ; A = E (current palette index)
0F9E ED 92 40                   nextreg $40,a              ; Nextreg $40 = palette index
0FA1 3E 41                      ld a,$41                   ; A = $41 (palette value register)
0FA3 ED 79                      out (c),a                  ; Select nextreg $41
0FA5 04                         inc b                      ; BC = $253B (Nextreg data port)
0FA6 ED 78                      in a,(c)                   ; A = read first byte of palette entry
0FA8 05                         dec b                      ; BC = $243B (Nextreg select port)
0FA9 77                         ld (hl),a                  ; Save first byte to (HL)
0FAA 23                         inc hl                     ; HL = HL + 1
0FAB 3E 44                      ld a,$44                   ; A = $44 (enhanced palette register)
0FAD ED 79                      out (c),a                  ; Select nextreg $44
0FAF 04                         inc b                      ; BC = $253B (Nextreg data port)
0FB0 ED 78                      in a,(c)                   ; A = read second byte of palette entry
0FB2 05                         dec b                      ; BC = $243B (Nextreg select port)
0FB3 77                         ld (hl),a                  ; Save second byte to (HL)
0FB4 23                         inc hl                     ; HL = HL + 1
0FB5 1C                         inc e                      ; E = E + 1 (next palette index)
0FB6 15                         dec d                      ; D = D - 1 (decrement counter)
0FB7 20 E4                      jr nz,L0F9D                ; Loop for all 32 entries
0FB9 C9                         ret                        ; Return
0FBA AF            L0FBA:       xor a
0FBB 16 20                      ld d,$20
0FBD 1E 00                      ld e,$00
0FBF ED 92 43                   nextreg $43,a
0FC2 7B            L0FC2:       ld a,e
0FC3 ED 92 40                   nextreg $40,a
0FC6 7E                         ld a,(hl)
0FC7 23                         inc hl
0FC8 ED 92 44                   nextreg $44,a
0FCB 7E                         ld a,(hl)
0FCC 23                         inc hl
0FCD ED 92 44                   nextreg $44,a
0FD0 1C                         inc e
0FD1 15                         dec d
0FD2 20 EE                      jr nz,L0FC2
0FD4 C9                         ret
;
; Copy Data and Save Palette
; Copies 32 bytes from HL to DE, then saves current palette to (HL).
; Called during initialization to set up data structures and preserve palette state.
; Entry: HL = source address, DE = destination address, BC = parameter (high byte used)
; Exit: Palette data saved at original HL location
;
0FD5 C5            SavePal:     push bc                    ; Save BC (parameter)
0FD6 01 20 00                   ld bc,$0020                ; BC = $0020 (32 bytes)
0FD9 D5                         push de                    ; Save DE (destination)
0FDA ED B0                      ldir                       ; Copy 32 bytes from HL to DE
0FDC EB                         ex de,hl                   ; HL = end of destination
0FDD CD 92 0F                   call L0F92                 ; Save palette data to HL
0FE0 E1                         pop hl                     ; HL = original DE (start of copied data)
0FE1 D1                         pop de                     ; DE = original BC parameter
0FE2 18 17                      jr L0FFB                   ; Jump to continue
;
; Palette Restoration Dispatcher
; Selects destination address based on A value and calls ROM2 palette routine.
; Entry: A = mode selector (1-5)
; Exit: Palette restored to hardware, carry set
;
0FE4 11 00 37      L0FE4:       ld de,$3700                ; DE = $3700 (default destination)
0FE7 3D                         dec a                      ; A = A - 1
0FE8 28 10                      jr z,L0FFA                 ; If A was 1, exchange DE/HL
0FEA 3D                         dec a                      ; A = A - 1
0FEB 28 0E                      jr z,L0FFB                 ; If A was 2, use $3700
0FED 3D                         dec a                      ; A = A - 1
0FEE 28 24                      jr z,L1014                 ; If A was 3, jump to L1014
0FF0 3D                         dec a                      ; A = A - 1
0FF1 CA 78 10                   jp z,L1078                 ; If A was 4, jump to L1078
0FF4 11 60 37                   ld de,$3760                ; DE = $3760 (alternate destination)
0FF7 3D                         dec a                      ; A = A - 1
0FF8 20 01                      jr nz,L0FFB                ; If A was not 5, continue
0FFA EB            L0FFA:       ex de,hl                   ; Swap HL and DE
0FFB 01 60 00      L0FFB:       ld bc,$0060                ; BC = $0060 (96 bytes)
0FFE E7                         rst $20                    ; Call ROM2 routine
0FFF 68 00                      .defw $0068                ; ROM2: Restore palette (96 bytes at $3700/$3760)
1001 37                         scf                        ; Set carry flag
1002 C9                         ret                        ; Return
;
; Save Display State and Palette
; Saves current display hardware state (nextreg values, attributes, border, palette)
; to RAM buffer. Called during initialization to preserve display configuration.
; Entry: None
; Exit: Display state saved to $D694 or $D5ED, palette saved, carry set
;
1003 3A B8 D5      SvDispState: ld a,($D5B8)               ; A = display mode indicator
1006 FE 04                      cp $04                     ; Compare with $04
1008 C8                         ret z                      ; If mode 4, return (no save needed)
1009 CD E8 0E                   call L0EE8                 ; Save and restore display settings
100C 21 94 D6                   ld hl,$D694                ; HL = $D694 (default buffer address)
100F 11 60 37                   ld de,$3760                ; DE = $3760 (palette destination)
1012 18 06                      jr L101A                   ; Jump to save routine
1014 21 ED D5      L1014:       ld hl,$D5ED                ; HL = $D5ED (alternate buffer address)
1017 11 00 37                   ld de,$3700                ; DE = $3700 (alternate palette destination)
101A D5            L101A:       push de                    ; Save DE (palette destination)
101B 3E 43                      ld a,$43                   ; A = $43 (palette control nextreg)
101D CD DE 12                   call GetNxRegA             ; Read nextreg $43
1020 77                         ld (hl),a                  ; Save to buffer
1021 23                         inc hl                     ; HL = HL + 1
1022 3E 15                      ld a,$15                   ; A = $15 (sprite/layer control)
1024 CD DE 12                   call GetNxRegA             ; Read nextreg $15
1027 77                         ld (hl),a                  ; Save to buffer
1028 23                         inc hl                     ; HL = HL + 1
1029 3E 14                      ld a,$14                   ; A = $14 (transparency control)
102B CD DE 12                   call GetNxRegA             ; Read nextreg $14
102E 77                         ld (hl),a                  ; Save to buffer
102F 23                         inc hl                     ; HL = HL + 1
1030 3A 8D 5C                   ld a,(ATTR_P)              ; A = permanent attributes
1033 77                         ld (hl),a                  ; Save to buffer
1034 23                         inc hl                     ; HL = HL + 1
1035 3A 62 5B                   ld a,($5B62)               ; A = system variable
1038 77                         ld (hl),a                  ; Save to buffer
1039 23                         inc hl                     ; HL = HL + 1
103A 3A 48 5C                   ld a,(BORDCR)              ; A = border color
103D 77                         ld (hl),a                  ; Save to buffer
103E 23                         inc hl                     ; HL = HL + 1
103F CD 92 0F                   call L0F92                 ; Save palette data (64 bytes) to HL
1042 D1                         pop de                     ; DE = palette destination
1043 E5                         push hl                    ; Save HL (end of buffer)
1044 CD FA 0F                   call L0FFA                 ; Restore palette from buffer to hardware
1047 E1                         pop hl                     ; Restore HL
1048 E5                         push hl                    ; Save HL again
1049 ED 34 20 00                add hl,$0020               ; HL = HL + $20 (skip 32 bytes)
104D CD BA 0F                   call L0FBA                 ; Write palette data from HL
1050 E1                         pop hl                     ; Restore HL
1051 7E                         ld a,(hl)                  ; A = first saved byte (ATTR_P)
1052 32 8D 5C                   ld (ATTR_P),a              ; Restore ATTR_P
1055 32 48 5C                   ld (BORDCR),a              ; Set BORDCR = ATTR_P
1058 F5                         push af                    ; Save AF
1059 1F                         rra                        ; Rotate right (extract border bits)
105A 1F                         rra
105B 1F                         rra
105C D3 FE                      out ($FE),a                ; Set hardware border color
105E F1                         pop af                     ; Restore AF
105F 2F                         cpl                        ; Complement A
1060 E6 38                      and $38                    ; Mask bits 3-5
1062 32 62 5B                   ld ($5B62),a               ; Save to $5B62
1065 3E 4A                      ld a,$4A                   ; A = $4A (nextreg: transparency fallback)
1067 CD DE 12                   call GetNxRegA             ; Read nextreg $4A
106A ED 92 14                   nextreg $14,a              ; Write to nextreg $14
106D ED 91 15 00                nextreg $15,$00            ; Clear nextreg $15
1071 37                         scf                        ; Set carry flag
1072 C9                         ret                        ; Return
1073 21 94 D6      L1073:       ld hl,$D694
1076 18 03                      jr L107B
1078 21 ED D5      L1078:       ld hl,$D5ED
107B 7E            L107B:       ld a,(hl)
107C F5                         push af
107D 23                         inc hl
107E 7E                         ld a,(hl)
107F ED 92 15                   nextreg $15,a
1082 23                         inc hl
1083 7E                         ld a,(hl)
1084 ED 92 14                   nextreg $14,a
1087 23                         inc hl
1088 7E                         ld a,(hl)
1089 32 8D 5C                   ld (ATTR_P),a
108C 23                         inc hl
108D 7E                         ld a,(hl)
108E 32 62 5B                   ld ($5B62),a
1091 23                         inc hl
1092 7E                         ld a,(hl)
1093 32 48 5C                   ld (BORDCR),a
1096 1F                         rra
1097 1F                         rra
1098 1F                         rra
1099 D3 FE                      out ($FE),a
109B 23                         inc hl
109C CD BA 0F                   call L0FBA
109F F1                         pop af
10A0 ED 92 43                   nextreg $43,a
10A3 37                         scf
10A4 C9                         ret
;
; Palette Data Table 1 (32 bytes)
; Default palette configuration copied to $D633 during initialization
;
10A5 38 50 56 66                .defb $38,$50,$56,$66      ; Palette entries 0-1
10A9 65 45 47 07                .defb $65,$45,$47,$07      ; Palette entries 2-3
10AD 30 28 28 28                .defb $30,$28,$28,$28      ; Palette entries 4-5
10B1 28 00 00 00                .defb $28,$00,$00,$00      ; Palette entries 6-7
10B5 38 38 38 38                .defb $38,$38,$38,$38      ; Palette entries 8-9
10B9 38 00 00 00                .defb $38,$00,$00,$00      ; Palette entries 10-11
10BD 00 00 00 00                .defb $00,$00,$00,$00      ; Palette entries 12-13
10C1 00 00 00 00                .defb $00,$00,$00,$00      ; Palette entries 14-15
;
; Palette Data Table 2 (32 bytes)
; Alternate palette configuration copied to $D6DA during initialization
;
10C5 38 50 56 66                .defb $38,$50,$56,$66      ; Palette entries 0-1
10C9 65 45 47 07                .defb $65,$45,$47,$07      ; Palette entries 2-3
10CD 68 78 69 79                .defb $68,$78,$69,$79      ; Palette entries 4-5
10D1 29 39 CF E7                .defb $29,$39,$CF,$E7      ; Palette entries 6-7
10D5 DF EF D7 3D                .defb $DF,$EF,$D7,$3D      ; Palette entries 8-9
10D9 38 3B 3C 3A                .defb $38,$3B,$3C,$3A      ; Palette entries 10-11
10DD 39 3D 38 38                .defb $39,$3D,$38,$38      ; Palette entries 12-13
10E1 00 00 00 00                .defb $00,$00,$00,$00      ; Palette entries 14-15
10E5 ED 91 51 10   L10E5:       nextreg $51,$10
10E9 21 B7 23                   ld hl,$23B7
10EC 37                         scf
10ED CD 3C 0F                   call InitSprPat
10F0 AF                         xor a
10F1 D3 FE         L10F1:       out ($FE),a
10F3 01 3B 24                   ld bc,$243B
10F6 3E 15                      ld a,$15
10F8 ED 79                      out (c),a
10FA 04                         inc b
10FB ED 60                      in h,(c)
10FD DB FF                      in a,($FF)
10FF 6F                         ld l,a
1100 E5                         push hl
1101 F6 38                      or $38
1103 D3 FF                      out ($FF),a
1105 CB 8C                      res 1,h
1107 ED 61                      out (c),h
1109 2A 78 5C                   ld hl,($5C78)
110C CB BC                      res 7,h
110E CB BD                      res 7,l
1110 7D                         ld a,l
1111 E6 03                      and $03
1113 3C                         inc a
1114 57                         ld d,a
1115 7C                         ld a,h
1116 E6 03         L1116:       and $03
1118 3C                         inc a
1119 5F            L1119:       ld e,a
111A 7C            L111A:       ld a,h
111B 82                         add a,d
111C FE E8                      cp $E8
111E 38 05                      jr c,L1125
1120 7A                         ld a,d
1121 ED 44                      neg
1123 57                         ld d,a
1124 84                         add a,h
1125 67            L1125:       ld h,a
1126 0E C8                      ld c,$C8
1128 CD 72 11                   call L1172
112B 7D                         ld a,l
112C 83                         add a,e
112D FE A8                      cp $A8
112F 38 05                      jr c,L1136
1131 7B                         ld a,e
1132 ED 44                      neg
1134 5F                         ld e,a
1135 85                         add a,l
1136 6F            L1136:       ld l,a
1137 0E 50                      ld c,$50
1139 CD 72 11                   call L1172
113C 76                         halt
113D FD CB 01 6E                bit 5,(iy+$01)
1141 28 D7                      jr z,L111A
1143 AF                         xor a
1144 01 90 FF                   ld bc,$FF90
1147 CD 7C 11                   call L117C
114A AF                         xor a
114B 01 20 BF                   ld bc,$BF20
114E CD 7C 11                   call L117C
1151 E1                         pop hl
1152 7C                         ld a,h
1153 ED 92 15                   nextreg $15,a
1156 7D                         ld a,l
1157 D3 FF                      out ($FF),a
1159 3A 48 5C                   ld a,(BORDCR)
115C 0F                         rrca
115D 0F                         rrca
115E 0F                         rrca
115F D3 FE                      out ($FE),a
1161 FD CB 01 AE                res 5,(iy+$01)
1165 21 B7 23                   ld hl,$23B7
1168 CD 3B 0F                   call L0F3B
116B ED 91 51 FF                nextreg $51,$FF
116F C3 E0 11                   jp L11E0
1172 06 18         L1172:       ld b,$18
1174 FD CB 47 7E                bit 7,(iy+$47)
1178 28 02                      jr z,L117C
117A 06 FF                      ld b,$FF
117C E5            L117C:       push hl
117D D5                         push de
117E C5                         push bc
117F 5F                         ld e,a
1180 80                         add a,b
1181 57                         ld d,a
1182 21 18 03                   ld hl,$0318
1185 01 3B 24      L1185:       ld bc,$243B
1188 ED 69                      out (c),l
118A 04                         inc b
118B ED 59                      out (c),e
118D ED 51                      out (c),d
118F 2C                         inc l
1190 25                         dec h
1191 20 F2                      jr nz,L1185
1193 05                         dec b
1194 ED 69                      out (c),l
1196 04                         inc b
1197 E1                         pop hl
1198 CB 25                      sla l
119A F5                         push af
119B 7B                         ld a,e
119C 30 02                      jr nc,L11A0
119E CB 3F                      srl a
11A0 CB 7D         L11A0:       bit 7,l
11A2 CB BD                      res 7,l
11A4 28 01                      jr z,L11A7
11A6 85                         add a,l
11A7 ED 79         L11A7:       out (c),a
11A9 F1                         pop af
11AA 7A                         ld a,d
11AB 30 02                      jr nc,L11AF
11AD CB 3F                      srl a
11AF 85            L11AF:       add a,l
11B0 ED 79                      out (c),a
11B2 D1                         pop de
11B3 E1                         pop hl
11B4 C9                         ret
11B5 CD 03 10                   call SvDispState
11B8 01 17 00      L11B8:       ld bc,$0017
11BB CD 77 12                   call L1277
;
;
;
11BE 3E FF         L11BE:       ld a,$FF
11C0 32 B8 D5                   ld ($D5B8),a
11C3 31 FF 5B                   ld sp,$5BFF
11C6 AF            L11C6:       xor a
11C7 CD 45 06      L11C7:       call L0645
11CA 3A 44 D7                   ld a,($D744)
11CD A7                         and a
11CE 20 F6                      jr nz,L11C6
11D0 3E 01                      ld a,$01
11D2 18 F3                      jr L11C7
11D4 3A B8 D5                   ld a,($D5B8)
11D7 A7                         and a
11D8 C0                         ret nz
11D9 E1                         pop hl
11DA CD 68 00                   call L0068
11DD 32 13 C9                   ld ($C913),a
11E0 3A 81 5C      L11E0:       ld a,($5C81)
11E3 E6 7F                      and $7F
11E5 F5            L11E5:       push af
11E6 3A 68 5B                   ld a,($5B68)
11E9 CB 4F                      bit 1,a
11EB 28 03                      jr z,L11F0
11ED DF                         rst $18
11EE 91                         sub c
11EF 37                         scf
11F0 01 B8 0B      L11F0:       ld bc,$0BB8
11F3 F1                         pop af
11F4 A7            L11F4:       and a
11F5 28 0B                      jr z,L1202
11F7 0D                         dec c
11F8 20 08                      jr nz,L1202
11FA 10 06                      djnz L1202
11FC 3D                         dec a
11FD CA E5 10                   jp z,L10E5
1200 18 E3                      jr L11E5
1202 76            L1202:       halt
1203 21 3B 5C                   ld hl,$5C3B
1206 CB 6E                      bit 5,(hl)
1208 28 EA                      jr z,L11F4
120A CB AE                      res 5,(hl)
120C 3A 08 5C                   ld a,($5C08)
120F 21 41 5C                   ld hl,$5C41
1212 FE 0E                      cp $0E
1214 28 06                      jr z,L121C
1216 CB 86                      res 0,(hl)
1218 FE 10                      cp $10
121A 30 1F                      jr nc,L123B
121C F5            L121C:       push af
121D FE 06                      cp $06
121F 20 09                      jr nz,L122A
1221 21 6A 5C                   ld hl,$5C6A
1224 3E 08                      ld a,$08
1226 AE                         xor (hl)
1227 77                         ld (hl),a
1228 18 0C                      jr L1236
122A FE 0E         L122A:       cp $0E
122C 38 0C                      jr c,L123A
122E D6 0D                      sub $0D
1230 BE                         cp (hl)
1231 77                         ld (hl),a
1232 20 02                      jr nz,L1236
1234 36 00                      ld (hl),$00
1236 FD CB 02 DE   L1236:       set 3,(iy+$02)
123A F1            L123A:       pop af
123B FD CB 30 7E   L123B:       bit 7,(iy+$30)
123F 37                         scf
1240 C0                         ret nz
1241 FD CB 07 4E                bit 1,(iy+$07)
1245 C0                         ret nz
1246 21 64 12                   ld hl,$1264
1249 06 08                      ld b,$08
124B BE            L124B:       cp (hl)
124C 23                         inc hl
124D 20 01                      jr nz,L1250
124F 7E                         ld a,(hl)
1250 23            L1250:       inc hl
1251 10 F8                      djnz L124B
1253 37                         scf
1254 C9                         ret
1255 CD E0 11      L1255:       call L11E0
1258 F5                         push af
1259 3A 39 5C                   ld a,($5C39)
125C 21 C8 00                   ld hl,$00C8
125F CD 20 3E                   call L3E20
1262 F1                         pop af
1263 C9                         ret
1264 C6 5B                      add a,$5B
1266 C5                         push bc
1267 5D                         ld e,l
1268 C7                         rst $00
1269 7F                         ld a,a
126A E2 7E C3                   jp po,LC37E
126D 7C                         ld a,h
126E CD 5C CC                   call LCC5C
1271 7B                         ld a,e
1272 CB 7D                      bit 7,l
1274 01 17 15      L1274:       ld bc,$1517
1277 79            L1277:       ld a,c
1278 90                         sub b
1279 3C                         inc a
127A 4F                         ld c,a
127B 3E 18                      ld a,$18
127D 90                         sub b
127E 47                         ld b,a
127F C5            L127F:       push bc
1280 EF                         rst $28
1281 9B                         sbc a,e
1282 0E 0E                      ld c,$0E
1284 08                         ex af,af'
1285 FD CB 45 5E                bit 3,(iy+$45)
1289 28 23                      jr z,L12AE
128B 08                         ex af,af'
128C 3E 0B                      ld a,$0B
128E 08                         ex af,af'
128F CD D1 12                   call L12D1
1292 E5            L1292:       push hl
1293 AF                         xor a
1294 06 20                      ld b,$20
1296 77            L1296:       ld (hl),a
1297 23                         inc hl
1298 10 FC                      djnz L1296
129A E1                         pop hl
129B E5                         push hl
129C CB EC                      set 5,h
129E 06 20                      ld b,$20
12A0 77            L12A0:       ld (hl),a
12A1 23                         inc hl
12A2 10 FC                      djnz L12A0
12A4 E1                         pop hl
12A5 24                         inc h
12A6 0D                         dec c
12A7 20 E9                      jr nz,L1292
12A9 CD D1 12                   call L12D1
12AC 18 0D                      jr L12BB
12AE E5            L12AE:       push hl
12AF 06 20                      ld b,$20
12B1 AF                         xor a
12B2 77            L12B2:       ld (hl),a
12B3 23                         inc hl
12B4 10 FC                      djnz L12B2
12B6 E1                         pop hl
12B7 24                         inc h
12B8 0D                         dec c
12B9 20 F3                      jr nz,L12AE
12BB 06 20         L12BB:       ld b,$20
12BD C5                         push bc
12BE EF                         rst $28
12BF 88                         adc a,b
12C0 0E EB                      ld c,$EB
12C2 C1                         pop bc
12C3 3A 8D 5C                   ld a,(ATTR_P)
12C6 77            L12C6:       ld (hl),a
12C7 23                         inc hl
12C8 10 FC                      djnz L12C6
12CA C1                         pop bc
12CB 05                         dec b
12CC 0D                         dec c
12CD 20 B0                      jr nz,L127F
12CF 37                         scf
12D0 C9                         ret
12D1 F5            L12D1:       push af
12D2 C5                         push bc
12D3 3E 53                      ld a,$53
12D5 CD DE 12                   call GetNxRegA
12D8 08                         ex af,af'
12D9 ED 79                      out (c),a
12DB C1                         pop bc
12DC F1                         pop af
12DD C9                         ret
;
; Read the Next register port value addressed by A
;
12DE 01 3B 24      GetNxRegA:   ld bc,$243B                ; Register index port
12E1 ED 79                      out (c),a                  ; A --> Register index
12E3 04                         inc b                      ; Register value port
12E4 ED 78                      in a,(c)                   ; Read register value
12E6 C9                         ret                        ; Done
;
;
;
12E7 14                         inc d
12E8 01 47 20                   ld bc,$2047
12EB 14                         inc d
12EC 00                         nop
12ED 19                         add hl,de
12EE B0                         or b
12EF 06 00                      ld b,$00
12F1 75                         ld (hl),l
12F2 69                         ld l,c
12F3 64                         ld h,h
12F4 65                         ld h,l
12F5 20 14                      jr nz,L130B
12F7 01 4C 20                   ld bc,$204C
12FA 14                         inc d
12FB 00                         nop
12FC 19                         add hl,de
12FD B0                         or b
12FE 25                         dec h
12FF 00                         nop
1300 69                         ld l,c
1301 6E                         ld l,(hl)
1302 6B                         ld l,e
1303 73                         ld (hl),e
1304 19                         add hl,de
1305 B0                         or b
1306 41                         ld b,c
1307 00                         nop
1308 45                         ld b,l
1309 4E                         ld c,(hl)
130A 54                         ld d,h
130B 45            L130B:       ld b,l
130C 52                         ld d,d
130D 3D                         dec a
130E 73                         ld (hl),e
130F 65                         ld h,l
1310 6C                         ld l,h
1311 65                         ld h,l
1312 63                         ld h,e
1313 74                         ld (hl),h
1314 20 45                      jr nz,L135B
1316 44                         ld b,h
1317 49                         ld c,c
1318 54                         ld d,h
1319 3D                         dec a
131A 75                         ld (hl),l
131B 70                         ld (hl),b
131C 20 45                      jr nz,L1363
131E 58                         ld e,b
131F 54                         ld d,h
1320 45                         ld b,l
1321 4E                         ld c,(hl)
1322 44                         ld b,h
1323 3D                         dec a
1324 6D                         ld l,l
1325 6F                         ld l,a
1326 72                         ld (hl),d
1327 65                         ld h,l
1328 20 42                      jr nz,L136C
132A 52                         ld d,d
132B 45                         ld b,l
132C 41                         ld b,c
132D 4B                         ld c,e
132E 0D                         dec c
132F 14                         inc d
1330 01 44 20                   ld bc,$2044
1333 14                         inc d
1334 00                         nop
1335 19                         add hl,de
1336 B8                         cp b
1337 06 00                      ld b,$00
1339 72                         ld (hl),d
133A 69                         ld l,c
133B 76                         halt
133C 65                         ld h,l
133D 20 14                      jr nz,L1353
133F 01 43 20                   ld bc,$2043
1342 14                         inc d
1343 00                         nop
1344 19                         add hl,de
1345 B8                         cp b
1346 25                         dec h
1347 00                         nop
1348 6F                         ld l,a
1349 70                         ld (hl),b
134A 79                         ld a,c
134B 20 19                      jr nz,L1366
134D B8                         cp b
134E 38 00                      jr c,L1350
1350 6D            L1350:       ld l,l
1351 6F                         ld l,a
1352 19                         add hl,de
1353 B8            L1353:       cp b
1354 43                         ld b,e
1355 00                         nop
1356 14                         inc d
1357 01 56 14                   ld bc,$1456
135A 00                         nop
135B 65            L135B:       ld h,l
135C 20 19                      jr nz,L1377
135E B8                         cp b
135F 51                         ld d,c
1360 00                         nop
1361 14                         inc d
1362 01 52 20                   ld bc,$2052
1365 14                         inc d
1366 00            L1366:       nop
1367 19                         add hl,de
1368 B8                         cp b
1369 57                         ld d,a
136A 00                         nop
136B 65                         ld h,l
136C 6E            L136C:       ld l,(hl)
136D 61                         ld h,c
136E 6D                         ld l,l
136F 65                         ld h,l
1370 20 19                      jr nz,L138B
1372 B8                         cp b
1373 74                         ld (hl),h
1374 00                         nop
1375 14                         inc d
1376 01 45 20                   ld bc,$2045
1379 14                         inc d
137A 00                         nop
137B 19                         add hl,de
137C B8                         cp b
137D 7A                         ld a,d
137E 00                         nop
137F 72                         ld (hl),d
1380 61                         ld h,c
1381 73                         ld (hl),e
1382 65                         ld h,l
1383 20 19                      jr nz,L139E
1385 B8                         cp b
1386 92                         sub d
1387 00                         nop
1388 6D                         ld l,l
1389 19                         add hl,de
138A B8                         cp b
138B 98            L138B:       sbc a,b
138C 00                         nop
138D 14                         inc d
138E 01 4B 20                   ld bc,$204B
1391 14                         inc d
1392 00                         nop
1393 19                         add hl,de
1394 B8                         cp b
1395 9E                         sbc a,(hl)
1396 00                         nop
1397 64                         ld h,h
1398 69                         ld l,c
1399 72                         ld (hl),d
139A 20 19                      jr nz,L13B5
139C B8                         cp b
139D B0                         or b
139E 00            L139E:       nop
139F 14                         inc d
13A0 01 55 20                   ld bc,$2055
13A3 14                         inc d
13A4 00                         nop
13A5 19                         add hl,de
13A6 B8                         cp b
13A7 B6                         or (hl)
13A8 00                         nop
13A9 6E                         ld l,(hl)
13AA 19                         add hl,de
13AB B8                         cp b
13AC BC                         cp h
13AD 00                         nop
13AE 6D                         ld l,l
13AF 6F                         ld l,a
13B0 75                         ld (hl),l
13B1 6E                         ld l,(hl)
13B2 74                         ld (hl),h
13B3 20 19                      jr nz,L13CE
13B5 B8            L13B5:       cp b
13B6 D8                         ret c
13B7 00                         nop
13B8 72                         ld (hl),d
13B9 65                         ld h,l
13BA 19                         add hl,de
13BB B8                         cp b
13BC E3                         ex (sp),hl
13BD 00                         nop
13BE 14                         inc d
13BF 01 20 19                   ld bc,$1920
13C2 B8                         cp b
13C3 E4 00 4D                   call po,L4D00
13C6 20 14                      jr nz,L13DC
13C8 00                         nop
13C9 19                         add hl,de
13CA B8                         cp b
13CB EA 00 6F                   jp pe,L6F00
13CE 75            L13CE:       ld (hl),l
13CF 6E                         ld l,(hl)
13D0 74                         ld (hl),h
13D1 FF                         rst $38
13D2 43                         ld b,e
13D3 68                         ld l,b
13D4 61                         ld h,c
13D5 6E                         ld l,(hl)
13D6 67                         ld h,a
13D7 65                         ld h,l
13D8 20 74                      jr nz,L144E
13DA 6F                         ld l,a
13DB 20 64                      jr nz,L1441
13DD 65                         ld h,l
13DE 73                         ld (hl),e
13DF 74                         ld (hl),h
13E0 69                         ld l,c
13E1 6E                         ld l,(hl)
13E2 61                         ld h,c
13E3 74                         ld (hl),h
13E4 69                         ld l,c
13E5 6F                         ld l,a
13E6 6E                         ld l,(hl)
13E7 20 61                      jr nz,L144A
13E9 6E                         ld l,(hl)
13EA 64                         ld h,h
13EB 20 70                      jr nz,L145D
13ED 72                         ld (hl),d
13EE 65                         ld h,l
13EF 73                         ld (hl),e
13F0 73                         ld (hl),e
13F1 20 50                      jr nz,L1443
13F3 20 74                      jr nz,L1469
13F5 6F                         ld l,a
13F6 20 70                      jr nz,L1468
13F8 61                         ld h,c
13F9 73                         ld (hl),e
13FA 74                         ld (hl),h
13FB 65                         ld h,l
13FC FF                         rst $38
13FD 19                         add hl,de
13FE 08                         ex af,af'
13FF 00                         nop
1400 00                         nop
1401 20 19                      jr nz,L141C
1403 08                         ex af,af'
1404 01 00 4F                   ld bc,$4F00
1407 20 19                      jr nz,L1422
1409 08                         ex af,af'
140A 07                         rlca
140B 00                         nop
140C 72                         ld (hl),d
140D 64                         ld h,h
140E 65                         ld h,l
140F 72                         ld (hl),d
1410 3A 19 08                   ld a,($0819)
1413 3A 00 2B                   ld a,($2B00)
1416 2D                         dec l
1417 19                         add hl,de
1418 08                         ex af,af'
1419 D2 00 49                   jp nc,L4900
141C 6E            L141C:       ld l,(hl)
141D 66                         ld h,(hl)
141E 6F                         ld l,a
141F 3A 19 08                   ld a,($0819)
1422 9B            L1422:       sbc a,e
1423 00                         nop
1424 4E                         ld c,(hl)
1425 61                         ld h,c
1426 6D                         ld l,l
1427 65                         ld h,l
1428 19                         add hl,de
1429 08                         ex af,af'
142A B3                         or e
142B 00                         nop
142C 41                         ld b,c
142D 72                         ld (hl),d
142E 65                         ld h,l
142F 61                         ld h,c
1430 19                         add hl,de
1431 08                         ex af,af'
1432 4D                         ld c,l
1433 00                         nop
1434 6D                         ld l,l
1435 69                         ld l,c
1436 58                         ld e,b
1437 20 6F                      jr nz,L14A8
1439 FF                         rst $38
143A 19                         add hl,de
143B 08                         ex af,af'
143C 76                         halt
143D 00                         nop
143E 73                         ld (hl),e
143F 65                         ld h,l
1440 61                         ld h,c
1441 72            L1441:       ld (hl),d
1442 63                         ld h,e
1443 48            L1443:       ld c,b
1444 FF                         rst $38
1445 16 16                      ld d,$16
1447 00                         nop
1448 20 17                      jr nz,L1461
144A 00            L144A:       nop
144B 00                         nop
144C 20 17                      jr nz,L1465
144E 00            L144E:       nop
144F 00                         nop
1450 16 16                      ld d,$16
1452 00                         nop
1453 FF                         rst $38
1454 2E 2E                      ld l,$2E
1456 FF                         rst $38
1457 4E                         ld c,(hl)
1458 65                         ld h,l
1459 77                         ld (hl),a
145A 20 6E                      jr nz,L14CA
145C 61                         ld h,c
145D 6D            L145D:       ld l,l
145E 65                         ld h,l
145F 3A 20 FF                   ld a,($FF20)
1462 50                         ld d,b
1463 61                         ld h,c
1464 73                         ld (hl),e
1465 74            L1465:       ld (hl),h
1466 65                         ld h,l
1467 20 61                      jr nz,L14CA
1469 73            L1469:       ld (hl),e
146A 3A 20 FF                   ld a,($FF20)
146D 63                         ld h,e
146E 6F                         ld l,a
146F 70                         ld (hl),b
1470 79                         ld a,c
1471 69                         ld l,c
1472 6E                         ld l,(hl)
1473 67                         ld h,a
1474 2E 2E                      ld l,$2E
1476 2E FF                      ld l,$FF
1478 65                         ld h,l
1479 72                         ld (hl),d
147A 61                         ld h,c
147B 73                         ld (hl),e
147C 69                         ld l,c
147D 6E                         ld l,(hl)
147E 67                         ld h,a
147F 2E 2E                      ld l,$2E
1481 2E FF                      ld l,$FF
1483 7F                         ld a,a
1484 62                         ld h,d
1485 72                         ld (hl),d
1486 6F                         ld l,a
1487 77                         ld (hl),a
1488 73                         ld (hl),e
1489 65                         ld h,l
148A 72                         ld (hl),d
148B 2E 63                      ld l,$63
148D 66                         ld h,(hl)
148E 67                         ld h,a
148F 00                         nop
1490 7F                         ld a,a
1491 65                         ld h,l
1492 6E                         ld l,(hl)
1493 42                         ld b,d
1494 72                         ld (hl),d
1495 6F                         ld l,a
1496 77                         ld (hl),a
1497 73                         ld (hl),e
1498 65                         ld h,l
1499 78                         ld a,b
149A 74                         ld (hl),h
149B 2E 63                      ld l,$63
149D 66                         ld h,(hl)
149E 67                         ld h,a
149F 00                         nop
14A0 1E 05                      ld e,$05
14A2 16 15                      ld d,$15
14A4 25                         dec h
14A5 53                         ld d,e
14A6 20 20                      jr nz,L14C8
14A8 7B            L14A8:       ld a,e
14A9 19                         add hl,de
14AA A8                         xor b
14AB C1                         pop bc
14AC 00                         nop
14AD 2E 16                      ld l,$16
14AF 15                         dec d
14B0 0F                         rrca
14B1 46                         ld b,(hl)
14B2 69                         ld l,c
14B3 6C                         ld l,h
14B4 74                         ld (hl),h
14B5 65                         ld h,l
14B6 72                         ld (hl),d
14B7 3A FF 55                   ld a,($55FF)
14BA 73                         ld (hl),e
14BB 65                         ld h,l
14BC 72                         ld (hl),d
14BD 20 61                      jr nz,L1520
14BF 72                         ld (hl),d
14C0 65                         ld h,l
14C1 61                         ld h,c
14C2 20 28                      jr nz,L14EC
14C4 30 2E                      jr nc,L14F4
14C6 2E 31                      ld l,$31
14C8 35            L14C8:       dec (hl)
14C9 29                         add hl,hl
14CA 3A 20 FF      L14CA:       ld a,($FF20)
14CD 1E 05                      ld e,$05
14CF 16 16                      ld d,$16
14D1 00                         nop
14D2 FF                         rst $38
14D3 6E                         ld l,(hl)
14D4 61                         ld h,c
14D5 6D                         ld l,l
14D6 65                         ld h,l
14D7 FF                         rst $38
14D8 6E                         ld l,(hl)
14D9 6F                         ld l,a
14DA 6E                         ld l,(hl)
14DB 65                         ld h,l
14DC FF                         rst $38
14DD 64                         ld h,h
14DE 61                         ld h,c
14DF 74                         ld (hl),h
14E0 65                         ld h,l
14E1 FF                         rst $38
14E2 73                         ld (hl),e
14E3 69                         ld l,c
14E4 7A                         ld a,d
14E5 65                         ld h,l
14E6 FF                         rst $38
14E7 61                         ld h,c
14E8 74                         ld (hl),h
14E9 74                         ld (hl),h
14EA 72                         ld (hl),d
14EB FF                         rst $38
14EC D3 14         L14EC:       out ($14),a
14EE D8                         ret c
14EF 14                         inc d
14F0 DD 14                      inc d
14F2 E2 14 19                   jp po,L1914
14F5 08                         ex af,af'
14F6 20 00                      jr nz,L14F8
14F8 FF            L14F8:       rst $38
14F9 D8                         ret c
14FA 14                         inc d
14FB E2 14 DD                   jp po,LDD14
14FE 14                         inc d
14FF E7                         rst $20
1500 14                         inc d
1501 19                         add hl,de
1502 08                         ex af,af'
1503 EB                         ex de,hl
1504 00                         nop
1505 FF                         rst $38
1506 19                         add hl,de
1507 00                         nop
1508 01 00 FF                   ld bc,$FF00
150B 53                         ld d,e
150C 65                         ld h,l
150D 61                         ld h,c
150E 72                         ld (hl),d
150F 63                         ld h,e
1510 68                         ld l,b
1511 3A 0D FF                   ld a,($FF0D)
1514 45                         ld b,l
1515 58                         ld e,b
1516 54                         ld d,h
1517 45                         ld b,l
1518 4E                         ld c,(hl)
1519 44                         ld b,h
151A 3D                         dec a
151B 66                         ld h,(hl)
151C 69                         ld l,c
151D 6C                         ld l,h
151E 65                         ld h,l
151F 73                         ld (hl),e
1520 2F            L1520:       cpl
1521 64                         ld h,h
1522 69                         ld l,c
1523 72                         ld (hl),d
1524 73                         ld (hl),e
1525 FF                         rst $38
1526 16 02                      ld d,$02
1528 00                         nop
1529 12                         ld (de),a
152A 01 20 50                   ld bc,$5020
152D 72                         ld (hl),d
152E 6F                         ld l,a
152F 63                         ld h,e
1530 65                         ld h,l
1531 73                         ld (hl),e
1532 73                         ld (hl),e
1533 69                         ld l,c
1534 6E                         ld l,(hl)
1535 67                         ld h,a
1536 2E 2E                      ld l,$2E
1538 2E 20                      ld l,$20
153A 12                         ld (de),a
153B 00                         nop
153C 20 FF                      jr nz,L153D
153E 50                         ld d,b
153F 72                         ld (hl),d
1540 65                         ld h,l
1541 73                         ld (hl),e
1542 73                         ld (hl),e
1543 20 61                      jr nz,L15A6
1545 6E                         ld l,(hl)
1546 79                         ld a,c
1547 20 6B                      jr nz,L15B4
1549 65                         ld h,l
154A 79                         ld a,c
154B FF                         rst $38
154C 43                         ld b,e
154D 4C                         ld c,h
154E 53                         ld d,e
154F 3A 4C 4F                   ld a,($4F4C)
1552 41                         ld b,c
1553 44                         ld b,h
1554 22 52 55                   ld ($5552),hl
1557 4E                         ld c,(hl)
1558 2E 42                      ld l,$42
155A 41                         ld b,c
155B 53                         ld d,e
155C 22 0D 72                   ld ($720D),hl
155F 75                         ld (hl),l
1560 6E                         ld l,(hl)
1561 2E 67                      ld l,$67
1563 64                         ld h,h
1564 65                         ld h,l
1565 FF                         rst $38
1566 63                         ld h,e
1567 3A 2F 64                   ld a,($642F)
156A 6F                         ld l,a
156B 63                         ld h,e
156C 73                         ld (hl),e
156D 2F                         cpl
156E 67                         ld h,a
156F 75                         ld (hl),l
1570 69                         ld l,c
1571 64                         ld h,h
1572 65                         ld h,l
1573 73                         ld (hl),e
1574 2F                         cpl
1575 62                         ld h,d
1576 72                         ld (hl),d
1577 6F                         ld l,a
1578 77                         ld (hl),a
1579 73                         ld (hl),e
157A 65                         ld h,l
157B 72                         ld (hl),d
157C 2E 67                      ld l,$67
157E 64                         ld h,h
157F 65                         ld h,l
1580 FF                         rst $38
1581 63                         ld h,e
1582 3A FF 63                   ld a,($63FF)
1585 3A 2F 6C                   ld a,($6C2F)
1588 69                         ld l,c
1589 6E                         ld l,(hl)
158A 6B                         ld l,e
158B 73                         ld (hl),e
158C FF                         rst $38
158D 4E                         ld c,(hl)
158E 65                         ld h,l
158F 78                         ld a,b
1590 74                         ld (hl),h
1591 4C                         ld c,h
1592 69                         ld l,c
1593 6E                         ld l,(hl)
1594 6B                         ld l,e
1595 52                         ld d,d
1596 55                         ld d,l
1597 4E                         ld c,(hl)
1598 4C                         ld c,h
1599 4E                         ld c,(hl)
159A 4B                         ld c,e
159B 42                         ld b,d
159C 41                         ld b,c
159D 53                         ld d,e
159E 53                         ld d,e
159F 43                         ld b,e
15A0 52                         ld d,d
15A1 ED 8A 15 C4   L15A1:       push $15C4
15A5 D5                         push de
15A6 C5            L15A6:       push bc
15A7 46            L15A7:       ld b,(hl)
15A8 04                         inc b
15A9 28 0B                      jr z,L15B6
15AB 05                         dec b
15AC 23                         inc hl
15AD 5E                         ld e,(hl)
15AE 23                         inc hl
;
;
;
15AF 56                         ld d,(hl)
15B0 23                         inc hl
15B1 B8                         cp b
15B2 28 08                      jr z,L15BC
15B4 18 F1         L15B4:       jr L15A7
15B6 A7            L15B6:       and a
15B7 05                         dec b
15B8 C1                         pop bc
15B9 D1                         pop de
15BA E1                         pop hl
15BB C9                         ret
15BC C1            L15BC:       pop bc
15BD EB                         ex de,hl
15BE E3                         ex (sp),hl
15BF EB                         ex de,hl
15C0 C9                         ret
15C1 CD C8 15      L15C1:       call L15C8                  ; Call JP (HL) routine - execute code at address in HL
15C4 26 01                      ld h,$01                    ; Set H := $01 (prepare high byte)
15C6 25                         dec h                       ; Decrement H (H := $00)
15C7 C9                         ret                         ; Return (HL now contains $00xx where xx is original L)
;
; Jump (HL): Execute code at address in HL
; Entry: HL = address to jump to
; Exit: None (jumps to address)
;
15C8 E9            L15C8:       jp (hl)                     ; Jump to address in HL
;
; Stack Switch with ROM Page Change to $08
; Entry: None
; Exit: SP swapped, nextreg $8E set to $08, AF preserved via AF'
;
15C9 ED 91 8E 08   L15C9:       nextreg $8E,$08             ; 128K paging: bit 3=1 (no RAM bank change), ROM0 selected
15CD 08            L15CD:       ex af,af'                   ; Swap to alternate AF register
15CE F1                         pop af                      ; Retrieve AF from stack
15CF 22 52 5B                   ld (TMPHL),hl               ; Save HL to temporary storage ($5B52)
15D2 2A 6A 5B                   ld hl,(TMPSP)               ; HL := saved stack pointer from TMPSP ($5B6A)
15D5 ED 73 6A 5B   L15D5:       ld (TMPSP),sp               ; Save current SP to TMPSP
15D9 F9                         ld sp,hl                    ; Switch to saved stack pointer (SP := HL)
15DA 2A 52 5B                   ld hl,(TMPHL)               ; Restore HL from temporary storage
15DD F5                         push af                     ; Preserve AF on stack
15DE 08                         ex af,af'                   ; Swap to alternate AF register
15DF C9                         ret                         ; Return from subroutine
;
; RST $08 Continuation: Stack Switch and Page RAM Bank 7
; This is the target of RST $08 (JP L15E0 at $0008). It switches the stack pointer to the
; work area (TMPSP, typically $5BFF) and pages RAM bank 7 into $C000-$FFFF.
; Entry: Called via RST $08
; Exit: RAM bank 7 paged at $C000, SP pointing to work area below sysvars, AF preserved via AF'
;
15E0 08            L15E0:       ex af,af'                   ; Restore primary AF register set
15E1 F1                         pop af                      ; Retrieve AF from stack
15E2 22 52 5B                   ld (TMPHL),hl               ; Save HL to temporary storage ($5B52)
15E5 2A 6A 5B                   ld hl,(TMPSP)               ; HL := saved stack pointer from TMPSP ($5B6A)
15E8 ED 73 6A 5B                ld (TMPSP),sp               ; Save current SP to TMPSP
15EC F9                         ld sp,hl                    ; Switch to saved stack pointer (SP := HL)
15ED 2A 52 5B                   ld hl,(TMPHL)               ; Restore HL from temporary storage
15F0 F5                         push af                     ; Preserve AF on new stack
15F1 08                         ex af,af'                   ; Swap to alternate AF register
15F2 ED 91 8E 78                nextreg $8E,$78             ; 128K paging: bits 6-4=%111 (RAM bank 7), bit 3=1 (change bank), ROM0
15F6 C9                         ret                         ; Return with new stack and ROM page active
15F7 00                         nop
15F8 00                         nop
15F9 00                         nop
15FA 00                         nop
15FB 00                         nop
15FC 00                         nop
15FD 00                         nop
15FE 2A 51 5C                   ld hl,($5C51)
1601 C3 6C 03                   jp L036C
1604 71                         ld (hl),c
1605 18 80                      jr L1587
1607 18 6D                      jr L1676
1609 19                         add hl,de
160A B0                         or b
160B 19                         add hl,de
160C 30 1A                      jr nc,L1628
160E 45                         ld b,l
160F 1A                         ld a,(de)
1610 E0                         ret po
1611 1B                         dec de
1612 71                         ld (hl),c
1613 20 4A                      jr nz,L165F
1615 1A            L1615:       ld a,(de)
1616 66                         ld h,(hl)
1617 1A                         ld a,(de)
1618 A2                         and d
1619 1A                         ld a,(de)
161A BF                         cp a
161B 1A                         ld a,(de)
161C 87                         add a,a
161D 1B            L161D:       dec de
161E 43                         ld b,e
161F 20 B7                      jr nz,L15D8
1621 20 B2                      jr nz,L15D5
1623 20 F0                      jr nz,L1615
1625 1B                         dec de
1626 53                         ld d,e
1627 1C                         inc e
1628 99            L1628:       sbc a,c
1629 1C                         inc e
162A B0                         or b
162B 1C                         inc e
162C DA 1C FA                   jp c,LFA1C
162F 1C                         inc e
1630 DA 1A D6                   jp c,LD61A
1633 1A            L1633:       ld a,(de)
1634 C7                         rst $00
1635 1C                         inc e
1636 CB 1A                      rr d
1638 AB                         xor e
1639 20 06                      jr nz,L1641
163B 1D                         dec e
163C 1F                         rra
163D 1D                         dec e
163E 2A 1D D1                   ld hl,($D11D)
1641 16 01         L1641:       ld d,$01
1643 19                         add hl,de
1644 4A                         ld c,d
1645 1B                         dec de
1646 C1                         pop bc
1647 1B                         dec de
1648 CF                         rst $08
1649 1A                         ld a,(de)
164A F5                         push af
164B 1A                         ld a,(de)
164C FF                         rst $38
164D 19                         add hl,de
164E 44                         ld b,h
164F 1A                         ld a,(de)
1650 6D                         ld l,l
1651 19                         add hl,de
1652 B0                         or b
1653 19                         add hl,de
1654 30 1A                      jr nc,L1670
1656 45                         ld b,l
1657 1A                         ld a,(de)
1658 44                         ld b,h
1659 1A                         ld a,(de)
165A 71                         ld (hl),c
165B 20 44                      jr nz,L16A1
165D 1A                         ld a,(de)
165E 44                         ld b,h
165F 1A            L165F:       ld a,(de)
1660 A2                         and d
1661 1A                         ld a,(de)
1662 BF                         cp a
1663 1A                         ld a,(de)
1664 44                         ld b,h
1665 1A                         ld a,(de)
1666 B6                         or (hl)
1667 18 B7                      jr L1620
1669 20 B2                      jr nz,L161D
166B 20 2A                      jr nz,L1697
166D 17                         rla
166E 2A 17 2A                   ld hl,($2A17)
1671 17                         rla
1672 2A 17 2A                   ld hl,($2A17)
1675 17                         rla
1676 2A 17 44      L1676:       ld hl,($4417)
1679 1A                         ld a,(de)
167A 44                         ld b,h
167B 1A                         ld a,(de)
167C 2A 17 44                   ld hl,($4417)
167F 1A                         ld a,(de)
1680 2A 17 2A                   ld hl,($2A17)
1683 17                         rla
1684 44                         ld b,h
1685 1A                         ld a,(de)
1686 2A 17 8C                   ld hl,($8C17)
1689 16 44                      ld d,$44
168B 1A                         ld a,(de)
168C DD CB 25 F6                set 6,(ix+$25)
1690 DD CB 25 FE                set 7,(ix+$25)
1694 C9                         ret
1695 DD E5         L1695:       push ix
1697 E1            L1697:       pop hl
1698 ED 34 30 00                add hl,$0030
169C C9                         ret
169D CD 95 16      L169D:       call L1695
16A0 01 FF 00                   ld bc,$00FF
16A3 DD CB 19 7E                bit 7,(ix+$19)
16A7 C0                         ret nz
16A8 CD B5 16                   call L16B5
16AB 4F                         ld c,a
16AC 0C                         inc c
16AD C9                         ret
16AE 3E 20         L16AE:       ld a,$20
16B0 DD 24                      inc xh
16B2 DD 25                      dec xh
16B4 C8                         ret z
16B5 DD 7E 1C      L16B5:       ld a,(ix+$1C)
16B8 DD CB 25 66                bit 4,(ix+$25)
16BC C8                         ret z
16BD CB 3F                      srl a
16BF C9                         ret
16C0 F5            L16C0:       push af
16C1 C5                         push bc
16C2 D5                         push de
16C3 E5                         push hl
16C4 5F                         ld e,a
16C5 CD 47 1D                   call L1D47
16C8 E1                         pop hl
16C9 D1                         pop de
16CA C1                         pop bc
16CB F1                         pop af
16CC C9                         ret
16CD DD CB 25 BE   L16CD:       res 7,(ix+$25)
16D1 DD CB 19 66                bit 4,(ix+$19)
16D5 28 31                      jr z,L1708
16D7 CD D4 22      L16D7:       call L22D4
16DA DD 77 0F                   ld (ix+$0F),a
16DD 4F                         ld c,a
16DE 47                         ld b,a
16DF AF                         xor a
16E0 37            L16E0:       scf
16E1 1F                         rra
16E2 10 FC                      djnz L16E0
16E4 DD 77 10                   ld (ix+$10),a
16E7 DD 75 0D                   ld (ix+$0D),l
16EA DD 74 0E                   ld (ix+$0E),h
16ED DD 6E 11                   ld l,(ix+$11)
16F0 60                         ld h,b
16F1 29                         add hl,hl
16F2 29                         add hl,hl
16F3 29                         add hl,hl
16F4 AF                         xor a
16F5 DD CB 1D 66                bit 4,(ix+$1D)
16F9 28 01                      jr z,L16FC
16FB 29                         add hl,hl
16FC ED 42         L16FC:       sbc hl,bc
16FE 3C                         inc a
16FF 30 FB                      jr nc,L16FC
1701 3D                         dec a
1702 DD 77 1C                   ld (ix+$1C),a
1705 C3 43 20                   jp L2043
1708 E6 03         L1708:       and $03
170A FE 03                      cp $03
170C C8                         ret z
170D 47                         ld b,a
170E DD 7E 19                   ld a,(ix+$19)
1711 E6 FC                      and $FC
1713 B0                         or b
1714 DD 77 19                   ld (ix+$19),a
1717 C9                         ret
1718 21 4C 16      L1718:       ld hl,$164C
171B C3 61 1D                   jp L1D61
171E DD CB 25 B6   L171E:       res 6,(ix+$25)
1722 DD CB 25 7E                bit 7,(ix+$25)
1726 20 A5                      jr nz,L16CD
1728 18 32                      jr L175C
172A DD CB 19 7E                bit 7,(ix+$19)
172E C8                         ret z
172F DD CB 25 F6                set 6,(ix+$25)
1733 18 27                      jr L175C
1735 7B            L1735:       ld a,e
1736 DD CB 25 76                bit 6,(ix+$25)
173A 20 E2                      jr nz,L171E
173C FE 20                      cp $20
173E 38 D8                      jr c,L1718
1740 20 14         L1740:       jr nz,L1756
1742 DD 7E 2A                   ld a,(ix+$2A)
1745 A7                         and a
1746 C8                         ret z
1747 DD 77 2C                   ld (ix+$2C),a
174A DD 7E 29                   ld a,(ix+$29)
174D 3D                         dec a
174E DD 77 2B                   ld (ix+$2B),a
1751 DD 34 2A                   inc (ix+$2A)
1754 18 06                      jr L175C
1756 DD 34 2A      L1756:       inc (ix+$2A)
1759 CD D9 18                   call L18D9
175C CD 95 16      L175C:       call L1695
175F DD 7E 29                   ld a,(ix+$29)
1762 ED 31                      add hl,a
1764 73                         ld (hl),e
1765 3C                         inc a
1766 DD 77 29                   ld (ix+$29),a
1769 DD CB 25 76                bit 6,(ix+$25)
176D C0                         ret nz
176E FE FE                      cp $FE
1770 30 07                      jr nc,L1779
1772 CD B5 16                   call L16B5
1775 DD BE 2A                   cp (ix+$2A)
1778 D0                         ret nc
1779 CD B5 16      L1779:       call L16B5
177C DD BE 2A                   cp (ix+$2A)
177F 30 36                      jr nc,L17B7
1781 DD 7E 2C                   ld a,(ix+$2C)
1784 FE 01                      cp $01
1786 DD 7E 2B                   ld a,(ix+$2B)
1789 28 03                      jr z,L178E
178B A7                         and a
178C 28 07                      jr z,L1795
178E 4F            L178E:       ld c,a
178F 0C                         inc c
1790 DD 46 2C                   ld b,(ix+$2C)
1793 18 28                      jr L17BD
1795 CD 95 16      L1795:       call L1695
1798 CD B5 16                   call L16B5
179B 47                         ld b,a
179C 0E 00                      ld c,$00
179E 7E            L179E:       ld a,(hl)
179F 23                         inc hl
17A0 0C                         inc c
17A1 FE 20                      cp $20
17A3 30 0B                      jr nc,L17B0
17A5 CD C0 16                   call L16C0
17A8 7E                         ld a,(hl)
17A9 23                         inc hl
17AA 0C                         inc c
17AB CD C0 16                   call L16C0
17AE 18 EE                      jr L179E
17B0 CD C0 16      L17B0:       call L16C0
17B3 10 E9                      djnz L179E
17B5 18 7C                      jr L1833
17B7 DD 4E 29      L17B7:       ld c,(ix+$29)
17BA DD 46 2A                   ld b,(ix+$2A)
17BD 79            L17BD:       ld a,c
17BE A7                         and a
17BF C8                         ret z
17C0 CD 95 16                   call L1695
17C3 DD 7E 19                   ld a,(ix+$19)
17C6 E6 03                      and $03
17C8 28 30                      jr z,L17FA
17CA CD B5 16                   call L16B5
17CD 90                         sub b
17CE 5F                         ld e,a
17CF DD 7E 19                   ld a,(ix+$19)
17D2 E6 02                      and $02
17D4 20 10                      jr nz,L17E6
17D6 7B                         ld a,e
17D7 CB 3F                      srl a
17D9 A7            L17D9:       and a
17DA 28 1E                      jr z,L17FA
17DC F5                         push af
17DD 3E 20                      ld a,$20
17DF CD C0 16                   call L16C0
17E2 F1                         pop af
17E3 3D                         dec a
17E4 18 F3                      jr L17D9
17E6 C5            L17E6:       push bc
17E7 E5                         push hl
17E8 16 00                      ld d,$00
17EA 7E            L17EA:       ld a,(hl)
17EB 23                         inc hl
17EC FE 20                      cp $20
17EE 20 01                      jr nz,L17F1
17F0 14                         inc d
17F1 30 02         L17F1:       jr nc,L17F5
17F3 23                         inc hl
17F4 0D                         dec c
17F5 0D            L17F5:       dec c
17F6 20 F2                      jr nz,L17EA
17F8 E1                         pop hl
17F9 C1                         pop bc
17FA 06 00         L17FA:       ld b,$00
17FC C5                         push bc
17FD 7E            L17FD:       ld a,(hl)
17FE CD C0 16                   call L16C0
1801 FE 20                      cp $20
1803 30 08                      jr nc,L180D
1805 23                         inc hl
1806 0D                         dec c
1807 7E                         ld a,(hl)
1808 CD C0 16                   call L16C0
180B 18 21                      jr L182E
180D 20 1F         L180D:       jr nz,L182E
180F DD 7E 19                   ld a,(ix+$19)
1812 E6 02                      and $02
1814 28 18                      jr z,L182E
1816 7B                         ld a,e
1817 06 00                      ld b,$00
1819 92            L1819:       sub d
181A 38 03                      jr c,L181F
181C 04                         inc b
181D 18 FA                      jr L1819
181F 15            L181F:       dec d
1820 78                         ld a,b
1821 A7                         and a
1822 28 0A                      jr z,L182E
1824 7B                         ld a,e
1825 90                         sub b
1826 5F                         ld e,a
1827 3E 20         L1827:       ld a,$20
1829 CD C0 16                   call L16C0
182C 10 F9                      djnz L1827
182E 23            L182E:       inc hl
182F 0D                         dec c
1830 20 CB                      jr nz,L17FD
1832 C1                         pop bc
1833 C5            L1833:       push bc
1834 CD 43 20                   call L2043
1837 C1                         pop bc
1838 CD 95 16                   call L1695
183B 09                         add hl,bc
183C DD 7E 29                   ld a,(ix+$29)
183F 91                         sub c
1840 47                         ld b,a
1841 F5                         push af
1842 CD A8 18                   call L18A8
1845 F1                         pop af
1846 C8                         ret z
1847 7E            L1847:       ld a,(hl)
1848 FE 20                      cp $20
184A 20 04                      jr nz,L1850
184C 23                         inc hl
184D 10 F8                      djnz L1847
184F C9                         ret
1850 C5            L1850:       push bc
1851 E5                         push hl
1852 5E                         ld e,(hl)
1853 7B                         ld a,e
1854 FE 20                      cp $20
1856 38 09                      jr c,L1861
1858 CD 40 17                   call L1740
185B E1            L185B:       pop hl
185C C1                         pop bc
185D 23                         inc hl
185E 10 F0                      djnz L1850
1860 C9                         ret
1861 CD 5C 17      L1861:       call L175C
1864 E1                         pop hl
1865 C1                         pop bc
1866 23                         inc hl
1867 05                         dec b
1868 C8                         ret z
1869 C5                         push bc
186A E5                         push hl
186B 5E                         ld e,(hl)
186C CD 5C 17                   call L175C
186F 18 EA                      jr L185B
1871 DD CB 19 66                bit 4,(ix+$19)
1875 C8                         ret z
1876 DD 7E 0F                   ld a,(ix+$0F)
1879 3C                         inc a
187A FE 09                      cp $09
187C D0                         ret nc
187D C3 D7 16      L187D:       jp L16D7
1880 DD CB 19 66                bit 4,(ix+$19)
1884 28 09                      jr z,L188F
1886 DD 7E 0F                   ld a,(ix+$0F)
1889 3D                         dec a
188A FE 03                      cp $03
188C 30 EF                      jr nc,L187D
188E C9                         ret
188F DD 7E 24      L188F:       ld a,(ix+$24)
1892 A7                         and a
1893 C4 43 20                   call nz,L2043
1896 CD 9D 16                   call L169D
1899 CD E7 19                   call L19E7
189C DD CB 19 EE                set 5,(ix+$19)
18A0 DD CB 25 B6                res 6,(ix+$25)
18A4 DD CB 25 BE                res 7,(ix+$25)
18A8 AF            L18A8:       xor a
18A9 DD 77 29                   ld (ix+$29),a
18AC DD 77 2A                   ld (ix+$2A),a
18AF DD 77 2C                   ld (ix+$2C),a
18B2 DD 77 2B                   ld (ix+$2B),a
18B5 C9                         ret
18B6 DD 7E 29      L18B6:       ld a,(ix+$29)
18B9 F5                         push af
18BA DD 7E 19      L18BA:       ld a,(ix+$19)
18BD F5                         push af
18BE DD CB 19 8E                res 1,(ix+$19)
18C2 CD 79 17                   call L1779
18C5 F1                         pop af
18C6 DD 77 19                   ld (ix+$19),a
18C9 DD 7E 29                   ld a,(ix+$29)
18CC A7                         and a
18CD 20 EB                      jr nz,L18BA
18CF F1                         pop af
18D0 A7                         and a
18D1 C0                         ret nz
18D2 CD A2 1A                   call L1AA2
18D5 D8                         ret c
18D6 C3 71 20                   jp L2071
18D9 CD EF 18      L18D9:       call L18EF
18DC C0                         ret nz
18DD DD 56 2A                   ld d,(ix+$2A)
18E0 CD B5 16                   call L16B5
18E3 BA                         cp d
18E4 D8                         ret c
18E5 DD 72 2C                   ld (ix+$2C),d
18E8 DD 7E 29                   ld a,(ix+$29)
18EB DD 77 2B                   ld (ix+$2B),a
18EE C9                         ret
18EF FE 2C         L18EF:       cp $2C
18F1 C8                         ret z
18F2 FE 2E                      cp $2E
18F4 C8                         ret z
18F5 FE 21                      cp $21
18F7 C8                         ret z
18F8 FE 3F                      cp $3F
18FA C8                         ret z
18FB FE 3B                      cp $3B
18FD C8                         ret z
18FE FE 3A                      cp $3A
1900 C9                         ret
1901 DD CB 19 66                bit 4,(ix+$19)
1905 20 0D                      jr nz,L1914
1907 DD CB 19 BE                res 7,(ix+$19)
190B 1F                         rra
190C D0                         ret nc
190D DD CB 19 FE                set 7,(ix+$19)
1911 C9                         ret
1912 3E 08         L1912:       ld a,$08
1914 CD D4 22      L1914:       call L22D4
1917 EB                         ex de,hl
1918 2A 36 5C                   ld hl,($5C36)
191B 14                         inc d
191C 24                         inc h
191D 01 00 03                   ld bc,$0300
1920 7C                         ld a,h
1921 FE BD                      cp $BD
1923 30 22                      jr nc,L1947
1925 E6 C0                      and $C0
1927 28 03                      jr z,L192C
1929 ED B0                      ldir
192B C9                         ret
192C E5            L192C:       push hl
192D D5                         push de
192E C5                         push bc
192F 16 54                      ld d,$54
1931 CD BA 27                   call SetMMU100B
1934 C1                         pop bc
1935 D1                         pop de
1936 E3                         ex (sp),hl
1937 CB B2                      res 6,d
1939 EF                         rst $28
193A C3 33 16                   jp L1633
193D 54                         ld d,h
193E E1                         pop hl
193F CD BD 27                   call SetMMU
1942 16 56         L1942:       ld d,$56
1944 C3 BA 27                   jp SetMMU100B
1947 C5            L1947:       push bc
1948 D5                         push de
1949 E5                         push hl
194A CD B3 27                   call L27B3
194D E3                         ex (sp),hl
194E 7E                         ld a,(hl)
194F 23                         inc hl
1950 E3                         ex (sp),hl
1951 F5                         push af
1952 15                         dec d
1953 CD BD 27                   call SetMMU
1956 F1                         pop af
1957 E1                         pop hl
1958 D1                         pop de
1959 C1                         pop bc
195A 12                         ld (de),a
195B 13                         inc de
195C 0B                         dec bc
195D 78                         ld a,b
195E B1                         or c
195F 20 E6                      jr nz,L1947
1961 C9                         ret
1962 16 54         L1962:       ld d,$54
1964 CD BA 27                   call SetMMU100B
1967 E5                         push hl
1968 CD 9B 23                   call ExpFont
196B 18 CF                      jr L193C
196D DD CB 19 66                bit 4,(ix+$19)
1971 20 9F                      jr nz,L1912
1973 DD CB 25 5E                bit 3,(ix+$25)
1977 20 14                      jr nz,L198D
1979 CD 0B 1A                   call L1A0B
197C DD E5                      push ix
197E E1                         pop hl
197F DD 5E 0B                   ld e,(ix+$0B)
1982 DD 56 0C                   ld d,(ix+$0C)
1985 19                         add hl,de
1986 CD E7 19                   call L19E7
1989 DD CB 25 DE                set 3,(ix+$25)
198D FD 36 58 80   L198D:       ld (iy+$58),$80
1991 11 8A 21      L1991:       ld de,$218A
1994 DD E5                      push ix
1996 E1                         pop hl
1997 DD 4E 0B                   ld c,(ix+$0B)
199A DD 46 0C                   ld b,(ix+$0C)
199D 09                         add hl,bc
199E E5                         push hl
199F CD 0B 1A                   call L1A0B
19A2 E1                         pop hl
19A3 A7                         and a
19A4 ED 42                      sbc hl,bc
19A6 22 9B 5B                   ld ($5B9B),hl
19A9 22 58 F3                   ld ($F358),hl
19AC EB                         ex de,hl
19AD C3 C9 20                   jp L20C9
19B0 DD CB 19 66                bit 4,(ix+$19)
19B4 20 AC                      jr nz,L1962
19B6 DD CB 25 5E                bit 3,(ix+$25)
19BA C8                         ret z
19BB FD 36 58 00                ld (iy+$58),$00
19BF CD 91 19                   call L1991
19C2 CD 0B 1A                   call L1A0B
19C5 2A 58 F3                   ld hl,($F358)
19C8 DD CB 25 9E                res 3,(ix+$25)
19CC E5            L19CC:       push hl
19CD DD 6E 0B                   ld l,(ix+$0B)
19D0 DD 66 0C                   ld h,(ix+$0C)
19D3 A7                         and a
19D4 ED 42                      sbc hl,bc
19D6 DD 75 0B                   ld (ix+$0B),l
19D9 DD 74 0C                   ld (ix+$0C),h
19DC E1                         pop hl
19DD F7                         rst $30
19DE CD 3F 05                   call L053F
19E1 CD CD 15                   call L15CD
19E4 C3 42 19      L19E4:       jp L1942
19E7 E5            L19E7:       push hl
19E8 DD 6E 0B                   ld l,(ix+$0B)
19EB DD 66 0C                   ld h,(ix+$0C)
19EE 09                         add hl,bc
19EF DD 75 0B                   ld (ix+$0B),l
19F2 DD 74 0C                   ld (ix+$0C),h
19F5 E1                         pop hl
19F6 F7                         rst $30
19F7 CD 77 05                   call L0577
19FA CD CD 15                   call L15CD
19FD 18 E5                      jr L19E4
19FF CD B6 18                   call L18B6
1A02 CD 9D 16                   call L169D
1A05 DD CB 19 AE                res 5,(ix+$19)
1A09 18 C1                      jr L19CC
1A0B 21 00 00      L1A0B:       ld hl,$0000
1A0E DD 4E 11                   ld c,(ix+$11)
1A11 44                         ld b,h
1A12 DD 7E 12                   ld a,(ix+$12)
1A15 09            L1A15:       add hl,bc
1A16 3D                         dec a
1A17 20 FC                      jr nz,L1A15
1A19 4D                         ld c,l
1A1A 44                         ld b,h
1A1B 29                         add hl,hl
1A1C 29                         add hl,hl
1A1D 29                         add hl,hl
1A1E CD F9 26                   call L26F9
1A21 38 08                      jr c,L1A2B
1A23 28 02                      jr z,L1A27
1A25 44                         ld b,h
1A26 4D                         ld c,l
1A27 09            L1A27:       add hl,bc
1A28 44            L1A28:       ld b,h
1A29 4D                         ld c,l
1A2A C9                         ret
1A2B 29            L1A2B:       add hl,hl
1A2C 29                         add hl,hl
1A2D 29                         add hl,hl
1A2E 18 F8                      jr L1A28
1A30 DD 7E 17      L1A30:       ld a,(ix+$17)
1A33 DD 77 22      L1A33:       ld (ix+$22),a
1A36 DD 7E 13                   ld a,(ix+$13)
1A39 DD 77 21                   ld (ix+$21),a
1A3C DD 36 23 00                ld (ix+$23),$00
1A40 DD 36 24 00                ld (ix+$24),$00
1A44 C9                         ret
1A45 DD 7E 18                   ld a,(ix+$18)
1A48 18 E9                      jr L1A33
1A4A DD 7E 24                   ld a,(ix+$24)
1A4D A7                         and a
1A4E C8                         ret z
1A4F DD 35 24      L1A4F:       dec (ix+$24)
1A52 DD 7E 23                   ld a,(ix+$23)
1A55 DD 96 0F                   sub (ix+$0F)
1A58 DD 77 23                   ld (ix+$23),a
1A5B D0                         ret nc
1A5C DD 86 1D                   add a,(ix+$1D)
1A5F DD 77 23                   ld (ix+$23),a
1A62 DD 35 21                   dec (ix+$21)
1A65 C9                         ret
1A66 DD 7E 24                   ld a,(ix+$24)
1A69 3C                         inc a
1A6A DD BE 1C                   cp (ix+$1C)
1A6D D0                         ret nc
1A6E DD 77 24                   ld (ix+$24),a
1A71 DD 7E 23                   ld a,(ix+$23)
1A74 DD 86 0F                   add a,(ix+$0F)
1A77 DD 77 23                   ld (ix+$23),a
1A7A DD BE 1D                   cp (ix+$1D)
1A7D D8                         ret c
1A7E DD 96 1D                   sub (ix+$1D)
1A81 DD 77 23                   ld (ix+$23),a
1A84 DD 34 21                   inc (ix+$21)
1A87 C9                         ret
1A88 DD 7E 22      L1A88:       ld a,(ix+$22)
1A8B C6 08                      add a,$08
1A8D DD CB 25 46                bit 0,(ix+$25)
1A91 C8                         ret z
1A92 3D                         dec a
1A93 3D                         dec a
1A94 C9                         ret
1A95 DD 7E 22      L1A95:       ld a,(ix+$22)
1A98 D6 08                      sub $08
1A9A DD CB 25 46                bit 0,(ix+$25)
1A9E C8                         ret z
1A9F 3C                         inc a
1AA0 3C                         inc a
1AA1 C9                         ret
1AA2 DD 7E 16      L1AA2:       ld a,(ix+$16)
1AA5 87                         add a,a
1AA6 87                         add a,a
1AA7 87                         add a,a
1AA8 3C                         inc a
1AA9 47                         ld b,a
1AAA DD 7E 22                   ld a,(ix+$22)
1AAD C6 08                      add a,$08
1AAF DD CB 25 46                bit 0,(ix+$25)
1AB3 28 04                      jr z,L1AB9
1AB5 3D                         dec a
1AB6 3D                         dec a
1AB7 04                         inc b
1AB8 04                         inc b
1AB9 B8            L1AB9:       cp b
1ABA D0                         ret nc
1ABB DD 77 22                   ld (ix+$22),a
1ABE C9                         ret
1ABF CD 95 1A                   call L1A95
1AC2 D8                         ret c
1AC3 DD BE 17                   cp (ix+$17)
1AC6 D8                         ret c
1AC7 DD 77 22                   ld (ix+$22),a
1ACA C9                         ret
1ACB 1E 22                      ld e,$22
1ACD 18 1F                      jr L1AEE
1ACF 1E 23                      ld e,$23
1AD1 DD 77 2B                   ld (ix+$2B),a
1AD4 18 1B                      jr L1AF1
1AD6 1E 21                      ld e,$21
1AD8 18 14                      jr L1AEE
1ADA 1E 20                      ld e,$20
1ADC 16 FF                      ld d,$FF
1ADE BB                         cp e
1ADF 30 0C                      jr nc,L1AED
1AE1 87                         add a,a
1AE2 4F                         ld c,a
1AE3 87                         add a,a
1AE4 DD CB 25 46                bit 0,(ix+$25)
1AE8 20 01                      jr nz,L1AEB
1AEA 4F                         ld c,a
1AEB 81            L1AEB:       add a,c
1AEC 57                         ld d,a
1AED 7A            L1AED:       ld a,d
1AEE DD 77 2D      L1AEE:       ld (ix+$2D),a
1AF1 DD 73 26      L1AF1:       ld (ix+$26),e
1AF4 C9                         ret
1AF5 67                         ld h,a
1AF6 DD 6E 2B                   ld l,(ix+$2B)
1AF9 E5            L1AF9:       push hl
1AFA 16 00                      ld d,$00
1AFC DD 5E 0F                   ld e,(ix+$0F)
1AFF 19                         add hl,de
1B00 2B                         dec hl
1B01 7C                         ld a,h
1B02 4D                         ld c,l
1B03 62                         ld h,d
1B04 6A                         ld l,d
1B05 06 10                      ld b,$10
1B07 CB 11         L1B07:       rl c
1B09 17                         rla
1B0A ED 6A                      adc hl,hl
1B0C ED 52                      sbc hl,de
1B0E 30 01                      jr nc,L1B11
1B10 19                         add hl,de
1B11 10 F4         L1B11:       djnz L1B07
1B13 CB 11                      rl c
1B15 17                         rla
1B16 2F                         cpl
1B17 A7                         and a
1B18 20 64                      jr nz,L1B7E
1B1A 79                         ld a,c
1B1B 2F                         cpl
1B1C D1                         pop de
1B1D F5                         push af
1B1E DD CB 1D 66                bit 4,(ix+$1D)
1B22 26 00                      ld h,$00
1B24 28 12                      jr z,L1B38
1B26 CB 5B                      bit 3,e
1B28 28 02                      jr z,L1B2C
1B2A 26 08                      ld h,$08
1B2C 7B            L1B2C:       ld a,e
1B2D E6 07                      and $07
1B2F 6F                         ld l,a
1B30 7A                         ld a,d
1B31 1F                         rra
1B32 7B                         ld a,e
1B33 1F                         rra
1B34 E6 F8                      and $F8
1B36 B5                         or l
1B37 5F                         ld e,a
1B38 7B            L1B38:       ld a,e
1B39 E6 07                      and $07
1B3B 84                         add a,h
1B3C 67                         ld h,a
1B3D 7B                         ld a,e
1B3E 1F                         rra
1B3F 1F                         rra
1B40 1F                         rra
1B41 E6 1F                      and $1F
1B43 DD 86 13                   add a,(ix+$13)
1B46 6F                         ld l,a
1B47 D1                         pop de
1B48 18 18                      jr L1B62
1B4A 57            L1B4A:       ld d,a
1B4B 47                         ld b,a
1B4C 04                         inc b
1B4D DD 6E 13                   ld l,(ix+$13)
1B50 AF                         xor a
1B51 DD 5E 1D                   ld e,(ix+$1D)
1B54 05            L1B54:       dec b
1B55 28 0A                      jr z,L1B61
1B57 DD 86 0F                   add a,(ix+$0F)
1B5A BB                         cp e
1B5B 38 F7                      jr c,L1B54
1B5D 93                         sub e
1B5E 2C                         inc l
1B5F 18 F3                      jr L1B54
1B61 67            L1B61:       ld h,a
1B62 7A            L1B62:       ld a,d
1B63 DD BE 1C                   cp (ix+$1C)
1B66 30 16                      jr nc,L1B7E
1B68 DD 77 24                   ld (ix+$24),a
1B6B DD 75 21                   ld (ix+$21),l
1B6E DD 74 23                   ld (ix+$23),h
1B71 DD 7E 2D                   ld a,(ix+$2D)
1B74 DD 86 17                   add a,(ix+$17)
1B77 38 05                      jr c,L1B7E
1B79 DD BE 18                   cp (ix+$18)
1B7C 38 05                      jr c,L1B83
1B7E 3E 04         L1B7E:       ld a,$04
1B80 C3 AF 27                   jp L27AF
1B83 DD 77 22      L1B83:       ld (ix+$22),a
1B86 C9                         ret
1B87 DD 7E 22                   ld a,(ix+$22)
1B8A DD 46 17                   ld b,(ix+$17)
1B8D 90                         sub b
1B8E DD 77 2D                   ld (ix+$2D),a
1B91 DD 7E 24                   ld a,(ix+$24)
1B94 A7                         and a
1B95 20 0B                      jr nz,L1BA2
1B97 CD 95 1A                   call L1A95
1B9A 90                         sub b
1B9B D8                         ret c
1B9C DD 77 2D                   ld (ix+$2D),a
1B9F DD 7E 1C                   ld a,(ix+$1C)
1BA2 3D            L1BA2:       dec a
1BA3 F5                         push af
1BA4 CD 4A 1B                   call L1B4A
1BA7 CD AD 1B                   call L1BAD
1BAA F1                         pop af
1BAB 18 9D                      jr L1B4A
1BAD F5            L1BAD:       push af
1BAE DD 7E 25                   ld a,(ix+$25)
1BB1 F5                         push af
1BB2 DD CB 25 A6                res 4,(ix+$25)
1BB6 3E 20                      ld a,$20
1BB8 CD 6B 1D                   call L1D6B
1BBB F1                         pop af
1BBC DD 77 25                   ld (ix+$25),a
1BBF F1                         pop af
1BC0 C9                         ret
1BC1 DD 6E 2D                   ld l,(ix+$2D)
1BC4 67                         ld h,a
1BC5 DD 4E 1C      L1BC5:       ld c,(ix+$1C)
1BC8 06 00                      ld b,$00
1BCA A7                         and a
1BCB ED 42         L1BCB:       sbc hl,bc
1BCD 30 FC                      jr nc,L1BCB
1BCF 09                         add hl,bc
1BD0 7D                         ld a,l
1BD1 DD 46 24                   ld b,(ix+$24)
1BD4 90                         sub b
1BD5 30 01                      jr nc,L1BD8
1BD7 81                         add a,c
1BD8 A7            L1BD8:       and a
1BD9 C8                         ret z
1BDA CD AD 1B                   call L1BAD
1BDD 3D                         dec a
1BDE 18 F8                      jr L1BD8
1BE0 DD 7E 1C                   ld a,(ix+$1C)
1BE3 CB 3F                      srl a
1BE5 DD BE 24                   cp (ix+$24)
1BE8 6F                         ld l,a
1BE9 26 00                      ld h,$00
1BEB 30 D8                      jr nc,L1BC5
1BED 6C                         ld l,h
1BEE 18 D5                      jr L1BC5
1BF0 CD F8 26                   call L26F8
1BF3 38 2B                      jr c,L1C20
1BF5 3D                         dec a
1BF6 28 48                      jr z,L1C40
1BF8 3A 64 5B                   ld a,($5B64)
1BFB A7                         and a
1BFC 20 09                      jr nz,L1C07
1BFE 7B                         ld a,e
1BFF FE 08                      cp $08
1C01 30 72                      jr nc,L1C75
1C03 16 F8                      ld d,$F8
1C05 18 05                      jr L1C0C
1C07 2F            L1C07:       cpl
1C08 57                         ld d,a
1C09 A3                         and e
1C0A 20 69                      jr nz,L1C75
1C0C DD 7E 1F      L1C0C:       ld a,(ix+$1F)
1C0F A2                         and d
1C10 B3                         or e
1C11 DD 77 1F                   ld (ix+$1F),a
1C14 3E 61                      ld a,$61
1C16 FD CB 45 5E                bit 3,(iy+$45)
1C1A 28 0B                      jr z,L1C27
1C1C 3E 63                      ld a,$63
1C1E 18 07                      jr L1C27
1C20 DD 73 1F      L1C20:       ld (ix+$1F),e
1C23 16 00                      ld d,$00
1C25 C6 5E                      add a,$5E
1C27 21 6C 5C      L1C27:       ld hl,$5C6C
1C2A 47            L1C2A:       ld b,a
1C2B 7E                         ld a,(hl)
1C2C A2                         and d
1C2D B3                         or e
1C2E 77                         ld (hl),a
1C2F FD CB 45 6E                bit 5,(iy+$45)
1C33 C8                         ret z
1C34 68                         ld l,b
1C35 26 5B                      ld h,$5B
1C37 7E                         ld a,(hl)
1C38 A2                         and d
1C39 B3                         or e
1C3A 77                         ld (hl),a
1C3B C9                         ret
1C3C 7B            L1C3C:       ld a,e
1C3D EE 07                      xor $07
1C3F 5F                         ld e,a
1C40 7B            L1C40:       ld a,e
1C41 FE 08                      cp $08
1C43 30 30                      jr nc,L1C75
1C45 87                         add a,a
1C46 87                         add a,a
1C47 87                         add a,a
1C48 5F                         ld e,a
1C49 16 00                      ld d,$00
1C4B F6 06                      or $06
1C4D D3 FF                      out ($FF),a
1C4F 3E 62                      ld a,$62
1C51 18 D4                      jr L1C27
1C53 CD F8 26                   call L26F8
1C56 38 31                      jr c,L1C89
1C58 3D                         dec a
1C59 28 E1                      jr z,L1C3C
1C5B 3A 64 5B                   ld a,($5B64)
1C5E A7                         and a
1C5F 20 0D                      jr nz,L1C6E
1C61 7B                         ld a,e
1C62 FE 08                      cp $08
1C64 30 0F                      jr nc,L1C75
1C66 87                         add a,a
1C67 87                         add a,a
1C68 87                         add a,a
1C69 5F                         ld e,a
1C6A 16 C7                      ld d,$C7
1C6C 18 9E                      jr L1C0C
1C6E 2F            L1C6E:       cpl
1C6F A7                         and a
1C70 20 08                      jr nz,L1C7A
1C72 1C                         inc e
1C73 1D                         dec e
1C74 C8                         ret z
1C75 3E 13         L1C75:       ld a,$13
1C77 C3 AF 27                   jp L27AF
1C7A 1F            L1C7A:       rra
1C7B 38 06                      jr c,L1C83
1C7D CB 23                      sla e
1C7F 30 F9                      jr nc,L1C7A
1C81 18 F2                      jr L1C75
1C83 3A 64 5B      L1C83:       ld a,($5B64)
1C86 57                         ld d,a
1C87 18 83                      jr L1C0C
1C89 16 00         L1C89:       ld d,$00
1C8B DD 73 20                   ld (ix+$20),e
1C8E 21 6D 5C                   ld hl,$5C6D
1C91 3D                         dec a
1C92 3E 88                      ld a,$88
1C94 28 94                      jr z,L1C2A
1C96 3C                         inc a
1C97 18 91                      jr L1C2A
1C99 CD F8 26                   call L26F8
1C9C D8                         ret c
1C9D 3D                         dec a
1C9E C8                         ret z
1C9F 3A 64 5B                   ld a,($5B64)
1CA2 A7                         and a
1CA3 C0                         ret nz
1CA4 7B                         ld a,e
1CA5 FE 02                      cp $02
1CA7 30 CC                      jr nc,L1C75
1CA9 0F                         rrca
1CAA 5F                         ld e,a
1CAB 16 7F                      ld d,$7F
1CAD C3 0C 1C      L1CAD:       jp L1C0C
1CB0 CD F8 26                   call L26F8
1CB3 D8                         ret c
1CB4 3D                         dec a
1CB5 C8                         ret z
1CB6 3A 64 5B                   ld a,($5B64)
1CB9 A7                         and a
1CBA C0                         ret nz
1CBB 7B                         ld a,e
1CBC FE 02                      cp $02
1CBE 30 B5                      jr nc,L1C75
1CC0 0F                         rrca
1CC1 0F                         rrca
1CC2 5F                         ld e,a
1CC3 16 BF                      ld d,$BF
1CC5 18 E6                      jr L1CAD
1CC7 CD F8 26                   call L26F8
1CCA D8                         ret c
1CCB 3D                         dec a
1CCC C8                         ret z
1CCD 16 00                      ld d,$00
1CCF 18 DC                      jr L1CAD
1CD1 FE 02         L1CD1:       cp $02
1CD3 30 A0                      jr nc,L1C75
1CD5 1F                         rra
1CD6 3E 00                      ld a,$00
1CD8 9F                         sbc a,a
1CD9 C9                         ret
1CDA CD D1 1C                   call L1CD1
1CDD DD 77 27                   ld (ix+$27),a
1CE0 E6 0C                      and $0C
1CE2 16 F3                      ld d,$F3
1CE4 FD CB 45 6E   L1CE4:       bit 5,(iy+$45)
1CE8 20 06                      jr nz,L1CF0
1CEA E6 05                      and $05
1CEC CB DA                      set 3,d
1CEE CB CA                      set 1,d
1CF0 5F            L1CF0:       ld e,a
1CF1 3A 91 5C                   ld a,($5C91)
1CF4 A2                         and d
1CF5 B3                         or e
1CF6 32 91 5C                   ld ($5C91),a
1CF9 C9                         ret
1CFA CD D1 1C                   call L1CD1
1CFD DD 77 28                   ld (ix+$28),a
1D00 E6 03                      and $03
1D02 16 FC                      ld d,$FC
1D04 18 DE                      jr L1CE4
1D06 5F                         ld e,a
1D07 CD 30 1A                   call L1A30
1D0A DD 7E 12                   ld a,(ix+$12)
1D0D 4F                         ld c,a
1D0E 7B                         ld a,e
1D0F DD 46 1C      L1D0F:       ld b,(ix+$1C)
1D12 F5            L1D12:       push af
1D13 C5                         push bc
1D14 CD 6B 1D                   call L1D6B
1D17 C1                         pop bc
1D18 F1                         pop af
1D19 10 F7                      djnz L1D12
1D1B 0D                         dec c
1D1C 20 F1                      jr nz,L1D0F
1D1E C9                         ret
1D1F DD CB 25 A6                res 4,(ix+$25)
1D23 1F                         rra
1D24 D0                         ret nc
1D25 DD CB 25 E6                set 4,(ix+$25)
1D29 C9                         ret
1D2A DD CB 25 AE                res 5,(ix+$25)
1D2E 1F                         rra
1D2F 30 04                      jr nc,L1D35
1D31 DD CB 25 EE                set 5,(ix+$25)
1D35 DD CB 25 86   L1D35:       res 0,(ix+$25)
1D39 1F                         rra
1D3A D0                         ret nc
1D3B DD CB 25 C6                set 0,(ix+$25)
1D3F C9                         ret
1D40 DD CB 19 6E   L1D40:       bit 5,(ix+$19)
1D44 C2 35 17                   jp nz,L1735
1D47 DD 7E 26      L1D47:       ld a,(ix+$26)
1D4A A7                         and a
1D4B 20 0D                      jr nz,L1D5A
1D4D 7B                         ld a,e
1D4E FE 20                      cp $20
1D50 30 19                      jr nc,L1D6B
1D52 FE 10                      cp $10
1D54 38 08                      jr c,L1D5E
1D56 DD 77 26                   ld (ix+$26),a
1D59 C9                         ret
1D5A DD 36 26 00   L1D5A:       ld (ix+$26),$00
1D5E 21 04 16      L1D5E:       ld hl,$1604
1D61 ED 31         L1D61:       add hl,a
1D63 ED 31                      add hl,a
1D65 4E                         ld c,(hl)
1D66 23                         inc hl
1D67 66                         ld h,(hl)
1D68 69                         ld l,c
1D69 7B                         ld a,e
1D6A E9                         jp (hl)
1D6B 26 00         L1D6B:       ld h,$00
1D6D 6F                         ld l,a
1D6E 29                         add hl,hl
1D6F 29                         add hl,hl
1D70 29                         add hl,hl
1D71 FE 80                      cp $80
1D73 38 38                      jr c,L1DAD
1D75 FE 90                      cp $90
1D77 30 1A                      jr nc,L1D93
1D79 5F                         ld e,a
1D7A 21 50 F3                   ld hl,$F350
1D7D E5                         push hl
1D7E DD 7E 0F                   ld a,(ix+$0F)
1D81 4F                         ld c,a
1D82 CB 39                      srl c
1D84 91                         sub c
1D85 47                         ld b,a
1D86 05                         dec b
1D87 0D                         dec c
1D88 C5                         push bc
1D89 CD BD 22                   call L22BD
1D8C C1                         pop bc
1D8D CD BD 22                   call L22BD
1D90 E1                         pop hl
1D91 18 53                      jr L1DE6
1D93 CD 3E 2B      L1D93:       call L2B3E
1D96 01 6B 1D                   ld bc,$1D6B
1D99 DA 5B 2B                   jp c,L2B5B
1D9C DD CB 25 8E                res 1,(ix+$25)
1DA0 ED 5B 7B 5C                ld de,(UDG)
1DA4 19                         add hl,de
1DA5 11 80 04                   ld de,$0480
1DA8 A7                         and a
1DA9 ED 52                      sbc hl,de
1DAB 18 19                      jr L1DC6
1DAD DD CB 25 8E   L1DAD:       res 1,(ix+$25)
1DB1 FE 20                      cp $20
1DB3 20 04                      jr nz,L1DB9
1DB5 DD CB 25 CE                set 1,(ix+$25)
1DB9 DD 4E 0D      L1DB9:       ld c,(ix+$0D)
1DBC DD 46 0E                   ld b,(ix+$0E)
1DBF 09                         add hl,bc
1DC0 DD CB 19 56                bit 2,(ix+$19)
1DC4 28 20                      jr z,L1DE6
1DC6 7C            L1DC6:       ld a,h
1DC7 FE BF                      cp $BF
1DC9 38 1B                      jr c,L1DE6
1DCB D6 40                      sub $40
1DCD 67                         ld h,a
1DCE E5                         push hl
1DCF 16 54                      ld d,$54
1DD1 CD B5 27                   call L27B5
1DD4 E3                         ex (sp),hl
1DD5 11 50 F3                   ld de,$F350
1DD8 01 08 00                   ld bc,$0008
1DDB ED B0                      ldir
1DDD E1                         pop hl
1DDE 16 54                      ld d,$54
1DE0 CD BD 27                   call SetMMU
1DE3 21 50 F3                   ld hl,$F350
1DE6 DD 7E 24      L1DE6:       ld a,(ix+$24)
1DE9 DD CB 25 66                bit 4,(ix+$25)
1DED 28 01                      jr z,L1DF0
1DEF 3C                         inc a
1DF0 DD BE 1C      L1DF0:       cp (ix+$1C)
1DF3 D4 43 20                   call nc,L2043
1DF6 DD 7E 25                   ld a,(ix+$25)
1DF9 E6 30                      and $30
1DFB CA AC 1E                   jp z,L1EAC
1DFE CB 67                      bit 4,a
1E00 28 68                      jr z,L1E6A
1E02 EB                         ex de,hl
1E03 21 30 F3                   ld hl,$F330
1E06 06 08                      ld b,$08
1E08 C5            L1E08:       push bc
1E09 DD 46 0F                   ld b,(ix+$0F)
1E0C CB 38                      srl b
1E0E 38 1B                      jr c,L1E2B
1E10 C5                         push bc
1E11 36 01                      ld (hl),$01
1E13 1A                         ld a,(de)
1E14 17            L1E14:       rla
1E15 F5                         push af
1E16 CB 16                      rl (hl)
1E18 F1                         pop af
1E19 CB 16                      rl (hl)
1E1B 10 F7                      djnz L1E14
1E1D 38 04                      jr c,L1E23
1E1F CB 16         L1E1F:       rl (hl)
1E21 30 FC                      jr nc,L1E1F
1E23 01 08 00      L1E23:       ld bc,$0008
1E26 09                         add hl,bc
1E27 36 01                      ld (hl),$01
1E29 18 1C                      jr L1E47
1E2B C5            L1E2B:       push bc
1E2C 36 01                      ld (hl),$01
1E2E 1A                         ld a,(de)
1E2F 17            L1E2F:       rla
1E30 F5                         push af
1E31 CB 16                      rl (hl)
1E33 F1                         pop af
1E34 CB 16                      rl (hl)
1E36 10 F7                      djnz L1E2F
1E38 17                         rla
1E39 F5                         push af
1E3A CB 16         L1E3A:       rl (hl)
1E3C 30 FC                      jr nc,L1E3A
1E3E 01 08 00                   ld bc,$0008
1E41 09                         add hl,bc
1E42 36 01                      ld (hl),$01
1E44 F1                         pop af
1E45 CB 16                      rl (hl)
1E47 C1            L1E47:       pop bc
1E48 17            L1E48:       rla
1E49 F5                         push af
1E4A CB 16                      rl (hl)
1E4C F1                         pop af
1E4D CB 16                      rl (hl)
1E4F 10 F7                      djnz L1E48
1E51 38 04                      jr c,L1E57
1E53 CB 16         L1E53:       rl (hl)
1E55 30 FC                      jr nc,L1E53
1E57 01 07 00      L1E57:       ld bc,$0007
1E5A A7                         and a
1E5B ED 42                      sbc hl,bc
1E5D 13                         inc de
1E5E C1                         pop bc
1E5F 10 A7                      djnz L1E08
1E61 21 30 F3                   ld hl,$F330
1E64 CD 6A 1E                   call L1E6A
1E67 21 38 F3                   ld hl,$F338
1E6A DD CB 25 6E   L1E6A:       bit 5,(ix+$25)
1E6E 28 3C                      jr z,L1EAC
1E70 EB                         ex de,hl
1E71 21 40 F3                   ld hl,$F340
1E74 06 08                      ld b,$08
1E76 1A            L1E76:       ld a,(de)
1E77 13                         inc de
1E78 77                         ld (hl),a
1E79 23                         inc hl
1E7A 77                         ld (hl),a
1E7B 23                         inc hl
1E7C 10 F8                      djnz L1E76
1E7E 21 40 F3                   ld hl,$F340
1E81 DD CB 25 46                bit 0,(ix+$25)
1E85 28 01                      jr z,L1E88
1E87 23                         inc hl
1E88 CD AC 1E      L1E88:       call L1EAC
1E8B CD 4F 1A                   call L1A4F
1E8E 21 48 F3                   ld hl,$F348
1E91 DD 7E 22                   ld a,(ix+$22)
1E94 C6 08                      add a,$08
1E96 DD CB 25 46                bit 0,(ix+$25)
1E9A 28 03                      jr z,L1E9F
1E9C 3D                         dec a
1E9D 3D                         dec a
1E9E 2B                         dec hl
1E9F DD 77 22      L1E9F:       ld (ix+$22),a
1EA2 CD AC 1E                   call L1EAC
1EA5 CD 95 1A                   call L1A95
1EA8 DD 77 22                   ld (ix+$22),a
1EAB C9                         ret
1EAC E5            L1EAC:       push hl
1EAD DD 46 18                   ld b,(ix+$18)
1EB0 04                         inc b
1EB1 CD 88 1A                   call L1A88
1EB4 B8                         cp b
1EB5 38 0B                      jr c,L1EC2
1EB7 DD 7E 22                   ld a,(ix+$22)
1EBA D6 08                      sub $08
1EBC DD 77 22                   ld (ix+$22),a
1EBF CD 71 20                   call L2071
1EC2 CD F9 26      L1EC2:       call L26F9
1EC5 DA E4 1F                   jp c,L1FE4
1EC8 DD 7E 21                   ld a,(ix+$21)
1ECB DD 56 22                   ld d,(ix+$22)
1ECE CD AC 22                   call L22AC
1ED1 DD CB 1E 5E                bit 3,(ix+$1E)
1ED5 DD 46 1F                   ld b,(ix+$1F)
1ED8 20 33                      jr nz,L1F0D
1EDA 08                         ex af,af'
1EDB 70                         ld (hl),b
1EDC DD 7E 23                   ld a,(ix+$23)
1EDF DD 86 0F                   add a,(ix+$0F)
1EE2 FE 09                      cp $09
1EE4 38 03                      jr c,L1EE9
1EE6 23                         inc hl
1EE7 70                         ld (hl),b
1EE8 2B                         dec hl
1EE9 DD 7E 22      L1EE9:       ld a,(ix+$22)
1EEC E6 07                      and $07
1EEE 28 27                      jr z,L1F17
1EF0 DD CB 25 46                bit 0,(ix+$25)
1EF4 28 04                      jr z,L1EFA
1EF6 FE 03                      cp $03
1EF8 38 1D                      jr c,L1F17
1EFA ED 34 20 00   L1EFA:       add hl,$0020
1EFE 70                         ld (hl),b
1EFF DD 7E 23                   ld a,(ix+$23)
1F02 DD 86 0F                   add a,(ix+$0F)
1F05 FE 09                      cp $09
1F07 38 0E                      jr c,L1F17
1F09 23                         inc hl
1F0A 70                         ld (hl),b
1F0B 18 0A                      jr L1F17
1F0D 78            L1F0D:       ld a,b
1F0E 08                         ex af,af'
1F0F DD CB 23 5E                bit 3,(ix+$23)
1F13 28 02                      jr z,L1F17
1F15 CB FA                      set 7,d
1F17 EB            L1F17:       ex de,hl
1F18 D9                         exx
1F19 E3                         ex (sp),hl
1F1A C5                         push bc
1F1B D5                         push de
1F1C 06 08                      ld b,$08
1F1E DD CB 25 46                bit 0,(ix+$25)
1F22 28 03                      jr z,L1F27
1F24 05                         dec b
1F25 05                         dec b
1F26 23                         inc hl
1F27 DD 5E 27      L1F27:       ld e,(ix+$27)
1F2A DD 55                      ld d,xl
1F2C DD 4E 10                   ld c,(ix+$10)
1F2F 79                         ld a,c
1F30 D9                         exx
1F31 2F                         cpl
1F32 DD B6 28                   or (ix+$28)
1F35 57                         ld d,a
1F36 DD 46 23                   ld b,(ix+$23)
1F39 CB 98                      res 3,b
1F3B DD 7E 1E                   ld a,(ix+$1E)
1F3E FE 0D                      cp $0D
1F40 28 09                      jr z,L1F4B
1F42 78                         ld a,b
1F43 DD 86 0F                   add a,(ix+$0F)
1F46 FE 09                      cp $09
1F48 DA B3 1F                   jp c,L1FB3
1F4B 1E FF         L1F4B:       ld e,$FF
1F4D ED 2B                      bsrf de,b
1F4F 4A                         ld c,d
1F50 DD 6B                      ld xl,e
1F52 D9                         exx
1F53 7E            L1F53:       ld a,(hl)
1F54 23                         inc hl
1F55 AB                         xor e
1F56 A1                         and c
1F57 D9                         exx
1F58 57                         ld d,a
1F59 1E 00                      ld e,$00
1F5B ED 2A                      bsrl de,b
1F5D 08                         ex af,af'
1F5E 28 3A                      jr z,L1F9A
1F60 08                         ex af,af'
1F61 FD CB 45 56                bit 2,(iy+$45)
1F65 20 16                      jr nz,L1F7D
1F67 E5                         push hl
1F68 79                         ld a,c
1F69 A6                         and (hl)
1F6A AA                         xor d
1F6B 77                         ld (hl),a
1F6C CB 7C                      bit 7,h
1F6E CB FC                      set 7,h
1F70 28 03                      jr z,L1F75
1F72 CB BC                      res 7,h
1F74 23                         inc hl
1F75 DD 7D         L1F75:       ld a,xl
1F77 A6                         and (hl)
1F78 AB                         xor e
1F79 77                         ld (hl),a
1F7A E1                         pop hl
1F7B 18 29                      jr L1FA6
1F7D 79            L1F7D:       ld a,c
1F7E A6                         and (hl)
1F7F AA                         xor d
1F80 77                         ld (hl),a
1F81 23                         inc hl
1F82 DD 7D                      ld a,xl
1F84 A6                         and (hl)
1F85 AB                         xor e
1F86 77                         ld (hl),a
1F87 2B                         dec hl
1F88 CB FC                      set 7,h
1F8A 08                         ex af,af'
1F8B 77                         ld (hl),a
1F8C 08                         ex af,af'
1F8D 04                         inc b
1F8E 05                         dec b
1F8F 28 05                      jr z,L1F96
1F91 23                         inc hl
1F92 08                         ex af,af'
1F93 77                         ld (hl),a
1F94 08                         ex af,af'
1F95 2B                         dec hl
1F96 CB BC         L1F96:       res 7,h
1F98 18 0C                      jr L1FA6
1F9A 08            L1F9A:       ex af,af'
1F9B 79                         ld a,c
1F9C A6                         and (hl)
1F9D AA                         xor d
1F9E 77                         ld (hl),a
1F9F 23                         inc hl
1FA0 DD 7D                      ld a,xl
1FA2 A6                         and (hl)
1FA3 AB                         xor e
1FA4 77                         ld (hl),a
1FA5 2B                         dec hl
1FA6 ED 93         L1FA6:       pixeldn
1FA8 D9                         exx
1FA9 10 A8                      djnz L1F53
1FAB DD 6A                      ld xl,d
1FAD D1                         pop de
1FAE C1                         pop bc
1FAF E1                         pop hl
1FB0 D9                         exx
1FB1 18 19                      jr L1FCC
1FB3 ED 2B         L1FB3:       bsrf de,b
1FB5 4A                         ld c,d
1FB6 D9                         exx
1FB7 7E            L1FB7:       ld a,(hl)
1FB8 23                         inc hl
1FB9 AB                         xor e
1FBA A1                         and c
1FBB D9                         exx
1FBC 57                         ld d,a
1FBD ED 2A                      bsrl de,b
1FBF 79                         ld a,c
1FC0 A6                         and (hl)
1FC1 AA                         xor d
1FC2 77                         ld (hl),a
1FC3 ED 93                      pixeldn
1FC5 D9                         exx
1FC6 10 EF                      djnz L1FB7
1FC8 D1                         pop de
1FC9 C1            L1FC9:       pop bc
1FCA E1                         pop hl
1FCB D9                         exx
1FCC DD 34 24      L1FCC:       inc (ix+$24)
1FCF DD 7E 23                   ld a,(ix+$23)
1FD2 DD 86 0F                   add a,(ix+$0F)
1FD5 DD BE 1D                   cp (ix+$1D)
1FD8 38 06                      jr c,L1FE0
1FDA DD 96 1D                   sub (ix+$1D)
1FDD DD 34 21                   inc (ix+$21)
1FE0 DD 77 23      L1FE0:       ld (ix+$23),a
1FE3 C9                         ret
1FE4 DD 7E 21      L1FE4:       ld a,(ix+$21)
1FE7 87                         add a,a
1FE8 87                         add a,a
1FE9 87                         add a,a
1FEA DD 86 23                   add a,(ix+$23)
1FED 6F                         ld l,a
1FEE DD 66 22                   ld h,(ix+$22)
1FF1 CD 8F 26                   call L268F
1FF4 79                         ld a,c
1FF5 DD 96 0F                   sub (ix+$0F)
1FF8 3C                         inc a
1FF9 4F                         ld c,a
1FFA DD 56 1F                   ld d,(ix+$1F)
1FFD DD 5E 20                   ld e,(ix+$20)
2000 DD CB 27 46                bit 0,(ix+$27)
2004 28 03                      jr z,L2009
2006 7A                         ld a,d
2007 53                         ld d,e
2008 5F                         ld e,a
2009 D9            L2009:       exx
200A E3                         ex (sp),hl
200B C5                         push bc
200C 06 08                      ld b,$08
200E DD CB 25 46                bit 0,(ix+$25)
2012 28 03                      jr z,L2017
2014 06 06                      ld b,$06
2016 23                         inc hl
2017 7E            L2017:       ld a,(hl)
2018 23                         inc hl
2019 D9                         exx
201A C5                         push bc
201B DD 46 0F                   ld b,(ix+$0F)
201E DD CB 28 46                bit 0,(ix+$28)
2022 20 16                      jr nz,L203A
2024 17            L2024:       rla
2025 72                         ld (hl),d
2026 38 01                      jr c,L2029
2028 73                         ld (hl),e
2029 23            L2029:       inc hl
202A 10 F8                      djnz L2024
202C C1            L202C:       pop bc
202D 79                         ld a,c
202E ED 31                      add hl,a
2030 7C                         ld a,h
2031 B8                         cp b
2032 D4 D6 26                   call nc,L26D6
2035 D9                         exx
2036 10 DF         L2036:       djnz L2017
2038 18 8F                      jr L1FC9
203A 17            L203A:       rla
203B 30 01                      jr nc,L203E
203D 72                         ld (hl),d
203E 23            L203E:       inc hl
203F 10 F9                      djnz L203A
2041 18 E9                      jr L202C
2043 AF            L2043:       xor a
2044 DD 77 23                   ld (ix+$23),a
2047 DD 77 24                   ld (ix+$24),a
204A DD 7E 13                   ld a,(ix+$13)
204D DD 77 21                   ld (ix+$21),a
2050 DD CB 25 6E                bit 5,(ix+$25)
2054 C4 57 20                   call nz,L2057
2057 E5            L2057:       push hl
2058 CD 88 1A                   call L1A88
205B DD 77 22                   ld (ix+$22),a
205E DD 7E 18                   ld a,(ix+$18)
2061 DD BE 22                   cp (ix+$22)
2064 DC 69 20                   call c,L2069
2067 E1                         pop hl
2068 C9                         ret
2069 DD 7E 22      L2069:       ld a,(ix+$22)
206C D6 08                      sub $08
206E DD 77 22                   ld (ix+$22),a
2071 DD 7E 1A      L2071:       ld a,(ix+$1A)
2074 A7                         and a
2075 28 17                      jr z,L208E
2077 DD 35 1B                   dec (ix+$1B)
207A 20 12                      jr nz,L208E
207C DD 77 1B                   ld (ix+$1B),a
207F 21 78 21                   ld hl,$2178
2082 CD 60 21                   call L2160
2085 CD 18 21                   call L2118
2088 CD E0 11                   call L11E0
208B CD 18 21                   call L2118
208E 21 81 21      L208E:       ld hl,$2181
2091 CD 60 21                   call L2160
2094 1E 01                      ld e,$01
2096 CD CE 20                   call L20CE
2099 CD 9D 20                   call L209D
209C C9                         ret
209D CD 5D 21      L209D:       call L215D
20A0 DD 4E 11                   ld c,(ix+$11)
20A3 06 01                      ld b,$01
20A5 C5                         push bc
20A6 DD 66 16                   ld h,(ix+$16)
20A9 18 30                      jr L20DB
20AB DD 77 1A                   ld (ix+$1A),a
20AE DD 77 1B                   ld (ix+$1B),a
20B1 C9                         ret
20B2 21 72 21                   ld hl,$2172
20B5 18 12                      jr L20C9
20B7 CD 30 1A                   call L1A30
20BA 3E 01                      ld a,$01
20BC DD 77 1B                   ld (ix+$1B),a
20BF 21 69 21                   ld hl,$2169
20C2 18 05                      jr L20C9
20C4 E5                         push hl
20C5 CD 42 19                   call L1942
20C8 E1                         pop hl
20C9 CD 60 21      L20C9:       call L2160
20CC 1E 00                      ld e,$00
20CE DD 4E 11      L20CE:       ld c,(ix+$11)
20D1 DD 7E 12                   ld a,(ix+$12)
20D4 93                         sub e
20D5 47                         ld b,a
20D6 C8                         ret z
20D7 C5                         push bc
20D8 DD 66 14                   ld h,(ix+$14)
20DB DD 6E 13      L20DB:       ld l,(ix+$13)
20DE 29            L20DE:       add hl,hl
20DF 29                         add hl,hl
20E0 29                         add hl,hl
20E1 CD F9 26                   call L26F9
20E4 38 3E                      jr c,L2124
20E6 EB                         ex de,hl
20E7 CD B0 22                   call L22B0
20EA C1                         pop bc
20EB C5                         push bc
20EC C5            L20EC:       push bc
20ED 06 00                      ld b,$00
20EF FD CB 45 5E                bit 3,(iy+$45)
20F3 CC 91 5B                   call z,L5B91
20F6 C1                         pop bc
20F7 10 F3                      djnz L20EC
20F9 C1                         pop bc
20FA C5            L20FA:       push bc
20FB 06 00                      ld b,$00
20FD 6B                         ld l,e
20FE 7A                         ld a,d
20FF F6 07                      or $07
2101 67                         ld h,a
2102 ED 93                      pixeldn
2104 E5                         push hl
2105 3E 08                      ld a,$08
2107 F5            L2107:       push af
2108 D5                         push de
2109 CD 94 5B                   call L5B94
210C D1                         pop de
210D F1                         pop af
210E 24                         inc h
210F 14                         inc d
2110 3D                         dec a
2111 20 F4                      jr nz,L2107
2113 D1                         pop de
2114 C1                         pop bc
2115 10 E3                      djnz L20FA
2117 C9                         ret
2118 01 01 01      L2118:       ld bc,$0101
211B C5                         push bc
211C DD 66 16                   ld h,(ix+$16)
211F DD 6E 15                   ld l,(ix+$15)
2122 18 BA                      jr L20DE
2124 DD 22 8C 5B   L2124:       ld ($5B8C),ix
2128 DD 7E 20                   ld a,(ix+$20)
212B 32 9A 5B                   ld ($5B9A),a
212E CD 8E 26                   call L268E
2131 D1                         pop de
2132 7B                         ld a,e
2133 87                         add a,a
2134 87                         add a,a
2135 DD 6F                      ld xl,a
2137 DD 26 00                   ld xh,$00
213A DD 29                      add ix,ix
213C 1E 08         L213C:       ld e,$08
213E D5            L213E:       push de
213F E5                         push hl
2140 CD 97 5B                   call L5B97
2143 E1                         pop hl
2144 78                         ld a,b
2145 06 00                      ld b,$00
2147 09                         add hl,bc
2148 23                         inc hl
2149 47                         ld b,a
214A D1                         pop de
214B 1D                         dec e
214C 20 F0                      jr nz,L213E
214E 7C                         ld a,h
214F B8                         cp b
2150 D4 D5 26                   call nc,L26D5
2153 15                         dec d
2154 20 E6                      jr nz,L213C
2156 DD 2A 8C 5B                ld ix,($5B8C)
215A C3 42 19                   jp L1942
215D 21 69 21      L215D:       ld hl,$2169
2160 11 91 5B      L2160:       ld de,$5B91
2163 01 09 00                   ld bc,$0009
2166 ED B0                      ldir
2168 C9                         ret
2169 C3 A1 21                   jp L21A1
216C C3 D3 21                   jp L21D3
216F C3 3B 22                   jp L223B
2172 C3 A1 21                   jp L21A1
2175 C3 F1 21                   jp L21F1
2178 C9                         ret
2179 00                         nop
217A 00                         nop
217B C3 0C 22                   jp L220C
217E C3 51 22                   jp L2251
2181 C3 93 21                   jp L2193
2184 C3 BB 21                   jp L21BB
2187 C3 1F 22                   jp L221F
218A C3 B2 21                   jp L21B2
218D C3 FB 21                   jp L21FB
2190 C3 46 22                   jp L2246
2193 D5            L2193:       push de
2194 EB                         ex de,hl
2195 21 20 00                   ld hl,$0020
2198 19                         add hl,de
2199 E5                         push hl
219A C5                         push bc
219B ED B0                      ldir
219D C1                         pop bc
219E E1                         pop hl
219F D1                         pop de
21A0 C9                         ret
21A1 DD 7E 1F      L21A1:       ld a,(ix+$1F)
21A4 41                         ld b,c
21A5 77            L21A5:       ld (hl),a
21A6 23                         inc hl
21A7 10 FC                      djnz L21A5
21A9 3E 20         L21A9:       ld a,$20
21AB 91                         sub c
21AC 85                         add a,l
21AD 6F                         ld l,a
21AE 78                         ld a,b
21AF 8C                         adc a,h
21B0 67                         ld h,a
21B1 C9                         ret
21B2 D5            L21B2:       push de
21B3 EB                         ex de,hl
21B4 CD 5B 22                   call L225B
21B7 EB                         ex de,hl
21B8 D1                         pop de
21B9 18 EE                      jr L21A9
21BB E5            L21BB:       push hl
21BC D5                         push de
21BD C5                         push bc
21BE ED B0                      ldir
21C0 C1                         pop bc
21C1 D1                         pop de
21C2 E1                         pop hl
21C3 DD CB 1E 5E                bit 3,(ix+$1E)
21C7 C8                         ret z
21C8 E5                         push hl
21C9 C5                         push bc
21CA CB FC                      set 7,h
21CC CB FA                      set 7,d
21CE ED B0                      ldir
21D0 C1                         pop bc
21D1 E1                         pop hl
21D2 C9                         ret
21D3 D5            L21D3:       push de
21D4 41                         ld b,c
21D5 AF                         xor a
21D6 12            L21D6:       ld (de),a
21D7 13                         inc de
21D8 10 FC                      djnz L21D6
21DA D1                         pop de
21DB DD CB 1E 5E                bit 3,(ix+$1E)
21DF C8                         ret z
21E0 DD CB 1E 56                bit 2,(ix+$1E)
21E4 28 03                      jr z,L21E9
21E6 DD 7E 1F      L21E6:       ld a,(ix+$1F)
21E9 41            L21E9:       ld b,c
21EA CB FA                      set 7,d
21EC 12            L21EC:       ld (de),a
21ED 13                         inc de
21EE 10 FC                      djnz L21EC
21F0 C9                         ret
21F1 DD 7E 1E      L21F1:       ld a,(ix+$1E)
21F4 E6 0C                      and $0C
21F6 FE 0C                      cp $0C
21F8 C0                         ret nz
21F9 18 EB                      jr L21E6
21FB E5            L21FB:       push hl
21FC D5                         push de
21FD CD 5B 22                   call L225B
2200 D1                         pop de
2201 CB FA                      set 7,d
2203 FD CB 45 5E                bit 3,(iy+$45)
2207 C4 5E 22                   call nz,L225E
220A E1                         pop hl
220B C9                         ret
220C DD 7E 1E      L220C:       ld a,(ix+$1E)
220F E6 0C                      and $0C
2211 FE 08                      cp $08
2213 20 02                      jr nz,L2217
2215 CB FA                      set 7,d
2217 41            L2217:       ld b,c
2218 1A            L2218:       ld a,(de)
2219 2F                         cpl
221A 12                         ld (de),a
221B 13                         inc de
221C 10 FA                      djnz L2218
221E C9                         ret
221F EB            L221F:       ex de,hl
2220 26 00                      ld h,$00
2222 69                         ld l,c
2223 23                         inc hl
2224 29                         add hl,hl
2225 29                         add hl,hl
2226 29                         add hl,hl
2227 19                         add hl,de
2228 CB 79                      bit 7,c
222A 20 07                      jr nz,L2233
222C 7C                         ld a,h
222D B8                         cp b
222E 38 03                      jr c,L2233
2230 C6 68                      add a,$68
2232 67                         ld h,a
2233 C5            L2233:       push bc
2234 DD E5                      push ix
2236 C1                         pop bc
2237 ED B0                      ldir
2239 C1                         pop bc
223A C9                         ret
223B 3A 9A 5B      L223B:       ld a,($5B9A)
223E DD 5D                      ld e,xl
2240 77            L2240:       ld (hl),a
2241 23                         inc hl
2242 1D                         dec e
2243 20 FB                      jr nz,L2240
2245 C9                         ret
2246 C5            L2246:       push bc
2247 06 00                      ld b,$00
2249 DD 4D                      ld c,xl
224B EB                         ex de,hl
224C CD 5B 22                   call L225B
224F C1                         pop bc
2250 C9                         ret
2251 DD 55         L2251:       ld d,xl
2253 7E            L2253:       ld a,(hl)
2254 2F                         cpl
2255 77                         ld (hl),a
2256 23                         inc hl
2257 15                         dec d
2258 20 F9                      jr nz,L2253
225A C9                         ret
225B 2A 9B 5B      L225B:       ld hl,($5B9B)
225E FD 7E 58      L225E:       ld a,(iy+$58)
2261 CB 7F                      bit 7,a
2263 28 01                      jr z,L2266
2265 EB                         ex de,hl
2266 E6 07         L2266:       and $07
2268 28 31                      jr z,L229B
226A 3D                         dec a
226B 28 10                      jr z,L227D
226D 3D                         dec a
226E 28 17                      jr z,L2287
2270 3D                         dec a
2271 28 1E                      jr z,L2291
2273 3A 93 5C                   ld a,($5C93)
2276 C5                         push bc
2277 0D                         dec c
2278 03                         inc bc
2279 ED B4                      ldirx
227B 18 23                      jr L22A0
227D 41            L227D:       ld b,c
227E 1A            L227E:       ld a,(de)
227F A6                         and (hl)
2280 12                         ld (de),a
2281 23                         inc hl
2282 13                         inc de
2283 10 F9                      djnz L227E
2285 18 1A                      jr L22A1
2287 41            L2287:       ld b,c
2288 1A            L2288:       ld a,(de)
2289 B6                         or (hl)
228A 12                         ld (de),a
228B 23                         inc hl
228C 13                         inc de
228D 10 F9                      djnz L2288
228F 18 10                      jr L22A1
2291 41            L2291:       ld b,c
2292 1A            L2292:       ld a,(de)
2293 AE                         xor (hl)
2294 12                         ld (de),a
2295 23                         inc hl
2296 13                         inc de
2297 10 F9                      djnz L2292
2299 18 06                      jr L22A1
229B C5            L229B:       push bc
229C 0D                         dec c
229D 03                         inc bc
229E ED B0                      ldir
22A0 C1            L22A0:       pop bc
22A1 FD CB 58 7E   L22A1:       bit 7,(iy+$58)
22A5 28 01                      jr z,L22A8
22A7 EB                         ex de,hl
22A8 22 9B 5B      L22A8:       ld ($5B9B),hl
22AB C9                         ret
22AC 87            L22AC:       add a,a
22AD 87                         add a,a
22AE 87                         add a,a
22AF 5F                         ld e,a
22B0 ED 94         L22B0:       pixelad
22B2 7A                         ld a,d
22B3 07                         rlca
22B4 07                         rlca
22B5 E6 03                      and $03
22B7 F6 58                      or $58
22B9 57                         ld d,a
22BA 5D                         ld e,l
22BB EB                         ex de,hl
22BC C9                         ret
22BD AF            L22BD:       xor a
22BE CB 3B                      srl e
22C0 1F                         rra
22C1 CB 2F         L22C1:       sra a
22C3 0D                         dec c
22C4 20 FB                      jr nz,L22C1
22C6 CB 3B                      srl e
22C8 1F                         rra
22C9 CB 2F         L22C9:       sra a
22CB 10 FC                      djnz L22C9
22CD 06 04                      ld b,$04
22CF 77            L22CF:       ld (hl),a
22D0 23                         inc hl
22D1 10 FC                      djnz L22CF
22D3 C9                         ret
22D4 FE 03         L22D4:       cp $03
22D6 38 15                      jr c,L22ED
22D8 FE 09                      cp $09
22DA 30 11                      jr nc,L22ED
22DC 21 00 EC                   ld hl,$EC00
22DF FE 05                      cp $05
22E1 D8                         ret c
22E2 26 EF                      ld h,$EF
22E4 FE 07                      cp $07
22E6 D8                         ret c
22E7 26 F7                      ld h,$F7
22E9 C8                         ret z
22EA 26 FB                      ld h,$FB
22EC C9                         ret
22ED 3E 0A         L22ED:       ld a,$0A
22EF C3 AF 27                   jp L27AF
22F2 00                         nop
22F3 FB                         ei
22F4 08                         ex af,af'
22F5 FF                         rst $38
22F6 10 0C                      djnz L2304
22F8 00                         nop
22F9 00                         nop
22FA 0F                         rrca
22FB 0B                         dec bc
22FC 00                         nop
22FD 60                         ld h,b
22FE 10 0C                      djnz L230C
2300 01 10 08                   ld bc,$0810
2303 01 00 FF                   ld bc,$FF00
2306 00                         nop
2307 FB                         ei
2308 08                         ex af,af'
2309 FF                         rst $38
230A 20 18                      jr nz,L2324
230C 00            L230C:       nop
230D 00                         nop
230E 1F                         rra
230F 17                         rla
2310 00                         nop
2311 C0                         ret nz
2312 10 18                      djnz L232C
2314 01 20 08                   ld bc,$0820
2317 02                         ld (bc),a
2318 00                         nop
2319 FF                         rst $38
231A 40                         ld b,b
231B 10 09                      djnz L2326
231D 00                         nop
231E 00                         nop
231F 20 08                      jr nz,L2329
2321 05                         dec b
2322 38 00                      jr c,L2324
2324 20 08         L2324:       jr nz,L232E
2326 0D            L2326:       dec c
2327 38 00                      jr c,L2329
;
; --- Subroutine: Initialize NextOS structures and copy font data ---
; This routine sets up NextOS data structures in banks $0B and $10, 
; initializes memory regions, and copies/processes font data.
; Entry: B = initialization flag (0 = full init, non-zero = skip init)
; Exit: NextOS structures initialized, font data copied
;
2329 ED 8A 23 86   L2329:       push $2386                  ; Push return address $2386
232D 58                         ld e,b                      ; E = initialization flag from B
232E 16 54         L232E:       ld d,$54                    ; D = $54 (use MMU Slots 4 and 5)
2330 CD 0A 27                   call PgIn100B               ; Page in banks $0B and $10 to slots 4/5
2333 1D                         dec e                       ; Decrement init flag
2334 28 3C                      jr z,L2372                  ; If flag was 1, skip initialization
;
; --- Initialize NextOS data structure at $A000 ---
;
2336 21 00 A0                   ld hl,$A000                 ; HL = $A000 (start of structure)
2339 11 01 A0                   ld de,$A001                 ; DE = $A001 (for LDIR fill)
233C 01 51 01                   ld bc,$0151                 ; BC = $0151 (337 bytes)
233F 75                         ld (hl),l                   ; Store $00 at $A000
2340 ED B0                      ldir                        ; Fill $A000-$A151 with $00
2342 3A 69 5B                   ld a,(LBANK)                ; A = last RAM bank number
2345 3C                         inc a                       ; A = number of RAM banks
2346 87                         add a,a                     ; A = number of 8K pages (banks * 2)
2347 32 50 A0                   ld ($A050),a                ; Store number of pages
234A 3E 10                      ld a,$10                    ; A = $10
234C 32 51 A0                   ld ($A051),a                ; Store $10 at $A051
234F 21 FF FF                   ld hl,$FFFF                 ; HL = $FFFF
2352 22 00 A0                   ld ($A000),hl               ; Store $FFFF at $A000
2355 22 28 A0                   ld ($A028),hl               ; Store $FFFF at $A028
2358 7D                         ld a,l                      ; A = $FF
2359 32 02 A0                   ld ($A002),a                ; Store $FF at $A002
235C 32 2A A0                   ld ($A02A),a                ; Store $FF at $A02A
235F 21 F7 3F                   ld hl,$3FF7                 ; HL = $3FF7
2362 22 20 A0                   ld ($A020),hl               ; Store $3FF7 at $A020
2365 22 48 A0                   ld ($A048),hl               ; Store $3FF7 at $A048
2368 21 01 00                   ld hl,$0001                 ; HL = $0001
236B E7                         rst $20                     ; Call ROM2 routine
236C BD 01                      .defw $01BD                 ; ROM2 address: IDE_WINDOW_MENU
236E 7B                         ld a,e                      ; A = E (init flag)
236F 32 58 5B                   ld ($5B58),a                ; Store init flag at $5B58
;
; --- Copy and decompress font data ---
;
2372 21 00 3D      L2372:       ld hl,$3D00                 ; HL = $3D00 (source: font data in ROM)
2375 11 00 BC                   ld de,$BC00                 ; DE = $BC00 (dest in paged RAM)
2378 01 00 03                   ld bc,$0300                 ; BC = $0300 (768 bytes)
237B EF                         rst $28                     ; Call ROM1 routine
237C C3 33                      .defw $33C3                 ; ROM1 address: copy routine
237E CD 9B 23                   call ExpFont                ; Process font data
2381 16 54                      ld d,$54                    ; D = $54 (MMU slot)
2383 C3 99 27                   jp L2799                    ; Jump to cleanup/return
2386 CD 08 27                   call L2708                  ; Additional initialization
2389 CD 4D 26                   call L264D                  ; More initialization
238C 21 00 F7                   ld hl,$F700                 ; HL = $F700
238F CD 54 0F                   call L0F54                  ; Initialize memory region
2392 21 00 FB                   ld hl,$FB00                 ; HL = $FB00
2395 CD 54 0F                   call L0F54                  ; Initialize memory region
2398 C3 97 27                   jp L2797                    ; Jump to final return
;
; --- Subroutine: Process and expand font data ---
; Converts compressed font data from $BC00 to expanded format at $B800,
; and generates character patterns at $AD00 using lookup table at ChLUT.
; The lookup table contains 9 special characters that use custom pattern bytes
; for their first row (top scanline), while the remaining rows use standard
; pattern data from $23F2. This allows specific characters to have unique
; top row patterns for special symbols, accented characters, or graphical elements.
; Entry: None (expects font data at $BC00)
; Exit: Processed font at $B800, character patterns at $AD00
;
239B 21 00 BC      ExpFont:     ld hl,$BC00                 ; HL = $BC00 (source: compressed font)
239E 11 00 B8                   ld de,$B800                 ; DE = $B800 (dest: expanded font)
23A1 01 03 00                   ld bc,$0003                 ; BC = $0300 (768 bytes)
23A4 7E            L23A4:       ld a,(hl)                   ; Load byte from compressed font
23A5 23                         inc hl                      ; Advance source pointer
23A6 87                         add a,a                     ; Shift left (multiply by 2)
23A7 12                         ld (de),a                   ; Store expanded byte
23A8 13                         inc de                      ; Advance dest pointer
23A9 10 F9                      djnz L23A4                  ; Loop for B bytes
23AB 0D                         dec c                       ; Decrement page counter
23AC 20 F6                      jr nz,L23A4                 ; Continue if more pages
23AE DD E5                      push ix                     ; Save IX
23B0 DD 21 32 26                ld ix,ChLUT                 ; IX = ChLUT (lookup table pointer)
23B4 21 F2 23                   ld hl,$23F2                 ; HL = $23F2 (pattern data)
23B7 11 00 AD                   ld de,$AD00                 ; DE = $AD00 (character patterns)
23BA 06 60                      ld b,$60                    ; B = $60 (96 characters)
23BC 0E 08         L23BC:       ld c,$08                    ; C = $08 (8 rows per character)
23BE AF            L23BE:       xor a                       ; A = $00 (default pattern byte)
23BF CB 59                      bit 3,c                     ; Test bit 3 of row counter
23C1 20 17                      jr nz,L23DA                 ; If set, use default $00
23C3 79                         ld a,c                      ; A = row counter
23C4 3D                         dec a                       ; A = row - 1
23C5 20 11                      jr nz,L23D8                 ; If not first row, use pattern data
23C7 78                         ld a,b                      ; A = character counter
23C8 DD BE 00                   cp (ix)                     ; Compare with lookup table entry
23CB 3E 00                      ld a,$00                    ; A = $00 (default)
23CD 20 0B                      jr nz,L23DA                 ; If no match, use default
23CF DD 23                      inc ix                      ; Advance to next lookup entry
23D1 DD 7E 00                   ld a,(ix)                   ; Load special pattern byte
23D4 DD 23                      inc ix                      ; Advance lookup pointer
23D6 18 02                      jr L23DA                    ; Use special pattern
23D8 7E            L23D8:       ld a,(hl)                   ; Load pattern from data
23D9 23                         inc hl                      ; Advance pattern pointer
23DA F5            L23DA:       push af                     ; Save pattern byte
23DB E6 E0                      and $E0                     ; Mask upper 3 bits
23DD 12                         ld (de),a                   ; Store in character pattern (byte 0)
23DE 14                         inc d                       ; D += 1 (skip 768 bytes)
23DF 14                         inc d                       ; D += 1 (skip 768 bytes)
23E0 14                         inc d                       ; D += 1 (skip 768 bytes)
23E1 F1                         pop af                      ; Restore pattern byte
23E2 87                         add a,a                     ; Shift left 1 bit
23E3 87                         add a,a                     ; Shift left 1 bit
23E4 87                         add a,a                     ; Shift left 1 bit
23E5 12                         ld (de),a                   ; Store in character pattern (byte 1)
23E6 15                         dec d                       ; Restore D
23E7 15                         dec d                       ; Restore D
23E8 15                         dec d                       ; Restore D
23E9 13                         inc de                      ; Advance to next row
23EA 0D                         dec c                       ; Decrement row counter
23EB 20 D1                      jr nz,L23BE                 ; Loop for all 8 rows
23ED 10 CD                      djnz L23BC                  ; Loop for all 96 characters
23EF DD E1                      pop ix                      ; Restore IX
23F1 C9                         ret                         ; Return
23F2 00                         nop
23F3 00                         nop
23F4 00                         nop
23F5 00                         nop
23F6 00                         nop
23F7 00                         nop
23F8 44                         ld b,h
23F9 44                         ld b,h
23FA 44                         ld b,h
23FB 44                         ld b,h
23FC 00                         nop
23FD 44                         ld b,h
23FE AA                         xor d
23FF AA                         xor d
2400 00                         nop
2401 00                         nop
2402 00                         nop
2403 00                         nop
2404 AA                         xor d
2405 FF                         rst $38
2406 AA                         xor d
2407 AA                         xor d
2408 FF                         rst $38
2409 AA                         xor d
240A 42                         ld b,d
240B EF                         rst $28
240C 8A                         adc a,d
240D EF                         rst $28
240E 23                         inc hl
240F EF                         rst $28
2410 A9                         xor c
2411 21 42 44                   ld hl,$4442
2414 88                         adc a,b
2415 A9                         xor c
2416 48                         ld c,b
2417 B4                         or h
2418 48                         ld c,b
2419 DD B2                      or d
241B FD 42                      ld b,d
241D 84                         add a,h
241E 00                         nop
241F 00                         nop
2420 00                         nop
2421 00                         nop
2422 42                         ld b,d
2423 84                         add a,h
2424 84                         add a,h
2425 84                         add a,h
2426 84                         add a,h
2427 42                         ld b,d
2428 84                         add a,h
2429 42                         ld b,d
242A 42                         ld b,d
242B 42                         ld b,d
242C 42                         ld b,d
242D 84                         add a,h
242E 00                         nop
242F AA                         xor d
2430 44                         ld b,h
2431 EE 44                      xor $44
2433 AA                         xor d
2434 00                         nop
2435 44                         ld b,h
2436 44                         ld b,h
2437 EE 44                      xor $44
2439 44                         ld b,h
243A 00                         nop
243B 00                         nop
243C 00                         nop
243D 00                         nop
243E 42                         ld b,d
243F 84                         add a,h
2440 00                         nop
2441 00                         nop
2442 00                         nop
2443 CE 00                      adc a,$00
2445 00                         nop
2446 00                         nop
2447 00                         nop
2448 00                         nop
2449 00                         nop
244A 00                         nop
244B 44                         ld b,h
244C 22 22 44                   ld ($4422),hl
244F 44                         ld b,h
2450 88                         adc a,b
2451 88                         adc a,b
2452 46                         ld b,(hl)
2453 A9                         xor c
2454 A9                         xor c
2455 A9                         xor c
2456 A9                         xor c
2457 46                         ld b,(hl)
2458 42                         ld b,d
2459 C6 42                      add a,$42
245B 42                         ld b,d
245C 42                         ld b,d
245D 47                         ld b,a
245E 46                         ld b,(hl)
245F A9                         xor c
2460 21 46 88                   ld hl,$8846
2463 EF                         rst $28
2464 C6 29                      add a,$29
2466 C2 21 29                   jp nz,L2921
2469 C6 22                      add a,$22
246B 62                         ld h,d
246C A6                         and (hl)
246D AA                         xor d
246E EF                         rst $28
246F 22 EF 88                   ld ($88EF),hl
2472 CE 21                      adc a,$21
2474 29                         add hl,hl
2475 C6 66                      add a,$66
2477 88                         adc a,b
2478 CE A9                      adc a,$A9
247A A9                         xor c
247B 46                         ld b,(hl)
247C EF                         rst $28
247D 21 42 44                   ld hl,$4442
2480 84                         add a,h
2481 84                         add a,h
2482 46                         ld b,(hl)
2483 A9                         xor c
2484 46                         ld b,(hl)
2485 A9                         xor c
2486 A9                         xor c
2487 46                         ld b,(hl)
2488 46                         ld b,(hl)
2489 A9                         xor c
248A A9                         xor c
248B 67                         ld h,a
248C 21 C6 00                   ld hl,$00C6
248F 44                         ld b,h
2490 00                         nop
2491 00                         nop
2492 44                         ld b,h
2493 00                         nop
2494 00                         nop
2495 44                         ld b,h
2496 00                         nop
2497 00                         nop
2498 44                         ld b,h
2499 88                         adc a,b
249A 00                         nop
249B 22 44 88                   ld ($8844),hl
249E 44                         ld b,h
249F 22 00 00                   ld ($0000),hl
24A2 CE 00                      adc a,$00
24A4 CE 00                      adc a,$00
24A6 00                         nop
24A7 88                         adc a,b
24A8 44                         ld b,h
24A9 22 44 88                   ld ($8844),hl
24AC 46                         ld b,(hl)
24AD A9                         xor c
24AE 21 42 00                   ld hl,$0042
24B1 42                         ld b,d
24B2 46                         ld b,(hl)
24B3 EF                         rst $28
24B4 AD                         xor l
24B5 EA 88 E7                   jp pe,LE788
24B8 46                         ld b,(hl)
24B9 A9                         xor c
24BA A9                         xor c
24BB EF                         rst $28
24BC A9                         xor c
24BD A9                         xor c
24BE CE A9                      adc a,$A9
24C0 CE A9                      adc a,$A9
24C2 A9                         xor c
24C3 CE 46                      adc a,$46
24C5 A9                         xor c
24C6 88                         adc a,b
24C7 88                         adc a,b
24C8 A9                         xor c
24C9 46                         ld b,(hl)
24CA CE A9                      adc a,$A9
24CC A9                         xor c
24CD A9                         xor c
24CE A9                         xor c
24CF CE EF                      adc a,$EF
24D1 88                         adc a,b
24D2 CE 88                      adc a,$88
24D4 88                         adc a,b
24D5 EF                         rst $28
24D6 EF                         rst $28
24D7 88                         adc a,b
24D8 EE 88                      xor $88
24DA 88                         adc a,b
24DB 88                         adc a,b
24DC 46                         ld b,(hl)
24DD A9                         xor c
24DE 88                         adc a,b
24DF EB                         ex de,hl
24E0 A9                         xor c
24E1 47                         ld b,a
24E2 A9                         xor c
24E3 A9                         xor c
24E4 EF                         rst $28
24E5 A9                         xor c
24E6 A9                         xor c
24E7 A9                         xor c
24E8 EE 44                      xor $44
24EA 44                         ld b,h
24EB 44                         ld b,h
24EC 44                         ld b,h
24ED EE 21                      xor $21
24EF 21 21 A1                   ld hl,$A121
24F2 A9                         xor c
24F3 46                         ld b,(hl)
24F4 A9                         xor c
24F5 AA                         xor d
24F6 CC CA A9                   call z,LA9CA
24F9 A9                         xor c
24FA 88                         adc a,b
24FB 88                         adc a,b
24FC 88                         adc a,b
24FD 88                         adc a,b
24FE 88                         adc a,b
24FF EF                         rst $28
2500 B1                         or c
2501 FB                         ei
2502 B5                         or l
2503 B1                         or c
2504 B1                         or c
2505 B1                         or c
2506 E9                         jp (hl)
2507 AD                         xor l
2508 AD                         xor l
2509 AB                         xor e
250A AB                         xor e
250B A9                         xor c
250C 46                         ld b,(hl)
250D A9                         xor c
250E A9                         xor c
250F A9                         xor c
2510 A9                         xor c
2511 46                         ld b,(hl)
2512 CE A9                      adc a,$A9
2514 A9                         xor c
2515 CE 88                      adc a,$88
2517 88                         adc a,b
2518 E6 A9                      and $A9
251A A9                         xor c
251B AD                         xor l
251C EB                         ex de,hl
251D E7                         rst $20
251E EE A9                      xor $A9
2520 A9                         xor c
2521 CE C9                      adc a,$C9
2523 A9                         xor c
2524 67                         ld h,a
2525 88                         adc a,b
2526 46                         ld b,(hl)
2527 21 29 C6                   ld hl,$C629
252A EE 44                      xor $44
252C 44                         ld b,h
252D 44                         ld b,h
252E 44                         ld b,h
252F 44                         ld b,h
2530 A9                         xor c
2531 A9                         xor c
2532 A9                         xor c
2533 A9                         xor c
2534 A9                         xor c
2535 E6 AA                      and $AA
2537 AA                         xor d
2538 AA                         xor d
2539 AA                         xor d
253A AA                         xor d
253B 44                         ld b,h
253C B1                         or c
253D B1                         or c
253E F1                         pop af
253F F5                         push af
2540 FB                         ei
2541 51                         ld d,c
2542 AA                         xor d
2543 AA                         xor d
2544 44                         ld b,h
2545 44                         ld b,h
2546 AA                         xor d
2547 AA                         xor d
2548 AA                         xor d
2549 AA                         xor d
254A AA                         xor d
254B 44                         ld b,h
254C 44                         ld b,h
254D 44                         ld b,h
254E EF                         rst $28
254F 21 42 44                   ld hl,$4442
2552 88                         adc a,b
2553 EF                         rst $28
2554 C6 84                      add a,$84
2556 84                         add a,h
2557 84                         add a,h
2558 84                         add a,h
2559 C6 00                      add a,$00
255B 88                         adc a,b
255C C8                         ret z
255D 44                         ld b,h
255E 62                         ld h,d
255F 22 66 22                   ld ($2266),hl
2562 22 22 22                   ld ($2222),hl
2565 66                         ld h,(hl)
2566 44                         ld b,h
2567 EE 44                      xor $44
2569 44                         ld b,h
256A 44                         ld b,h
256B 44                         ld b,h
256C 00                         nop
256D 00                         nop
256E 00                         nop
256F 00                         nop
2570 00                         nop
2571 00                         nop
2572 46                         ld b,(hl)
2573 A9                         xor c
2574 88                         adc a,b
2575 EE 88                      xor $88
2577 EF                         rst $28
2578 00                         nop
2579 C6 21                      add a,$21
257B 67                         ld h,a
257C A9                         xor c
257D 47                         ld b,a
257E 88                         adc a,b
257F 88                         adc a,b
2580 CE A9                      adc a,$A9
2582 A9                         xor c
2583 CE 00                      adc a,$00
2585 67                         ld h,a
2586 88                         adc a,b
2587 88                         adc a,b
2588 88                         adc a,b
2589 67                         ld h,a
258A 21 21 67                   ld hl,$6721
258D A9                         xor c
258E A9                         xor c
258F 67                         ld h,a
2590 00                         nop
2591 46                         ld b,(hl)
2592 A9                         xor c
2593 CE 88                      adc a,$88
2595 67                         ld h,a
2596 66                         ld h,(hl)
2597 88                         adc a,b
2598 CC 88 88                   call z,L8888
259B 88                         adc a,b
259C 00                         nop
259D 67                         ld h,a
259E A9                         xor c
259F A9                         xor c
25A0 67                         ld h,a
25A1 21 88 88                   ld hl,$8888
25A4 CE A9                      adc a,$A9
25A6 A9                         xor c
25A7 A9                         xor c
25A8 44                         ld b,h
25A9 00                         nop
25AA 4C                         ld c,h
25AB 44                         ld b,h
25AC 44                         ld b,h
25AD 4E                         ld c,(hl)
25AE 21 00 21                   ld hl,$2100
25B1 21 21 A9                   ld hl,$A921
25B4 88                         adc a,b
25B5 AA                         xor d
25B6 CC CC AA                   call z,LAACC
25B9 A9                         xor c
25BA 48                         ld c,b
25BB 48                         ld c,b
25BC 48                         ld c,b
25BD 48                         ld c,b
25BE 48                         ld c,b
25BF 46                         ld b,(hl)
25C0 00                         nop
25C1 BA                         cp d
25C2 F5                         push af
25C3 B5                         or l
25C4 B5                         or l
25C5 B5                         or l
25C6 00            L25C6:       nop
25C7 CE A9                      adc a,$A9
25C9 A9                         xor c
25CA A9                         xor c
25CB A9                         xor c
25CC 00                         nop
25CD 46                         ld b,(hl)
25CE A9                         xor c
25CF A9                         xor c
25D0 A9                         xor c
25D1 46                         ld b,(hl)
25D2 00                         nop
25D3 CE A9                      adc a,$A9
25D5 A9                         xor c
25D6 CE 88                      adc a,$88
25D8 00                         nop
25D9 67                         ld h,a
25DA A9                         xor c
25DB A9                         xor c
25DC 67                         ld h,a
25DD 21 00 67                   ld hl,$6700
25E0 88                         adc a,b
25E1 88                         adc a,b
25E2 88                         adc a,b
25E3 88                         adc a,b
25E4 00                         nop
25E5 67                         ld h,a
25E6 88                         adc a,b
25E7 46                         ld b,(hl)
25E8 21 CE 44                   ld hl,$44CE
25EB EE 44                      xor $44
25ED 44                         ld b,h
25EE 44                         ld b,h
25EF 43                         ld b,e
25F0 00                         nop
25F1 A9                         xor c
25F2 A9                         xor c
25F3 A9                         xor c
25F4 A9                         xor c
25F5 E6 00                      and $00
25F7 AA                         xor d
25F8 AA                         xor d
25F9 AA                         xor d
25FA AA                         xor d
25FB 44                         ld b,h
25FC 00                         nop
25FD B1                         or c
25FE B5                         or l
25FF F5                         push af
2600 F5                         push af
2601 4A                         ld c,d
2602 00                         nop
2603 AA                         xor d
2604 AA                         xor d
2605 44                         ld b,h
2606 AA                         xor d
2607 AA                         xor d
2608 00                         nop
2609 A9                         xor c
260A A9                         xor c
260B A9                         xor c
260C 67                         ld h,a
260D 21 00 EF                   ld hl,$EF00
2610 21 42 84                   ld hl,$8442
2613 EF                         rst $28
2614 66                         ld h,(hl)
2615 44                         ld b,h
2616 88                         adc a,b
2617 44                         ld b,h
2618 44                         ld b,h
2619 66                         ld h,(hl)
261A 44                         ld b,h
261B 44                         ld b,h
261C 44                         ld b,h
261D 44                         ld b,h
261E 44                         ld b,h
261F 44                         ld b,h
2620 CC 44 22                   call z,L2244
2623 44                         ld b,h
2624 44                         ld b,h
2625 CC 45 AA                   call z,LAA45
2628 00                         nop
2629 00                         nop
262A 00                         nop
262B 00                         nop
262C EE B1                      xor $B1
262E F3                         di
262F B5                         or l
2630 F3                         di
2631 B1                         or c
;
; --- Lookup table for special character patterns (9 entries x 2 bytes) ---
; Format: character_number, special_pattern_byte
;
2632                   ChLUT:   .defb $5C, $42
2634                            .defb $2F, $20
2636                            .defb $21, $FF
2638                            .defb $19, $C6
263A                            .defb $16, $46
263C                            .defb $10, $88
263E                            .defb $0F, $21
2640                            .defb $07, $C6
2642                            .defb $01, $EE
2644 CD 08 27                   call L2708
2647 CD 4D 26                   call L264D
264A C3 97 27                   jp L2797
264D 21 F2 22      L264D:       ld hl,$22F2
2650 11 0D F3                   ld de,$F30D
2653 01 14 00                   ld bc,$0014
2656 ED B0                      ldir
2658 CD 86 26      L2658:       call L2686
265B 11 0D F4                   ld de,$F40D
265E 01 15 23                   ld bc,$2315
2661 CD 73 26                   call L2673
2664 11 0D FB                   ld de,$FB0D
2667 CD 73 26                   call L2673
266A 11 0D F7                   ld de,$F70D
266D CD 73 26                   call L2673
2670 11 0D FF                   ld de,$FF0D
2673 E5            L2673:       push hl
2674 C5                         push bc
2675 01 0F 00                   ld bc,$000F
2678 ED B0                      ldir
267A E1                         pop hl
267B 0E 05                      ld c,$05
267D ED B0                      ldir
267F CD 86 26                   call L2686
2682 44                         ld b,h
2683 4D                         ld c,l
2684 E1                         pop hl
2685 C9                         ret
2686 06 0F         L2686:       ld b,$0F
2688 AF                         xor a
2689 12            L2689:       ld (de),a
268A 13                         inc de
268B 10 FC                      djnz L2689
268D C9                         ret
268E 37            L268E:       scf
268F FD CB 45 4E   L268F:       bit 1,(iy+$45)
2693 28 2C                      jr z,L26C1
2695 D5                         push de
2696 F5                         push af
2697 7C                         ld a,h
2698 07                         rlca
2699 07                         rlca
269A 07                         rlca
269B E6 07                      and $07
269D 5F                         ld e,a
269E 7C                         ld a,h
269F E6 1F                      and $1F
26A1 F6 C0                      or $C0
26A3 67                         ld h,a
26A4 01 3B 24                   ld bc,$243B
26A7 16 13                      ld d,$13
26A9 ED 51                      out (c),d
26AB 04                         inc b
26AC ED 78                      in a,(c)
26AE 87                         add a,a
26AF 83                         add a,e
26B0 5F                         ld e,a
26B1 ED 92 56                   nextreg $56,a
26B4 F1                         pop af
26B5 30 05                      jr nc,L26BC
26B7 7B                         ld a,e
26B8 3C                         inc a
26B9 ED 92 57                   nextreg $57,a
26BC D1            L26BC:       pop de
26BD 01 FF E0                   ld bc,$E0FF
26C0 C9                         ret
26C1 CB 3C         L26C1:       srl h
26C3 30 02                      jr nc,L26C7
26C5 CB FD                      set 7,l
26C7 CB F4         L26C7:       set 6,h
26C9 01 7F 58                   ld bc,$587F
26CC 7C                         ld a,h
26CD B8                         cp b
26CE D8                         ret c
26CF C6 68                      add a,$68
26D1 67                         ld h,a
26D2 06 D8                      ld b,$D8
26D4 C9                         ret
26D5 37            L26D5:       scf
26D6 CB 79         L26D6:       bit 7,c
26D8 28 17                      jr z,L26F1
26DA CB AC                      res 5,h
26DC 3E 56                      ld a,$56
26DE C5            L26DE:       push bc
26DF 01 3B 24                   ld bc,$243B
26E2 ED 79                      out (c),a
26E4 04                         inc b
26E5 ED 78                      in a,(c)
26E7 3C                         inc a
26E8 ED 79                      out (c),a
26EA C1                         pop bc
26EB D0                         ret nc
26EC 3E 57                      ld a,$57
26EE A7                         and a
26EF 18 ED                      jr L26DE
26F1 7C            L26F1:       ld a,h
26F2 C6 68                      add a,$68
26F4 67                         ld h,a
26F5 06 D8                      ld b,$D8
26F7 C9                         ret
26F8 5F            L26F8:       ld e,a
26F9 3A 7F 5C      L26F9:       ld a,(GMODE)
26FC E6 0F                      and $0F
26FE C8                         ret z
26FF FE 03                      cp $03
2701 D8                         ret c
2702 CB 3F                      srl a
2704 CB 3F                      srl a
2706 3D                         dec a
2707 C9                         ret
;
;
;
2708 16 56         L2708:       ld d,$56
;
; Pages in banks $0B to MMU4, $10 to MMU5. Saves old pages to OMMU45
;
270A C1            PgIn100B:    pop bc                      ; Pop the return value into BC
270B 21 00 00                   ld hl,$0000                 ; 
270E 39                         add hl,sp                   ; HL := SP, Carry reset
270F 7C                         ld a,h                      ; A := the MSB of SP
2710 FE 5C                      cp $5C                      ; 
2712 38 08                      jr c,L271C                  ; Jump if MSP of SP < $5C (temporary stack)
2714 2A 6A 5B                   ld hl,(TMPSP)               ; HL := TMPSP
2717 ED 73 6A 5B                ld (TMPSP),sp               ; Save SP to TMPSP
271B F9                         ld sp,hl                    ; Use the TMPSP
271C 32 8E 5B      L271C:       ld ($5B8E),a                ; Store the MSB of SP
271F C5                         push bc                     ; Store the return value into the stack
2720 CD BA 27                   call SetMMU100B             ; Set pages $0B for Slot 4, $10 for slot 5
2723 22 8A 5B                   ld (OMMU45),hl              ; Old Slot4 and 5 pages
2726 C9                         ret                         ; Done
2727 1E 80         L2727:       ld e,$80
2729 18 02                      jr L272D
272B 1E FF         L272B:       ld e,$FF
272D 22 8F 5B      L272D:       ld ($5B8F),hl
2730 CD 08 27                   call L2708
2733 CD 9E 27                   call L279E
2736 2A 8F 5B                   ld hl,($5B8F)
2739 16 FF                      ld d,$FF
273B CB 7B                      bit 7,e
273D 20 03                      jr nz,L2742
273F 53                         ld d,e
2740 1E FF                      ld e,$FF
2742 7E            L2742:       ld a,(hl)
2743 23                         inc hl
2744 BB                         cp e
2745 38 07                      jr c,L274E
2747 16 01                      ld d,$01
2749 1C                         inc e
274A 28 22                      jr z,L276E
274C CB BF                      res 7,a
274E E5            L274E:       push hl
274F D5                         push de
2750 5F                         ld e,a
2751 CD 40 1D                   call L1D40
2754 D1                         pop de
2755 E1                         pop hl
2756 15                         dec d
2757 20 E9                      jr nz,L2742
2759 18 13                      jr L276E
275B 5F            L275B:       ld e,a
275C CD 08 27                   call L2708
275F CD 9E 27                   call L279E
2762 CD 40 1D                   call L1D40
2765 18 07                      jr L276E
2767 5F            L2767:       ld e,a
2768 CD 08 27                   call L2708
276B CD 47 1D                   call L1D47
276E 2A 8A 5B      L276E:       ld hl,(OMMU45)
2771 7D                         ld a,l
2772 ED 92 56                   nextreg $56,a
2775 7C                         ld a,h
2776 ED 92 57                   nextreg $57,a
2779 3A 8E 5B      L2779:       ld a,($5B8E)
277C FE 5C                      cp $5C
277E D8                         ret c
277F 2A 6A 5B                   ld hl,(TMPSP)
2782 ED 73 6A 5B                ld (TMPSP),sp
2786 F9                         ld sp,hl
2787 C9                         ret
2788 78            L2788:       ld a,b
2789 B1                         or c
278A C8                         ret z
278B 1A                         ld a,(de)
278C C5                         push bc
278D D5                         push de
278E CD 5B 27                   call L275B
2791 D1                         pop de
2792 C1                         pop bc
2793 13                         inc de
2794 0B                         dec bc
2795 18 F1                      jr L2788
2797 16 56         L2797:       ld d,$56
2799 CD B5 27      L2799:       call L27B5
279C 18 DB                      jr L2779
279E FD 7E 45      L279E:       ld a,(iy+$45)
27A1 E6 0F                      and $0F
27A3 DD BE 1E                   cp (ix+$1E)
27A6 C8                         ret z
27A7 DD AE 1E                   xor (ix+$1E)
27AA FE 05                      cp $05
27AC C8                         ret z
27AD 3E 5E                      ld a,$5E
27AF F7            L27AF:       rst $30
27B0 DF            L27B0:       rst $18
27B1 A5                         and l
27B2 0D                         dec c
27B3 16 56         L27B3:       ld d,$56
27B5 2A 8A 5B      L27B5:       ld hl,(OMMU45)
27B8 18 03                      jr SetMMU
;
; Sets the MMU slot pair in D ($50-$57) to the ULA Screen banks
;
27BA 21 0B 10      SetMMU100B: ld hl,$100B                  ; HL := Pages $10, and $0b
;
; Sets the MMU slot pair in D ($50-$57) to the L, and H values, respectively
; Returns with the old values in HL
;
27BD C5            SetMMU:      push bc                     ; Save BC
27BE 01 3B 24                   ld bc,$243B                 ; BC := Next register index port
27C1 ED 51                      out (c),d                   ; Set thre Next register index to D
27C3 04                         inc b                       ; BC := Next register value port
27C4 ED 78                      in a,(c)                    ; A := Register value
27C6 ED 69                      out (c),l                   ; Set new register value to L
27C8 6F                         ld l,a                      ; L := old register value
27C9 05                         dec b                       ; BC := Next register index port 
27CA 14                         inc d                       ; Next register index
27CB ED 51                      out (c),d                   ; Set thre Next register index to D
27CD 04                         inc b                       ; BC := Next register value port 
27CE ED 78                      in a,(c)                    ; A := Register value
27D0 ED 61                      out (c),h                   ; Set new register value to L 
27D2 67                         ld h,a                      ; L := old register value
27D3 C1                         pop bc                      ; Restore BC
27D4 C9                         ret                         ; Done
;
;
;
27D5 FD CB 37 FE   L27D5:       set 7,(iy+$37)
27D9 A7                         and a
27DA 28 03                      jr z,L27DF
27DC 4F                         ld c,a
27DD 06 00                      ld b,$00
27DF CB 78         L27DF:       bit 7,b
27E1 28 0F                      jr z,L27F2
27E3 DD 21 00 00                ld ix,$0000
27E7 FD 7E 45                   ld a,(iy+$45)
27EA E6 0F                      and $0F
27EC 28 04                      jr z,L27F2
27EE C6 F2                      add a,$F2
27F0 DD 67                      ld xh,a
27F2 79            L27F2:       ld a,c
27F3 A7                         and a
27F4 C8                         ret z
27F5 7B                         ld a,e
27F6 CB 50                      bit 2,b
27F8 28 01                      jr z,L27FB
27FA 7A                         ld a,d
27FB 32 9A 5B      L27FB:       ld ($5B9A),a
27FE 22 8F 5B                   ld ($5B8F),hl
2801 21 71 5C                   ld hl,$5C71
2804 7E                         ld a,(hl)
2805 E6 E3                      and $E3
2807 77                         ld (hl),a
2808 78                         ld a,b
2809 E6 10                      and $10
280B B6                         or (hl)
280C 77                         ld (hl),a
280D 78                         ld a,b
280E 87                         add a,a
280F 87                         add a,a
2810 E6 0C                      and $0C
2812 B6                         or (hl)
2813 77                         ld (hl),a
2814 78                         ld a,b
2815 ED 23                      swapnib
2817 E6 06                      and $06
2819 47                         ld b,a
281A 21 3C 5C                   ld hl,$5C3C
281D 7E                         ld a,(hl)
281E E6 F9                      and $F9
2820 B0                         or b
2821 77                         ld (hl),a
2822 43                         ld b,e
2823 79                         ld a,c
2824 B8                         cp b
2825 30 01                      jr nc,L2828
2827 41                         ld b,c
2828 ED 43 9B 5B   L2828:       ld ($5B9B),bc
282C CD 08 27                   call L2708
282F DD 24                      inc xh
2831 DD 25                      dec xh
2833 C4 9E 27                   call nz,L279E
2836 DD 36 1B 00                ld (ix+$1B),$00
283A 3A 9A 5B                   ld a,($5B9A)
283D 57                         ld d,a
283E 21 71 5C                   ld hl,$5C71
2841 CB 66                      bit 4,(hl)
2843 CB A6                      res 4,(hl)
2845 ED 4B 9B 5B                ld bc,($5B9B)
2849 2A 8F 5B                   ld hl,($5B8F)
284C 28 06                      jr z,L2854
284E CD F9 2A                   call L2AF9
2851 C4 85 2A                   call nz,L2A85
2854 3E 0D         L2854:       ld a,$0D
2856 32 9B 5B                   ld ($5B9B),a
2859 04                         inc b
285A 05                         dec b
285B 20 10                      jr nz,L286D
285D 3A 71 5C                   ld a,($5C71)
2860 E6 C0                      and $C0
2862 20 09                      jr nz,L286D
2864 36 22                      ld (hl),$22
2866 23                         inc hl
2867 36 22                      ld (hl),$22
2869 2B                         dec hl
286A 14                         inc d
286B 06 02                      ld b,$02
286D AF            L286D:       xor a
286E F5                         push af
286F 2A 8F 5B      L286F:       ld hl,($5B8F)
2872 1E 00                      ld e,$00
2874 7A                         ld a,d
2875 CD EB 2A                   call L2AEB
2878 FD CB 37 66                bit 4,(iy+$37)
287C CC A9 2A                   call z,L2AA9
287F 78                         ld a,b
2880 92                         sub d
2881 CD EB 2A                   call L2AEB
2884 F1                         pop af
2885 93                         sub e
2886 D4 76 2A                   call nc,L2A76
2889 FD CB 37 66                bit 4,(iy+$37)
288D 20 2F                      jr nz,L28BE
288F C5                         push bc
2890 D5                         push de
2891 CD 55 12                   call L1255
2894 D1                         pop de
2895 C1                         pop bc
2896 21 41 29                   ld hl,$2941
2899 CD A1 15                   call L15A1
289C 28 12                      jr z,L28B0
289E FE 20                      cp $20
28A0 30 48                      jr nc,L28EA
28A2 21 71 5C                   ld hl,$5C71
28A5 CB 5E                      bit 3,(hl)
28A7 28 0E                      jr z,L28B7
28A9 32 9B 5B                   ld ($5B9B),a
28AC CB E6                      set 4,(hl)
28AE CB 96                      res 2,(hl)
28B0 C5            L28B0:       push bc
28B1 D5                         push de
28B2 D4 18 3E                   call nc,L3E18
28B5 D1                         pop de
28B6 C1                         pop bc
28B7 7B            L28B7:       ld a,e
28B8 F5                         push af
28B9 CD 85 2A                   call L2A85
28BC 18 B1                      jr L286F
28BE 58            L28BE:       ld e,b
28BF DD 7E 18                   ld a,(ix+$18)
28C2 DD 96 22                   sub (ix+$22)
28C5 CB 3F                      srl a
28C7 CB 3F                      srl a
28C9 CB 3F                      srl a
28CB 47                         ld b,a
28CC DD 7E 1A                   ld a,(ix+$1A)
28CF 90                         sub b
28D0 3C                         inc a
28D1 DD 77 1B                   ld (ix+$1B),a
28D4 FD 7E 37                   ld a,(iy+$37)
28D7 1F                         rra
28D8 1F                         rra
28D9 E6 03                      and $03
28DB 47                         ld b,a
28DC 3A 9B 5B                   ld a,($5B9B)
28DF 4F                         ld c,a
28E0 D5                         push de
28E1 16 56                      ld d,$56
28E3 CD B5 27                   call L27B5
28E6 D1                         pop de
28E7 C3 79 27                   jp L2779
28EA F5            L28EA:       push af
28EB FE 20                      cp $20
28ED 20 08                      jr nz,L28F7
28EF 3E FE                      ld a,$FE
28F1 DB FE                      in a,($FE)
28F3 1F                         rra
28F4 D4 2A 29                   call nc,L292A
28F7 F1            L28F7:       pop af
28F8 67                         ld h,a
28F9 FE 80                      cp $80
28FB 38 06                      jr c,L2903
28FD FD CB 02 4E                bit 1,(iy+$02)
2901 28 B4                      jr z,L28B7
2903 78            L2903:       ld a,b
2904 B9                         cp c
2905 30 A9                      jr nc,L28B0
2907 E5                         push hl
2908 2A 8F 5B                   ld hl,($5B8F)
290B 7A                         ld a,d
290C ED 31                      add hl,a
290E 04                         inc b
290F 14                         inc d
2910 79                         ld a,c
2911 92                         sub d
2912 28 0F                      jr z,L2923
2914 C5                         push bc
2915 D5                         push de
2916 E5                         push hl
2917 4F                         ld c,a
2918 06 00                      ld b,$00
291A 09                         add hl,bc
291B 54                         ld d,h
291C 5D                         ld e,l
291D 2B                         dec hl
291E ED B8                      lddr
2920 E1                         pop hl
2921 D1            L2921:       pop de
2922 C1                         pop bc
2923 F1            L2923:       pop af
2924 77                         ld (hl),a
2925 CD D2 29                   call L29D2
2928 18 8D                      jr L28B7
292A FD CB 02 56   L292A:       bit 2,(iy+$02)
292E C8                         ret z
292F DF                         rst $18
2930 75                         ld (hl),l
2931 3E C0                      ld a,$C0
2933 CD B3 27                   call L27B3
2936 2A 6A 5B                   ld hl,(TMPSP)
2939 ED 73 6A 5B                ld (TMPSP),sp
293D F9                         ld sp,hl
293E DF                         rst $18
293F 1E 00                      ld e,$00
2941 00                         nop
2942 A6                         and (hl)
2943 29                         add hl,hl
2944 03                         inc bc
2945 66                         ld h,(hl)
2946 2A 04 FA                   ld hl,($FA04)
2949 29                         add hl,hl
294A 05                         dec b
294B 15                         dec d
294C 2A 07 75                   ld hl,($7507)
294F 29                         add hl,hl
2950 08                         ex af,af'
2951 7A                         ld a,d
2952 29                         add hl,hl
2953 09                         add hl,bc
2954 80                         add a,b
2955 29                         add hl,hl
2956 0A                         ld a,(bc)
2957 96                         sub (hl)
2958 29                         add hl,hl
2959 0B                         dec bc
295A 86                         add a,(hl)
295B 29                         add hl,hl
295C 0C                         inc c
295D B7                         or a
295E 29                         add hl,hl
295F 0D                         dec c
2960 DD 29                      add ix,ix
2962 10 6D                      djnz L29D1
2964 2A 11 70                   ld hl,($7011)
2967 2A 18 B3                   ld hl,($B318)
296A 29                         add hl,hl
296B 1B                         dec de
296C 30 2A                      jr nc,L2998
296E 1C                         inc e
296F 4B                         ld c,e
2970 2A 1D AC                   ld hl,($AC1D)
2973 29                         add hl,hl
2974 FF                         rst $38
2975 06 00                      ld b,$00
2977 50                         ld d,b
2978 37                         scf
2979 C9                         ret
297A 15            L297A:       dec d
297B 37                         scf
297C F0                         ret p
297D 14                         inc d
297E A7                         and a
297F C9                         ret
2980 7A            L2980:       ld a,d
2981 B8                         cp b
2982 C8                         ret z
2983 14                         inc d
2984 37                         scf
2985 C9                         ret
2986 CD 7A 29                   call L297A
2989 D0                         ret nc
298A CD AE 16                   call L16AE
298D 9A                         sbc a,d
298E ED 44                      neg
2990 16 00                      ld d,$00
2992 37                         scf
2993 F8                         ret m
2994 57                         ld d,a
2995 C9                         ret
2996 CD 80 29                   call L2980
2999 D0                         ret nc
299A CD AE 16                   call L16AE
299D 82                         add a,d
299E 3D                         dec a
299F 50                         ld d,b
29A0 B8                         cp b
29A1 3F                         ccf
29A2 D8                         ret c
29A3 37                         scf
29A4 57                         ld d,a
29A5 C9                         ret
29A6 7A                         ld a,d
29A7 B8                         cp b
29A8 C8                         ret z
29A9 50                         ld d,b
29AA 37                         scf
29AB C9                         ret
29AC 7A                         ld a,d
29AD A7                         and a
29AE C8                         ret z
29AF 16 00                      ld d,$00
29B1 37                         scf
29B2 C9                         ret
29B3 7A            L29B3:       ld a,d
29B4 B8                         cp b
29B5 C8                         ret z
29B6 14                         inc d
29B7 7A            L29B7:       ld a,d
29B8 A7                         and a
29B9 C8                         ret z
29BA C5                         push bc
29BB D5                         push de
29BC 2A 8F 5B                   ld hl,($5B8F)
29BF ED 31                      add hl,a
29C1 54                         ld d,h
29C2 5D                         ld e,l
29C3 1B                         dec de
29C4 78                         ld a,b
29C5 92                         sub d
29C6 28 05                      jr z,L29CD
29C8 48                         ld c,b
29C9 06 00                      ld b,$00
29CB ED B0                      ldir
29CD D1            L29CD:       pop de
29CE C1                         pop bc
29CF 05                         dec b
29D0 15                         dec d
29D1 37            L29D1:       scf
29D2 21 71 5C      L29D2:       ld hl,$5C71
29D5 CB 56                      bit 2,(hl)
29D7 C8                         ret z
29D8 CB E6         L29D8:       set 4,(hl)
29DA CB 9E                      res 3,(hl)
29DC C9                         ret
29DD 21 71 5C                   ld hl,$5C71
29E0 CB 96                      res 2,(hl)
29E2 37                         scf
29E3 18 F3                      jr L29D8
29E5 2A 8F 5B      L29E5:       ld hl,($5B8F)
29E8 7A                         ld a,d
29E9 ED 31                      add hl,a
29EB 2B                         dec hl
29EC 7E                         ld a,(hl)
29ED FE 20                      cp $20
29EF C9                         ret
29F0 2A 8F 5B      L29F0:       ld hl,($5B8F)
29F3 7A                         ld a,d
29F4 ED 31                      add hl,a
29F6 7E                         ld a,(hl)
29F7 FE 20                      cp $20
29F9 C9                         ret
29FA 7A                         ld a,d
29FB A7                         and a
29FC C8                         ret z
29FD CD E5 29      L29FD:       call L29E5
2A00 20 07                      jr nz,L2A09
2A02 CD 7A 29                   call L297A
2A05 38 F6                      jr c,L29FD
2A07 37                         scf
2A08 C9                         ret
2A09 CD E5 29      L2A09:       call L29E5
2A0C 37                         scf
2A0D C8                         ret z
2A0E CD 7A 29                   call L297A
2A11 38 F6                      jr c,L2A09
2A13 37                         scf
2A14 C9                         ret
2A15 7A                         ld a,d
2A16 B8                         cp b
2A17 C8                         ret z
2A18 CD F0 29      L2A18:       call L29F0
2A1B 28 07                      jr z,L2A24
2A1D CD 80 29                   call L2980
2A20 38 F6                      jr c,L2A18
2A22 37                         scf
2A23 C9                         ret
2A24 CD F0 29      L2A24:       call L29F0
2A27 37                         scf
2A28 C0                         ret nz
2A29 CD 80 29                   call L2980
2A2C 38 F6                      jr c,L2A24
2A2E 37                         scf
2A2F C9                         ret
2A30 7A                         ld a,d
2A31 A7                         and a
2A32 C8                         ret z
2A33 CD E5 29      L2A33:       call L29E5
2A36 20 07                      jr nz,L2A3F
2A38 CD B7 29                   call L29B7
2A3B 38 F6                      jr c,L2A33
2A3D 37                         scf
2A3E C9                         ret
2A3F CD E5 29      L2A3F:       call L29E5
2A42 37                         scf
2A43 C8                         ret z
2A44 CD B7 29                   call L29B7
2A47 38 F6                      jr c,L2A3F
2A49 37                         scf
2A4A C9                         ret
2A4B 7A                         ld a,d
2A4C B8                         cp b
2A4D C8                         ret z
2A4E CD F0 29      L2A4E:       call L29F0
2A51 28 07                      jr z,L2A5A
2A53 CD B3 29                   call L29B3
2A56 38 F6                      jr c,L2A4E
2A58 37                         scf
2A59 C9                         ret
2A5A CD F0 29      L2A5A:       call L29F0
2A5D 37                         scf
2A5E C0                         ret nz
2A5F CD B3 29                   call L29B3
2A62 38 F6                      jr c,L2A5A
2A64 37                         scf
2A65 C9                         ret
2A66 CD B7 29      L2A66:       call L29B7
2A69 3F                         ccf
2A6A D8                         ret c
2A6B 18 F9                      jr L2A66
2A6D 42                         ld b,d
2A6E 37                         scf
2A6F C9                         ret
2A70 CD 68 00                   call L0068
2A73 A0                         and b
2A74 13                         inc de
2A75 C9                         ret
2A76 C8            L2A76:       ret z
2A77 D5                         push de
2A78 5F                         ld e,a
2A79 D5                         push de
2A7A 3E 20                      ld a,$20
2A7C CD 9E 2A                   call L2A9E
2A7F D1                         pop de
2A80 CD 85 2A                   call L2A85
2A83 D1                         pop de
2A84 C9                         ret
2A85 1C            L2A85:       inc e
2A86 1D                         dec e
2A87 C8                         ret z
2A88 DD 24                      inc xh
2A8A DD 25                      dec xh
2A8C 3E 08                      ld a,$08
2A8E 28 0E                      jr z,L2A9E
2A90 DD 36 28 FF                ld (ix+$28),$FF
2A94 3E 0C                      ld a,$0C
2A96 CD 9E 2A                   call L2A9E
2A99 DD 36 28 00                ld (ix+$28),$00
2A9D C9                         ret
2A9E F5            L2A9E:       push af
2A9F D5                         push de
2AA0 CD 12 2B                   call L2B12
2AA3 D1                         pop de
2AA4 F1                         pop af
2AA5 1D                         dec e
2AA6 20 F6                      jr nz,L2A9E
2AA8 C9                         ret
2AA9 E5            L2AA9:       push hl
2AAA D5                         push de
2AAB C5                         push bc
2AAC CD D9 2A                   call L2AD9
2AAF CD E8 2A                   call L2AE8
2AB2 D6 90                      sub $90
2AB4 87                         add a,a
2AB5 87                         add a,a
2AB6 87                         add a,a
2AB7 01 08 00                   ld bc,$0008
2ABA 21 F7 0D                   ld hl,StripePtr
2ABD 5F                         ld e,a
2ABE 50                         ld d,b
2ABF 19                         add hl,de
2AC0 11 9D 5B                   ld de,$5B9D
2AC3 D5                         push de
2AC4 ED B0                      ldir
2AC6 D1                         pop de
2AC7 CD 58 0E                   call L0E58
2ACA E5                         push hl
2ACB 3E 90                      ld a,$90
2ACD CD 26 2B                   call L2B26
2AD0 D1                         pop de
2AD1 CD 58 0E                   call L0E58
2AD4 C1                         pop bc
2AD5 D1                         pop de
2AD6 E1                         pop hl
2AD7 1C                         inc e
2AD8 C9                         ret
2AD9 3A 41 5C      L2AD9:       ld a,($5C41)
2ADC E6 03                      and $03
2ADE C0                         ret nz
2ADF 3A 6A 5C                   ld a,($5C6A)
2AE2 E6 08                      and $08
2AE4 C8                         ret z
2AE5 3E 03                      ld a,$03
2AE7 C9                         ret
2AE8 C6 92         L2AE8:       add a,$92
2AEA C9                         ret
2AEB C5            L2AEB:       push bc
2AEC 47                         ld b,a
2AED 04                         inc b
2AEE 18 05                      jr L2AF5
2AF0 7E            L2AF0:       ld a,(hl)
2AF1 23                         inc hl
2AF2 CD 12 2B                   call L2B12
2AF5 10 F9         L2AF5:       djnz L2AF0
2AF7 C1                         pop bc
2AF8 C9                         ret
2AF9 C5            L2AF9:       push bc
2AFA E5                         push hl
2AFB 1E 00                      ld e,$00
2AFD 04                         inc b
2AFE 18 05                      jr L2B05
2B00 7E            L2B00:       ld a,(hl)
2B01 23                         inc hl
2B02 CD 0A 2B                   call L2B0A
2B05 10 F9         L2B05:       djnz L2B00
2B07 E1                         pop hl
2B08 C1                         pop bc
2B09 C9                         ret
2B0A E5            L2B0A:       push hl
2B0B 21 10 2B                   ld hl,$2B10
2B0E 18 06                      jr L2B16
2B10 1C                         inc e
2B11 C9                         ret
2B12 E5            L2B12:       push hl
2B13 21 26 2B                   ld hl,$2B26
2B16 CD 3E 2B      L2B16:       call L2B3E
2B19 30 09                      jr nc,L2B24
2B1B C5                         push bc
2B1C 44                         ld b,h
2B1D 4D                         ld c,l
2B1E CD 5B 2B                   call L2B5B
2B21 C1                         pop bc
2B22 E1                         pop hl
2B23 C9                         ret
2B24 E3            L2B24:       ex (sp),hl
2B25 C9                         ret
2B26 1C            L2B26:       inc e
2B27 DD 24                      inc xh
2B29 DD 25                      dec xh
2B2B C2 C0 16                   jp nz,L16C0
2B2E C5                         push bc
2B2F D5                         push de
2B30 E5                         push hl
2B31 5F                         ld e,a
2B32 CD B3 27                   call L27B3
2B35 7B                         ld a,e
2B36 D7                         rst $10
2B37 CD 42 19                   call L1942
2B3A E1                         pop hl
2B3B D1                         pop de
2B3C C1                         pop bc
2B3D C9                         ret
2B3E FE A5         L2B3E:       cp $A5
2B40 3F                         ccf
2B41 D0                         ret nc
2B42 DD 24                      inc xh
2B44 DD 25                      dec xh
2B46 C8                         ret z
2B47 D5                         push de
2B48 E5                         push hl
2B49 26 00                      ld h,$00
2B4B 6F                         ld l,a
2B4C ED 34 70 FF                add hl,$FF70
2B50 29                         add hl,hl
2B51 29                         add hl,hl
2B52 29                         add hl,hl
2B53 ED 5B 7B 5C                ld de,(UDG)
2B57 19                         add hl,de
2B58 E1                         pop hl
2B59 D1                         pop de
2B5A C9                         ret
2B5B D5            L2B5B:       push de
2B5C D6 A5                      sub $A5
2B5E 11 95 00                   ld de,$0095
2B61 EF                         rst $28
2B62 41                         ld b,c
2B63 0C                         inc c
2B64 EB                         ex de,hl
2B65 D1                         pop de
2B66 38 13                      jr c,L2B7B
2B68 DD 24                      inc xh
2B6A DD 25                      dec xh
2B6C 28 06                      jr z,L2B74
2B6E DD CB 25 4E                bit 1,(ix+$25)
2B72 18 04                      jr L2B78
2B74 FD CB 01 46   L2B74:       bit 0,(iy+$01)
2B78 CC 94 2B      L2B78:       call z,L2B94
2B7B EF            L2B7B:       rst $28
2B7C 7B                         ld a,e
2B7D 00                         nop
2B7E 23                         inc hl
2B7F F5            L2B7F:       push af
2B80 C5                         push bc
2B81 E5                         push hl
2B82 E6 7F                      and $7F
2B84 CD 98 2B                   call L2B98
2B87 E1                         pop hl
2B88 C1                         pop bc
2B89 F1                         pop af
2B8A 87                         add a,a
2B8B 30 EE                      jr nc,L2B7B
2B8D FE 48                      cp $48
2B8F 28 03                      jr z,L2B94
2B91 FE 82                      cp $82
2B93 D8                         ret c
2B94 3E A0         L2B94:       ld a,$A0
2B96 18 E7                      jr L2B7F
2B98 C5            L2B98:       push bc
2B99 C9                         ret
2B9A D9            L2B9A:       exx
2B9B CD A0 2B                   call L2BA0
2B9E D9                         exx
2B9F C9                         ret
2BA0 CD 08 27      L2BA0:       call L2708
2BA3 D9                         exx
2BA4 04                         inc b
2BA5 10 0B                      djnz L2BB2
2BA7 DD 7E 21                   ld a,(ix+$21)
2BAA DD 6E 23                   ld l,(ix+$23)
2BAD DD 66 22                   ld h,(ix+$22)
2BB0 18 18                      jr L2BCA
2BB2 10 0D         L2BB2:       djnz L2BC1
2BB4 7A                         ld a,d
2BB5 A7                         and a
2BB6 C2 7E 1B                   jp nz,L1B7E
2BB9 DD 73 2D                   ld (ix+$2D),e
2BBC CD F9 1A                   call L1AF9
2BBF 18 1B                      jr L2BDC
2BC1 DD 7E 15      L2BC1:       ld a,(ix+$15)
2BC4 3C                         inc a
2BC5 2E 00                      ld l,$00
2BC7 DD 66 18                   ld h,(ix+$18)
2BCA DD 96 13      L2BCA:       sub (ix+$13)
2BCD 5F                         ld e,a
2BCE DD 56 1D                   ld d,(ix+$1D)
2BD1 ED 30                      mul d,e
2BD3 7C                         ld a,h
2BD4 26 00                      ld h,$00
2BD6 EB                         ex de,hl
2BD7 19                         add hl,de
2BD8 DD 96 17                   sub (ix+$17)
2BDB 5F                         ld e,a
2BDC D9            L2BDC:       exx
2BDD C3 6E 27                   jp L276E
2BE0 ED 91 57 10   L2BE0:       nextreg $57,$10
2BE4 21 C7 E3                   ld hl,$E3C7
2BE7 5E                         ld e,(hl)
2BE8 36 00                      ld (hl),$00
2BEA 23                         inc hl
2BEB 56                         ld d,(hl)
2BEC ED 91 57 0F                nextreg $57,$0F
2BF0 21 45 52                   ld hl,$5245
2BF3 A7                         and a
2BF4 ED 52                      sbc hl,de
2BF6 20 0B                      jr nz,L2C03
2BF8 21 54 14                   ld hl,$1454
2BFB CD A6 2C                   call L2CA6
2BFE 3E 00                      ld a,$00
2C00 E7                         rst $20
2C01 B1                         or c
2C02 01 CD DD                   ld bc,$DDCD
2C05 0E DF                      ld c,$DF
2C07 B9                         cp c
2C08 14                         inc d
2C09 CD 03 10                   call SvDispState
2C0C CD 92 3B                   call L3B92
2C0F 21 00 F7                   ld hl,$F700
2C12 11 E7 12                   ld de,$12E7
2C15 3E FF                      ld a,$FF
2C17 06 0F                      ld b,$0F
2C19 CD 2E 2C                   call L2C2E
2C1C C3 B8 11      L2C1C:       jp L11B8
2C1F 3A E9 D5      L2C1F:       ld a,($D5E9)
2C22 FE 3B                      cp $3B
2C24 38 F6                      jr c,L2C1C
2C26 20 B8                      jr nz,L2BE0
2C28 AF                         xor a
2C29 CD 68 00                   call L0068
2C2C FC 02 F5                   call m,LF502
2C2F 7A                         ld a,d
2C30 B3                         or e
2C31 CA 3B 33                   jp z,L333B
2C34 F1                         pop af
2C35 32 D4 D5                   ld ($D5D4),a
2C38 E6 40                      and $40
2C3A 28 01                      jr z,L2C3D
2C3C 78                         ld a,b
2C3D 32 D5 D5      L2C3D:       ld ($D5D5),a
2C40 22 CE D5                   ld ($D5CE),hl
2C43 ED 53 D0 D5                ld ($D5D0),de
2C47 AF                         xor a
2C48 32 DC D5                   ld ($D5DC),a
2C4B CD 26 32                   call L3226
2C4E CD 64 32                   call L3264
2C51 CD FA 32      L2C51:       call L32FA
2C54 3E 7F         L2C54:       ld a,$7F
2C56 DB FE                      in a,($FE)
2C58 1F                         rra
2C59 30 F9                      jr nc,L2C54
2C5B FD CB 01 AE                res 5,(iy+$01)
2C5F ED 73 D6 D5                ld ($D5D6),sp
2C63 CD D1 34                   call L34D1
2C66 FD CB 30 9E                res 3,(iy+$30)
2C6A CD 55 12                   call L1255
2C6D F5                         push af
2C6E 3A E2 D5                   ld a,($D5E2)
2C71 A7                         and a
2C72 21 21 3D                   ld hl,$3D21
2C75 28 03                      jr z,L2C7A
2C77 21 FA 3C                   ld hl,$3CFA
2C7A F1            L2C7A:       pop af
2C7B CD 82 2C                   call L2C82
2C7E 20 D1                      jr nz,L2C51
2C80 18 D2                      jr L2C54
2C82 CD A1 15      L2C82:       call L15A1
2C85 D4 18 3E                   call nc,L3E18
2C88 AF                         xor a
2C89 32 41 5C                   ld ($5C41),a
2C8C FD CB 30 6E                bit 5,(iy+$30)
2C90 C9                         ret
2C91 DD 21 00 F7   L2C91:       ld ix,$F700
2C95 D5                         push de
2C96 3E 16                      ld a,$16
2C98 CD 5B 27                   call L275B
2C9B D1                         pop de
2C9C D5                         push de
2C9D 7B                         ld a,e
2C9E CD 5B 27                   call L275B
2CA1 D1                         pop de
2CA2 7A                         ld a,d
2CA3 C3 5B 27                   jp L275B
2CA6 44            L2CA6:       ld b,h
2CA7 4D                         ld c,l
2CA8 21 27 D8                   ld hl,$D827
2CAB E5            L2CAB:       push hl
2CAC 0A            L2CAC:       ld a,(bc)
2CAD 03                         inc bc
2CAE 77                         ld (hl),a
2CAF 23                         inc hl
2CB0 3C                         inc a
2CB1 20 F9                      jr nz,L2CAC
2CB3 E1                         pop hl
2CB4 C9                         ret
2CB5 21 E4 D5      L2CB5:       ld hl,$D5E4
2CB8 34                         inc (hl)
2CB9 21 C3 D3                   ld hl,$D3C3
2CBC 11 38 C7                   ld de,$C738
2CBF D5                         push de
2CC0 01 0D 00                   ld bc,$000D
2CC3 ED B0                      ldir
2CC5 18 15                      jr L2CDC
2CC7 21 EA D5      L2CC7:       ld hl,$D5EA
2CCA CB 9E                      res 3,(hl)
2CCC AF            L2CCC:       xor a
2CCD 32 E4 D5                   ld ($D5E4),a
2CD0 3A EA D5                   ld a,($D5EA)
2CD3 E6 40                      and $40
2CD5 32 E1 D5                   ld ($D5E1),a
2CD8 CD 32 2D                   call L2D32
2CDB D5                         push de
2CDC 21 26 15      L2CDC:       ld hl,$1526
2CDF CD DC 33                   call L33DC
2CE2 D1                         pop de
2CE3 AF                         xor a
2CE4 F5                         push af
2CE5 3A E1 D5                   ld a,($D5E1)
2CE8 A7                         and a
2CE9 28 1F                      jr z,L2D0A
2CEB 21 0B 00                   ld hl,$000B
2CEE CD A6 2C                   call L2CA6
2CF1 01 A7 00                   ld bc,$00A7
2CF4 CD 50 2D                   call L2D50
2CF7 22 DF D5                   ld ($D5DF),hl
2CFA A7                         and a
2CFB 28 0D                      jr z,L2D0A
2CFD C1                         pop bc
2CFE FE F7                      cp $F7
2D00 30 27                      jr nc,L2D29
2D02 F5                         push af
2D03 CD 3F 2D                   call L2D3F
2D06 AF                         xor a
2D07 32 E1 D5                   ld ($D5E1),a
2D0A AF            L2D0A:       xor a
2D0B D5                         push de
2D0C CD 9B 33                   call L339B
2D0F D1                         pop de
2D10 C1                         pop bc
2D11 C5                         push bc
2D12 3A EA D5                   ld a,($D5EA)
2D15 E6 40                      and $40
2D17 F6 27                      or $27
2D19 4F                         ld c,a
2D1A D5                         push de
2D1B CD 50 2D                   call L2D50
2D1E 22 DD D5                   ld ($D5DD),hl
2D21 D1                         pop de
2D22 C1                         pop bc
2D23 80                         add a,b
2D24 F5                         push af
2D25 CD 3F 2D                   call L2D3F
2D28 F1                         pop af
2D29 21 EA D5      L2D29:       ld hl,$D5EA
2D2C CB DE                      set 3,(hl)
2D2E 32 E2 D5                   ld ($D5E2),a
2D31 C9                         ret
2D32 11 38 C7      L2D32:       ld de,$C738
2D35 D5                         push de
2D36 AF                         xor a
2D37 06 0D                      ld b,$0D
2D39 12            L2D39:       ld (de),a
2D3A 13                         inc de
2D3B 10 FC                      djnz L2D39
2D3D D1                         pop de
2D3E C9                         ret
2D3F D5            L2D3F:       push de
2D40 21 38 C7                   ld hl,$C738
2D43 06 0D                      ld b,$0D
2D45 1A            L2D45:       ld a,(de)
2D46 4E                         ld c,(hl)
2D47 77                         ld (hl),a
2D48 79                         ld a,c
2D49 12                         ld (de),a
2D4A 13                         inc de
2D4B 23                         inc hl
2D4C 10 F7                      djnz L2D45
2D4E D1                         pop de
2D4F C9                         ret
2D50 3E F8         L2D50:       ld a,$F8
2D52 90                         sub b
2D53 47                         ld b,a
2D54 3A EA D5                   ld a,($D5EA)
2D57 CB 5F                      bit 3,a
2D59 28 02                      jr z,L2D5D
2D5B CB E1                      set 4,c
2D5D EE 10         L2D5D:       xor $10
2D5F E6 30                      and $30
2D61 67                         ld h,a
2D62 79                         ld a,c
2D63 E6 C0                      and $C0
2D65 B4                         or h
2D66 67                         ld h,a
2D67 C5                         push bc
2D68 D5                         push de
2D69 E5                         push hl
2D6A CD 7E 35                   call L357E
2D6D E1                         pop hl
2D6E D1                         pop de
2D6F C1                         pop bc
2D70 E6 07                      and $07
2D72 B4                         or h
2D73 67                         ld h,a
2D74 E6 03                      and $03
2D76 FE 01                      cp $01
2D78 28 02                      jr z,L2D7C
2D7A CB DC                      set 3,h
2D7C 7C            L2D7C:       ld a,h
2D7D CB B1                      res 6,c
2D7F 21 27 D8                   ld hl,$D827
2D82 E7                         rst $20
2D83 1E 01                      ld e,$01
2D85 3E 00                      ld a,$00
2D87 32 E3 D5                   ld ($D5E3),a
2D8A 30 02                      jr nc,L2D8E
2D8C 78                         ld a,b
2D8D 3D                         dec a
2D8E F5            L2D8E:       push af
2D8F 57                         ld d,a
2D90 1E 0D                      ld e,$0D
2D92 ED 30                      mul d,e
2D94 ED 35 38 C7                add de,$C738
2D98 F1                         pop af
2D99 C9                         ret
2D9A 0E 01                      ld c,$01
2D9C 06 00         L2D9C:       ld b,$00
2D9E C5            L2D9E:       push bc
2D9F E5                         push hl
2DA0 11 98 15                   ld de,$1598
2DA3 CD CA 31                   call L31CA
2DA6 E1                         pop hl
2DA7 C1                         pop bc
2DA8 37                         scf
2DA9 C8                         ret z
2DAA A7                         and a
2DAB 05                         dec b
2DAC C8                         ret z
2DAD 23                         inc hl
2DAE EB                         ex de,hl
2DAF 2A CE D5                   ld hl,($D5CE)
2DB2 7E            L2DB2:       ld a,(hl)
2DB3 23                         inc hl
2DB4 3C                         inc a
2DB5 28 2D                      jr z,L2DE4
2DB7 3D                         dec a
2DB8 28 F8                      jr z,L2DB2
2DBA D5                         push de
2DBB E5                         push hl
2DBC F5                         push af
2DBD CD 31 2E                   call L2E31
2DC0 20 1B                      jr nz,L2DDD
2DC2 7E                         ld a,(hl)
2DC3 CD 8C 2E                   call L2E8C
2DC6 20 15                      jr nz,L2DDD
2DC8 0D                         dec c
2DC9 20 12                      jr nz,L2DDD
2DCB C1                         pop bc
2DCC E1                         pop hl
2DCD 7E            L2DCD:       ld a,(hl)
2DCE 23                         inc hl
2DCF 05                         dec b
2DD0 CD 8C 2E                   call L2E8C
2DD3 20 F8                      jr nz,L2DCD
2DD5 CD 14 31                   call L3114
2DD8 A7                         and a
2DD9 78                         ld a,b
2DDA D1                         pop de
2DDB 37                         scf
2DDC C9                         ret
2DDD F1            L2DDD:       pop af
2DDE E1                         pop hl
2DDF ED 31                      add hl,a
2DE1 D1                         pop de
2DE2 18 CE                      jr L2DB2
2DE4 1A            L2DE4:       ld a,(de)
2DE5 FE 20                      cp $20
2DE7 28 02                      jr z,L2DEB
2DE9 A7            L2DE9:       and a
2DEA C9                         ret
2DEB C5            L2DEB:       push bc
2DEC EB                         ex de,hl
2DED ED 34 F8 FF                add hl,$FFF8
2DF1 11 27 D8                   ld de,$D827
2DF4 D5                         push de
2DF5 CD 0D 34                   call L340D
2DF8 E1                         pop hl
2DF9 11 01 00                   ld de,$0001
2DFC 42                         ld b,d
2DFD 4B                         ld c,e
2DFE E7                         rst $20
2DFF 06 01                      ld b,$01
2E01 C1                         pop bc
2E02 D0                         ret nc
2E03 C5                         push bc
2E04 06 00                      ld b,$00
2E06 E7                         rst $20
2E07 0F                         rrca
2E08 01 F5 DD                   ld bc,$DDF5
2E0B E5                         push hl
2E0C 06 00                      ld b,$00
2E0E E7                         rst $20
2E0F 09                         add hl,bc
2E10 01 E1 F1                   ld bc,$F1E1
2E13 C1                         pop bc
2E14 D0                         ret nc
2E15 7E                         ld a,(hl)
2E16 23                         inc hl
2E17 5E                         ld e,(hl)
2E18 23                         inc hl
2E19 56                         ld d,(hl)
2E1A A7                         and a
2E1B 21 9A 15                   ld hl,$159A
2E1E CA 9C 2D      L2E1E:       jp z,L2D9C
2E21 FE 03                      cp $03
2E23 20 C4                      jr nz,L2DE9
2E25 21 00 1B                   ld hl,$1B00
2E28 ED 52                      sbc hl,de
2E2A 20 BD                      jr nz,L2DE9
2E2C 21 9D 15                   ld hl,$159D
2E2F 18 ED                      jr L2E1E
2E31 D5            L2E31:       push de
2E32 06 03                      ld b,$03
2E34 7E            L2E34:       ld a,(hl)
2E35 FE 2A                      cp $2A
2E37 23                         inc hl
2E38 28 21                      jr z,L2E5B
2E3A 2B                         dec hl
2E3B 1A                         ld a,(de)
2E3C 13                         inc de
2E3D E6 7F                      and $7F
2E3F FE 20                      cp $20
2E41 28 2C                      jr z,L2E6F
2E43 BE                         cp (hl)
2E44 28 12                      jr z,L2E58
2E46 FE 41                      cp $41
2E48 38 09                      jr c,L2E53
2E4A FE 5B                      cp $5B
2E4C 30 05                      jr nc,L2E53
2E4E CB EF                      set 5,a
2E50 BE                         cp (hl)
2E51 28 05                      jr z,L2E58
2E53 7E            L2E53:       ld a,(hl)
2E54 FE 3F                      cp $3F
2E56 20 21                      jr nz,L2E79
2E58 23            L2E58:       inc hl
2E59 10 D9                      djnz L2E34
2E5B D1            L2E5B:       pop de
2E5C 7E                         ld a,(hl)
2E5D FE 2C                      cp $2C
2E5F 20 2B                      jr nz,L2E8C
2E61 23            L2E61:       inc hl
2E62 7E                         ld a,(hl)
2E63 CD 8C 2E                   call L2E8C
2E66 C8                         ret z
2E67 CD 95 2E                   call L2E95
2E6A 20 F5                      jr nz,L2E61
2E6C AF            L2E6C:       xor a
2E6D 3C                         inc a
2E6E C9                         ret
2E6F 7E            L2E6F:       ld a,(hl)
2E70 FE 2C                      cp $2C
2E72 28 E7                      jr z,L2E5B
2E74 CD 8C 2E                   call L2E8C
2E77 28 E2                      jr z,L2E5B
2E79 D1            L2E79:       pop de
2E7A 7E            L2E7A:       ld a,(hl)
2E7B FE 2C                      cp $2C
2E7D 23                         inc hl
2E7E 28 B1                      jr z,L2E31
2E80 CD 8C 2E                   call L2E8C
2E83 28 E7                      jr z,L2E6C
2E85 CD 95 2E                   call L2E95
2E88 28 E2                      jr z,L2E6C
2E8A 18 EE                      jr L2E7A
2E8C FE 3A         L2E8C:       cp $3A
2E8E C8                         ret z
2E8F FE 3B                      cp $3B
2E91 C8                         ret z
2E92 FE 3C                      cp $3C
2E94 C9                         ret
2E95 FE FF         L2E95:       cp $FF
2E97 C8                         ret z
2E98 FE 0D         L2E98:       cp $0D
2E9A C8                         ret z
2E9B FE 0A                      cp $0A
2E9D C9                         ret
2E9E AF                         xor a
2E9F 32 41 5C                   ld ($5C41),a
2EA2 3A D5 D5                   ld a,($D5D5)
2EA5 2F                         cpl
2EA6 E6 04                      and $04
2EA8 C0                         ret nz
2EA9 ED 73 D8 D5                ld ($D5D8),sp
2EAD 11 90 14                   ld de,$1490
2EB0 CD B7 3B                   call L3BB7
2EB3 E5            L2EB3:       push hl
2EB4 21 67 3D                   ld hl,$3D67
2EB7 01 06 00                   ld bc,$0006
2EBA 11 27 D8                   ld de,$D827
2EBD ED B0                      ldir
2EBF E1                         pop hl
2EC0 D5                         push de
2EC1 EB                         ex de,hl
2EC2 21 90 E0                   ld hl,$E090
2EC5 0E 00                      ld c,$00
2EC7 E5            L2EC7:       push hl
2EC8 DD E1                      pop ix
2ECA CB B9                      res 7,c
2ECC 36 16                      ld (hl),$16
2ECE 23                         inc hl
2ECF 79                         ld a,c
2ED0 CB 3F                      srl a
2ED2 CB 3F                      srl a
2ED4 C6 16                      add a,$16
2ED6 77                         ld (hl),a
2ED7 23                         inc hl
2ED8 D5                         push de
2ED9 79                         ld a,c
2EDA E6 03                      and $03
2EDC 57                         ld d,a
2EDD 1E 0D                      ld e,$0D
2EDF ED 30                      mul d,e
2EE1 73                         ld (hl),e
2EE2 23                         inc hl
2EE3 D1                         pop de
2EE4 06 0D                      ld b,$0D
2EE6 1A            L2EE6:       ld a,(de)
2EE7 13                         inc de
2EE8 FE 3A                      cp $3A
2EEA 28 30                      jr z,L2F1C
2EEC CD 95 2E                   call L2E95
2EEF 28 08                      jr z,L2EF9
2EF1 CB 6F                      bit 5,a
2EF3 28 09                      jr z,L2EFE
2EF5 77            L2EF5:       ld (hl),a
2EF6 23                         inc hl
2EF7 10 ED                      djnz L2EE6
2EF9 DD E5         L2EF9:       push ix
2EFB E1                         pop hl
2EFC 18 63                      jr L2F61
2EFE CB 79         L2EFE:       bit 7,c
2F00 20 F3                      jr nz,L2EF5
2F02 CB F9                      set 7,c
2F04 36 14                      ld (hl),$14
2F06 23                         inc hl
2F07 36 01                      ld (hl),$01
2F09 23                         inc hl
2F0A 77                         ld (hl),a
2F0B 23                         inc hl
2F0C 36 14                      ld (hl),$14
2F0E 23                         inc hl
2F0F 36 00                      ld (hl),$00
2F11 23                         inc hl
2F12 CB EF                      set 5,a
2F14 E3                         ex (sp),hl
2F15 77                         ld (hl),a
2F16 E3                         ex (sp),hl
2F17 05                         dec b
2F18 28 DF                      jr z,L2EF9
2F1A 18 CA                      jr L2EE6
2F1C E5            L2F1C:       push hl
2F1D CD FF 33                   call L33FF
2F20 1A                         ld a,(de)
2F21 CB EF                      set 5,a
2F23 FE 66                      cp $66
2F25 20 05                      jr nz,L2F2C
2F27 CB 7E                      bit 7,(hl)
2F29 20 18                      jr nz,L2F43
2F2B 13                         inc de
2F2C FE 64         L2F2C:       cp $64
2F2E 20 05                      jr nz,L2F35
2F30 CB 7E                      bit 7,(hl)
2F32 28 0F                      jr z,L2F43
2F34 13                         inc de
2F35 23            L2F35:       inc hl
2F36 1A                         ld a,(de)
2F37 FE 2E                      cp $2E
2F39 20 0B                      jr nz,L2F46
2F3B 13                         inc de
2F3C EB                         ex de,hl
2F3D CD 31 2E                   call L2E31
2F40 EB                         ex de,hl
2F41 28 03                      jr z,L2F46
2F43 E1            L2F43:       pop hl
2F44 18 B3                      jr L2EF9
2F46 1A            L2F46:       ld a,(de)
2F47 13                         inc de
2F48 FE 3A                      cp $3A
2F4A 20 F7                      jr nz,L2F43
2F4C E1                         pop hl
2F4D E3                         ex (sp),hl
2F4E 23                         inc hl
2F4F 36 D0                      ld (hl),$D0
2F51 23                         inc hl
2F52 36 2F                      ld (hl),$2F
2F54 23                         inc hl
2F55 24                         inc h
2F56 73                         ld (hl),e
2F57 23                         inc hl
2F58 72                         ld (hl),d
2F59 2B                         dec hl
2F5A 25                         dec h
2F5B E3                         ex (sp),hl
2F5C 0C                         inc c
2F5D CB 59                      bit 3,c
2F5F 20 0F                      jr nz,L2F70
2F61 CD 98 2E      L2F61:       call L2E98
2F64 CA C7 2E                   jp z,L2EC7
2F67 3C                         inc a
2F68 28 04                      jr z,L2F6E
2F6A 1A                         ld a,(de)
2F6B 13                         inc de
2F6C 18 F3                      jr L2F61
2F6E 16 00         L2F6E:       ld d,$00
2F70 ED 53 DA D5   L2F70:       ld ($D5DA),de
2F74 3E FF                      ld a,$FF
2F76 77                         ld (hl),a
2F77 E1                         pop hl
2F78 77                         ld (hl),a
2F79 79                         ld a,c
2F7A E6 7F                      and $7F
2F7C 28 1D                      jr z,L2F9B
2F7E CD D4 33      L2F7E:       call L33D4
2F81 CD D9 33                   call L33D9
2F84 21 90 E0                   ld hl,$E090
2F87 CD C4 2F                   call L2FC4
2F8A FD CB 30 9E   L2F8A:       res 3,(iy+$30)
2F8E CD 55 12                   call L1255
2F91 21 27 D8                   ld hl,$D827
2F94 CD 82 2C                   call L2C82
2F97 20 E5                      jr nz,L2F7E
2F99 18 EF                      jr L2F8A
2F9B ED 7B D8 D5   L2F9B:       ld sp,($D5D8)
2F9F AF            L2F9F:       xor a
2FA0 32 DC D5                   ld ($D5DC),a
2FA3 FD CB 30 EE                set 5,(iy+$30)
2FA7 37                         scf
2FA8 C9                         ret
2FA9 ED 7B D8 D5                ld sp,($D5D8)
2FAD CD 9F 2F                   call L2F9F
2FB0 2A DA D5                   ld hl,($D5DA)
2FB3 7C                         ld a,h
2FB4 A7                         and a
2FB5 28 E4                      jr z,L2F9B
2FB7 7E            L2FB7:       ld a,(hl)
2FB8 23                         inc hl
2FB9 CD 98 2E                   call L2E98
2FBC CA B3 2E                   jp z,L2EB3
2FBF 3C                         inc a
2FC0 28 D9                      jr z,L2F9B
2FC2 18 F3                      jr L2FB7
2FC4 7E            L2FC4:       ld a,(hl)
2FC5 23                         inc hl
2FC6 FE FF                      cp $FF
2FC8 C8                         ret z
2FC9 E5                         push hl
2FCA CD 5B 27                   call L275B
2FCD E1                         pop hl
2FCE 18 F4                      jr L2FC4
2FD0 24                         inc h
2FD1 5E                         ld e,(hl)
2FD2 23                         inc hl
2FD3 56                         ld d,(hl)
2FD4 EB                         ex de,hl
2FD5 7E                         ld a,(hl)
2FD6 CD 8C 2E                   call L2E8C
2FD9 28 26                      jr z,L3001
2FDB 11 30 DA                   ld de,$DA30
2FDE 7E            L2FDE:       ld a,(hl)
2FDF 13                         inc de
2FE0 23                         inc hl
2FE1 12                         ld (de),a
2FE2 CD 95 2E                   call L2E95
2FE5 C8                         ret z
2FE6 CD 8C 2E                   call L2E8C
2FE9 20 F3                      jr nz,L2FDE
2FEB AF                         xor a
2FEC 12                         ld (de),a
2FED 2B                         dec hl
2FEE E5                         push hl
2FEF CD D4 33                   call L33D4
2FF2 CD D9 33                   call L33D9
2FF5 FD CB 30 EE                set 5,(iy+$30)
2FF9 21 31 DA                   ld hl,$DA31
2FFC DF                         rst $18
2FFD 6C                         ld l,h
2FFE 2B                         dec hl
2FFF E1                         pop hl
3000 C0                         ret nz
3001 7E            L3001:       ld a,(hl)
3002 23                         inc hl
3003 CD 8C 2E                   call L2E8C
3006 37                         scf
3007 3F                         ccf
3008 C0                         ret nz
3009 4F                         ld c,a
300A 06 FF                      ld b,$FF
300C 11 00 F7                   ld de,$F700
300F D5                         push de
3010 04            L3010:       inc b
3011 7E                         ld a,(hl)
3012 12                         ld (de),a
3013 23                         inc hl
3014 13                         inc de
3015 CD 95 2E                   call L2E95
3018 20 F6                      jr nz,L3010
301A C5                         push bc
301B CD F9 33                   call L33F9
301E C1                         pop bc
301F E1                         pop hl
3020 79                         ld a,c
3021 C3 D3 30                   jp L30D3
3024 3A D5 D5                   ld a,($D5D5)
3027 2F                         cpl
3028 E6 02                      and $02
302A C0                         ret nz
302B 3E 3C                      ld a,$3C
302D CD 14 31                   call L3114
3030 CD F9 33                   call L33F9
3033 28 0D                      jr z,L3042
3035 CD C7 31                   call L31C7
3038 20 08                      jr nz,L3042
303A CD 1D 31                   call L311D
303D 21 5E 15                   ld hl,$155E
3040 18 55                      jr L3097
3042 CD AA 38      L3042:       call L38AA
3045 30 4B                      jr nc,L3092
3047 21 31 DA                   ld hl,$DA31
304A E5                         push hl
304B 01 01 00                   ld bc,$0001
304E 7E            L304E:       ld a,(hl)
304F 23                         inc hl
3050 3C                         inc a
3051 28 0B                      jr z,L305E
3053 04                         inc b
3054 28 07                      jr z,L305D
3056 FE 2F                      cp $2F
3058 20 F4                      jr nz,L304E
305A 48                         ld c,b
305B 18 F1                      jr L304E
305D 05            L305D:       dec b
305E 0D            L305E:       dec c
305F 28 01                      jr z,L3062
3061 41                         ld b,c
3062 78            L3062:       ld a,b
3063 D1                         pop de
3064 D5                         push de
3065 ED 32                      add de,a
3067 21 61 15                   ld hl,$1561
306A 01 05 00                   ld bc,$0005
306D ED B0                      ldir
306F E1                         pop hl
3070 E5                         push hl
3071 CD 9A 30                   call L309A
3074 38 20                      jr c,L3096
3076 21 66 15                   ld hl,$1566
3079 11 00 F7                   ld de,$F700
307C 01 0F 00                   ld bc,$000F
307F ED B0                      ldir
3081 E1                         pop hl
3082 7E            L3082:       ld a,(hl)
3083 ED A0                      ldi
3085 3C                         inc a
3086 20 FA                      jr nz,L3082
3088 21 00 F7                   ld hl,$F700
308B E5                         push hl
308C CD 9A 30                   call L309A
308F 38 05                      jr c,L3096
3091 E1                         pop hl
3092 ED 8A 15 66   L3092:       push $1566
3096 E1            L3096:       pop hl
3097 C3 33 09      L3097:       jp L0933
309A 11 01 00      L309A:       ld de,$0001
309D 42                         ld b,d
309E 4B                         ld c,e
309F E7                         rst $20
30A0 06 01                      ld b,$01
30A2 D0                         ret nc
30A3 06 00                      ld b,$00
30A5 E7                         rst $20
30A6 09                         add hl,bc
30A7 01 37 C9                   ld bc,$C937
30AA 0E 02                      ld c,$02
30AC 3E 7F                      ld a,$7F
30AE DB FE                      in a,($FE)
30B0 A1                         and c
30B1 28 01                      jr z,L30B4
30B3 0D                         dec c
30B4 CD F9 33      L30B4:       call L33F9
30B7 28 1F                      jr z,L30D8
30B9 0D                         dec c
30BA 20 0B                      jr nz,L30C7
30BC 3A D5 D5                   ld a,($D5D5)
30BF 2F                         cpl
30C0 E6 01                      and $01
30C2 20 03                      jr nz,L30C7
30C4 CD C7 31                   call L31C7
30C7 C2 5D 32      L30C7:       jp nz,L325D
30CA CD 1D 31                   call L311D
30CD D0                         ret nc
30CE 21 4C 15                   ld hl,$154C
30D1 3E 3C                      ld a,$3C
30D3 CD 14 31      L30D3:       call L3114
30D6 18 13                      jr L30EB
30D8 CD 9C 2D      L30D8:       call L2D9C
30DB D0                         ret nc
30DC 20 0D                      jr nz,L30EB
30DE C5                         push bc
30DF 11 27 D8                   ld de,$D827
30E2 01 FF 03                   ld bc,$03FF
30E5 CD BA 3B                   call L3BBA
30E8 C1                         pop bc
30E9 18 4A                      jr L3135
30EB A7            L30EB:       and a
30EC E5                         push hl
30ED F5                         push af
30EE 01 27 D8                   ld bc,$D827
30F1 21 90 E0                   ld hl,$E090
30F4 CD AB 2C                   call L2CAB
30F7 CD AA 38                   call L38AA
30FA F1                         pop af
30FB F5                         push af
30FC C4 E6 31                   call nz,L31E6
30FF F1                         pop af
3100 E1                         pop hl
3101 CA DB 31                   jp z,L31DB
3104 E5                         push hl
3105 ED 31                      add hl,a
3107 7E                         ld a,(hl)
3108 36 0D                      ld (hl),$0D
310A E3                         ex (sp),hl
310B F5                         push af
310C CD 4C 09                   call L094C
310F F1                         pop af
3110 E1                         pop hl
3111 77                         ld (hl),a
3112 A7                         and a
3113 C9                         ret
3114 32 E9 D5      L3114:       ld ($D5E9),a
3117 3E FE                      ld a,$FE
3119 32 B8 D5                   ld ($D5B8),a
311C C9                         ret
311D 21 27 D8      L311D:       ld hl,$D827
3120 3E 00                      ld a,$00
3122 E7                         rst $20
3123 B1                         or c
3124 01 ED 91                   ld bc,$91ED
3127 57                         ld d,a
3128 10 11                      djnz L313B
312A 45                         ld b,l
312B 52                         ld d,d
312C ED 53 C7 E3                ld ($E3C7),de
3130 ED 91 57 0F                nextreg $57,$0F
3134 C9                         ret
3135 11 8D 15      L3135:       ld de,$158D
3138 06 08                      ld b,$08
313A 1A            L313A:       ld a,(de)
313B BE            L313B:       cp (hl)
313C 13                         inc de
313D 23                         inc hl
313E 37            L313E:       scf
313F 3F                         ccf
3140 C0                         ret nz
3141 10 F7                      djnz L313A
3143 7E                         ld a,(hl)
3144 CD 98 2E                   call L2E98
3147 20 F5                      jr nz,L313E
3149 C5                         push bc
314A CD A2 31                   call L31A2
314D 30 05                      jr nc,L3154
314F E5                         push hl
3150 CD 5D 32                   call L325D
3153 E1                         pop hl
3154 C1            L3154:       pop bc
3155 D0                         ret nc
3156 C5                         push bc
3157 CD A2 31                   call L31A2
315A C1                         pop bc
315B 3F                         ccf
315C D8                         ret c
315D C5                         push bc
315E 21 27 D8                   ld hl,$D827
3161 E5                         push hl
3162 CD 47 38                   call L3847
3165 E1                         pop hl
3166 11 00 C4                   ld de,$C400
3169 7E            L3169:       ld a,(hl)
316A ED A0                      ldi
316C 3C                         inc a
316D 20 FA                      jr nz,L3169
316F 1B                         dec de
3170 12                         ld (de),a
3171 21 EA D5                   ld hl,$D5EA
3174 CB BE                      res 7,(hl)
3176 CD DA 34      L3176:       call L34DA
3179 16 FF                      ld d,$FF
317B 14            L317B:       inc d
317C 3A E2 D5                   ld a,($D5E2)
317F 5F                         ld e,a
3180 7A                         ld a,d
3181 BB                         cp e
3182 38 0D                      jr c,L3191
3184 D5                         push de
3185 CD 05 37                   call L3705
3188 D1                         pop de
3189 38 EB                      jr c,L3176
318B CD EA 32                   call L32EA
318E A7                         and a
318F C1                         pop bc
3190 C9                         ret
3191 CD 64 36      L3191:       call L3664
3194 20 E5                      jr nz,L317B
3196 7A                         ld a,d
3197 CD 51 37                   call L3751
319A C1                         pop bc
319B 79                         ld a,c
319C 3D                         dec a
319D CA B4 30                   jp z,L30B4
31A0 37                         scf
31A1 C9                         ret
31A2 11 27 D8      L31A2:       ld de,$D827
31A5 01 02 FE                   ld bc,$FE02
31A8 7E            L31A8:       ld a,(hl)
31A9 FE FF                      cp $FF
31AB C8                         ret z
31AC 23                         inc hl
31AD CD 98 2E                   call L2E98
31B0 28 F6                      jr z,L31A8
31B2 12            L31B2:       ld (de),a
31B3 13                         inc de
31B4 7E                         ld a,(hl)
31B5 CD 95 2E                   call L2E95
31B8 28 08                      jr z,L31C2
31BA 23                         inc hl
31BB 10 F5                      djnz L31B2
31BD 0D                         dec c
31BE 20 F2                      jr nz,L31B2
31C0 A7                         and a
31C1 C9                         ret
31C2 3E FF         L31C2:       ld a,$FF
31C4 12                         ld (de),a
31C5 37                         scf
31C6 C9                         ret
31C7 11 95 15      L31C7:       ld de,$1595
31CA EB            L31CA:       ex de,hl
31CB 06 03                      ld b,$03
31CD 13            L31CD:       inc de
31CE 1A                         ld a,(de)
31CF E6 7F                      and $7F
31D1 BE                         cp (hl)
31D2 23                         inc hl
31D3 C0                         ret nz
31D4 10 F7                      djnz L31CD
31D6 C9                         ret
31D7 AF                         xor a
31D8 3C                         inc a
31D9 18 07                      jr L31E2
31DB 11 31 DA      L31DB:       ld de,$DA31
31DE 21 90 E0                   ld hl,$E090
31E1 AF                         xor a
31E2 ED 7B D6 D5   L31E2:       ld sp,($D5D6)
31E6 37            L31E6:       scf
31E7 F5                         push af
31E8 E5                         push hl
31E9 D5                         push de
31EA 01 81 15                   ld bc,$1581
31ED 21 52 C7                   ld hl,$C752
31F0 E5                         push hl
31F1 CD AB 2C                   call L2CAB
31F4 CD 32 2D                   call L2D32
31F7 E1                         pop hl
31F8 01 A0 02                   ld bc,$02A0
31FB AF                         xor a
31FC D5                         push de
31FD E5                         push hl
31FE E7                         rst $20
31FF 1E 01                      ld e,$01
3201 E1                         pop hl
3202 D1                         pop de
3203 01 20 02                   ld bc,$0220
3206 AF                         xor a
3207 E7                         rst $20
3208 1E 01                      ld e,$01
320A CD 78 10                   call L1078
320D CD BD 33                   call L33BD
3210 CD D4 33                   call L33D4
3213 3A 93 D6                   ld a,($D693)
3216 DF                         rst $18
3217 A9                         xor c
3218 14                         inc d
3219 2A 3A D7                   ld hl,($D73A)
321C EF                         rst $28
321D 15                         dec d
321E 16 CD                      ld d,$CD
3220 C9                         ret
3221 0E D1                      ld c,$D1
3223 E1                         pop hl
3224 F1                         pop af
3225 C9                         ret
3226 A7            L3226:       and a
3227 CD BD 33                   call L33BD
322A 3A 7F 5C                   ld a,(GMODE)
322D 32 93 D6                   ld ($D693),a
3230 2A 51 5C                   ld hl,($5C51)
3233 22 3A D7                   ld ($D73A),hl
3236 3E 05                      ld a,$05
3238 DF                         rst $18
3239 A9                         xor c
323A 14                         inc d
323B 3E 02                      ld a,$02
323D EF                         rst $28
323E 01 16 C3                   ld bc,$C316
3241 14                         inc d
3242 10 3E                      djnz L3282
3244 43                         ld b,e
3245 E7                         rst $20
3246 2D                         dec l
3247 01 21 84                   ld bc,$8421
324A 15                         dec d
324B CD A6 2C                   call L2CA6
324E 3E 02                      ld a,$02
3250 E7                         rst $20
3251 B1                         or c
3252 01 18 08                   ld bc,$0818
3255 21 54 14                   ld hl,$1454
3258 CD A6 2C                   call L2CA6
325B 18 03                      jr L3260
325D 21 27 D8      L325D:       ld hl,$D827
3260 E7            L3260:       rst $20
3261 06 05                      ld b,$05
3263 D0                         ret nc
3264 21 F7 09      L3264:       ld hl,$09F7
3267 11 33 D6                   ld de,$D633
326A CD 4A 3F                   call L3F4A
326D DD 21 00 F7                ld ix,$F700
3271 3A 3A D6                   ld a,($D63A)
3274 CD 6F 35                   call L356F
3277 21 A0 14                   ld hl,$14A0
327A CD DC 33                   call L33DC
327D CD 15 33                   call L3315
3280 21 C9 E4                   ld hl,$E4C9
3283 CD DC 33                   call L33DC
3286 3A 39 D6                   ld a,($D639)
3289 5F                         ld e,a
328A 21 A9 5A                   ld hl,$5AA9
328D 73                         ld (hl),e
328E 21 B7 5A                   ld hl,$5AB7
3291 3A EA D5                   ld a,($D5EA)
3294 CB 67                      bit 4,a
3296 28 01                      jr z,L3299
3298 73                         ld (hl),e
3299 23            L3299:       inc hl
329A CB 6F                      bit 5,a
329C 20 01                      jr nz,L329F
329E 73                         ld (hl),e
329F 23            L329F:       inc hl
32A0 CB 57                      bit 2,a
32A2 28 01                      jr z,L32A5
32A4 73                         ld (hl),e
32A5 CD 63 34      L32A5:       call L3463
32A8 CD 05 35                   call L3505
32AB CD FA 32                   call L32FA
32AE CD C7 2C                   call L2CC7
32B1 ED 91 57 10                nextreg $57,$10
32B5 21 2C D9                   ld hl,$D92C
32B8 11 C9 E3                   ld de,$E3C9
32BB DD 2E 00                   ld xl,$00
32BE 1A            L32BE:       ld a,(de)
32BF BE                         cp (hl)
32C0 28 04                      jr z,L32C6
32C2 DD 2E 01                   ld xl,$01
32C5 7E                         ld a,(hl)
32C6 ED A0         L32C6:       ldi
32C8 3C                         inc a
32C9 20 F3                      jr nz,L32BE
32CB DD 2D                      dec xl
32CD 28 28                      jr z,L32F7
32CF 2A DD E4                   ld hl,($E4DD)
32D2 ED 91 57 0F                nextreg $57,$0F
32D6 3A E4 D5      L32D6:       ld a,($D5E4)
32D9 BD                         cp l
32DA 28 10                      jr z,L32EC
32DC 3A E2 D5                   ld a,($D5E2)
32DF FE F7                      cp $F7
32E1 20 07                      jr nz,L32EA
32E3 E5                         push hl
32E4 CD B5 2C                   call L2CB5
32E7 E1                         pop hl
32E8 18 EC                      jr L32D6
32EA 26 FF         L32EA:       ld h,$FF
32EC 3A E2 D5      L32EC:       ld a,($D5E2)
32EF A7                         and a
32F0 28 05                      jr z,L32F7
32F2 3D                         dec a
32F3 BC                         cp h
32F4 38 01                      jr c,L32F7
32F6 7C                         ld a,h
32F7 C3 4C 37      L32F7:       jp L374C
32FA 2A D0 D5      L32FA:       ld hl,($D5D0)
32FD 3A DC D5                   ld a,($D5DC)
3300 87                         add a,a
3301 30 03                      jr nc,L3306
3303 21 D2 13                   ld hl,$13D2
3306 FD CB 30 AE   L3306:       res 5,(iy+$30)
330A E5            L330A:       push hl
330B CD D4 33                   call L33D4
330E CD D9 33                   call L33D9
3311 E1                         pop hl
3312 C3 2B 27      L3312:       jp L272B
3315 AF            L3315:       xor a
3316 CD 9B 33                   call L339B
3319 20 14                      jr nz,L332F
331B 21 36 D8                   ld hl,$D836
331E 11 EA D5                   ld de,$D5EA
3321 ED A0                      ldi
3323 ED A0                      ldi
3325 4E                         ld c,(hl)
3326 23                         inc hl
3327 46                         ld b,(hl)
3328 21 FF 62                   ld hl,$62FF
332B A7                         and a
332C ED 42                      sbc hl,bc
332E C8                         ret z
332F AF            L332F:       xor a
3330 1B                         dec de
3331 12                         ld (de),a
3332 1B                         dec de
3333 12                         ld (de),a
3334 21 0B 00                   ld hl,$000B
3337 CD 76 33                   call L3376
333A C9                         ret
333B F1            L333B:       pop af
333C FE 08                      cp $08
333E 38 03                      jr c,L3343
3340 3E 15                      ld a,$15
3342 C9                         ret
3343 A7            L3343:       and a
3344 28 0A                      jr z,L3350
3346 3D                         dec a
3347 C2 E4 0F                   jp nz,L0FE4
334A ED 43 EA D5                ld ($D5EA),bc
334E 18 26                      jr L3376
3350 E5            L3350:       push hl
3351 CD 15 33                   call L3315
3354 D1                         pop de
3355 21 27 D8                   ld hl,$D827
3358 01 0F 00                   ld bc,$000F
335B ED B0                      ldir
335D ED 4B EA D5                ld bc,($D5EA)
3361 37                         scf
3362 C9                         ret
3363 C5            L3363:       push bc
3364 AF                         xor a
3365 CD 9B 33                   call L339B
3368 C1                         pop bc
3369 21 EA D5                   ld hl,$D5EA
336C 7E                         ld a,(hl)
336D A8                         xor b
336E 77                         ld (hl),a
336F 23                         inc hl
3370 7E                         ld a,(hl)
3371 A9                         xor c
3372 77                         ld (hl),a
3373 21 27 D8                   ld hl,$D827
3376 ED 91 57 10   L3376:       nextreg $57,$10
337A 11 00 00                   ld de,$0000
337D ED 53 DD E4                ld ($E4DD),de
3381 ED 91 57 0F                nextreg $57,$0F
3385 11 27 D8                   ld de,$D827
3388 01 0F 00                   ld bc,$000F
338B ED B0                      ldir
338D 21 EA D5                   ld hl,$D5EA
3390 0E 02                      ld c,$02
3392 ED B0                      ldir
3394 EB                         ex de,hl
3395 36 FF                      ld (hl),$FF
3397 23                         inc hl
3398 36 62                      ld (hl),$62
339A 37                         scf
339B 21 27 D8      L339B:       ld hl,$D827
339E 11 C9 E4                   ld de,$E4C9
33A1 06 13                      ld b,$13
33A3 38 01                      jr c,L33A6
33A5 EB                         ex de,hl
33A6 ED 91 57 10   L33A6:       nextreg $57,$10
33AA 0E 00                      ld c,$00
33AC 7E            L33AC:       ld a,(hl)
33AD 23                         inc hl
33AE 12                         ld (de),a
33AF 13                         inc de
33B0 81                         add a,c
33B1 4F                         ld c,a
33B2 10 F8                      djnz L33AC
33B4 79                         ld a,c
33B5 BE                         cp (hl)
33B6 12                         ld (de),a
33B7 ED 91 57 0F                nextreg $57,$0F
33BB 37                         scf
33BC C9                         ret
33BD 21 B6 E3      L33BD:       ld hl,$E3B6
33C0 11 89 5B                   ld de,$5B89
33C3 01 22 00                   ld bc,$0022
33C6 38 01                      jr c,L33C9
33C8 EB                         ex de,hl
33C9 ED 91 57 10   L33C9:       nextreg $57,$10
33CD ED B8                      lddr
33CF ED 91 57 0F                nextreg $57,$0F
33D3 C9                         ret
33D4 21 45 14      L33D4:       ld hl,$1445
33D7 18 03                      jr L33DC
33D9 21 CD 14      L33D9:       ld hl,$14CD
33DC DD 21 00 F7   L33DC:       ld ix,$F700
33E0 C3 12 33                   jp L3312
33E3 F5            L33E3:       push af
33E4 E5                         push hl
33E5 ED 34 08 00                add hl,$0008
33E9 CD DC 33                   call L33DC
33EC E1                         pop hl
33ED F1                         pop af
33EE E6 03                      and $03
33F0 87                         add a,a
33F1 ED 31                      add hl,a
33F3 7E                         ld a,(hl)
33F4 23                         inc hl
33F5 66                         ld h,(hl)
33F6 6F                         ld l,a
33F7 18 E3                      jr L33DC
33F9 11 27 D8      L33F9:       ld de,$D827
33FC CD 0A 34                   call L340A
33FF 2A E6 D5      L33FF:       ld hl,($D5E6)
3402 ED 34 07 00                add hl,$0007
3406 A7                         and a
3407 CB 7E                      bit 7,(hl)
3409 C9                         ret
340A 2A E6 D5      L340A:       ld hl,($D5E6)
340D E5            L340D:       push hl
340E E3                         ex (sp),hl
340F 06 08                      ld b,$08
3411 CD 22 34                   call L3422
3414 E3                         ex (sp),hl
3415 7E                         ld a,(hl)
3416 E1                         pop hl
3417 E6 7F                      and $7F
3419 FE 2E                      cp $2E
341B C8                         ret z
341C 3E 2E                      ld a,$2E
341E 12                         ld (de),a
341F 13                         inc de
3420 06 03                      ld b,$03
3422 7E            L3422:       ld a,(hl)
3423 23                         inc hl
3424 E6 7F                      and $7F
3426 FE 20                      cp $20
3428 28 02                      jr z,L342C
342A 12                         ld (de),a
342B 13                         inc de
342C 10 F4         L342C:       djnz L3422
342E 3E FF                      ld a,$FF
3430 12                         ld (de),a
3431 C9                         ret
3432 3A D4 D5                   ld a,($D5D4)
3435 E6 20                      and $20
3437 C8                         ret z
3438 3E FF                      ld a,$FF
343A E7                         rst $20
343B 2D                         dec l
343C 01 FE 43                   ld bc,$43FE
343F C8                         ret z
3440 6F                         ld l,a
3441 E7                         rst $20
3442 F4 00 D0                   call p,LD000
3445 CD 8C 3B                   call L3B8C
3448 3E FF                      ld a,$FF
344A E7                         rst $20
344B 2D                         dec l
344C 01 4F 3C                   ld bc,$3C4F
344F FE 51                      cp $51
3451 38 02                      jr c,L3455
3453 3E 41                      ld a,$41
3455 B9            L3455:       cp c
3456 C8                         ret z
3457 47                         ld b,a
3458 C5                         push bc
3459 E7                         rst $20
345A 2D                         dec l
345B 01 C1 78                   ld bc,$78C1
345E DA 64 32                   jp c,L3264
3461 18 EB                      jr L344E
3463 01 00 00      L3463:       ld bc,$0000
3466 CD 77 12                   call L1277
3469 21 2C D9                   ld hl,$D92C
346C E5                         push hl
346D 3E FF                      ld a,$FF
346F E7                         rst $20
3470 2D                         dec l
3471 01 32 79                   ld bc,$7932
3474 5B                         ld e,e
3475 32 7A 5B                   ld ($5B7A),a
3478 E1                         pop hl
3479 E5                         push hl
347A 77                         ld (hl),a
347B 23                         inc hl
347C 36 3A                      ld (hl),$3A
347E 23                         inc hl
347F 36 FF                      ld (hl),$FF
3481 E1                         pop hl
3482 E5                         push hl
3483 3E 01                      ld a,$01
3485 E7                         rst $20
3486 B1                         or c
3487 01 21 06                   ld bc,$0621
348A 15                         dec d
348B CD DC 33                   call L33DC
348E E1                         pop hl
348F AF                         xor a
3490 46            L3490:       ld b,(hl)
3491 23                         inc hl
3492 3C                         inc a
3493 04                         inc b
3494 20 FA                      jr nz,L3490
3496 2B                         dec hl
3497 3D                         dec a
3498 01 33 00                   ld bc,$0033
349B B9                         cp c
349C 30 01                      jr nc,L349F
349E 4F                         ld c,a
349F 11 31 DA      L349F:       ld de,$DA31
34A2 79                         ld a,c
34A3 ED 32                      add de,a
34A5 ED B8                      lddr
34A7 ED A8                      ldd
34A9 0E 33                      ld c,$33
34AB CD 5B 3B                   call L3B5B
34AE 2E 00                      ld l,$00
34B0 3A 3A D6      L34B0:       ld a,($D63A)
34B3 18 3E                      jr L34F3
34B5 F5            L34B5:       push af
34B6 CD FF 33                   call L33FF
34B9 C1                         pop bc
34BA 20 0D                      jr nz,L34C9
34BC 0E 01                      ld c,$01
34BE CD 9E 2D                   call L2D9E
34C1 3E 00                      ld a,$00
34C3 D0                         ret nc
34C4 3E 01                      ld a,$01
34C6 C8                         ret z
34C7 3C                         inc a
34C8 C9                         ret
34C9 CD C7 31      L34C9:       call L31C7
34CC 3E 03                      ld a,$03
34CE C8                         ret z
34CF 3C                         inc a
34D0 C9                         ret
34D1 AF            L34D1:       xor a
34D2 CD B5 34                   call L34B5
34D5 21 3B D6                   ld hl,$D63B
34D8 18 0F                      jr L34E9
34DA 21 45 D6      L34DA:       ld hl,$D645
34DD 7E                         ld a,(hl)
34DE 2B                         dec hl
34DF 2B                         dec hl
34E0 E5                         push hl
34E1 96                         sub (hl)
34E2 3C                         inc a
34E3 D5                         push de
34E4 CD B5 34                   call L34B5
34E7 D1                         pop de
34E8 E1                         pop hl
34E9 ED 31         L34E9:       add hl,a
34EB 7E                         ld a,(hl)
34EC 2A E8 D5                   ld hl,($D5E8)
34EF ED 34 02 00                add hl,$0002
34F3 01 00 58      L34F3:       ld bc,$5800
34F6 61                         ld h,c
34F7 29                         add hl,hl
34F8 29                         add hl,hl
34F9 29                         add hl,hl
34FA 29                         add hl,hl
34FB 29                         add hl,hl
34FC 09                         add hl,bc
34FD 0E 20                      ld c,$20
34FF 77            L34FF:       ld (hl),a
3500 23                         inc hl
3501 0D                         dec c
3502 20 FB                      jr nz,L34FF
3504 C9                         ret
3505 01 01 01      L3505:       ld bc,$0101
3508 CD 77 12                   call L1277
350B 2E 01                      ld l,$01
350D CD B0 34                   call L34B0
3510 3A 3A D6                   ld a,($D63A)
3513 CD 6F 35                   call L356F
3516 21 FD 13                   ld hl,$13FD
3519 CD DC 33                   call L33DC
351C 3A EA D5                   ld a,($D5EA)
351F E6 40                      and $40
3521 3E 6E                      ld a,$6E
3523 28 07                      jr z,L352C
3525 3E 66                      ld a,$66
3527 CD 5B 27                   call L275B
352A 3E 66                      ld a,$66
352C CD 5B 27      L352C:       call L275B
352F CD 7E 35                   call L357E
3532 F5                         push af
3533 21 3A 14                   ld hl,$143A
3536 E6 07         L3536:       and $07
3538 CC DC 33                   call z,L33DC
353B F1                         pop af
353C F5                         push af
353D 21 EC 14                   ld hl,$14EC
3540 CD E3 33                   call L33E3
3543 21 F9 14                   ld hl,$14F9
3546 3A EA D5                   ld a,($D5EA)
3549 CD E3 33                   call L33E3
354C 3A 39 D6                   ld a,($D639)
354F 4F                         ld c,a
3550 21 20 58                   ld hl,$5820
3553 71                         ld (hl),c
3554 2E 2B                      ld l,$2B
3556 71                         ld (hl),c
3557 2E 32                      ld l,$32
3559 71                         ld (hl),c
355A 2E 33                      ld l,$33
355C 71                         ld (hl),c
355D 2E 36                      ld l,$36
355F 71                         ld (hl),c
3560 2E 3A                      ld l,$3A
3562 71                         ld (hl),c
3563 F1                         pop af
3564 1F                         rra
3565 1F                         rra
3566 E6 01                      and $01
3568 C6 27                      add a,$27
356A 6F                         ld l,a
356B 71                         ld (hl),c
356C 3A 33 D6                   ld a,($D633)
356F DD 21 00 F7   L356F:       ld ix,$F700
3573 F5                         push af
3574 3E 18                      ld a,$18
3576 CD 5B 27                   call L275B
3579 F1                         pop af
357A CD 5B 27                   call L275B
357D C9                         ret
357E 3A D5 D5      L357E:       ld a,($D5D5)
3581 E6 08                      and $08
3583 3E 01                      ld a,$01
3585 C8                         ret z
3586 3A EB D5                   ld a,($D5EB)
3589 37                         scf
358A C9                         ret
358B CD 7E 35                   call L357E
358E E6 07                      and $07
3590 C0                         ret nz
3591 21 EA D5                   ld hl,$D5EA
3594 CB BE                      res 7,(hl)
3596 21 0B 15                   ld hl,$150B
3599 CD 06 33                   call L3306
359C 21 14 15                   ld hl,$1514
359F CD DC 33                   call L33DC
35A2 11 00 00                   ld de,$0000
35A5 06 03                      ld b,$03
35A7 C5            L35A7:       push bc
35A8 D5                         push de
35A9 06 00                      ld b,$00
35AB 4B                         ld c,e
35AC 21 0B 10                   ld hl,$100B
35AF 22 8A 5B                   ld (OMMU45),hl
35B2 21 D2 E1                   ld hl,$E1D2
35B5 11 00 C4                   ld de,$C400
35B8 79                         ld a,c
35B9 A7                         and a
35BA C4 47 19                   call nz,L1947
35BD AF                         xor a
35BE 12                         ld (de),a
35BF CD 0D 36                   call L360D
35C2 78                         ld a,b
35C3 A7                         and a
35C4 20 09                      jr nz,L35CF
35C6 CD DA 34                   call L34DA
35C9 7A                         ld a,d
35CA CD 51 37                   call L3751
35CD 18 04                      jr L35D3
35CF 7A            L35CF:       ld a,d
35D0 CD 4C 37                   call L374C
35D3 CD D1 34      L35D3:       call L34D1
35D6 11 16 08      L35D6:       ld de,$0816
35D9 CD 91 2C                   call L2C91
35DC D1                         pop de
35DD C1                         pop bc
35DE 78                         ld a,b
35DF A7                         and a
35E0 28 25                      jr z,L3607
35E2 AF                         xor a
35E3 06 07                      ld b,$07
35E5 0E 29                      ld c,$29
35E7 21 D2 E1                   ld hl,$E1D2
35EA CD D5 27                   call L27D5
35ED CB 48                      bit 1,b
35EF 28 B6                      jr z,L35A7
35F1 AF                         xor a
35F2 32 41 5C                   ld ($5C41),a
35F5 C5                         push bc
35F6 D5                         push de
35F7 79                         ld a,c
35F8 FE 0E                      cp $0E
35FA 20 DA                      jr nz,L35D6
35FC 21 EA D5                   ld hl,$D5EA
35FF 7E                         ld a,(hl)
3600 EE 80                      xor $80
3602 77                         ld (hl),a
3603 D1                         pop de
3604 C1                         pop bc
3605 18 A0         L3605:       jr L35A7
3607 FD CB 30 EE   L3607:       set 5,(iy+$30)
360B 37                         scf
360C C9                         ret
360D 01 00 00      L360D:       ld bc,$0000
3610 3A E4 D5      L3610:       ld a,($D5E4)
3613 A7                         and a
3614 20 02                      jr nz,L3618
3616 0E 01                      ld c,$01
3618 11 00 00      L3618:       ld de,$0000
361B CD 64 36                   call L3664
361E C8                         ret z
361F 38 28                      jr c,L3649
3621 3A E2 D5                   ld a,($D5E2)
3624 57                         ld d,a
3625 15                         dec d
3626 CD 64 36                   call L3664
3629 C8                         ret z
362A 30 2C                      jr nc,L3658
362C 7B            L362C:       ld a,e
362D BA                         cp d
362E C8                         ret z
362F 3C                         inc a
3630 BA                         cp d
3631 C8                         ret z
3632 82                         add a,d
3633 1F                         rra
3634 F5                         push af
3635 D5                         push de
3636 57                         ld d,a
3637 CD 64 36                   call L3664
363A E1                         pop hl
363B DD E1                      pop ix
363D C8                         ret z
363E EB                         ex de,hl
363F 38 04                      jr c,L3645
3641 DD 5C                      ld e,xh
3643 18 E7                      jr L362C
3645 DD 54         L3645:       ld d,xh
3647 18 E3                      jr L362C
3649 CB 41         L3649:       bit 0,c
364B C0                         ret nz
364C C5                         push bc
364D CD EE 36                   call L36EE
3650 C1                         pop bc
3651 CB C0                      set 0,b
3653 38 BB                      jr c,L3610
3655 16 00                      ld d,$00
3657 C9                         ret
3658 C5            L3658:       push bc
3659 D5                         push de
365A CD 05 37                   call L3705
365D D1                         pop de
365E C1                         pop bc
365F CB C0                      set 0,b
3661 38 AD                      jr c,L3610
3663 C9                         ret
3664 D5            L3664:       push de
3665 14                         inc d
3666 1E 0D                      ld e,$0D
3668 ED 30                      mul d,e
366A ED 35 38 C7                add de,$C738
366E EB                         ex de,hl
366F 3A EA D5                   ld a,($D5EA)
3672 CB 77                      bit 6,a
3674 28 19                      jr z,L368F
3676 E5                         push hl
3677 ED 34 07 00                add hl,$0007
367B CB 7E                      bit 7,(hl)
367D E1                         pop hl
367E 20 08                      jr nz,L3688
3680 87                         add a,a
3681 30 0C                      jr nc,L368F
3683 AF                         xor a
3684 3C                         inc a
3685 37                         scf
3686 D1                         pop de
3687 C9                         ret
3688 87            L3688:       add a,a
3689 38 04                      jr c,L368F
368B AF                         xor a
368C 3C                         inc a
368D D1                         pop de
368E C9                         ret
368F C5            L368F:       push bc
3690 CD AD 38                   call L38AD
3693 21 31 DA                   ld hl,$DA31
3696 CD 47 38                   call L3847
3699 C1                         pop bc
369A 21 30 DA                   ld hl,$DA30
369D 11 FF C3                   ld de,$C3FF
36A0 13            L36A0:       inc de
36A1 23                         inc hl
36A2 1A                         ld a,(de)
36A3 A7                         and a
36A4 28 14                      jr z,L36BA
36A6 BE                         cp (hl)
36A7 28 F7                      jr z,L36A0
36A9 C5                         push bc
36AA CD BF 36                   call L36BF
36AD 4F                         ld c,a
36AE 7E                         ld a,(hl)
36AF CD BF 36                   call L36BF
36B2 47                         ld b,a
36B3 79                         ld a,c
36B4 B8                         cp b
36B5 C1                         pop bc
36B6 28 E8                      jr z,L36A0
36B8 D1                         pop de
36B9 C9                         ret
36BA 56            L36BA:       ld d,(hl)
36BB 14                         inc d
36BC BA                         cp d
36BD D1                         pop de
36BE C9                         ret
36BF FE 61         L36BF:       cp $61
36C1 D8                         ret c
36C2 FE 7B                      cp $7B
36C4 D0                         ret nc
36C5 E6 DF                      and $DF
36C7 C9                         ret
36C8 1E 01                      ld e,$01
36CA 18 02                      jr L36CE
36CC 1E 13                      ld e,$13
36CE CD DA 34      L36CE:       call L34DA
36D1 3A E5 D5                   ld a,($D5E5)
36D4 93                         sub e
36D5 57                         ld d,a
36D6 30 79                      jr nc,L3751
36D8 3A E4 D5                   ld a,($D5E4)
36DB A7                         and a
36DC 20 07                      jr nz,L36E5
36DE 7A                         ld a,d
36DF 83                         add a,e
36E0 A7                         and a
36E1 C8                         ret z
36E2 AF                         xor a
36E3 18 6C                      jr L3751
36E5 D5            L36E5:       push de
36E6 CD EE 36                   call L36EE
36E9 F1                         pop af
36EA C6 F7                      add a,$F7
36EC 18 5E                      jr L374C
36EE 3A E4 D5      L36EE:       ld a,($D5E4)
36F1 A7                         and a
36F2 C8                         ret z
36F3 3D                         dec a
36F4 F5                         push af
36F5 CD CC 2C                   call L2CCC
36F8 F1                         pop af
36F9 37                         scf
36FA C8                         ret z
36FB F5            L36FB:       push af
36FC CD B5 2C                   call L2CB5
36FF F1                         pop af
3700 3D                         dec a
3701 20 F8                      jr nz,L36FB
3703 37                         scf
3704 C9                         ret
3705 3A E2 D5      L3705:       ld a,($D5E2)
3708 FE F7                      cp $F7
370A 3F                         ccf
370B C0                         ret nz
370C CD B5 2C                   call L2CB5
370F 3A E2 D5                   ld a,($D5E2)
3712 A7                         and a
3713 37                         scf
3714 C0                         ret nz
3715 CD EE 36                   call L36EE
3718 A7                         and a
3719 C9                         ret
371A 1E 01                      ld e,$01
371C 18 02                      jr L3720
371E 1E 13                      ld e,$13
3720 CD DA 34      L3720:       call L34DA
3723 3A E2 D5                   ld a,($D5E2)
3726 57                         ld d,a
3727 3A E5 D5                   ld a,($D5E5)
372A 83                         add a,e
372B 38 03                      jr c,L3730
372D BA                         cp d
372E 38 21                      jr c,L3751
3730 D6 F7         L3730:       sub $F7
3732 47                         ld b,a
3733 C5                         push bc
3734 CD 05 37                   call L3705
3737 C1                         pop bc
3738 38 0A                      jr c,L3744
373A 57                         ld d,a
373B 15                         dec d
373C 3A E5 D5                   ld a,($D5E5)
373F BA                         cp d
3740 C8                         ret z
3741 7A                         ld a,d
3742 18 0D                      jr L3751
3744 3A E2 D5      L3744:       ld a,($D5E2)
3747 3D                         dec a
3748 B8                         cp b
3749 38 01                      jr c,L374C
374B 78                         ld a,b
374C 21 E3 D5      L374C:       ld hl,$D5E3
374F 36 FF                      ld (hl),$FF
3751 32 E5 D5      L3751:       ld ($D5E5),a
3754 2A E4 D5                   ld hl,($D5E4)
3757 67                         ld h,a
3758 ED 91 57 10                nextreg $57,$10
375C 22 DD E4                   ld ($E4DD),hl
375F ED 91 57 0F                nextreg $57,$0F
3763 06 FF                      ld b,$FF
3765 21 4E C6                   ld hl,$C64E
3768 ED 34 F7 00   L3768:       add hl,$00F7
376C 04                         inc b
376D D6 13                      sub $13
376F 30 F7                      jr nc,L3768
3771 C6 13                      add a,$13
3773 F5                         push af
3774 E5                         push hl
3775 3A E3 D5                   ld a,($D5E3)
3778 B8                         cp b
3779 CA 33 38                   jp z,L3833
377C 78                         ld a,b
377D 32 E3 D5                   ld ($D5E3),a
3780 0E 13                      ld c,$13
3782 57                         ld d,a
3783 59                         ld e,c
3784 ED 30                      mul d,e
3786 3A E2 D5                   ld a,($D5E2)
3789 93                         sub e
378A B9                         cp c
378B 38 01                      jr c,L378E
378D 79                         ld a,c
378E E5            L378E:       push hl
378F F5                         push af
3790 06 02                      ld b,$02
3792 0E 14                      ld c,$14
3794 CD 77 12                   call L1277
3797 C1                         pop bc
3798 04                         inc b
3799 0E 02                      ld c,$02
379B E1                         pop hl
379C AF                         xor a
379D C3 2F 38                   jp L382F
37A0 32 E8 D5      L37A0:       ld ($D5E8),a
37A3 22 E6 D5                   ld ($D5E6),hl
37A6 C5                         push bc
37A7 CD AD 38                   call L38AD
37AA F5                         push af
37AB CD 10 3C                   call L3C10
37AE 21 31 DA                   ld hl,$DA31
37B1 3A EA D5                   ld a,($D5EA)
37B4 CB 57                      bit 2,a
37B6 CC 47 38                   call z,L3847
37B9 F1                         pop af
37BA D1                         pop de
37BB D5                         push de
37BC 16 00                      ld d,$00
37BE CD 91 2C                   call L2C91
37C1 3A EA D5                   ld a,($D5EA)
37C4 E6 03                      and $03
37C6 21 43 38                   ld hl,$3843
37C9 ED 31                      add hl,a
37CB 4E                         ld c,(hl)
37CC C5                         push bc
37CD CD 5B 3B                   call L3B5B
37D0 C1                         pop bc
37D1 D1                         pop de
37D2 D5                         push de
37D3 51                         ld d,c
37D4 14                         inc d
37D5 CD FF 33                   call L33FF
37D8 E5                         push hl
37D9 28 16                      jr z,L37F1
37DB 16 2E                      ld d,$2E
37DD CD 91 2C                   call L2C91
37E0 E1                         pop hl
37E1 CD C7 31                   call L31C7
37E4 21 1B 00                   ld hl,$001B
37E7 20 03                      jr nz,L37EC
37E9 21 41 00                   ld hl,$0041
37EC CD 27 27      L37EC:       call L2727
37EF 18 2E                      jr L381F
37F1 CD 91 2C      L37F1:       call L2C91
37F4 E1                         pop hl
37F5 3A EA D5                   ld a,($D5EA)
37F8 E6 03                      and $03
37FA 28 23                      jr z,L381F
37FC 3D                         dec a
37FD 20 05                      jr nz,L3804
37FF CD 20 3C                   call L3C20
3802 18 1B                      jr L381F
3804 3D            L3804:       dec a
3805 20 0D                      jr nz,L3814
3807 ED 5B 3F 5C                ld de,($5C3F)
380B ED 4B 74 5C                ld bc,($5C74)
380F DF                         rst $18
3810 47                         ld b,a
3811 37                         scf
3812 18 0B                      jr L381F
3814 CD AE 3C      L3814:       call L3CAE
3817 EB                         ex de,hl
3818 23                         inc hl
3819 23                         inc hl
381A 1E 04                      ld e,$04
381C CD 2D 27                   call L272D
381F CD DA 34      L381F:       call L34DA
3822 C1                         pop bc
3823 2A E6 D5      L3823:       ld hl,($D5E6)
3826 ED 34 0D 00                add hl,$000D
382A 3A E8 D5                   ld a,($D5E8)
382D 3C                         inc a
382E 0C                         inc c
382F 05            L382F:       dec b
3830 C2 A0 37                   jp nz,L37A0
3833 E1            L3833:       pop hl
3834 F1                         pop af
3835 32 E8 D5                   ld ($D5E8),a
3838 5F                         ld e,a
3839 16 0D                      ld d,$0D
383B ED 30                      mul d,e
383D 19                         add hl,de
383E 22 E6 D5                   ld ($D5E6),hl
3841 37                         scf
3842 C9                         ret
3843 2D                         dec l
3844 25                         dec h
3845 22 2D CD                   ld ($CD2D),hl
3848 53                         ld d,e
3849 38 D8                      jr c,L3823
384B 7E            L384B:       ld a,(hl)
384C 23                         inc hl
384D 12                         ld (de),a
384E 13                         inc de
384F 3C                         inc a
3850 20 F9                      jr nz,L384B
3852 C9                         ret
3853 01 00 00      L3853:       ld bc,$0000
3856 3E FF                      ld a,$FF
3858 ED B1                      cpir
385A 2B                         dec hl
385B 54                         ld d,h
385C 5D                         ld e,l
385D C5                         push bc
385E 2B            L385E:       dec hl
385F 7E                         ld a,(hl)
3860 FE 2E                      cp $2E
3862 28 08                      jr z,L386C
3864 03                         inc bc
3865 CB 78                      bit 7,b
3867 20 F5                      jr nz,L385E
3869 EB                         ex de,hl
386A C1                         pop bc
386B C5                         push bc
386C D1            L386C:       pop de
386D 54                         ld d,h
386E 5D                         ld e,l
386F 2B                         dec hl
3870 7E                         ld a,(hl)
3871 FE 7D                      cp $7D
3873 37                         scf
3874 C0                         ret nz
3875 CD 97 38                   call L3897
3878 D5                         push de
3879 5F                         ld e,a
387A CD 97 38                   call L3897
387D ED 23                      swapnib
387F B3                         or e
3880 D1                         pop de
3881 ED 33                      add bc,a
3883 CB 78                      bit 7,b
3885 37                         scf
3886 C8                         ret z
3887 06 FF                      ld b,$FF
3889 ED 44                      neg
388B C6 03                      add a,$03
388D 4F                         ld c,a
388E 09                         add hl,bc
388F 7E                         ld a,(hl)
3890 FE 7B                      cp $7B
3892 37                         scf
3893 C0                         ret nz
3894 EB                         ex de,hl
3895 A7                         and a
3896 C9                         ret
3897 2B            L3897:       dec hl
3898 7E                         ld a,(hl)
3899 D6 30                      sub $30
389B FE 0A                      cp $0A
389D D8                         ret c
389E D6 07                      sub $07
38A0 FE 10                      cp $10
38A2 D8                         ret c
38A3 D6 20                      sub $20
38A5 FE 10                      cp $10
38A7 D8            L38A7:       ret c
38A8 AF                         xor a
38A9 C9                         ret
38AA 2A E6 D5      L38AA:       ld hl,($D5E6)
38AD E5            L38AD:       push hl
38AE DD 2A DD D5                ld ix,($D5DD)
38B2 ED 34 07 00                add hl,$0007
38B6 CB 7E                      bit 7,(hl)
38B8 28 0B                      jr z,L38C5
38BA 3A EA D5                   ld a,($D5EA)
38BD E6 40                      and $40
38BF 28 04                      jr z,L38C5
38C1 DD 2A DF D5                ld ix,($D5DF)
38C5 D1            L38C5:       pop de
38C6 21 0B 00                   ld hl,$000B
38C9 CD A6 2C                   call L2CA6
38CC 01 31 DA                   ld bc,$DA31
38CF E7                         rst $20
38D0 B7                         or a
38D1 01 C9 CD                   ld bc,$CDC9
38D4 AA                         xor d
38D5 38 D0                      jr c,L38A7
38D7 21 31 DA                   ld hl,$DA31
38DA 16 5A                      ld d,$5A
38DC CD EC 38                   call L38EC
38DF 16 02                      ld d,$02
38E1 CD 10 39                   call L3910
38E4 D0                         ret nc
38E5 EB                         ex de,hl
38E6 21 31 DA                   ld hl,$DA31
38E9 C3 BC 3A                   jp L3ABC
38EC D5            L38EC:       push de
38ED E5                         push hl
38EE CD 14 3B                   call L3B14
38F1 E1                         pop hl
38F2 C1                         pop bc
38F3 50                         ld d,b
38F4 D5                         push de
38F5 E5                         push hl
38F6 CD 53 38                   call L3853
38F9 E1                         pop hl
38FA EB                         ex de,hl
38FB A7                         and a
38FC ED 52                      sbc hl,de
38FE 45                         ld b,l
38FF D1                         pop de
3900 C9                         ret
3901 11 00 04                   ld de,$0400
3904 CD 0F 39                   call L390F
3907 D0                         ret nc
3908 3E 02                      ld a,$02
390A E7                         rst $20
390B B1                         or c
390C 01 18 60                   ld bc,$6018
390F 43            L390F:       ld b,e
3910 3A D4 D5      L3910:       ld a,($D5D4)
3913 A2                         and d
3914 C8                         ret z
3915 16 5A                      ld d,$5A
3917 21 57 14                   ld hl,$1457
391A 18 01                      jr L391D
391C 43            L391C:       ld b,e
391D C5            L391D:       push bc
391E D5                         push de
391F CD 06 33                   call L3306
3922 D1                         pop de
3923 C1                         pop bc
3924 4A                         ld c,d
3925 50                         ld d,b
3926 06 04                      ld b,$04
3928 AF                         xor a
3929 21 52 E1                   ld hl,$E152
392C CD D5 27                   call L27D5
392F FD CB 30 EE                set 5,(iy+$30)
3933 7B                         ld a,e
3934 A7                         and a
3935 C8                         ret z
3936 D5                         push de
3937 21 0B 10                   ld hl,$100B
393A 22 8A 5B                   ld (OMMU45),hl
393D 21 52 E1                   ld hl,$E152
3940 11 27 D8                   ld de,$D827
3943 01 5A 00                   ld bc,$005A
3946 D5                         push de
3947 CD 47 19                   call L1947
394A D1                         pop de
394B E1                         pop hl
394C 26 00                      ld h,$00
394E 19                         add hl,de
394F 36 FF         L394F:       ld (hl),$FF
3951 2B                         dec hl
3952 7E                         ld a,(hl)
3953 FE 20                      cp $20
3955 28 F8                      jr z,L394F
3957 EB                         ex de,hl
3958 7E            L3958:       ld a,(hl)
3959 FE 20                      cp $20
395B 37                         scf
395C C0                         ret nz
395D 23                         inc hl
395E 18 F8                      jr L3958
3960 21 7C 2A                   ld hl,$2A7C
3963 1E 08                      ld e,$08
3965 CD 3E 3B                   call L3B3E
3968 28 0B                      jr z,L3975
396A 3E 03                      ld a,$03
396C E7                         rst $20
396D B1                         or c
396E 01 D4 DA                   ld bc,$DAD4
3971 3A C3 64                   ld a,($64C3)
3974 32 E5 21                   ld ($21E5),a
3977 78                         ld a,b
3978 14                         inc d
3979 CD 0A 33                   call L330A
397C E1                         pop hl
397D E7                         rst $20
397E 24                         inc h
397F 01 C3 CF                   ld bc,$CFC3
3982 3A 11 00                   ld a,($0011)
3985 0E 21                      ld c,$21
3987 B1                         or c
3988 14                         inc d
3989 CD 1C 39                   call L391C
398C 21 27 D8                   ld hl,$D827
398F 38 03                      jr c,L3994
3991 21 0B 00                   ld hl,$000B
3994 CD 76 33      L3994:       call L3376
3997 18 D9                      jr L3972
3999 11 00 02                   ld de,$0200
399C 21 B9 14                   ld hl,$14B9
399F CD 1C 39                   call L391C
39A2 1E 00                      ld e,$00
39A4 30 17                      jr nc,L39BD
39A6 21 27 D8                   ld hl,$D827
39A9 7E            L39A9:       ld a,(hl)
39AA 23                         inc hl
39AB FE FF                      cp $FF
39AD 28 0E                      jr z,L39BD
39AF D6 30                      sub $30
39B1 3F                         ccf
39B2 D0                         ret nc
39B3 16 0A                      ld d,$0A
39B5 BA                         cp d
39B6 D0                         ret nc
39B7 ED 30                      mul d,e
39B9 ED 32                      add de,a
39BB 18 EC                      jr L39A9
39BD 7B            L39BD:       ld a,e
39BE E7                         rst $20
39BF 30 01                      jr nc,L39C2
39C1 D0                         ret nc
39C2 18 AE         L39C2:       jr L3972
39C4 3A EB D5                   ld a,($D5EB)
39C7 4F                         ld c,a
39C8 3D                         dec a
39C9 A9                         xor c
39CA E6 03                      and $03
39CC 4F                         ld c,a
39CD 18 02                      jr L39D1
39CF 0E 04                      ld c,$04
39D1 06 00         L39D1:       ld b,$00
39D3 C5                         push bc
39D4 CD 7E 35                   call L357E
39D7 C1                         pop bc
39D8 D0                         ret nc
39D9 18 04                      jr L39DF
39DB 06 20                      ld b,$20
39DD 0E 00         L39DD:       ld c,$00
39DF CD 63 33      L39DF:       call L3363
39E2 18 8E                      jr L3972
39E4 06 04                      ld b,$04
39E6 18 F5                      jr L39DD
39E8 06 10                      ld b,$10
39EA 18 F1                      jr L39DD
39EC 06 40                      ld b,$40
39EE 18 ED                      jr L39DD
39F0 3A EA D5                   ld a,($D5EA)
39F3 47                         ld b,a
39F4 3C                         inc a
39F5 A8                         xor b
39F6 E6 03                      and $03
39F8 47                         ld b,a
39F9 0E 00                      ld c,$00
39FB CD 63 33                   call L3363
39FE CD 05 35                   call L3505
3A01 3A E5 D5      L3A01:       ld a,($D5E5)
3A04 57                         ld d,a
3A05 C3 4C 37                   jp L374C
3A08 CD AA 38                   call L38AA
3A0B D0                         ret nc
3A0C 06 02                      ld b,$02
3A0E 0E 14                      ld c,$14
3A10 CD 77 12                   call L1277
3A13 11 0A 00                   ld de,$000A
3A16 CD 91 2C                   call L2C91
3A19 0E FF                      ld c,$FF
3A1B CD 5B 3B                   call L3B5B
3A1E 21 3E 15                   ld hl,$153E
3A21 CD 06 33                   call L3306
3A24 FD CB 30 EE                set 5,(iy+$30)
3A28 CD 55 12                   call L1255
3A2B 18 D4                      jr L3A01
3A2D 3E 02                      ld a,$02
3A2F 21 95 2A                   ld hl,$2A95
3A32 18 05                      jr L3A39
3A34 3E 01                      ld a,$01
3A36 21 90 2A                   ld hl,$2A90
3A39 32 DC D5      L3A39:       ld ($D5DC),a
3A3C 1E 01                      ld e,$01
3A3E CD 3E 3B                   call L3B3E
3A41 21 DC D5                   ld hl,$D5DC
3A44 28 04                      jr z,L3A4A
3A46 7E                         ld a,(hl)
3A47 E6 01                      and $01
3A49 C0                         ret nz
3A4A CB FE         L3A4A:       set 7,(hl)
3A4C CD AA 38                   call L38AA
3A4F 11 90 E0                   ld de,$E090
3A52 D5                         push de
3A53 CD 05 3C                   call L3C05
3A56 D1                         pop de
3A57 1A            L3A57:       ld a,(de)
3A58 13                         inc de
3A59 3C                         inc a
3A5A 20 FB                      jr nz,L3A57
3A5C 1B                         dec de
3A5D 62                         ld h,d
3A5E 6B                         ld l,e
3A5F 01 90 E0                   ld bc,$E090
3A62 A7                         and a
3A63 ED 42                      sbc hl,bc
3A65 22 D2 D5                   ld ($D5D2),hl
3A68 21 31 DA                   ld hl,$DA31
3A6B CD 08 3C                   call L3C08
3A6E FD CB 30 EE                set 5,(iy+$30)
3A72 37                         scf
3A73 C9                         ret
3A74 21 DC D5                   ld hl,$D5DC
3A77 7E                         ld a,(hl)
3A78 87                         add a,a
3A79 CB BE                      res 7,(hl)
3A7B D0                         ret nc
3A7C CB 46                      bit 0,(hl)
3A7E 21 85 2A                   ld hl,$2A85
3A81 20 03                      jr nz,L3A86
3A83 21 9A 2A                   ld hl,$2A9A
3A86 CD 45 3B      L3A86:       call L3B45
3A89 21 90 E0                   ld hl,$E090
3A8C ED 4B D2 D5                ld bc,($D5D2)
3A90 09                         add hl,bc
3A91 16 5A                      ld d,$5A
3A93 CD EC 38                   call L38EC
3A96 21 62 14                   ld hl,$1462
3A99 CD 1D 39                   call L391D
3A9C 30 31                      jr nc,L3ACF
3A9E 11 31 DA                   ld de,$DA31
3AA1 D5                         push de
3AA2 E5                         push hl
3AA3 CD 05 3C                   call L3C05
3AA6 E1                         pop hl
3AA7 CD 08 3C                   call L3C08
3AAA E1                         pop hl
3AAB 11 27 D8                   ld de,$D827
3AAE D5                         push de
3AAF CD 08 3C                   call L3C08
3AB2 D1                         pop de
3AB3 3A DC D5                   ld a,($D5DC)
3AB6 1F                         rra
3AB7 38 08                      jr c,L3AC1
3AB9 21 90 E0                   ld hl,$E090
3ABC E7            L3ABC:       rst $20
3ABD 27                         daa
3ABE 01 18 0E                   ld bc,$0E18
3AC1 3E 80         L3AC1:       ld a,$80
3AC3 32 FD D7                   ld ($D7FD),a
3AC6 21 6D 14                   ld hl,$146D
3AC9 CD 0A 33                   call L330A
3ACC DF                         rst $18
3ACD B1                         or c
3ACE 3E F5                      ld a,$F5
3AD0 CD 8C 3B                   call L3B8C
3AD3 CD D4 33                   call L33D4
3AD6 F1                         pop af
3AD7 C3 6F 39                   jp L396F
3ADA FE 0A                      cp $0A
3ADC 30 04                      jr nc,L3AE2
3ADE C6 3E                      add a,$3E
3AE0 18 02                      jr L3AE4
3AE2 C6 19         L3AE2:       add a,$19
3AE4 F5            L3AE4:       push af
3AE5 CD D4 33                   call L33D4
3AE8 3E 12                      ld a,$12
3AEA D7                         rst $10
3AEB 3E 01                      ld a,$01
3AED D7                         rst $10
3AEE F1                         pop af
3AEF DF                         rst $18
3AF0 1B                         dec de
3AF1 0D                         dec c
3AF2 3E 12                      ld a,$12
3AF4 D7                         rst $10
3AF5 3E 00                      ld a,$00
3AF7 D7                         rst $10
3AF8 CD 18 3E                   call L3E18
3AFB CD 55 12                   call L1255
3AFE C9                         ret
3AFF 3A D4 D5                   ld a,($D5D4)
3B02 E6 10                      and $10
3B04 C8                         ret z
3B05 CD D4 33                   call L33D4
3B08 FD CB 30 EE                set 5,(iy+$30)
3B0C 0E 03                      ld c,$03
3B0E DF                         rst $18
3B0F A1                         and c
3B10 2B                         dec hl
3B11 37                         scf
3B12 18 BB                      jr L3ACF
3B14 E5            L3B14:       push hl
3B15 01 FF FF                   ld bc,$FFFF
3B18 7E            L3B18:       ld a,(hl)
3B19 23                         inc hl
3B1A 03                         inc bc
3B1B 3C                         inc a
3B1C 20 FA                      jr nz,L3B18
3B1E 78                         ld a,b
3B1F A7                         and a
3B20 20 04                      jr nz,L3B26
3B22 79                         ld a,c
3B23 BA                         cp d
3B24 38 03                      jr c,L3B29
3B26 06 00         L3B26:       ld b,$00
3B28 4A                         ld c,d
3B29 C5            L3B29:       push bc
3B2A CD 42 19                   call L1942
3B2D 22 8A 5B                   ld (OMMU45),hl
3B30 11 52 E1                   ld de,$E152
3B33 C1                         pop bc
3B34 E1                         pop hl
3B35 C5                         push bc
3B36 CD 47 19                   call L1947
3B39 CD B3 27                   call L27B3
3B3C D1                         pop de
3B3D C9                         ret
3B3E 3A D4 D5      L3B3E:       ld a,($D5D4)
3B41 A3                         and e
3B42 D1                         pop de
3B43 C8                         ret z
3B44 D5                         push de
3B45 E5            L3B45:       push hl
3B46 CD D4 33                   call L33D4
3B49 E1                         pop hl
3B4A DF                         rst $18
3B4B 6C                         ld l,h
3B4C 2B                         dec hl
3B4D FD CB 30 EE                set 5,(iy+$30)
3B51 D1                         pop de
3B52 C0                         ret nz
3B53 D5                         push de
3B54 CD F9 33                   call L33F9
3B57 21 27 D8                   ld hl,$D827
3B5A C9                         ret
3B5B ED 91 57 10   L3B5B:       nextreg $57,$10
3B5F 41                         ld b,c
3B60 04                         inc b
3B61 21 31 DA                   ld hl,$DA31
3B64 11 52 E1                   ld de,$E152
3B67 D5                         push de
3B68 C5                         push bc
3B69 7E            L3B69:       ld a,(hl)
3B6A 23                         inc hl
3B6B 12                         ld (de),a
3B6C 13                         inc de
3B6D 3C                         inc a
3B6E 28 13                      jr z,L3B83
3B70 10 F7                      djnz L3B69
3B72 7E            L3B72:       ld a,(hl)
3B73 23                         inc hl
3B74 3C                         inc a
3B75 20 FB                      jr nz,L3B72
3B77 2B                         dec hl
3B78 2B                         dec hl
3B79 1B                         dec de
3B7A 1B                         dec de
3B7B 01 10 00                   ld bc,$0010
3B7E ED B8                      lddr
3B80 3E 7E                      ld a,$7E
3B82 12                         ld (de),a
3B83 ED 91 57 0F   L3B83:       nextreg $57,$0F
3B87 D1                         pop de
3B88 E1                         pop hl
3B89 C3 2D 27                   jp L272D
3B8C 3A D4 D5      L3B8C:       ld a,($D5D4)
3B8F E6 80                      and $80
3B91 C8                         ret z
3B92 21 01 F7      L3B92:       ld hl,$F701
3B95 E5                         push hl
3B96 01 FE 07                   ld bc,$07FE
3B99 11 83 14                   ld de,$1483
3B9C CD C5 3B                   call L3BC5
3B9F E1                         pop hl
3BA0 54            L3BA0:       ld d,h
3BA1 5D                         ld e,l
3BA2 2B                         dec hl
3BA3 06 00                      ld b,$00
3BA5 1A            L3BA5:       ld a,(de)
3BA6 13                         inc de
3BA7 CD 95 2E                   call L2E95
3BAA 28 03                      jr z,L3BAF
3BAC 04                         inc b
3BAD 20 F6                      jr nz,L3BA5
3BAF 70            L3BAF:       ld (hl),b
3BB0 EB                         ex de,hl
3BB1 3C                         inc a
3BB2 20 EC                      jr nz,L3BA0
3BB4 2B                         dec hl
3BB5 77                         ld (hl),a
3BB6 C9                         ret
3BB7 01 00 07      L3BB7:       ld bc,$0700
3BBA 21 00 C0      L3BBA:       ld hl,$C000
3BBD C5                         push bc
3BBE E5                         push hl
3BBF CD C5 3B                   call L3BC5
3BC2 E1                         pop hl
3BC3 C1                         pop bc
3BC4 C9                         ret
3BC5 E5            L3BC5:       push hl
3BC6 C5                         push bc
3BC7 D5                         push de
3BC8 54                         ld d,h
3BC9 5D                         ld e,l
3BCA 13                         inc de
3BCB 36 FF                      ld (hl),$FF
3BCD ED B0                      ldir
3BCF E1                         pop hl
3BD0 11 27 D8                   ld de,$D827
3BD3 D5                         push de
3BD4 0E 00                      ld c,$00
3BD6 CD 83 09                   call L0983
3BD9 3E FF                      ld a,$FF
3BDB 12                         ld (de),a
3BDC E1                         pop hl
3BDD 11 01 00                   ld de,$0001
3BE0 42                         ld b,d
3BE1 4B                         ld c,e
3BE2 E7                         rst $20
3BE3 06 01                      ld b,$01
3BE5 D1                         pop de
3BE6 1B                         dec de
3BE7 E1                         pop hl
3BE8 D0                         ret nc
3BE9 E5                         push hl
3BEA D5                         push de
3BEB 01 07 00                   ld bc,$0007
3BEE E7                         rst $20
3BEF 12                         ld (de),a
3BF0 01 30 03                   ld bc,$0330
3BF3 11 00 00                   ld de,$0000
3BF6 D5                         push de
3BF7 06 00                      ld b,$00
3BF9 E7                         rst $20
3BFA 09                         add hl,bc
3BFB 01 D1 E1                   ld bc,$E1D1
3BFE A7                         and a
3BFF ED 52                      sbc hl,de
3C01 D1                         pop de
3C02 19                         add hl,de
3C03 37                         scf
3C04 C9                         ret
3C05 21 2C D9      L3C05:       ld hl,$D92C
3C08 7E            L3C08:       ld a,(hl)
3C09 12                         ld (de),a
3C0A 3C                         inc a
3C0B C8                         ret z
3C0C 23                         inc hl
3C0D 13                         inc de
3C0E 18 F8                      jr L3C08
3C10 ED 43 74 5C   L3C10:       ld ($5C74),bc
3C14 ED 53 3F 5C                ld ($5C3F),de
3C18 DD 22 6E 5B                ld ($5B6E),ix
3C1C 22 70 5B                   ld ($5B70),hl
3C1F C9                         ret
3C20 2A 6E 5B      L3C20:       ld hl,($5B6E)
3C23 ED 5B 70 5B                ld de,($5B70)
3C27 DD 21 8A 3C                ld ix,$3C8A
3C2B 3E 20                      ld a,$20
3C2D 06 09                      ld b,$09
3C2F C5            L3C2F:       push bc
3C30 DD CB 03 7E                bit 7,(ix+$03)
3C34 28 0B                      jr z,L3C41
3C36 FE 20                      cp $20
3C38 4F                         ld c,a
3C39 28 02                      jr z,L3C3D
3C3B 0E 2C                      ld c,$2C
3C3D F5            L3C3D:       push af
3C3E 79                         ld a,c
3C3F D7                         rst $10
3C40 F1                         pop af
3C41 DD 4E 00      L3C41:       ld c,(ix)
3C44 DD 46 01                   ld b,(ix+$01)
3C47 A7                         and a
3C48 ED 42                      sbc hl,bc
3C4A EB                         ex de,hl
3C4B DD 4E 02                   ld c,(ix+$02)
3C4E DD 46 03                   ld b,(ix+$03)
3C51 CB B8                      res 7,b
3C53 ED 42                      sbc hl,bc
3C55 EB                         ex de,hl
3C56 38 09                      jr c,L3C61
3C58 3C                         inc a
3C59 FE 21                      cp $21
3C5B 20 E4                      jr nz,L3C41
3C5D 3E 31                      ld a,$31
3C5F 18 E0                      jr L3C41
3C61 DD 4E 00      L3C61:       ld c,(ix)
3C64 DD 46 01                   ld b,(ix+$01)
3C67 09                         add hl,bc
3C68 EB                         ex de,hl
3C69 DD 4E 02                   ld c,(ix+$02)
3C6C DD 46 03                   ld b,(ix+$03)
3C6F CB B8                      res 7,b
3C71 ED 4A                      adc hl,bc
3C73 EB                         ex de,hl
3C74 F5                         push af
3C75 D7                         rst $10
3C76 F1                         pop af
3C77 FE 20                      cp $20
3C79 28 02                      jr z,L3C7D
3C7B 3E 30                      ld a,$30
3C7D 01 04 00      L3C7D:       ld bc,$0004
3C80 DD 09                      add ix,bc
3C82 C1                         pop bc
3C83 10 AA                      djnz L3C2F
3C85 7D                         ld a,l
3C86 C6 30                      add a,$30
3C88 D7                         rst $10
3C89 C9                         ret
3C8A 00                         nop
3C8B CA 9A 3B                   jp z,L3B9A
3C8E 00                         nop
3C8F E1                         pop hl
3C90 F5                         push af
3C91 85                         add a,l
3C92 80                         add a,b
3C93 96                         sub (hl)
3C94 98                         sbc a,b
3C95 00                         nop
3C96 40                         ld b,b
3C97 42                         ld b,d
3C98 0F                         rrca
3C99 00                         nop
3C9A A0                         and b
3C9B 86                         add a,(hl)
3C9C 01 80 10                   ld bc,$1080
3C9F 27                         daa
3CA0 00                         nop
3CA1 00                         nop
3CA2 E8                         ret pe
3CA3 03                         inc bc
3CA4 00                         nop
3CA5 00                         nop
3CA6 64                         ld h,h
3CA7 00                         nop
3CA8 00                         nop
3CA9 80                         add a,b
3CAA 0A                         ld a,(bc)
3CAB 00                         nop
3CAC 00                         nop
3CAD 00                         nop
3CAE AF            L3CAE:       xor a
3CAF CB 7E                      bit 7,(hl)
3CB1 23                         inc hl
3CB2 28 01                      jr z,L3CB5
3CB4 3C                         inc a
3CB5 CB 7E         L3CB5:       bit 7,(hl)
3CB7 23                         inc hl
3CB8 28 02                      jr z,L3CBC
3CBA CB DF                      set 3,a
3CBC CB 7E         L3CBC:       bit 7,(hl)
3CBE 23                         inc hl
3CBF 28 02                      jr z,L3CC3
3CC1 CB D7                      set 2,a
3CC3 CB 7E         L3CC3:       bit 7,(hl)
3CC5 23                         inc hl
3CC6 28 02                      jr z,L3CCA
3CC8 CB CF                      set 1,a
3CCA 47            L3CCA:       ld b,a
3CCB 4F                         ld c,a
3CCC 11 9D 5B                   ld de,$5B9D
3CCF D5                         push de
3CD0 3E 20                      ld a,$20
3CD2 12                         ld (de),a
3CD3 13                         inc de
3CD4 12                         ld (de),a
3CD5 13                         inc de
3CD6 3E 64                      ld a,$64
3CD8 CD F1 3C                   call L3CF1
3CDB 3E 61                      ld a,$61
3CDD CD F1 3C                   call L3CF1
3CE0 3E 73                      ld a,$73
3CE2 CD F1 3C                   call L3CF1
3CE5 3E 70                      ld a,$70
3CE7 CD F1 3C                   call L3CF1
3CEA 3E 20                      ld a,$20
3CEC 12                         ld (de),a
3CED 13                         inc de
3CEE 12                         ld (de),a
3CEF D1                         pop de
3CF0 C9                         ret
3CF1 CB 39         L3CF1:       srl c
3CF3 38 02                      jr c,L3CF7
3CF5 3E 2D                      ld a,$2D
3CF7 12            L3CF7:       ld (de),a
3CF8 13                         inc de
3CF9 C9                         ret
3CFA 0D                         dec c
3CFB AA                         xor d
3CFC 30 30                      jr nc,L3D2E
3CFE AA                         xor d
3CFF 30 65                      jr nc,L3D66
3D01 60                         ld h,b
3D02 39                         add hl,sp
3D03 63                         ld h,e
3D04 34            L3D04:       inc (hl)
3D05 3A 72 D3                   ld a,($D372)
3D08 38 76                      jr c,L3D80
3D0A 2D                         dec l
3D0B 3A 0E 9E                   ld a,($9E0E)
3D0E 2E 0A                      ld l,$0A
3D10 1A                         ld a,(de)
3D11 37                         scf
3D12 36 1A                      ld (hl),$1A
3D14 37                         scf
3D15 09                         add hl,bc
3D16 1E 37                      ld e,$37
3D18 38 1E                      jr c,L3D38
3D1A 37                         scf
3D1B 68                         ld l,b
3D1C 8B                         adc a,e
3D1D 35                         dec (hl)
3D1E 6E                         ld l,(hl)
3D1F 08                         ex af,af'
3D20 3A 0B C8                   ld a,($C80B)
3D23 36 37                      ld (hl),$37
3D25 C8                         ret z
3D26 36 08                      ld (hl),$08
3D28 CC 36 35                   call z,L3536
3D2B CC 36 20                   call z,L2036
3D2E D7            L3D2E:       rst $10
3D2F 31 64 48                   ld sp,$4864
3D32 34                         inc (hl)
3D33 6D                         ld l,l
3D34 FF                         rst $38
3D35 3A 6B 01                   ld a,($016B)
3D38 39            L3D38:       add hl,sp
3D39 75                         ld (hl),l
3D3A 32 34 66                   ld ($6634),a
3D3D 83                         add a,e
3D3E 39                         add hl,sp
3D3F 70                         ld (hl),b
3D40 74                         ld (hl),h
3D41 3A 07 55                   ld a,($5507)
3D44 32 6C 43                   ld ($436C),a
3D47 32 2E DB                   ld ($DB2E),a
3D4A 39                         add hl,sp
3D4B 73                         ld (hl),e
3D4C E8                         ret pe
3D4D 39                         add hl,sp
3D4E 69                         ld l,c
3D4F F0                         ret p
3D50 39                         add hl,sp
3D51 78                         ld a,b
3D52 EC 39 6F                   call pe,L6F39
3D55 C4 39 2D                   call nz,L2D39
3D58 CF                         rst $08
3D59 39                         add hl,sp
3D5A 2B                         dec hl
3D5B CF                         rst $08
3D5C 39                         add hl,sp
3D5D 61                         ld h,c
3D5E 99                         sbc a,c
3D5F 39                         add hl,sp
3D60 67                         ld h,a
3D61 24                         inc h
3D62 30 7B                      jr nc,L3DDF
3D64 E4 39 FF                   call po,LFF39
3D67 20 9B                      jr nz,L3D04
3D69 2F                         cpl
3D6A 0E A9                      ld c,$A9
3D6C 2F                         cpl
3D6D 3E FF         L3D6D:       ld a,$FF
3D6F CD B5 07                   call L07B5
3D72 3A BB D5                   ld a,($D5BB)
3D75 C6 85                      add a,$85
3D77 6F                         ld l,a
3D78 3E 00                      ld a,$00
3D7A 47                         ld b,a
3D7B CE 3D                      adc a,$3D
3D7D 67                         ld h,a
3D7E 4E                         ld c,(hl)
3D7F 09                         add hl,bc
3D80 CD 1D 08      L3D80:       call L081D
3D83 37                         scf
3D84 C9                         ret
3D85 04                         inc b
3D86 0D                         dec c
3D87 16 1F                      ld d,$1F
3D89 20 33                      jr nz,L3DBE
3D8B 2E 35                      ld l,$35
3D8D 4D                         ld c,l
3D8E 48                         ld c,b
3D8F 7A                         ld a,d
3D90 20 3E                      jr nz,L3DD0
3D92 FF                         rst $38
3D93 3C                         inc a
3D94 20 20                      jr nz,L3DB6
3D96 37                         scf
3D97 4D                         ld c,l
3D98 48                         ld c,b
3D99 7A                         ld a,d
3D9A 20 3E                      jr nz,L3DDA
3D9C FF                         rst $38
3D9D 3C                         inc a
3D9E 20 31                      jr nz,L3DD1
3DA0 34                         inc (hl)
3DA1 4D                         ld c,l
3DA2 48                         ld c,b
3DA3 7A                         ld a,d
3DA4 20 3E                      jr nz,L3DE4
3DA6 FF                         rst $38
3DA7 3C                         inc a
3DA8 20 32                      jr nz,L3DDC
3DAA 38 4D                      jr c,L3DF9
3DAC 48                         ld c,b
3DAD 7A                         ld a,d
3DAE 20 20                      jr nz,L3DD0
3DB0 FF                         rst $38
3DB1 76            L3DB1:       halt
3DB2 3E 07                      ld a,$07
3DB4 CD DE 12                   call GetNxRegA
3DB7 E6 03                      and $03
3DB9 C9                         ret
3DBA 3A BB D5                   ld a,($D5BB)
3DBD 3C                         inc a
3DBE FE 04         L3DBE:       cp $04
3DC0 D0                         ret nc
3DC1 32 BB D5      L3DC1:       ld ($D5BB),a
3DC4 18 A7                      jr L3D6D
3DC6 3A BB D5                   ld a,($D5BB)
3DC9 3D                         dec a
3DCA F8                         ret m
3DCB 18 F4                      jr L3DC1
3DCD CD B1 3D      L3DCD:       call L3DB1
3DD0 F5            L3DD0:       push af
3DD1 AF            L3DD1:       xor a
3DD2 ED 79                      out (c),a
3DD4 EF                         rst $28
3DD5 B5                         or l
3DD6 03                         inc bc
3DD7 F1                         pop af
3DD8 ED 92 07                   nextreg $07,a
3DDB C9                         ret
3DDC ED 43 54 5B   L3DDC:       ld (TMPBC),bc
3DE0 E3                         ex (sp),hl
3DE1 4E                         ld c,(hl)
3DE2 23                         inc hl
3DE3 46                         ld b,(hl)
3DE4 23            L3DE4:       inc hl
3DE5 E3                         ex (sp),hl
3DE6 ED 8A 3E 93                push $3E93
3DEA ED 8A 00 7B                push $007B
3DEE C5                         push bc
3DEF ED 8A 00 7B                push $007B
3DF3 C3 8F 3E                   jp L3E8F
3DF6 00                         nop
3DF7 00                         nop
3DF8 00                         nop
3DF9 00            L3DF9:       nop
3DFA 00                         nop
3DFB 00                         nop
3DFC 00                         nop
3DFD 00                         nop
3DFE 00                         nop
3DFF 00                         nop
;
; Calls a subroutine in ROM2
; The subroutine address is stored immediately after the RST $20 instruction
;
3E00 ED 43 54 5B   Rom2Call:    ld (TMPBC),bc              ; Store BC temporarily
3E04 E3                         ex (sp),hl                 ; HL := return address
3E05 4E                         ld c,(hl)                  
3E06 23                         inc hl
3E07 46                         ld b,(hl)                  ; Now, BC contains the address to call
3E08 23                         inc hl  
3E09 E3                         ex (sp),hl                 ; Set the return address (from RST $20)
3E0A ED 8A 3E 13                push RETF2                 ; Push the return address (from ROM2 routine)
3E0E C5                         push bc                    ; This is the address to call in ROM2
3E0F ED 4B 54 5B                ld bc,(TMPBC)              ; Restore the original BC value
;
; At the RETF2 address in ROM2 there is a nextreg $8E,$00 instruction that switches back to ROM0
; ROM2 contains a ret instruction after RETF2, and that returns to the caller in ROM0
;
3E13 ED 91 8E 02   RETF2:       nextreg $8E,$02            ; Switch to ROM2. 
3E17 C9                         ret                        ; Jump to ROM2 routine
;
;
;
3E18 3A 38 5C      L3E18:       ld a,($5C38)
3E1B CB 3F                      srl a
3E1D 21 80 0C                   ld hl,$0C80
3E20 DD E5         L3E20:       push ix
3E22 16 00                      ld d,$00
3E24 5F                         ld e,a
3E25 CD CD 3D      L3E25:       call L3DCD
3E28 DD E1                      pop ix
3E2A C9                         ret
3E2B DD E5                      push ix
3E2D 11 30 00                   ld de,$0030
3E30 21 00 03                   ld hl,$0300
3E33 18 F0                      jr L3E25
3E35 F5                         push af
3E36 E5                         push hl
3E37 3A 8D 5C                   ld a,(ATTR_P)
3E3A F5                         push af
3E3B 3A 48 5C                   ld a,(BORDCR)
3E3E 32 8D 5C                   ld (ATTR_P),a
3E41 CD C9 0E                   call L0EC9
3E44 3E FD                      ld a,$FD
3E46 EF                         rst $28
3E47 01 16 F1                   ld bc,$F116
3E4A 32 8D 5C                   ld (ATTR_P),a
3E4D E1                         pop hl
3E4E 7E            L3E4E:       ld a,(hl)
3E4F 23                         inc hl
3E50 FE FF                      cp $FF
3E52 28 03                      jr z,L3E57
3E54 D7                         rst $10
3E55 18 F7                      jr L3E4E
3E57 F1            L3E57:       pop af
3E58 28 0F                      jr z,L3E69
3E5A CD E0 11                   call L11E0
3E5D D5            L3E5D:       push de
3E5E CD C9 0E                   call L0EC9
3E61 3E FE                      ld a,$FE
3E63 EF                         rst $28
3E64 01 16 D1                   ld bc,$D116
3E67 7B                         ld a,e
3E68 C9                         ret
3E69 CD E0 11      L3E69:       call L11E0
3E6C E6 DF                      and $DF
3E6E 1E 00                      ld e,$00
3E70 FE 43                      cp $43
3E72 28 E9                      jr z,L3E5D
3E74 1C                         inc e
3E75 FE 52                      cp $52
3E77 28 E4                      jr z,L3E5D
3E79 1C                         inc e
3E7A FE 49                      cp $49
3E7C 28 DF                      jr z,L3E5D
3E7E 18 E9                      jr L3E69
;
; Calls a subroutine in ROM2
; The subroutine address is stored immediately after the RST $18 instruction
;
3E80 ED 43 54 5B   Rom1Call:    ld (TMPBC),bc              ; Store BC temporarily
3E84 E3                         ex (sp),hl                 ; HL := return address
3E85 4E                         ld c,(hl)
3E86 23                         inc hl
3E87 46                         ld b,(hl)                  ; Now, BC contains the address to call
3E88 23                         inc hl
3E89 E3                         ex (sp),hl                 ; Set the return address (from RST $20)
3E8A ED 8A 3E 93                push $3E93                 ; Push the return address (from ROM2 routine)
3E8E C5                         push bc                    ; This is the address to call in ROM2
3E8F ED 4B 54 5B   L3E8F:       ld bc,(TMPBC)              ; Restore the original BC value
;
; At the RETF1 address in ROM1 there is a nextreg $8E,$00 instruction that switches back to ROM0
; ROM1 contains a ret instruction after RETF1, and that returns to the caller in ROM0
;
3E93 ED 91 8E 01   RETF1:       nextreg $8E,$01            ; Switch to ROM2.
3E97 C9                         ret                        ; Jump to ROM2 routine
;
;
;
3E98 2A 5D 5C      L3E98:       ld hl,($5C5D)
3E9B E5                         push hl
3E9C 2A 51 5C                   ld hl,($5C51)
3E9F ED 34 0F 00                add hl,$000F
3EA3 22 5D 5C                   ld ($5C5D),hl
3EA6 E3                         ex (sp),hl
3EA7 E5                         push hl
3EA8 D9                         exx
3EA9 C5                         push bc
3EAA D5                         push de
3EAB E5                         push hl
3EAC D9                         exx
3EAD EF                         rst $28
3EAE 18 
3EAF 00                      jr L3EB0
3EB0 EF            L3EB0:       rst $28
3EB1 BC                         cp h
3EB2 28 D9                      jr z,L3E8D
3EB4 E1                         pop hl
3EB5 D1                         pop de
3EB6 C1                         pop bc
3EB7 D9                         exx
3EB8 D1                         pop de
3EB9 ED 53 5D 5C                ld ($5C5D),de
3EBD DA 95 04                   jp c,L0495
3EC0 78                         ld a,b
3EC1 E6 E0                      and $E0
3EC3 FE C0                      cp $C0
3EC5 20 06                      jr nz,L3ECD
3EC7 23                         inc hl
3EC8 23                         inc hl
3EC9 23                         inc hl
3ECA 7E                         ld a,(hl)
3ECB 23                         inc hl
3ECC 3D                         dec a
3ECD C2 95 04      L3ECD:       jp nz,L0495
3ED0 4E                         ld c,(hl)
3ED1 23                         inc hl
3ED2 46                         ld b,(hl)
3ED3 23                         inc hl
3ED4 EB                         ex de,hl
3ED5 E1                         pop hl
3ED6 2B                         dec hl
3ED7 7E                         ld a,(hl)
3ED8 2B                         dec hl
3ED9 6E                         ld l,(hl)
3EDA 67                         ld h,a
3EDB E5                         push hl
3EDC ED 42                      sbc hl,bc
3EDE E1                         pop hl
3EDF C9                         ret
3EE0 CD 98 3E                   call L3E98
3EE3 30 16                      jr nc,L3EFB
3EE5 19                         add hl,de
3EE6 7E                         ld a,(hl)
3EE7 2A 51 5C      L3EE7:       ld hl,($5C51)
3EEA ED 34 0D 00                add hl,$000D
3EEE 5E                         ld e,(hl)
3EEF 23                         inc hl
3EF0 56                         ld d,(hl)
3EF1 13                         inc de
3EF2 72                         ld (hl),d
3EF3 2B                         dec hl
3EF4 73                         ld (hl),e
3EF5 37                         scf
3EF6 C9                         ret
3EF7 F5                         push af
3EF8 CD 98 3E                   call L3E98
3EFB D2 E0 03      L3EFB:       jp nc,L03E0
3EFE 19                         add hl,de
3EFF F1                         pop af
3F00 77                         ld (hl),a
3F01 18 E4                      jr L3EE7
3F03 E5                         push hl
3F04 D5                         push de
3F05 78                         ld a,b
3F06 F5                         push af
3F07 CD 98 3E                   call L3E98
3F0A F1                         pop af
3F0B A7                         and a
3F0C 20 06                      jr nz,L3F14
3F0E C1                         pop bc
3F0F C1                         pop bc
3F10 11 00 00                   ld de,$0000
3F13 C9                         ret
3F14 3D            L3F14:       dec a
3F15 20 19                      jr nz,L3F30
3F17 E1                         pop hl
3F18 7C                         ld a,h
3F19 B5                         or l
3F1A C2 E0 03                   jp nz,L03E0
3F1D E1                         pop hl
3F1E A7                         and a
3F1F ED 42                      sbc hl,bc
3F21 30 D8                      jr nc,L3EFB
3F23 09                         add hl,bc
3F24 EB                         ex de,hl
3F25 2A 51 5C                   ld hl,($5C51)
3F28 01 0D 00                   ld bc,$000D
3F2B 09                         add hl,bc
3F2C 73                         ld (hl),e
3F2D 23                         inc hl
3F2E 72                         ld (hl),d
3F2F C9                         ret
3F30 E1            L3F30:       pop hl
3F31 E1                         pop hl
3F32 60                         ld h,b
3F33 69                         ld l,c
3F34 11 00 00                   ld de,$0000
3F37 C9                         ret
3F38 3A B8 D5                   ld a,($D5B8)
3F3B FE 08                      cp $08
3F3D C8                         ret z
3F3E 21 15 0A                   ld hl,$0A15
3F41 A7                         and a
3F42 28 03                      jr z,L3F47
3F44 21 23 0A                   ld hl,$0A23
3F47 11 DA D6      L3F47:       ld de,$D6DA
3F4A DD E5         L3F4A:       push ix
3F4C E5                         push hl
3F4D D5                         push de
3F4E CD 50 0E                   call L0E50
3F51 E3                         ex (sp),hl
3F52 E5                         push hl
3F53 CD 74 12                   call L1274
3F56 FD 7E 45                   ld a,(iy+$45)
3F59 E6 0F                      and $0F
3F5B 20 02                      jr nz,L3F5F
3F5D 3E 05                      ld a,$05
3F5F C6 F2         L3F5F:       add a,$F2
3F61 DD 67                      ld xh,a
3F63 DD 2E 00                   ld xl,$00
3F66 21 E7 3F                   ld hl,$3FE7
3F69 CD 2B 27                   call L272B
3F6C E1                         pop hl
3F6D E5                         push hl
3F6E 3E 07                      ld a,$07
3F70 ED 31                      add hl,a
3F72 7E                         ld a,(hl)
3F73 CD 5B 27                   call L275B
3F76 3E 14                      ld a,$14
3F78 CD 5B 27                   call L275B
3F7B FD CB 45 5E                bit 3,(iy+$45)
3F7F 01 00 1A                   ld bc,$1A00
3F82 28 03                      jr z,L3F87
3F84 01 01 39                   ld bc,$3901
3F87 C5            L3F87:       push bc
3F88 79                         ld a,c
3F89 CD 5B 27                   call L275B
3F8C C1                         pop bc
3F8D C5            L3F8D:       push bc
3F8E 3E 20                      ld a,$20
3F90 CD 5B 27                   call L275B
3F93 C1                         pop bc
3F94 10 F7                      djnz L3F8D
3F96 D1                         pop de
3F97 1A                         ld a,(de)
3F98 F5                         push af
3F99 0D                         dec c
3F9A 01 90 06                   ld bc,$0690
3F9D C5            L3F9D:       push bc
3F9E D5                         push de
3F9F 79                         ld a,c
3FA0 CC 5B 27                   call z,L275B
3FA3 3E 18                      ld a,$18
3FA5 CD 5B 27                   call L275B
3FA8 D1                         pop de
3FA9 13                         inc de
3FAA D5                         push de
3FAB 1A                         ld a,(de)
3FAC CD 5B 27                   call L275B
3FAF D1                         pop de
3FB0 C1                         pop bc
3FB1 79                         ld a,c
3FB2 EE 01                      xor $01
3FB4 4F                         ld c,a
3FB5 AF                         xor a
3FB6 10 E5                      djnz L3F9D
3FB8 21 EE 3F                   ld hl,$3FEE
3FBB CD 2B 27                   call L272B
3FBE F1                         pop af
3FBF D1                         pop de
3FC0 CD 58 0E                   call L0E58
3FC3 E1                         pop hl
3FC4 F5                         push af
3FC5 7E            L3FC5:       ld a,(hl)
3FC6 23                         inc hl
3FC7 FE 3A                      cp $3A
3FC9 28 0F                      jr z,L3FDA
3FCB FE 20                      cp $20
3FCD 38 0B                      jr c,L3FDA
3FCF FE 5F                      cp $5F
3FD1 28 F2                      jr z,L3FC5
3FD3 E5                         push hl
3FD4 CD 5B 27                   call L275B
3FD7 E1                         pop hl
3FD8 18 EB                      jr L3FC5
3FDA 21 23 00      L3FDA:       ld hl,$0023
3FDD CD 27 27                   call L2727
3FE0 F1                         pop af
3FE1 CD 5B 27                   call L275B
3FE4 DD E1                      pop ix
3FE6 C9                         ret
3FE7 1E 08                      ld e,$08
3FE9 16 15                      ld d,$15
3FEB 00                         nop
3FEC 18 FF                      jr L3FED
3FEE 20 16                      jr nz,L4006
3FF0 15                         dec d
3FF1 00                         nop
3FF2 FF                         rst $38
3FF3 00                         nop
3FF4 00                         nop
3FF5 00                         nop
3FF6 00                         nop
3FF7 00                         nop
3FF8 00                         nop
3FF9 00                         nop
3FFA 00                         nop
3FFB 00                         nop
3FFC 00                         nop
3FFD 00                         nop
3FFE 00                         nop
3FFF 00                         nop
