; ZX Spectrum Next ROM Disassembly (ROM 2)
; ================================================================================
; File: enNextZX.rom
; Source ROM Block: ROM 2 (file bytes 0x8000-0xBFFF)
; ================================================================================

; RST $00: Infinite loop
;
0000 00            StartLoop:   nop
0001 18 FD                      jr StartLoop

; Filler bytes (unused)
;
0003 00 00 00 00 00             .defb $00, $00, $00, $00, $00

; RST $08
;
0008 C3 18 3F                   jp L3F18
000B 2E 62 61 6B                .defb $2E, $62, $61, $6B   ; ".bak"
000F FF                         .defb $ff

; RST $10, RST $18, RST $20, RST $28, RST $30: fall back to RST $38
;
0010                            .fillb $28,$00

;
; RST $38: IRQ handler
;
0038 F5                         push af                    ; Save used registers
0039 C5                         push bc
003A E5                         push hl
003B 01 3B 24                   ld bc,$243B
003E ED 68                      in l,(c)                   ; L is the current Next Reg port index
0040 E5                         push hl                    ; Save HL
0041 C5                         push bc                    ; Save BC
0042 AF                         xor a                      ; A := 0m reset, carry
0043 21 45 00                   ld hl,$0045                
0046 CD 31 3F                   call L3F31
0049 C1                         pop bc                     ; Restore BC
004A E1                         pop hl                     ; Restore HL
004B ED 69                      out (c),l                  ; Restore the last Next Reg port index
004D E1                         pop hl                     ; Restore registers
004E C1                         pop bc
004F F1                         pop af
0050 FB                         ei                         ; Enable the IRQ again
0051 C9                         ret                        ; Done

; Deprecated API stub - returns rc_notimp (error code $3A - Not implemented)
; Used for deprecated functions: IDE_FORMAT, IDE_PARTITION_NEW, IDE_PARTITION_INIT,
; IDE_PARTITION_ERASE, IDE_PARTITION_RENAME, IDE_PARTITION_WRITE, IDE_PARTITION_WINFO,
; IDE_PARTITION_GETINFO, IDE_PARTITION_SETINFO, IDE_PATH, IDE_CAPACITY, IDE_BROWSER,
; IDE_MOUNT, IDE_FILESIZE, IDE_DOS_UNPERMANENT
;
0052 3E 3A         IdeDepr:     ld a,$3A
0054 A7                         and a
0055 C9                         ret

; Non-filesystem-related API entry points
;
0056 C3 52 11                   jp IdeStrmOpen             ; IDE_STREAM_OPEN
0059 C3 BE 14                   jp L14BE                   ; IDE_STREAM_CLOSE
005C C3 65 15                   jp L1565                   ; IDE_STREAM_IN
005F C3 5B 15                   jp L155B                   ; IDE_STREAM_OUT
0062 C3 6A 15                   jp L156A                   ; IDE_STREAM_PTR

; Filler byte
;
0065 00                         .defb $00

; NMI routine
;
0066 ED 45         NMI:         retn                       ; ROM2 does not do anything with NMI
;
;
;
0068 CF                         rst $08
0069 01                         .defb $01
006A DD 04                      .defw $04dd
006C C9                         ret
;
;
;
006D CF                         rst $08
006E 01                         .defb $01
006F 1D 00                      .defw $001D
0071 C9                         ret
;
;
;
0072 CF                         rst $08
0073 01                         .defb $01
0074 E0 02                      .defw $02E0
0076 C9                         ret

; Zero bytes ($29)
;
0077                            .fillb $29,$00
00A0 C3 70 1A                   jp IdeVer                  ; IDE_VERSION
00A3 C3 AE 19      L00A3:       jp IdeIntf                 ; IDE_INTERFACE
00A6 C3 DF 1A                   jp IdeInit                 ; IDE_INIT
00A9 C3 DB 01      L00A9:       jp IdeDrv                  ; IDE_DRIVE
00AC C3 4A 18      L00AC:       jp IdeSRead                ; IDE_SECTOR_READ
00AF C3 79 18                   jp IdeSWrt                 ; IDE_SECTOR_WRITE
00B2 C3 52 00                   jp IdeDepr                 ; IDE_FORMAT (deprecated)
00B5 C3 E6 01      L00B5:       jp IdePrtFind              ; IDE_PARTITION_FIND
00B8 C3 52 00                   jp IdeDepr                 ; IDE_PARTITION_NEW (deprecated)
00BB C3 52 00                   jp IdeDepr                 ; IDE_PARTITION_INIT (deprecated)
00BE C3 52 00                   jp IdeDepr                 ; IDE_PARTITION_ERASE (deprecated)
00C1 C3 52 00                   jp IdeDepr                 ; IDE_PARTITION_RENAME (deprecated)
00C4 C3 EB 01      L00C4:       jp IdePrtRd                ; IDE_PARTITION_READ
00C7 C3 52 00                   jp IdeDepr                 ; IDE_PARTITION_WRITE (deprecated)
00CA C3 52 00                   jp IdeDepr                 ; IDE_PARTITION_WINFO (deprecated)
00CD C3 40 07                   jp IdePrtOpen              ; IDE_PARTITION_OPEN
00D0 C3 CF 07                   jp IdePrtCls               ; IDE_PARTITION_CLOSE
00D3 C3 52 00                   jp IdeDepr                 ; IDE_PARTITION_GETINFO (deprecated)
00D6 C3 52 00                   jp IdeDepr                 ; IDE_PARTITION_SETINFO (deprecated)
00D9 C3 AC 16                   jp IdeSwOpen               ; IDE_SWAP_OPEN
00DC C3 76 17      L00DC:       jp IdeSwCls                ; IDE_SWAP_CLOSE
00DF C3 8B 16                   jp IdeSwOut                ; IDE_SWAP_OUT
00E2 C3 14 16                   jp IdeSwIn                 ; IDE_SWAP_IN
00E5 C3 A8 16                   jp IdeSwEx                 ; IDE_SWAP_EX
00E8 C3 BD 15                   jp IdeSwPos                ; IDE_SWAP_POS
00EB C3 C9 15                   jp IdeSwMove               ; IDE_SWAP_MOVE
00EE C3 9B 17                   jp IdeSwRsz                ; IDE_SWAP_RESIZE
00F1 C3 CF 03      L00F1:       jp IdeDosMap               ; IDE_DOS_MAP
00F4 C3 51 04      L00F4:       jp IdeDosUnmap             ; IDE_DOS_UNMAP
00F7 C3 78 04      L00F7:       jp IdeDosMpng              ; IDE_DOS_MAPPING
00FA C3 52 00                   jp IdeDepr                 ; IDE_DOS_UNPERMANENT (deprecated)
00FD C3 2E 08                   jp IdeSnapLd               ; IDE_SNAPLOAD
0100 C3 2A 25                   jp DosInit                 ; DOS_INITIALISE
0103 C3 2C 25                   jp DosVersion              ; DOS_VERSION
0106 C3 22 03      L0106:       jp DosOpen                 ; DOS_OPEN
0109 C3 58 02      L0109:       jp DosClose                ; DOS_CLOSE
010C C3 69 02      L010C:       jp DosAband                ; DOS_ABANDON
010F C3 26 02                   jp DosRefHead              ; DOS_REF_HEAD
0112 C3 7A 02      L0112:       jp DosRead                 ; DOS_READ
0115 C3 D6 02                   jp DosWrite                ; DOS_WRITE
0118 C3 2C 02                   jp DosBtRead               ; DOS_BYTE_READ
011B C3 32 02                   jp DosBtWrite              ; DOS_BYTE_WRITE
011E C3 00 02      L011E:       jp DosCat                  ; DOS_CATALOG
0121 C3 F0 01                   jp DosFreeSpc              ; DOS_FREE_SPACE
0124 C3 12 28                   jp DosDelete               ; DOS_DELETE
0127 C3 23 28                   jp DosRename               ; DOS_RENAME
012A C3 3C 25                   jp DosBoot                 ; DOS_BOOT
012D C3 50 05      L012D:       jp DosSetDrv               ; DOS_SET_DRIVE
0130 C3 5E 05      L0130:       jp DosSetUser              ; DOS_SET_USER
0133 C3 38 02                   jp DosGetPos               ; DOS_GET_POSITION
0136 C3 3E 02                   jp DosSetPos               ; DOS_SET_POSITION
0139 C3 46 02      L0139:       jp DosGetEof               ; DOS_GET_EOF
013C C3 E0 05      L013C:       jp DosGet1346              ; DOS_GET_1346
013F C3 E5 05      L013F:       jp DosSet1346              ; DOS_SET_1346
0142 C3 F8 01                   jp DosFlush                ; DOS_FLUSH
0145 C3 4C 02                   jp DosSetAcc               ; DOS_SET_ACCESS
0148 C3 14 02                   jp DosSetAttr              ; DOS_SET_ATTRIBUTES
014B C3 52 00                   jp IdeDepr                 ; Reserved (invalid)
014E C3 9F 25                   jp DosSetMsg               ; DOS_SET_MESSAGE
0151 C3 E4 20                   jp DosRefXdpb              ; DOS_REF_XDPB
0154 C3 99 25                   jp DosInvalid              ; DOS_MAP_B (invalid)
0157 C3 9D 25                   jp DdIntf                  ; DD_INTERFACE
015A C3 9D 25                   jp DdIntf                  ; DD_INIT
015D C3 9D 25                   jp DdIntf                  ; DD_SETUP
0160 C3 9D 25                   jp DdIntf                  ; DD_SET_RETRY
0163 C3 89 27                   jp DdReadSect              ; DD_READ_SECTOR
0166 C3 99 25                   jp DosInvalid              ; DD_WRITE_SECTOR (deprecated)
0169 C3 99 25                   jp DosInvalid              ; DD_CHECK_SECTOR (deprecated)
016C C3 99 25                   jp DosInvalid              ; DD_FORMAT (deprecated)
016F C3 99 25                   jp DosInvalid              ; DD_READ_ID (deprecated)
0172 C3 99 25                   jp DosInvalid              ; DD_TEST_UNSUITABLE (deprecated)
0175 C3 99 25                   jp DosInvalid              ; DD_LOGIN (deprecated)
0178 C3 99 25                   jp DosInvalid              ; DD_SEL_FORMAT (deprecated)
017B C3 50 27                   jp DdTrackWrt              ; DD_WRITE_TRACK (deprecated)
017E C3 78 27                   jp DdTrackRead             ; DD_READ_TRACK (deprecated)
0181 C3 99 25                   jp DosInvalid              ; DD_SETUP_DPB (deprecated)
0184 C3 19 26                   jp DdEncode                ; DD_ENCODE
0187 C3 28 26                   jp DdLXdpb                 ; DD_L_XDPB
018A C3 6A 26                   jp DdLPdb                  ; DD_L_DPB
018D C3 9D 25                   jp DdIntf                  ; DD_L_SEEK
0190 C3 9E 27                   jp DdLRead                 ; DD_L_READ
0193 C3 99 25                   jp DosInvalid              ; DD_L_WRITE (deprecated)
0196 C3 9D 25                   jp DdIntf                  ; DD_L_ON_MOTOR
0199 C3 9D 25                   jp DdIntf                  ; DD_L_T_OFF_MOTOR
019C C3 9D 25                   jp DdIntf                  ; DD_L_OFF_MOTOR
019F C3 52 00                   jp IdeDepr                 ; (invalid)
01A2 C3 52 00                   jp IdeDepr                 ; IDE_IDENTIFY (deprecated)
01A5 C3 8A 1F                   jp IdeParts                ; IDE_PARTITIONS
01A8 C3 52 00                   jp IdeDepr                 ; (invalid)
01AB C3 52 00                   jp IdeDepr                 ; (invalid)
01AE C3 52 00                   jp IdeDepr                 ; (invalid)
01B1 C3 27 05      EntIdePath:  jp IdePath                 ; IDE_PATH
01B4 C3 E0 01                   jp IdeCapac                ; IDE_CAPACITY
01B7 C3 0B 02                   jp IdeGetLfn               ; IDE_GET_LFN
01BA C3 C6 10                   jp IdeBrowser              ; IDE_BROWSER
01BD C3 9F 0E                   jp IdeBank                 ; IDE_BANK
01C0 C3 9D 0F                   jp IdeBasic                ; IDE_BASIC
01C3 C3 9E 15                   jp IdeWLineIn              ; IDE_WINDOW_LINEIN
01C6 C3 A8 15                   jp IdeWStr                 ; IDE_WINDOW_STRING
01C9 C3 B8 0F                   jp IdeIntVar               ; IDE_INTEGER_VAR
01CC C3 EF 0F                   jp IdeRtc                  ; IDE_RTC
01CF C3 F7 0F      L01CF:       jp IdeDriver               ; IDE_DRIVER
01D2 C3 75 1A                   jp IdeMount                ; IDE_MOUNT
01D5 C3 FD 0F                   jp IdeMode                 ; IDE_MODE
01D8 C3 80 10                   jp IdeToknsr               ; IDE_TOKENISER
;
; IDE_DRIVE: Get unit handle
;
01DB CF            IdeDrv:      rst $08
01DC 00                         .defb $00
01DD 03 01                      .defw $0103
01DF C9                         ret
;
; IDE_CAPACITY: Get card capacity
;
01E0 79            IdeCapac:    ld a,c
01E1 CF                         rst $08
01E2 00                         .defb $00
01E3 06 01                      .defw $0106
01E5 C9                         ret
;
; IDE_PARTITION_FIND: Find named partition
;
01E6 CF            IdePrtFind:  rst $08
01E7 00                         .defb $00
01E8 09 01                      .defw $0109
01EA C9                         ret
;
; IDE_PARTITION_READ: Read IDE partition
;
01EB CF            IdePrtRd:    ld bc,$CFC9
01EC 00                         nop
01ED 0C                         inc c
01EE 01 C9                      .defb $01, $C9
;
; DOS_FREE_SPACE: Free space on disk
;
01F0 CD B4 05      DosFreeSpc:  call $05B4
01F3 CF                         rst $08
01F4 00                         .defb $00
01F5 18 01                      .defw $0118
01F7 C9                         ret
;
; DOS_FLUSH: Bring disk up to date
;
01F8 CD B4 05      DosFlush:    call L05B4
01FB CF                         rst $08
01FC 00                         .defb $00
01FD 1B 01                      .defw $011B
01FF C9                         ret
;
; DOS_CATALOG: Catalog disk directory
;
0200 DD 6F         DosCat:      ld xl,a
0202 CF                         rst $08
0203 00                         .defb $00
0204 4F 03                      .defw $034F
0206 CF                         rst $08
0207 00                         .defb $00
0208 7B 01                      .defb $017B
020A C9                         ret
;
; IDE_GET_LFN: Get long filename
;
020B CF            IdeGetLfn:   rst $08
020C 00                         .defb $00
020D 4F 03                      .defw $034F
020F CF                         rst $08
0210 00                         .defb $00
0211 7E 01                      .defw $017E
0213 C9                         ret

; DOS_SET_ATTRIBUTES: Change a file's attributes
;
0214 CF            DosSetAttr:  rst $08
0215 00                         .defb $00
0216 4F 03                      .defw $034F
0218 CF                         rst $08
0219 00                         .defb $00
021A 8A 01                      .defw $018A
021C C9                         ret
;
;
;
021D CF                         rst $08
021E 00                         .defb $00
021F 4F 03                      .defw $034F
0221 CF                         rst $08
0222 00                         .defb $00
0223 84 01                      .defw $0184
0225 C9                         ret

; DOS_REF_HEAD: Point at the header data for this file
;
0226 78            DosRefHead:  ld a,b
0227 CF                         rst $08
0228 00                         .defb $00
0229 3F 01                      .defw $013F
022B C9                         ret

; DOS_BYTE_READ: Read a byte
;
022C 78            DosBtRead:   ld a,b
022D CF                         rst $08
022E 00                         .defb $00
022F 48 01                      .defw $0148
0231 C9                         ret

; DOS_BYTE_WRITE: Write a byte
;
0232 78            DosBtWrite:  ld a,b
0233 CF                         rst $08
0234 00                         .defb $00
0235 4B 01                      .defw $014B
0237 C9                         ret

; DOS_GET_POSITION: Get file pointer for random access
;
0238 78            DosGetPos:   ld a,b
0239 CF                         rst $08
023A 00                         .defb $00
023B 4E 01                      .defw $014E
022D C9                         ret

; DOS_SET_POSITION: Set file pointer for random access
;
023E 78            DosSetPos:   ld a,b
023F 16 00                      ld d,$00
0241 CF                         rst $08
0242 00                         .defb $00
0243 51 01                      .defw $0151
0245 C9                         ret

; DOS_GET_EOF: Get end of file position for random access
;
0246 78            DosGetEof:   ld a,b
0247 CF                         rst $08
0248 00                         .defb $00
0249 54 01                      .defw $0154
024C C9                         ret

; DOS_SET_ACCESS: Change open file's access mode
;
024C 79            DosSetAcc:   ld a,c
024D E6 F8                      and $F8
024F 3E 1E                      ld a,$1E
0251 C0                         ret nz
0252 78                         ld a,b
0253 CF                         rst $08
0254 00                         .defb $00
0255 57 01                      .defb $0157
0257 C9                         ret

; DOS_CLOSE: Close a file
;
0258 78            DosClose:    ld a,b
0259 ED 73 05 F5                ld ($F505),sp
025D 31 05 F5                   ld sp,$F505
0260 CF                         rst $08
0261 00                         .defb $00
0262 75 01                      .defw $0175
0264 ED 7B 05 F5                ld sp,($F505)
0268 C9                         ret
;
; DOS_ABANDON: Abandon a file
;
0269 78            DosAband:    ld a,b
026A ED 73 05 F5                ld ($F505),sp
026E 31 05 F5                   ld sp,$F505
0271 CF                         rst $08
0272 00                         .defb $00
0273 78 01                      .defw $178
0275 ED 7B 05 F5                ld sp,($F505)
0279 C9                         ret
;
; DOS_READ: Read bytes into memory
;
027A 7C            DosRead:     ld a,h
027B E6 C0                      and $C0
027D 20 13                      jr nz,L0292
027F C5                         push bc
0280 D5                         push de
0281 E5                         push hl
0282 CD 2C 02                   call DosBtRead
0285 E1                         pop hl
0286 D1                         pop de
0287 C1                         pop bc
0288 30 47                      jr nc,L02D1
028A 23                         inc hl
028B 1B                         dec de
028C 7A                         ld a,d
028D B3                         or e
028E 20 EA                      jr nz,DosRead
0290 37                         scf
0291 C9                         ret
0292 E5            L0292:       push hl
0293 1B                         dec de
0294 19                         add hl,de
0295 13                         inc de
0296 38 11                      jr c,L02A9
0298 23                         inc hl
0299 E3                         ex (sp),hl
029A CD A3 02                   call L02A3
029D E1            L029D:       pop hl
029E 30 31                      jr nc,L02D1
02A0 AF                         xor a
02A1 37                         scf
02A2 C9                         ret
02A3 78            L02A3:       ld a,b
02A4 CF                         rst $08
02A5 00                         .defb $00
02A6 42 01                      .defw $0142
02A8 C9                         ret
;
;
;
02A9 E1            L02A9:       ret po
02AA D5                         push de
02AB E5                         push hl
02AC EB                         ex de,hl
02AD 21 00 00                   ld hl,$0000
02B0 A7                         and a
02B1 ED 52                      sbc hl,de
02B3 EB                         ex de,hl
02B4 E1                         pop hl
02B5 E3                         ex (sp),hl
02B6 A7                         and a
02B7 ED 52                      sbc hl,de
02B9 E3                         ex (sp),hl
02BA E5                         push hl
02BB D5                         push de
02BC C5                         push bc
02BD CD A3 02                   call L02A3
02C0 C1                         pop bc
02C1 E1                         pop hl
02C2 30 05                      jr nc,L02C9
02C4 D1                         pop de
02C5 19                         add hl,de
02C6 D1                         pop de
02C7 18 B1                      jr DosRead
02C9 ED 52         L02C9:       sbc hl,de
02CB C1                         pop bc
02CC 09                         add hl,bc
02CD C1                         pop bc
02CE EB                         ex de,hl
02CF 09                         add hl,bc
02D0 EB                         ex de,hl
02D1 47            L02D1:       ld b,a
02D2 7A                         ld a,d
02D3 B3                         or e
02D4 78                         ld a,b
02D5 C9                         ret
;
; DOS_WRITE: Write bytes from memory
;
02D6 7C            DosWrite:    ld a,h
02D7 E6 C0                      and $C0
02D9 20 14                      jr nz,L02EF
02DB C5                         push bc
02DC D5                         push de
02DD E5                         push hl
02DE 4E                         ld c,(hl)
02DF CD 32 02                   call DosBtWrite
02E2 E1                         pop hl
02E3 D1                         pop de
02E4 C1                         pop bc
02E5 30 EA                      jr nc,L02D1
02E7 23                         inc hl
02E8 1B                         dec de
02E9 7A                         ld a,d
02EA B3                         or e
02EB 20 E9                      jr nz,DosWrite
02ED 37                         scf
02EE C9                         ret
02EF E5            L02EF:       push hl
02F0 1B                         dec de
02F1 19                         add hl,de
02F2 13                         inc de
02F3 38 0D                      jr c,L0302
02F5 23                         inc hl
02F6 E3                         ex (sp),hl
02F7 CD FC 02                   call L02FC
02FA 18 A1                      jr L029D
02FC 78            L02FC:       ld a,b
02FD CF                         rst $08
02FE 00                         .defb $00
02FF 45 01                      .defw $0145
0301 C9                         ret
;
;
;
0302 E1            L0302:       ret po
0303 D5                         push de
0304 E5                         push hl
0305 EB                         ex de,hl
0306 21 00 00                   ld hl,$0000
0309 A7                         and a
030A ED 52                      sbc hl,de
030C EB                         ex de,hl
030D E1                         pop hl
030E E3                         ex (sp),hl
030F A7                         and a
0310 ED 52                      sbc hl,de
0312 E3                         ex (sp),hl
0313 E5                         push hl
0314 D5                         push de
0315 C5                         push bc
0316 CD FC 02                   call L02FC
0319 C1                         pop bc
031A E1                         pop hl
031B 30 AC                      jr nc,L02C9
031D D1                         pop de
031E 19                         add hl,de
031F D1                         pop de
0320 18 B4                      jr DosWrite
;
; DOS_OPEN: Create and/or open a file
;
0322 CD AC 03      DosOpen:     call L03AC
0325 D0                         ret nc
0326 7B                         ld a,e
0327 D6 03                      sub $03
0329 20 59                      jr nz,L0384
032B E5                         push hl
032C 21 4A 31                   ld hl,$314A
032F CF                         rst $08
0330 07                         .defb 07
0331 1D 00                      .defw 001D
0333 E1                         pop hl
0334 1C                         inc e
0335 1F                         rra
0336 38 4C                      jr c,L0384
0338 C5                         push bc
0339 D5                         push de
033A E5                         push hl
033B 1E 00                      ld e,$00
033D CD 84 03                   call L0384
0340 E1                         pop hl
0341 D1                         pop de
0342 C1                         pop bc
0343 D8                         ret c
0344 FE 18                      cp $18
0346 37                         scf
0347 3F                         ccf
0348 C0                         ret nz
0349 C5                         push bc
034A D5                         push de
034B E5                         push hl
034C 06 00                      ld b,$00
034E 11 00 FF                   ld de,$FF00
0351 D5                         push de
0352 7E            L0352:       ld a,(hl)
0353 23                         inc hl
0354 12                         ld (de),a
0355 13                         inc de
0356 FE 2E                      cp $2E
0358 20 02                      jr nz,L035C
035A 42                         ld b,d
035B 4B                         ld c,e
035C 3C            L035C:       inc a
035D 20 F3                      jr nz,L0352
035F 62                         ld h,d
0360 6B                         ld l,e
0361 37                         scf
0362 ED 42                      sbc hl,bc
0364 7D                         ld a,l
0365 E6 FC                      and $FC
0367 B4                         or h
0368 20 02                      jr nz,L036C
036A 50                         ld d,b
036B 59                         ld e,c
036C 1B            L036C:       dec de
036D 21 0B 00                   ld hl,$000B
0370 01 05 00                   ld bc,$0005
0373 ED B0                      ldir
0375 E1                         pop hl
0376 E5                         push hl
0377 CD 1D 02                   call L021D
037A D1                         pop de
037B E1                         pop hl
037C E5                         push hl
037D CD 98 05                   call L0598
0380 E1                         pop hl
0381 D1                         pop de
0382 C1                         pop bc
0383 D0                         ret nc
0384 79            L0384:       ld a,c
0385 E6 F8                      and $F8
0387 3E 1E                      ld a,$1E
0389 C0                         ret nz
038A D5                         push de
038B 50                         ld d,b
038C 1E 38                      ld e,$38
038E ED 30                      mul d,e
0390 ED 35 D0 DB                add de,$DBD0
0394 D5                         push de
0395 DD E1                      pop ix
0397 D1                         pop de
0398 CF                         rst $08
0399 00                         .defb $00
039A 4F 03                      .defw $034F
039C ED 73 05 F5                ld ($F505),sp
03A0 31 05 F5                   ld sp,$F505
03A3 CF                         rst $08
03A4 00                         .defb $00
03A5 72 01                      .defw $0172
03A7 ED 7B 05 F5                ld sp,($F505)
03AB C9                         ret
;
;
;
03AC CB 59         L03AC:       bit 3,c
03AE 37                         scf
03AF C8                         ret z
03B0 CB 99                      res 3,c
03B2 C5                         push bc
03B3 CD 67 28                   call L2867
03B6 30 07                      jr nc,L03BF
03B8 C1                         pop bc
03B9 C5                         push bc
03BA CB 49                      bit 1,c
03BC C4 DD 28                   call nz,L28DD
03BF C1            L03BF:       pop bc
03C0 11 02 02                   ld de,$0202
03C3 C9                         ret
03C4 21 10 23      L03C4:       ld hl,$2310
03C7 ED 31                      add hl,a
03C9 CF                         rst $08
03CA 00                         .defb $00
03CB 1D 00                      .defw $001D
03CD 87                         add a,a
03CE C9                         ret
;
; IDE_DOS_MAP: Map drive to partition
;
03CF 57            IdeDosMap:   ld d,a
03D0 7D                         ld a,l
03D1 CD B4 05                   call L05B4
03D4 5F                         ld e,a
03D5 CD C4 03                   call L03C4
03D8 3E 3E                      ld a,$3E
03DA D0                         ret nc
03DB 7A                         ld a,d
03DC FE FF                      cp $FF
03DE 28 06                      jr z,L03E6
03E0 7B                         ld a,e
03E1 CF                         rst $08
03E2 00                         .defb $00
03E3 69 01                      .defw $0169
03E5 C9                         ret
;
;
;
03E6 D5                         push de
03E7 E5                         push hl
03E8 C5                         push bc
03E9 60                         ld h,b
03EA 69                         ld l,c
03EB 7B                         ld a,e
03EC C6 30                      add a,$30
03EE 57                         ld d,a
03EF 1E 00                      ld e,$00
03F1 01 00 01                   ld bc,$0100
03F4 3E 09                      ld a,$09
03F6 CF                         rst $08
03F7 00                         .defb $00
03F8 03 07                      .defw $0703
03FA C1                         pop bc
03FB CD 24 22                   call L2224
03FE E1                         pop hl
03FF D1                         pop de
0400 D0                         ret nc
0401 E5                         push hl
0402 21 02 23                   ld hl,$2302
0405 01 FF 0E                   ld bc,$0EFF
0408 CF            L0408:       rst $08
0409 00                         .defb $00
040A 1D 00                      .defw $001d
040C 23                         inc hl
040D A7                         and a
040E FA 34 04                   jp m,L0434
0411 B9                         cp c
0412 28 20                      jr z,L0434
0414 4F                         ld c,a
0415 3E 10                      ld a,$10
0417 90                         sub b
0418 F6 80                      or $80
041A E3                         ex (sp),hl
041B C5                         push bc
041C D5                         push de
041D E5                         push hl
041E DD E5                      push ix
0420 57                         ld d,a
0421 01 5F F7                   ld bc,$F75F
0424 CF                         rst $08
0425 00                         .defb $00
0426 69 01                      .defw $0169
0428 DD E1                      pop ix
042A E1                         pop hl
042B D1                         pop de
042C C1                         pop bc
042D E3                         ex (sp),hl
042E 38 0E                      jr c,L043E
0430 FE 09                      cp $09
0432 20 07                      jr nz,L043B
0434 10 D2         L0434:       djnz L0408
0436 CD F4 04                   call L04F4
0439 3E 09                      ld a,$09
043B A7            L043B:       and a
043C E1                         pop hl
043D C9                         ret
043E E1            L043E:       pop hl
043F DD 4E 11                   ld c,(ix+$11)
0442 DD 46 12                   ld b,(ix+$12)
0445 7B                         ld a,e
0446 87                         add a,a
0447 21 38 E4                   ld hl,$E438
044A ED 31                      add hl,a
044C 71                         ld (hl),c
044D 23                         inc hl
044E 70                         ld (hl),b
044F 37                         scf
0450 C9                         ret
;
; IDE_DOS_UNMAP: Unmap drive
;
0451 7D            IdeDosUnmap: ld a,l
0452 CD B4 05                   call L05B4
0455 F5                         push af
0456 CF                         rst $08
0457 00                         .defb $00
0458 6C 01                      .defw $016C
045A D1                         ret nc
045B 38 06                      jr c,L0461
045C 06 FE                      ld b,$FE
045E 16 37                      ld d,$37
0460 C8                         ret z
0461 3F            L0461:       ccf
0462 C9                         ret
0463 7A                         ld a,d
0464 87                         add a,a
0465 21 38 E4                   ld hl,$E438
0468 ED 31                      add hl,a
046A 5E                         ld e,(hl)
046B 23                         inc hl
046C 56                         ld d,(hl)
046D 7A                         ld a,d
046E B3                         or e
046F 37                         scf
0470 C8                         ret z
0471 AF                         xor a
0472 77                         ld (hl),a
0473 2B                         dec hl
0474 77                         ld (hl),a
0475 C3 FA 04                   jp L04FA
;
; IDE_DOS_MAPPING: Get drive mapping
;
0478 7D            IdeDosMpng:  ld a,l
0479 F5                         push af
047A C5                         push bc
047B E6 7F                      and $7F
047D CD B4 05                   call L05B4
0480 01 00 F7                   ld bc,$F700
0483 F5                         push af
0484 3E FF                      ld a,$FF
0486 02                         ld (bc),a
0487 F1                         pop af
0488 CF                         rst $08
0489 00                         .defb $00
048A 1E 01                      .defw $011E
048C 30 2C                      jr nc,L04BA
048E 3C                         inc a
048F 20 28                      jr nz,L04B9
0491 D1                         pop de
0492 F1                         pop af
0493 F5                         push af
0494 D5                         push de
0495 21 FD 1F                   ld hl,$1FFD
0498 11 00 F7                   ld de,$F700
049B 01 06 00                   ld bc,$0006
049E ED B0                      ldir
04A0 E6 7F                      and $7F
04A2 CD B4 05                   call L05B4
04A5 C6 30                      add a,$30
04A7 67                         ld h,a
04A8 2E 00                      ld l,$00
04AA 0E F9                      ld c,$F9
04AC 3E 09                      ld a,$09
04AE CF                         rst $08
04AF 00                         .defb $00
04B0 69 07                      .defw $0769
04B2 3E FF                      ld a,$FF
04B4 12                         ld (de),a
04B5 AF                         xor a
04B6 47                         ld b,a
04B7 4F                         ld c,a
04B8 37                         scf
04B9 3D            L04B9:       dec a
04BA D1            L04BA:       pop de
04BB E1                         pop hl
04BC F5                         push af
04BD C5                         push bc
04BE 30 28                      jr nc,L04E8
04C0 06 FF                      ld b,$FF
04C2 CB 7C                      bit 7,h
04C4 F5                         push af
04C5 21 00 F7                   ld hl,$F700
04C8 20 02                      jr nz,L04CC
04CA 06 12                      ld b,$12
04CC 7E            L04CC:       ld a,(hl)
04CD 23                         inc hl
04CE FE FF                      cp $FF
04D0 28 04                      jr z,L04D6
04D2 12                         ld (de),a
04D3 13                         inc de
04D4 10 F6                      djnz L04CC
04D6 F1            L04D6:       pop af
04D7 28 05                      jr z,L04DE
04D9 3E FF                      ld a,$FF
04DB 12                         ld (de),a
04DC 18 0A                      jr L04E8
04DE 04            L04DE:       inc b
04DF 05                         dec b
04E0 28 06                      jr z,L04E8
04E2 3E 20                      ld a,$20
04E4 12            L04E4:       ld (de),a
04E5 13                         inc de
04E6 10 FC                      djnz L04E4
04E8 C1            L04E8:       pop bc
04E9 F1                         pop af
04EA 2E 00                      ld l,$00
04EC 2C                         inc l
04ED D8                         ret c
04EE FE 16                      cp $16
04F0 37                         scf
04F1 C8                         ret z
04F2 3F                         ccf
04F3 C9                         ret
04F4 DD 5E 11      L04F4:       ld e,(ix+$11)
04F7 DD 56 12                   ld d,(ix+$12)
04FA 62            L04FA:       ld h,d
04FB 6B                         ld l,e
04FC 13                         inc de
04FD 01 05 00                   ld bc,$0005
0500 CF                         rst $08
0501 00                         .defb $00
0502 DB 04                      .defw $04DB
0504 37                         scf
0505 C9                         ret
0506 CF                         rst $08
0507 00                         .defb $00
0508 4F 03                      .defw $034F
050A F5            L050A:       push af
050B E5                         push hl
050C E6 0F                      and $0F
050E CD 55 05                   call L0555
0511 E1                         pop hl
0512 D1                         pop de
0513 D0                         ret nc
0514 7A                         ld a,d
0515 F5                         push af
0516 E5                         push hl
0517 ED 23                      swapnib
0519 E6 0F                      and $0F
051B CD 30 01                   call L0130
051E E1                         pop hl
051F D1                         pop de
0520 D0                         ret nc
0521 7A                         ld a,d
0522 06 00                      ld b,$00
0524 E5                         push hl
0525 18 08                      jr L052F

;
; IDE_PATH: Create, delete, change or get directory
;
0527 47            IdePath:     ld b,a
0528 E5                         push hl
0529 C5                         push bc
052A CF                         rst $08
052B 00                         .defb $00
052C 4F 03                      .defw $034F
052E C1                         pop bc
052F 11 00 FF      L052F:       ld de,$FF00
0532 E5                         push hl
0533 C5                         push bc
0534 ED 73 05 F5                ld ($F505),sp
0538 31 05 F5                   ld sp,$F505
053B CF                         rst $08
053C 00                         .defb $00
053D 81 01                      .defw $0181
053F ED 7B 05 F5                ld sp,($F505)
0543 C1                         pop bc
0544 E1                         pop hl
0545 D1                         pop de
0546 D0                         ret nc
0547 05                         dec b
0548 C0                         ret nz
0549 7E            L0549:       ld a,(hl)
054A ED A0                      ldi
054C 3C                         inc a
054D 20 FA                      jr nz,L0549
054F C9                         ret

;
; DOS_SET_DRIVE: Set/get default drive
;
0550 FE FF         DosSetDrv:   cp $FF
0552 C4 B4 05                   call nz,L05B4
0555 CF            L0555:       rst $08
0556 00                         .defb $00
0557 6F 01                      .defw $016F
0559 D0                         ret nc
055A C6 41                      add a,$41
055C 37                         scf
055D C9                         ret

;
; DOS_SET_USER: Set/get default user number
;
055E F5            DosSetUser:  push af
055F 3E FF                      ld a,$FF
0561 CF                         rst $08
0562 00                         .defb $00
0563 6F 01                      .defw $016F
0565 D1                         pop de
0566 5F                         ld e,a
0567 CD C4 03                   call L03C4
056A FA 77 05                   jp m,L0577
056D AF                         xor a
056E 14                         inc d
056F 37                         scf
0570 C8                         ret z
0571 15                         dec d
0572 C8                         ret z
0573 3E 14                      ld a,$14
0575 A7                         and a
0576 C9                         ret
0577 D5            L0577:       push de
0578 7B                         ld a,e
0579 CF                         rst $08
057A 00                         .defb $00
057B 24 01                      .defw $0124
057D D1                         pop de
057E D0                         ret nc
057F 14                         inc d
0580 C8                         ret z
0581 7B                         ld a,e
0582 C6 20                      add a,$20
0584 67                         ld h,a
0585 2E 01                      ld l,$01
0587 15                         dec d
0588 7A                         ld a,d
0589 ED 23                      swapnib
058B B3                         or e
058C CF                         rst $08
058D 09                         .defb $09
058E E0 02                      .defw $02E0
0590 2F                         cpl
0591 2B                         dec hl
0592 CF                         rst $08
0593 09                         .defb $09
0594 E0 02                      .defw $02E0
0596 37                         scf
0597 C9                         ret
0598 CF            L0598:       rst $08
0599 00                         .defb $00
059A 4F 03                      .defw $034F
059C F5                         push af
059D EB                         ex de,hl
059E CF                         rst $08
059F 00                         .defb $00
05A0 4F 03                      .defw $034F
05A2 EB                         ex de,hl
05A3 C1                         pop bc
05A4 ED 73 05 F5                ld ($F505),sp
05A8 31 05 F5                   ld sp,$F505
05AB CF                         rst $08
05AC 00                         .defb $00
05AD 87 01                      .defw $0187
05AF ED 7B 05 F5                ld sp,($F505)
05B3 C9                         ret
;
;
;
05B4 E6 DF         L05B4:       and $DF
05B6 D6 41                      sub $41
05B8 38 03                      jr c,L05BD
05BA FE 10                      cp $10
05BC D8                         ret c
05BD F1            L05BD:       pop af
05BE 3E 16                      ld a,$16
05C0 A7                         and a
05C1 C9                         ret
05C2 CF                         rst $08
05C3 0D                         .defb $0D
05C4 1D 00                      .defw $001D
05C6 C9                         ret
;
;
;
05C7 CF                         rst $08
05C8 00                         .defb $00
05C9 E0 02                      .defw $02E0
05CB C9                         ret
;
;
;
05CC E5                         push hl
05CD 21 06 20                   ld hl,$2006
05D0 CF                         rst $08
05D1 00                         .defb $00
05D2 1D 00                      .defw $001D
05D4 E6 0F                      and $0F
05D6 E1                         pop hl
05D7 22 52 5B                   ld (TMPHL),hl
05DA 21 DD 04                   ld hl,$04DD
05DD C3 2A 3F                   jp L3F2A
;
; DOS_GET_1346: Get memory usage in pages 1, 3, 4, 6
;
05E0 CF            DosGet1346:  rst $08
05E1 0D                         .defb $0D
05E2 B6 34                      .defw 34B6
05E4 C9                         ret

;
; DOS_SET_1346: Re-allocate memory usage in pages 1, 3, 4, 6
;
05E5 CF            DosSet1346:  rst $08
05E6 0D                         .defb $0D
05E7 BC 34                      .defw $34BC
05E9 C9                         ret
;
;
;
05EA CF            L05EA:       rst $08
05EB 0D                         .defb $0D
05EC 4D 34                      .defw $344D
05EE C9                         ret
;
;
;
05EF CF            L05EF:       rst $08
05F0 0D                         .defb $0D
05F1 F4 34                      .defw $34F4
05F3 C9                         ret
;
;
;
05F4 06 02         L05F4:       ld b,$02
05F6 CF                         rst $08
05F7 00                         .defb $00
05F8 B2 03                      .defw $03B2
05FA C9                         ret
;
;
;
05FB CF                         rst $08
05FC 0D                         .defb $0D
05FD 32 34                      .defw $3432
05FF C9                         ret
;
;
;
0600 CF                         rst $08
0601 0D                         .defb $0D
0602 40 34                      .defw $3440
0604 C9                         ret
;
;
;
0605 DD 21 6C E4   L0605:       ld ix,$E46C
0609 1E 14                      ld e,$14
060B DD 7E 00      L060B:       ld a,(ix)
060E A7                         and a
060F 37                         scf
0610 C8                         ret z
0611 C5                         push bc
0612 01 13 00                   ld bc,$0013
0615 DD 09                      add ix,bc
0617 C1                         pop bc
0618 1D                         dec e
0619 20 F0                      jr nz,L060B
061B 3E 3C                      ld a,$3C
061D A7                         and a
061E C9                         ret
061F D6 05         L061F:       sub $05
0621 DD E5                      push ix
0623 D5                         push de
0624 E5                         push hl
0625 57                         ld d,a
0626 DD 21 6C E4                ld ix,$E46C
062A 1E 14                      ld e,$14
062C DD 7E 00      L062C:       ld a,(ix)
062F A7                         and a
0630 28 14                      jr z,L0646
0632 DD 7E 10                   ld a,(ix+$10)
0635 E6 01                      and $01
0637 BA                         cp d
0638 20 0C                      jr nz,L0646
063A DD 6E 11                   ld l,(ix+$11)
063D DD 66 12                   ld h,(ix+$12)
0640 ED 42                      sbc hl,bc
0642 3E 3B                      ld a,$3B
0644 28 0B                      jr z,L0651
0646 C5            L0646:       push bc
0647 01 13 00                   ld bc,$0013
064A DD 09                      add ix,bc
064C C1                         pop bc
064D 1D                         dec e
064E 20 DC                      jr nz,L062C
0650 37                         scf
0651 E1            L0651:       pop hl
0652 D1                         pop de
0653 DD E1                      pop ix
0655 C9                         ret
0656 D6 05         L0656:       sub $05
0658 3F                         ccf
0659 30 11                      jr nc,L066C
065B FE 02                      cp $02
065D 30 0D                      jr nc,L066C
065F CB 3F                      srl a
0661 DD 21 58 E4                ld ix,$E458
0665 30 04                      jr nc,L066B
0667 DD 21 62 E4                ld ix,$E462
066B A7            L066B:       and a
066C 3E 16         L066C:       ld a,$16
066E C0                         ret nz
066F DD 7E 00                   ld a,(ix)
0672 DD B6 01                   or (ix+$01)
0675 3E 16                      ld a,$16
0677 C8                         ret z
0678 37                         scf
0679 C9                         ret
067A 79                         ld a,c
067B D6 05                      sub $05
067D 4F                         ld c,a
067E DD 21 35 31                ld ix,$3135
0682 D2 DE 17                   jp nc,L17DE
0685 FE FF                      cp $FF
0687 3E 16                      ld a,$16
0689 3F                         ccf
068A D0                         ret nc
068B CF                         rst $08
068C 0D                         .defb $0D
068D 3D 35                      .defw $353D
068F 26 00                      ld h,$00
0691 54                         ld d,h
0692 5C                         ld e,h
0693 DD 21 3B 31                ld ix,$313B
0697 37                         scf
0698 C9                         ret
0699 CD 56 06      L0699:       call L0656
069C D0                         ret nc
069D DD 6E 06                   ld l,(ix+$06)
06A0 DD 66 07                   ld h,(ix+$07)
06A3 A7                         and a
06A4 ED 42                      sbc hl,bc
06A6 3E 38                      ld a,$38
06A8 3F                         ccf
06A9 D0                         ret nc
06AA DD 6E 08                   ld l,(ix+$08)
06AD DD 66 09                   ld h,(ix+$09)
06B0 E5                         push hl
06B1 DD E1                      pop ix
06B3 C5                         push bc
06B4 CB 38                      srl b
06B6 CB 19                      rr c
06B8 CB 38                      srl b
06BA CB 19                      rr c
06BC CB 38                      srl b
06BE CB 19                      rr c
06C0 50                         ld d,b
06C1 59                         ld e,c
06C2 C1                         pop bc
06C3 79                         ld a,c
06C4 E6 07                      and $07
06C6 0E 00                      ld c,$00
06C8 1F                         rra
06C9 CB 19                      rr c
06CB 1F                         rra
06CC CB 19                      rr c
06CE 47                         ld b,a
06CF 37                         scf
06D0 C9                         ret
06D1 C5            L06D1:       push bc
06D2 DD E5                      push ix
06D4 E5                         push hl
06D5 CD 99 06                   call L0699
06D8 30 1A                      jr nc,L06F4
06DA C5                         push bc
06DB 01 00 07                   ld bc,$0700
06DE 21 90 E0                   ld hl,$E090
06E1 CD 4A 18                   call IdeSRead
06E4 C1                         pop bc
06E5 30 0D                      jr nc,L06F4
06E7 21 90 E0                   ld hl,$E090
06EA 09                         add hl,bc
06EB D1                         pop de
06EC 01 40 00                   ld bc,$0040
06EF ED B0                      ldir
06F1 37                         scf
06F2 18 01                      jr L06F5
06F4 E1            L06F4:       pop hl
06F5 DD E1         L06F5:       pop ix
06F7 C1                         pop bc
06F8 C9                         ret
06F9 DD E5                      push ix
06FB 01 00 00                   ld bc,$0000
06FE F5            L06FE:       push af
06FF C5                         push bc
0700 E5                         push hl
0701 21 12 F7                   ld hl,$F712
0704 CD D1 06                   call L06D1
0707 30 25                      jr nc,L072E
0709 E1                         pop hl
070A E5                         push hl
070B 11 12 F7                   ld de,$F712
070E 06 10                      ld b,$10
0710 1A            L0710:       ld a,(de)
0711 BE                         cp (hl)
0712 28 15                      jr z,L0729
0714 FE 41                      cp $41
0716 38 04                      jr c,L071C
0718 FE 5B                      cp $5B
071A 38 08                      jr c,L0724
071C FE 61         L071C:       cp $61
071E 38 14                      jr c,L0734
0720 FE 7B                      cp $7B
0722 30 10                      jr nc,L0734
0724 EE 20         L0724:       xor $20
0726 BE                         cp (hl)
0727 20 0B                      jr nz,L0734
0729 13            L0729:       inc de
072A 23                         inc hl
072B 10 E3                      djnz L0710
072D 37                         scf
072E E1            L072E:       pop hl
072F C1                         pop bc
0730 E1            L0730:       pop hl
0731 DD E1                      pop ix
0733 C9                         ret
0734 E1            L0734:       pop hl
0735 C1                         pop bc
0736 03                         inc bc
0737 78                         ld a,b
0738 B1                         or c
0739 3E 38                      ld a,$38
073B 28 F3                      jr z,L0730
073D F1                         pop af
073E 18 BE                      jr L06FE
;
; IDE_PARTITION_OPEN: Open a partition
;
0740 F5            IdePrtOpen:  push af
0741 CD 1F 06                   call L061F
0744 30 05                      jr nc,L074B
0746 CD 05 06                   call L0605
0749 38 02                      jr c,L074D
074B E1            L074B:       pop hl
074C C9                         ret
074D F1            L074D:       pop af
074E F5                         push af
074F 21 12 F7                   ld hl,$F712
0752 CD C4 00                   call L00C4
0755 30 F4                      jr nc,L074B
0757 3A 22 F7                   ld a,($F722)
075A 3D                         dec a
075B FE FD                      cp $FD
075D 3E 38                      ld a,$38
075F 30 EA                      jr nc,L074B
0761 F1                         pop af
0762 CD D5 07                   call L07D5
0765 F3            L0765:       di
0766 DD E5                      push ix
0768 D1                         pop de
0769 21 22 F7                   ld hl,$F722
076C 01 10 00                   ld bc,$0010
076F ED B0                      ldir
0771 FD E5                      push iy
0773 DD E5                      push ix
0775 DD 4E 01                   ld c,(ix+$01)
0778 DD 46 02                   ld b,(ix+$02)
077B DD 56 03                   ld d,(ix+$03)
077E CD A9 00                   call L00A9
0781 DD 5E 03                   ld e,(ix+$03)
0784 D5                         push de
0785 DD 5E 04                   ld e,(ix+$04)
0788 DD 56 05                   ld d,(ix+$05)
078B D5                         push de
078C DD E1                      pop ix
078E FD 21 00 00                ld iy,$0000
0792 21 00 00                   ld hl,$0000
0795 54                         ld d,h
0796 5D                         ld e,l
0797 FD 09         L0797:       add iy,bc
0799 ED 5A                      adc hl,de
079B DD 2B                      dec ix
079D DD 7C                      ld a,xh
079F DD B5                      or xl
07A1 20 F4                      jr nz,L0797
07A3 C1                         pop bc
07A4 78                         ld a,b
07A5 06 00                      ld b,$00
07A7 A7                         and a
07A8 28 07                      jr z,L07B1
07AA FD 09         L07AA:       add iy,bc
07AC ED 5A                      adc hl,de
07AE 3D                         dec a
07AF 20 F9                      jr nz,L07AA
07B1 DD E1         L07B1:       pop ix
07B3 FD 7D                      ld a,yl
07B5 DD 77 01                   ld (ix+$01),a
07B8 FD 7C                      ld a,yh
07BA DD 77 02                   ld (ix+$02),a
07BD DD 75 03                   ld (ix+$03),l
07C0 DD 74 04                   ld (ix+$04),h
07C3 AF                         xor a
07C4 DD 77 05                   ld (ix+$05),a
07C7 DD 77 06                   ld (ix+$06),a
07CA FD E1                      pop iy
07CC FB                         ei
07CD 37                         scf
07CE C9                         ret
;
; IDE_PARTITION_CLOSE: Close a partition
;
07CF DD 36 00 00   IdePrtCls:   ld (ix),$00
07D3 37                         scf
07D4 C9                         ret
07D5 F5            L07D5:       push af
07D6 D6 05                      sub $05
07D8 DD 77 10                   ld (ix+$10),a
07DB DD 71 11                   ld (ix+$11),c
07DE DD 70 12                   ld (ix+$12),b
07E1 A7                         and a
07E2 CD 69 1A                   call L1A69
07E5 30 04                      jr nc,L07EB
07E7 DD CB 10 CE                set 1,(ix+$10)
07EB F1            L07EB:       pop af
07EC C9                         ret
07ED EB            L07ED:       ex de,hl
07EE AF                         xor a
07EF 08                         ex af,af'
07F0 F5                         push af
07F1 AF                         xor a
07F2 57                         ld d,a
07F3 5F                         ld e,a
07F4 CB 38         L07F4:       srl b
07F6 30 07                      jr nc,L07FF
07F8 4F                         ld c,a
07F9 08                         ex af,af'
07FA EB                         ex de,hl
07FB 19                         add hl,de
07FC EB                         ex de,hl
07FD 89                         adc a,c
07FE 08                         ex af,af'
07FF 28 05         L07FF:       jr z,L0806
0801 29                         add hl,hl
0802 8F                         adc a,a
0803 C3 F4 07                   jp L07F4
0806 F1            L0806:       pop af
0807 08                         ex af,af'
0808 C9                         ret
0809 F5            L0809:       push af
080A CD 09 0E                   call L0E09
080D F6 08                      or $08
080F ED 79                      out (c),a
0811 3A 93 5C                   ld a,($5C93)
0814 ED 92 07                   nextreg $07,a
0817 F1                         pop af
0818 C9                         ret
0819 00                         nop
081A 30 00                      jr nc,L081C
081C 03            L081C:       inc bc
;
; Zero bytes ($08)
;
081D                            .fillb $08,$00
0825 FF                         rst $38
;
; Zero bytes ($08)
;
0826                            .fillb $08,$00
;
; IDE_SNAPLOAD: Load a snapshot
;
082E 54            IdeSnapLd:   ld d,h
082F 5D                         ld e,l
0830 1A            L0830:       ld a,(de)
0831 13                         inc de
0832 FE FF                      cp $FF
0834 20 FA                      jr nz,L0830
0836 1B                         dec de
0837 1B                         dec de
0838 1B                         dec de
0839 1A                         ld a,(de)
083A FE 2E                      cp $2E
083C 13                         inc de
083D 1A                         ld a,(de)
083E 20 0C                      jr nz,L084C
0840 E6 DF                      and $DF
0842 FE 4F                      cp $4F
0844 CA A6 0C      L0844:       jp z,L0CA6
0847 FE 50                      cp $50
0849 37                         scf
084A 28 F8                      jr z,L0844
084C 1A            L084C:       ld a,(de)
084D E6 DF                      and $DF
084F 32 92 5C                   ld ($5C92),a
0852 CD 09 0E                   call L0E09
0855 E6 E7                      and $E7
0857 ED 79                      out (c),a
0859 3E 07                      ld a,$07
085B CD 0B 0E                   call RdNextReg
085E E6 03                      and $03
0860 32 93 5C                   ld ($5C93),a
0863 FE 04                      cp $04
0865 30 04                      jr nc,L086B
0867 3E 03                      ld a,$03
0869 ED 79                      out (c),a
086B 01 01 00      L086B:       ld bc,$0001
086E 50                         ld d,b
086F 1E 02                      ld e,$02
0871 CD 06 01                   call L0106
0874 30 93                      jr nc,L0809
0876 21 00 00                   ld hl,$0000
0879 54                         ld d,h
087A 5D                         ld e,l
087B CD 3F 01                   call L013F
087E 06 00                      ld b,$00
0880 CD 39 01                   call L0139
0883 7B                         ld a,e
0884 B2                         or d
0885 32 00 5D                   ld ($5D00),a
0888 CD 00 3F                   call L3F00
088B B9                         cp c
088C 14                         inc d
088D F3                         di
088E 31 FF 5B                   ld sp,$5BFF
0891 21 00 58                   ld hl,$5800
0894 11 01 58                   ld de,$5801
0897 01 FF 02                   ld bc,$02FF
089A 75                         ld (hl),l
089B ED B0                      ldir
089D AF                         xor a
089E D3 FE                      out ($FE),a
08A0 21 19 08                   ld hl,$0819
08A3 11 45 5D                   ld de,$5D45
08A6 01 15 00                   ld bc,$0015
08A9 ED B0                      ldir
08AB 3E 04                      ld a,$04
08AD 32 79 5D                   ld ($5D79),a
08B0 3A 92 5C                   ld a,($5C92)
08B3 CB 77                      bit 6,a
08B5 28 5C                      jr z,L0913
08B7 21 08 5D                   ld hl,$5D08
08BA 3E 1B                      ld a,$1B
08BC CD D2 0A                   call L0AD2
08BF 31 07 5D                   ld sp,$5D07
08C2 F1                         pop af
08C3 32 2D 5D                   ld ($5D2D),a
08C6 E1                         pop hl
08C7 22 36 5D                   ld ($5D36),hl
08CA E1                         pop hl
08CB 22 34 5D                   ld ($5D34),hl
08CE E1                         pop hl
08CF 22 32 5D                   ld ($5D32),hl
08D2 E1                         pop hl
08D3 22 38 5D                   ld ($5D38),hl
08D6 E1                         pop hl
08D7 22 27 5D                   ld ($5D27),hl
08DA E1                         pop hl
08DB 22 30 5D                   ld ($5D30),hl
08DE E1                         pop hl
08DF 22 25 5D                   ld ($5D25),hl
08E2 E1                         pop hl
08E3 22 3A 5D                   ld ($5D3A),hl
08E6 E1                         pop hl
08E7 22 3C 5D                   ld ($5D3C),hl
08EA E1                         pop hl
08EB 7D                         ld a,l
08EC 0F                         rrca
08ED 0F                         rrca
08EE E6 01                      and $01
08F0 32 3E 5D                   ld ($5D3E),a
08F3 7C                         ld a,h
08F4 32 2E 5D                   ld ($5D2E),a
08F7 E1                         pop hl
08F8 22 23 5D                   ld ($5D23),hl
08FB E1                         pop hl
08FC 22 2B 5D                   ld ($5D2B),hl
08FF E1                         pop hl
0900 7D                         ld a,l
0901 32 40 5D                   ld ($5D40),a
0904 7C                         ld a,h
0905 87                         add a,a
0906 32 2F 5D                   ld ($5D2F),a
0909 31 FF 5B                   ld sp,$5BFF
090C 21 13 23                   ld hl,$2313
090F 06 00                      ld b,$00
0911 18 27                      jr L093A
0913 21 23 5D      L0913:       ld hl,$5D23
0916 3E 1E                      ld a,$1E
0918 CD D2 0A                   call L0AD2
091B 21 2F 5D                   ld hl,$5D2F
091E 7E                         ld a,(hl)
091F FE FF                      cp $FF
0921 20 03                      jr nz,L0926
0923 3E 01                      ld a,$01
0925 77                         ld (hl),a
0926 CB C6         L0926:       set 0,(hl)
0928 21 2E 5D                   ld hl,$5D2E
092B CB 16                      rl (hl)
092D 0F                         rrca
092E CB 1E                      rr (hl)
0930 E6 10                      and $10
0932 47                         ld b,a
0933 2A 29 5D                   ld hl,($5D29)
0936 7C                         ld a,h
0937 B5                         or l
0938 28 67                      jr z,L09A1
093A 78            L093A:       ld a,b
093B 32 05 5D                   ld ($5D05),a
093E 22 43 5D                   ld ($5D43),hl
0941 CD F0 0A                   call L0AF0
0944 3A 92 5C                   ld a,($5C92)
0947 FE 58                      cp $58
0949 CC 86 0B                   call z,L0B86
094C 3E 05                      ld a,$05
094E CD 71 0B                   call L0B71
0951 3E 02                      ld a,$02
0953 CD 76 0B                   call L0B76
0956 AF                         xor a
0957 CD 76 0B                   call L0B76
095A 3A 00 5D                   ld a,($5D00)
095D A7                         and a
095E 28 3E                      jr z,L099E
0960 3E 04                      ld a,$04
0962 32 45 5D                   ld ($5D45),a
0965 A7                         and a
0966 CD 60 0B                   call L0B60
0969 ED 43 43 5D                ld ($5D43),bc
096D 7B                         ld a,e
096E 32 46 5D                   ld ($5D46),a
0971 ED 91 53 00                nextreg $53,$00
0975 ED 91 54 01                nextreg $54,$01
0979 21 00 60                   ld hl,$6000
097C E6 07                      and $07
097E CD 80 5D                   call L5D80
0981 AF                         xor a
0982 FE 02         L0982:       cp $02
0984 28 11                      jr z,L0997
0986 FE 05                      cp $05
0988 28 0D                      jr z,L0997
098A 57                         ld d,a
098B 3A 46 5D                   ld a,($5D46)
098E E6 07                      and $07
0990 BA                         cp d
0991 7A                         ld a,d
0992 F5                         push af
0993 C4 71 0B                   call nz,L0B71
0996 F1                         pop af
0997 3C            L0997:       inc a
0998 FE 08                      cp $08
099A 38 E6                      jr c,L0982
099C 3E 08                      ld a,$08
099E C3 60 0A      L099E:       jp L0A60
09A1 21 41 5D      L09A1:       ld hl,$5D41
09A4 3E 02                      ld a,$02
09A6 CD D2 0A                   call L0AD2
09A9 2A 41 5D                   ld hl,($5D41)
09AC 7C                         ld a,h
09AD A7                         and a
09AE 20 73                      jr nz,L0A23
09B0 7D                         ld a,l
09B1 FE 38                      cp $38
09B3 30 7B                      jr nc,L0A30
09B5 F5                         push af
09B6 21 43 5D                   ld hl,$5D43
09B9 CD D2 0A                   call L0AD2
09BC CD F0 0A                   call L0AF0
09BF 3E 08                      ld a,$08
09C1 CD 0B 0E                   call RdNextReg
09C4 E6 FE                      and $FE
09C6 21 40 5D                   ld hl,$5D40
09C9 CB 56                      bit 2,(hl)
09CB 28 02                      jr z,L09CF
09CD F6 01                      or $01
09CF ED 79         L09CF:       out (c),a
09D1 F1                         pop af
09D2 21 45 5D                   ld hl,$5D45
09D5 FE 17                      cp $17
09D7 20 0A                      jr nz,L09E3
09D9 7E                         ld a,(hl)
09DA FE 03                      cp $03
09DC 38 05                      jr c,L09E3
09DE FE 05                      cp $05
09E0 30 01                      jr nc,L09E3
09E2 34                         inc (hl)
09E3 3A 48 5D      L09E3:       ld a,($5D48)
09E6 87                         add a,a
09E7 7E                         ld a,(hl)
09E8 30 10                      jr nc,L09FA
09EA FE 09                      cp $09
09EC 30 0C                      jr nc,L09FA
09EE FE 04                      cp $04
09F0 38 08                      jr c,L09FA
09F2 FE 07                      cp $07
09F4 3E 0C                      ld a,$0C
09F6 38 01                      jr c,L09F9
09F8 3C                         inc a
09F9 77            L09F9:       ld (hl),a
09FA FE 07         L09FA:       cp $07
09FC 30 05                      jr nc,L0A03
09FE 3E 04                      ld a,$04
0A00 32 79 5D                   ld ($5D79),a
0A03 7E            L0A03:       ld a,(hl)
0A04 FE 04                      cp $04
0A06 30 2D                      jr nc,L0A35
0A08 3E 30                      ld a,$30
0A0A 32 46 5D                   ld ($5D46),a
0A0D 16 03                      ld d,$03
0A0F D5            L0A0F:       push de
0A10 CD 54 0B                   call L0B54
0A13 FE 04                      cp $04
0A15 1E 02                      ld e,$02
0A17 28 0C                      jr z,L0A25
0A19 FE 05                      cp $05
0A1B 1E 00                      ld e,$00
0A1D 28 06                      jr z,L0A25
0A1F FE 08                      cp $08
0A21 1E 05                      ld e,$05
0A23 20 0B         L0A23:       jr nz,L0A30
0A25 7B            L0A25:       ld a,e
0A26 CD 71 0B                   call L0B71
0A29 D1                         pop de
0A2A 15                         dec d
0A2B 20 E2                      jr nz,L0A0F
0A2D AF                         xor a
0A2E 18 30                      jr L0A60
0A30 3E 15         L0A30:       ld a,$15
0A32 C3 D9 0A                   jp L0AD9
0A35 16 08         L0A35:       ld d,$08
0A37 D5            L0A37:       push de
0A38 CD 54 0B                   call L0B54
0A3B D6 03                      sub $03
0A3D 38 F1                      jr c,L0A30
0A3F FE 08                      cp $08
0A41 30 ED                      jr nc,L0A30
0A43 CD 71 0B                   call L0B71
0A46 D1                         pop de
0A47 15                         dec d
0A48 20 ED                      jr nz,L0A37
0A4A 3A 45 5D                   ld a,($5D45)
0A4D 06 18                      ld b,$18
0A4F FE 50                      cp $50
0A51 28 0E                      jr z,L0A61
0A53 06 10                      ld b,$10
0A55 FE 51                      cp $51
0A57 28 08                      jr z,L0A61
0A59 FE 0C                      cp $0C
0A5B 3E 08                      ld a,$08
0A5D 38 01                      jr c,L0A60
0A5F 3C                         inc a
0A60 47            L0A60:       ld b,a
0A61 ED 91 56 0E   L0A61:       nextreg $56,$0E
0A65 ED 91 57 0F                nextreg $57,$0F
0A69 3A 92 5C                   ld a,($5C92)
0A6C FE 58                      cp $58
0A6E 11 FF 00                   ld de,$00FF
0A71 28 37                      jr z,L0AAA
0A73 78                         ld a,b
0A74 EE 18                      xor $18
0A76 F5                         push af
0A77 CD 70 0D                   call L0D70
0A7A 30 5D                      jr nc,L0AD9
0A7C 57                         ld d,a
0A7D D5                         push de
0A7E 06 00                      ld b,$00
0A80 CD 09 01                   call L0109
0A83 D1                         pop de
0A84 ED 91 B8 00                nextreg $B8,$00
0A88 CB 6A                      bit 5,d
0A8A 28 07                      jr z,L0A93
0A8C 3A 48 5D                   ld a,($5D48)
0A8F CB 57                      bit 2,a
0A91 28 09                      jr z,L0A9C
0A93 3E 84         L0A93:       ld a,$84
0A95 CD 0B 0E                   call RdNextReg
0A98 F6 01                      or $01
0A9A ED 79                      out (c),a
0A9C F1            L0A9C:       pop af
0A9D FE 09                      cp $09
0A9F 30 09                      jr nc,L0AAA
0AA1 3E 0A                      ld a,$0A
0AA3 CD 0B 0E                   call RdNextReg
0AA6 E6 EF                      and $EF
0AA8 ED 79                      out (c),a
0AAA CD 09 08      L0AAA:       call L0809
0AAD 3E 02                      ld a,$02
0AAF CD 0B 0E                   call RdNextReg
0AB2 E6 80                      and $80
0AB4 F6 08                      or $08
0AB6 ED 79                      out (c),a
0AB8 00                         nop
0AB9 06 00         L0AB9:       ld b,$00
0ABB D5                         push de
0ABC ED 91 56 0E                nextreg $56,$0E
0AC0 ED 91 57 0F                nextreg $57,$0F
0AC4 CD 12 01                   call L0112
0AC7 E1                         pop hl
0AC8 D8                         ret c
0AC9 FE 19                      cp $19
0ACB 37                         scf
0ACC 3F                         ccf
0ACD C0                         ret nz
0ACE ED 52                      sbc hl,de
0AD0 BF                         cp a
0AD1 C9                         ret
0AD2 5F            L0AD2:       ld e,a
0AD3 16 00                      ld d,$00
0AD5 CD B9 0A                   call L0AB9
0AD8 D8                         ret c
0AD9 F5            L0AD9:       push af
0ADA CD 00 3F                   call L3F00
0ADD CD 37 F1                   call LF137
0AE0 FE 0A                      cp $0A
0AE2 16 3E                      ld d,$3E
0AE4 38 02                      jr c,L0AE8
0AE6 16 19                      ld d,$19
0AE8 82            L0AE8:       add a,d
0AE9 CD 00 3F                   call L3F00
0AEC 1B                         dec de
0AED 0D                         dec c
0AEE 18 FE         L0AEE:       jr L0AEE
0AF0 21 22 0C      L0AF0:       ld hl,$0C22
0AF3 11 80 5D                   ld de,$5D80
0AF6 01 84 00                   ld bc,$0084
0AF9 ED B0                      ldir
0AFB ED 43 03 5D                ld ($5D03),bc
0AFF 3E 12                      ld a,$12
0B01 CD 0B 0E                   call RdNextReg
0B04 21 01 5D                   ld hl,$5D01
0B07 77                         ld (hl),a
0B08 23                         inc hl
0B09 3C                         inc a
0B0A 77                         ld (hl),a
0B0B 2B                         dec hl
0B0C E5                         push hl
0B0D 7E                         ld a,(hl)
0B0E CD 14 0B                   call L0B14
0B11 E1                         pop hl
0B12 23                         inc hl
0B13 7E                         ld a,(hl)
0B14 4F            L0B14:       ld c,a
0B15 21 00 C0                   ld hl,$C000
0B18 11 00 40                   ld de,$4000
0B1B CD B9 0A                   call L0AB9
0B1E D8                         ret c
0B1F C8                         ret z
0B20 18 B7                      jr L0AD9
0B22 2A 03 5D      L0B22:       ld hl,($5D03)
0B25 CB 74                      bit 6,h
0B27 28 10                      jr z,L0B39
0B29 CB B4                      res 6,h
0B2B E5                         push hl
0B2C 21 01 5D                   ld hl,$5D01
0B2F 7E                         ld a,(hl)
0B30 23                         inc hl
0B31 56                         ld d,(hl)
0B32 77                         ld (hl),a
0B33 2B                         dec hl
0B34 72                         ld (hl),d
0B35 CD 14 0B                   call L0B14
0B38 E1                         pop hl
0B39 11 01 5D      L0B39:       ld de,$5D01
0B3C 1A                         ld a,(de)
0B3D 13                         inc de
0B3E 87                         add a,a
0B3F ED 92 53                   nextreg $53,a
0B42 3C                         inc a
0B43 ED 92 54                   nextreg $54,a
0B46 1A                         ld a,(de)
0B47 87                         add a,a
0B48 ED 92 55                   nextreg $55,a
0B4B 3C                         inc a
0B4C ED 92 56                   nextreg $56,a
0B4F ED 34 00 60                add hl,$6000
0B53 C9                         ret
0B54 37            L0B54:       scf
0B55 CD 60 0B                   call L0B60
0B58 78                         ld a,b
0B59 A1                         and c
0B5A 3C                         inc a
0B5B 32 05 5D                   ld ($5D05),a
0B5E 7B                         ld a,e
0B5F C9                         ret
0B60 F5            L0B60:       push af
0B61 CD 22 0B                   call L0B22
0B64 4E                         ld c,(hl)
0B65 23                         inc hl
0B66 46                         ld b,(hl)
0B67 23                         inc hl
0B68 5E                         ld e,(hl)
0B69 23                         inc hl
0B6A F1                         pop af
0B6B 38 11                      jr c,L0B7E
0B6D 56                         ld d,(hl)
0B6E 23                         inc hl
0B6F 18 0D                      jr L0B7E
0B71 26 00         L0B71:       ld h,$00
0B73 22 06 5D                   ld ($5D06),hl
0B76 F5            L0B76:       push af
0B77 CD 22 0B                   call L0B22
0B7A F1                         pop af
0B7B CD 80 5D                   call L5D80
0B7E ED 34 00 A0   L0B7E:       add hl,$A000
0B82 22 03 5D                   ld ($5D03),hl
0B85 C9                         ret
0B86 3A 01 5D      L0B86:       ld a,($5D01)
0B89 87                         add a,a
0B8A ED 92 53                   nextreg $53,a
0B8D C6 03                      add a,$03
0B8F ED 92 55                   nextreg $55,a
0B92 3A 5C 7C                   ld a,($7C5C)
0B95 FE FB                      cp $FB
0B97 20 0A                      jr nz,L0BA3
0B99 2A 5D 7C                   ld hl,($7C5D)
0B9C 11 ED 4D                   ld de,$4DED
0B9F ED 52                      sbc hl,de
0BA1 28 1C                      jr z,L0BBF
0BA3 21 D4 0B      L0BA3:       ld hl,$0BD4
0BA6 7E            L0BA6:       ld a,(hl)
0BA7 A7                         and a
0BA8 C8                         ret z
0BA9 47                         ld b,a
0BAA 23                         inc hl
0BAB 5E                         ld e,(hl)
0BAC 23                         inc hl
0BAD 56                         ld d,(hl)
0BAE 23            L0BAE:       inc hl
0BAF 1A                         ld a,(de)
0BB0 13                         inc de
0BB1 96                         sub (hl)
0BB2 20 17                      jr nz,L0BCB
0BB4 10 F8                      djnz L0BAE
0BB6 06 02                      ld b,$02
0BB8 23            L0BB8:       inc hl
0BB9 5E                         ld e,(hl)
0BBA 23                         inc hl
0BBB 56                         ld d,(hl)
0BBC 12                         ld (de),a
0BBD 10 F9                      djnz L0BB8
0BBF 3E 05         L0BBF:       ld a,$05
0BC1 CD 0B 0E                   call RdNextReg
0BC4 E6 05                      and $05
0BC6 F6 42                      or $42
0BC8 ED 79                      out (c),a
0BCA C9                         ret
0BCB 23            L0BCB:       inc hl
0BCC 10 FD                      djnz L0BCB
0BCE 23                         inc hl
0BCF 23                         inc hl
0BD0 23                         inc hl
0BD1 23                         inc hl
0BD2 18 D2                      jr L0BA6
0BD4 0C                         inc c
0BD5 68                         ld l,b
0BD6 7C                         ld a,h
0BD7 D9                         exx
0BD8 FD E1                      pop iy
0BDA DD E1                      pop ix
0BDC E1                         pop hl
0BDD D1                         pop de
0BDE C1                         pop bc
0BDF F1                         pop af
0BE0 FB                         ei
0BE1 ED 4D                      reti
0BE3 64                         ld h,h
0BE4 7C                         ld a,h
0BE5 68                         ld l,b
0BE6 7C                         ld a,h
0BE7 0D                         dec c
0BE8 64                         ld h,h
0BE9 7C                         ld a,h
0BEA D9                         exx
0BEB D9                         exx
0BEC FD E1                      pop iy
0BEE DD E1                      pop ix
0BF0 E1                         pop hl
0BF1 D1                         pop de
0BF2 C1                         pop bc
0BF3 F1                         pop af
0BF4 FB                         ei
0BF5 ED 4D                      reti
0BF7 64                         ld h,h
0BF8 7C                         ld a,h
0BF9 65                         ld h,l
0BFA 7C                         ld a,h
0BFB 0C                         inc c
0BFC 6B                         ld l,e
0BFD 7C                         ld a,h
0BFE D9                         exx
0BFF FD E1                      pop iy
0C01 DD E1                      pop ix
0C03 E1                         pop hl
0C04 D1                         pop de
0C05 C1                         pop bc
0C06 F1                         pop af
0C07 FB                         ei
0C08 ED 4D                      reti
0C0A 64                         ld h,h
0C0B 7C                         ld a,h
0C0C 6B                         ld l,e
0C0D 7C                         ld a,h
0C0E 0C                         inc c
0C0F 2F                         cpl
0C10 A9            L0C10:       xor c
0C11 D9                         exx
0C12 FD E1                      pop iy
0C14 DD E1                      pop ix
0C16 D1                         pop de
0C17 C1                         pop bc
0C18 E1                         pop hl
0C19 F1                         pop af
0C1A FB                         ei
0C1B ED 4D                      reti
0C1D 2B                         dec hl
0C1E A9                         xor c
0C1F 2F                         cpl
0C20 A9                         xor c
0C21 00                         nop
0C22 87                         add a,a
0C23 ED 92 57                   nextreg $57,a
0C26 3C                         inc a
0C27 F5                         push af
0C28 FE 0B                      cp $0B
0C2A 28 54                      jr z,L0C80
0C2C FE 0F                      cp $0F
0C2E 28 65                      jr z,L0C95
0C30 11 00 E0                   ld de,$E000
0C33 3A 05 5D                   ld a,($5D05)
0C36 A7                         and a
0C37 20 12                      jr nz,L0C4B
0C39 CD A0 5D                   call L5DA0
0C3C F1                         pop af
0C3D ED 92 57                   nextreg $57,a
0C40 16 E0                      ld d,$E0
0C42 01 00 20      L0C42:       ld bc,$2000
0C45 ED B0                      ldir
0C47 AF            L0C47:       xor a
0C48 D3 E3                      out ($E3),a
0C4A C9                         ret
0C4B CD B2 5D      L0C4B:       call L5DB2
0C4E F1                         pop af
0C4F ED 92 57                   nextreg $57,a
0C52 16 E0                      ld d,$E0
0C54 ED 4B 06 5D   L0C54:       ld bc,($5D06)
0C58 04            L0C58:       inc b
0C59 05                         dec b
0C5A 20 20                      jr nz,L0C7C
0C5C 7E                         ld a,(hl)
0C5D 23                         inc hl
0C5E FE ED                      cp $ED
0C60 28 0F                      jr z,L0C71
0C62 12            L0C62:       ld (de),a
0C63 1C                         inc e
0C64 20 F2                      jr nz,L0C58
0C66 14                         inc d
0C67 CB 6A                      bit 5,d
0C69 20 ED                      jr nz,L0C58
0C6B ED 43 06 5D                ld ($5D06),bc
0C6F 18 D6                      jr L0C47
0C71 06 01         L0C71:       ld b,$01
0C73 4E                         ld c,(hl)
0C74 23                         inc hl
0C75 B9                         cp c
0C76 20 EA                      jr nz,L0C62
0C78 46                         ld b,(hl)
0C79 23                         inc hl
0C7A 4E                         ld c,(hl)
0C7B 23                         inc hl
0C7C 79            L0C7C:       ld a,c
0C7D 05                         dec b
0C7E 18 E2                      jr L0C62
0C80 3E 86         L0C80:       ld a,$86
0C82 D3 E3                      out ($E3),a
0C84 CD FF 5D                   call L5DFF
0C87 F1                         pop af
0C88 ED 92 57                   nextreg $57,a
0C8B 16 E0                      ld d,$E0
0C8D 3A 05 5D      L0C8D:       ld a,($5D05)
0C90 A7                         and a
0C91 20 C1                      jr nz,L0C54
0C93 18 AD                      jr L0C42
0C95 F1            L0C95:       pop af
0C96 3E 84                      ld a,$84
0C98 D3 E3                      out ($E3),a
0C9A CD FF 5D                   call L5DFF
0C9D 3E 85                      ld a,$85
0C9F D3 E3                      out ($E3),a
0CA1 11 00 20                   ld de,$2000
0CA4 18 E7                      jr L0C8D
0CA6 E5            L0CA6:       push hl
0CA7 F5                         push af
0CA8 D6 4F                      sub $4F
0CAA 87                         add a,a
0CAB 87                         add a,a
0CAC 87                         add a,a
0CAD CD 70 0D                   call L0D70
0CB0 D1                         pop de
0CB1 C1                         pop bc
0CB2 D0                         ret nc
0CB3 21 00 80                   ld hl,$8000
0CB6 F9                         ld sp,hl
0CB7 D5                         push de
0CB8 C5                         push bc
0CB9 CD 50 0D                   call L0D50
0CBC E1                         pop hl
0CBD 11 00 80                   ld de,$8000
0CC0 F1                         pop af
0CC1 F5                         push af
0CC2 30 02                      jr nc,L0CC6
0CC4 1E 09                      ld e,$09
0CC6 3E FF         L0CC6:       ld a,$FF
0CC8 CD 46 0E                   call L0E46
0CCB D2 D9 0A                   jp nc,L0AD9
0CCE 26 C0                      ld h,$C0
0CD0 CD 50 0D                   call L0D50
0CD3 21 07 0D                   ld hl,$0D07
0CD6 11 00 F0                   ld de,$F000
0CD9 01 49 00                   ld bc,$0049
0CDC ED B0                      ldir
0CDE F3                         di
0CDF 3E 0A                      ld a,$0A
0CE1 CD 0B 0E                   call RdNextReg
0CE4 E6 EF                      and $EF
0CE6 ED 79                      out (c),a
0CE8 01 FD 7F                   ld bc,$7FFD
0CEB 3E 2F                      ld a,$2F
0CED ED 79                      out (c),a
0CEF AF                         xor a
0CF0 08                         ex af,af'
0CF1 F1                         pop af
0CF2 FD 21 00 40                ld iy,$4000
0CF6 ED 56                      im 1
0CF8 21 00 80                   ld hl,$8000
0CFB 11 00 40                   ld de,$4000
0CFE 42                         ld b,d
0CFF 4B                         ld c,e
0D00 ED B0                      ldir
0D02 EB                         ex de,hl
0D03 F9                         ld sp,hl
0D04 C3 00 F0                   jp LF000
0D07 ED 91 8C A0                nextreg $8C,$A0
0D0B FB                         ei
0D0C 38 1B                      jr c,L0D29
0D0E 3E 0E                      ld a,$0E
0D10 ED 47                      ld i,a
0D12 21 AA 3F                   ld hl,$3FAA
0D15 E5                         push hl
0D16 CD 47 07                   call L0747
0D19 21 FF 88                   ld hl,$88FF
0D1C 22 00 40                   ld ($4000),hl
0D1F 21 47 04                   ld hl,$0447
0D22 E5                         push hl
0D23 01 00 00                   ld bc,$0000
0D26 C3 34 09                   jp L0934
0D29 21 40 F0      L0D29:       ld hl,$F040
0D2C 11 00 40                   ld de,$4000
0D2F 01 09 00                   ld bc,$0009
0D32 ED B0                      ldir
0D34 DD 21 81 02                ld ix,$0281
0D38 3E 1E                      ld a,$1E
0D3A ED 47                      ld i,a
0D3C 21 00 3E                   ld hl,$3E00
0D3F E5                         push hl
0D40 21 76 06                   ld hl,$0676
0D43 E5                         push hl
0D44 C3 07 02                   jp L0207
0D47 FF                         rst $38
0D48 80                         add a,b
0D49 FC 7F 00                   call m,L007F
0D4C 80                         add a,b
0D4D 00                         nop
0D4E FE FF                      cp $FF
0D50 2E 00         L0D50:       ld l,$00
0D52 54                         ld d,h
0D53 1E 01                      ld e,$01
0D55 01 FF 3F                   ld bc,$3FFF
0D58 75                         ld (hl),l
0D59 ED B0                      ldir
0D5B C9                         ret
;
;
;
0D5C 01 50 F6                   ld bc,$F650
0D5F CF                         rst $08
0D60 92                         .defb $92
0D61 C9 5F                      .defw $5FC9
0D63 D6 A5                      sub $A5
0D65 D2 10 0C                   jp nc,L0C10
0D68 01 50 FB                   ld bc,$FB50
0D6B CF                         rst $08
0D6C 92                         .defb $92
0D6D C9 CD                      .defw $CDC9
0D6F 0E F5                      ld e,$F5
0D71 CD 14 1E                   call L1E14
0D74 F1                         pop af
0D75 F5                         push af
0D76 CD 37 0E                   call L0E37
0D79 C1                         pop bc
0D7A D0                         ret nc
0D7B C5                         push bc
0D7C CB 60                      bit 4,b
0D7E 28 2C                      jr z,L0DAC
0D80 3A 68 5B                   ld a,($5B68)
0D83 CB 67                      bit 4,a
0D85 20 25                      jr nz,L0DAC
0D87 21 5C 0D                   ld hl,$0D5C
0D8A 11 00 C0                   ld de,$C000
0D8D 01 14 00                   ld bc,$0014
0D90 D5                         push de
0D91 ED B0                      ldir
0D93 E1                         pop hl
0D94 11 AC 0E                   ld de,$0EAC
0D97 0E 06                      ld c,$06
0D99 CD 94 0E                   call L0E94
0D9C 11 CD 0E                   ld de,$0ECD
0D9F 0E 0C                      ld c,$0C
0DA1 CD 94 0E                   call L0E94
0DA4 11 BE 15                   ld de,$15BE
0DA7 0E 02                      ld c,$02
0DA9 CD 94 0E                   call L0E94
0DAC C1            L0DAC:       pop bc
0DAD 78                         ld a,b
0DAE FE 18                      cp $18
0DB0 3E A0                      ld a,$A0
0DB2 16 01                      ld d,$01
0DB4 1E C2                      ld e,$C2
0DB6 20 06                      jr nz,L0DBE
0DB8 3E 90                      ld a,$90
0DBA 15                         dec d
0DBB 1E C0                      ld e,$C0
0DBD 43                         ld b,e
0DBE ED 92 03      L0DBE:       nextreg $03,a
0DC1 78                         ld a,b
0DC2 E6 10                      and $10
0DC4 EE 10                      xor $10
0DC6 87                         add a,a
0DC7 F6 80                      or $80
0DC9 F5                         push af
0DCA 3E 83                      ld a,$83
0DCC CD 0B 0E                   call RdNextReg
0DCF 3C                         inc a
0DD0 20 0E                      jr nz,L0DE0
0DD2 ED 91 83 3F                nextreg $83,$3F
0DD6 7A                         ld a,d
0DD7 ED 92 84                   nextreg $84,a
0DDA ED 91 85 01                nextreg $85,$01
0DDE 18 09                      jr L0DE9
0DE0 3E 82         L0DE0:       ld a,$82
0DE2 CD 0B 0E                   call RdNextReg
0DE5 E6 25                      and $25
0DE7 B3                         or e
0DE8 5F                         ld e,a
0DE9 AF            L0DE9:       xor a
0DEA ED 92 14                   nextreg $14,a
0DED ED 92 4A                   nextreg $4A,a
0DF0 ED 92 D8                   nextreg $D8,a
0DF3 CD 09 0E                   call L0E09
0DF6 E6 FC                      and $FC
0DF8 F6 01                      or $01
0DFA ED 79                      out (c),a
0DFC 05                         dec b
0DFD 3E 08                      ld a,$08
0DFF CD 0B 0E                   call RdNextReg
0E02 E6 BF                      and $BF
0E04 ED 79                      out (c),a
0E06 F1                         pop af
0E07 37                         scf
0E08 C9                         ret
0E09 3E 06         L0E09:       ld a,$06
;
; Read Nextreg Register
; Reads the value of a nextreg register specified in A.
; Entry: A = nextreg register number to read
; Exit: A = value read from nextreg, BC = $253B (data port)
;
0E0B 01 3B 24      RdNextReg:   ld bc,$243B                ; BC = $243B (Nextreg select port)
0E0E ED 79                      out (c),a                  ; Select nextreg register A
0E10 04                         inc b                      ; BC = $253B (Nextreg data port)
0E11 ED 78                      in a,(c)                   ; A = read value from nextreg
0E13 C9                         ret                        ; Return with value in A
;
;
;
0E14 ED 91 82 DA   L0E14:       nextreg $82,$DA
0E18 ED 91 83 2B                nextreg $83,$2B
0E1C ED 91 84 01                nextreg $84,$01
0E20 ED 91 85 00                nextreg $85,$00
0E24 CD 09 0E                   call L0E09
0E27 E6 FC                      and $FC
0E29 F6 01                      or $01
0E2B ED 79                      out (c),a
0E2D 3E 08                      ld a,$08
0E2F CD 0B 0E                   call RdNextReg
0E32 E6 BB                      and $BB
0E34 ED 79                      out (c),a
0E36 C9                         ret
0E37 ED 91 8C C0   L0E37:       nextreg $8C,$C0
0E3B 11 00 00                   ld de,$0000
0E3E E6 FE                      and $FE
0E40 D6 10                      sub $10
0E42 28 02                      jr z,L0E46
0E44 3E 04                      ld a,$04
0E46 ED 47         L0E46:       ld i,a
0E48 D5                         push de
0E49 01 01 01                   ld bc,$0101
0E4C 11 02 00                   ld de,$0002
0E4F CD 06 01                   call L0106
0E52 30 1E                      jr nc,L0E72
0E54 21 00 C0      L0E54:       ld hl,$C000
0E57 11 00 10                   ld de,$1000
0E5A E5                         push hl
0E5B D5                         push de
0E5C 01 07 01                   ld bc,$0107
0E5F CD 12 01                   call L0112
0E62 C1                         pop bc
0E63 E1                         pop hl
0E64 D1                         pop de
0E65 F5                         push af
0E66 CD 81 0E                   call L0E81
0E69 F1                         pop af
0E6A D5                         push de
0E6B 38 E7                      jr c,L0E54
0E6D FE 19                      cp $19
0E6F 37                         scf
0E70 28 01                      jr z,L0E73
0E72 A7            L0E72:       and a
0E73 E1            L0E73:       pop hl
0E74 F5                         push af
0E75 06 01                      ld b,$01
0E77 CD 09 01                   call L0109
0E7A 06 01                      ld b,$01
0E7C D4 0C 01                   call nc,L010C
0E7F F1                         pop af
0E80 C9                         ret
0E81 ED 57         L0E81:       ld a,i
0E83 3C                         inc a
0E84 28 0B                      jr z,L0E91
0E86 ED 47                      ld i,a
0E88 CB B2                      res 6,d
0E8A FE 09                      cp $09
0E8C D0                         ret nc
0E8D FE 05                      cp $05
0E8F 30 03                      jr nc,L0E94
0E91 ED B0         L0E91:       ldir
0E93 C9                         ret
0E94 ED 8A 5B 43   L0E94:       push $5B43
0E98 ED 8A 00 1B                push $001B
0E9C C3 3E 5B                   jp L5B3E
;
; IDE_BANK: Allocate or free 8K RAM banks in main ZX memory or DivMMC memory
; IN: H=bank type:
;       rc_banktype_zx (0), ZX memory half-banks (8K size)
;       rc_banktype_mmc (1), DivMMC memory banks (8K size)
;     L=reason:
;       rc_bank_total (0), return total number of 8K banks of specified type
;       rc_bank_alloc (1), allocate next available 8K bank
;       rc_bank_reserve (2), reserve bank specified in E (0..total-1)
;       rc_bank_free (3), free bank specified in E (0..total-1)
;       rc_bank_available (4), return number of currently-available 8K banks
;       of specified type
;     E=8K bank ID (0..total-1), for rc_bank_reserve/rc_bank_free
; OUT(s): Fc=1
;     E=8K bank ID (0..total-1), for rc_bank_alloc
;     E=total number of 8K banks of specified type, for rc_bank_total
;     E=available number of 8K banks of specified type, for rc_bank_available
; OUT(f): Fc=0
;     A=error: rc_inuse if no available banks to allocate
;     rc_badparam if H, L or E is invalid
;
0E9F 01 3B 24      IdeBank:     ld bc,$243B
0EA2 3E 57                      ld a,$57
0EA4 ED 79                      out (c),a
0EA6 04                         inc b
0EA7 ED 50                      in d,(c)
0EA9 3E 10                      ld a,$10
0EAB ED 79                      out (c),a
0EAD DD 21 00 E0                ld ix,$E000
0EB1 3A 50 E0                   ld a,($E050)
0EB4 CB 44                      bit 0,h
0EB6 28 07                      jr z,L0EBF
0EB8 DD 21 20 E0                ld ix,$E020
0EBC 3A 51 E0                   ld a,($E051)
0EBF 47            L0EBF:       ld b,a
0EC0 2C                         inc l
0EC1 2D                         dec l
0EC2 28 78                      jr z,L0F3C
0EC4 2D                         dec l
0EC5 20 42                      jr nz,L0F09
0EC7 3D                         dec a
0EC8 0F                         rrca
0EC9 0F                         rrca
0ECA 0F                         rrca
0ECB E6 1F                      and $1F
0ECD DD 85                      add a,xl
0ECF DD 6F                      ld xl,a
0ED1 78                         ld a,b
0ED2 3D                         dec a
0ED3 E6 07                      and $07
0ED5 3C                         inc a
0ED6 0E 80                      ld c,$80
0ED8 CB 01         L0ED8:       rlc c
0EDA 3D                         dec a
0EDB 20 FB                      jr nz,L0ED8
0EDD 58                         ld e,b
0EDE DD 7E 00      L0EDE:       ld a,(ix)
0EE1 A1                         and c
0EE2 28 10                      jr z,L0EF4
0EE4 CB 09                      rrc c
0EE6 1D                         dec e
0EE7 28 06                      jr z,L0EEF
0EE9 30 F3                      jr nc,L0EDE
0EEB DD 2B                      dec ix
0EED 18 EF                      jr L0EDE
0EEF 3E 24         L0EEF:       ld a,$24
0EF1 A7                         and a
0EF2 18 6D                      jr L0F61
0EF4 1D            L0EF4:       dec e
0EF5 DD 7E 00      L0EF5:       ld a,(ix)
0EF8 B1                         or c
0EF9 DD 77 00                   ld (ix),a
0EFC CB 7C                      bit 7,h
0EFE 28 07                      jr z,L0F07
0F00 DD 7E 28                   ld a,(ix+$28)
0F03 B1                         or c
0F04 DD 77 28                   ld (ix+$28),a
0F07 18 57         L0F07:       jr L0F60
0F09 7D            L0F09:       ld a,l
0F0A FE 03                      cp $03
0F0C 28 5E                      jr z,L0F6C
0F0E 7B                         ld a,e
0F0F B8                         cp b
0F10 30 55                      jr nc,L0F67
0F12 0F                         rrca
0F13 0F                         rrca
0F14 0F                         rrca
0F15 E6 1F                      and $1F
0F17 DD 85                      add a,xl
0F19 DD 6F                      ld xl,a
0F1B 0E 01                      ld c,$01
0F1D 7B                         ld a,e
0F1E E6 07                      and $07
0F20 28 05                      jr z,L0F27
0F22 CB 01         L0F22:       rlc c
0F24 3D                         dec a
0F25 20 FB                      jr nz,L0F22
0F27 DD 7E 00      L0F27:       ld a,(ix)
0F2A 2D                         dec l
0F2B 20 12                      jr nz,L0F3F
0F2D A1                         and c
0F2E 28 C5                      jr z,L0EF5
0F30 CB 7C                      bit 7,h
0F32 28 BB                      jr z,L0EEF
0F34 DD 7E 28                   ld a,(ix+$28)
0F37 A1                         and c
0F38 20 BB                      jr nz,L0EF5
0F3A 18 B3                      jr L0EEF
0F3C 58            L0F3C:       ld e,b
0F3D 18 21                      jr L0F60
0F3F 2D            L0F3F:       dec l
0F40 20 25                      jr nz,L0F67
0F42 A1                         and c
0F43 28 1B                      jr z,L0F60
0F45 DD 7E 28                   ld a,(ix+$28)
0F48 A1                         and c
0F49 28 04                      jr z,L0F4F
0F4B CB 7C                      bit 7,h
0F4D 28 A0                      jr z,L0EEF
0F4F 79            L0F4F:       ld a,c
0F50 2F                         cpl
0F51 4F                         ld c,a
0F52 DD 7E 00                   ld a,(ix)
0F55 A1                         and c
0F56 DD 77 00                   ld (ix),a
0F59 DD 7E 28                   ld a,(ix+$28)
0F5C A1                         and c
0F5D DD 77 28                   ld (ix+$28),a
0F60 37            L0F60:       scf
0F61 01 3B 25      L0F61:       ld bc,$253B
0F64 ED 51                      out (c),d
0F66 C9                         ret
0F67 3E 15         L0F67:       ld a,$15
0F69 A7                         and a
0F6A 18 F5                      jr L0F61
0F6C 1E 00         L0F6C:       ld e,$00
0F6E 0E 01                      ld c,$01
0F70 DD 7E 00      L0F70:       ld a,(ix)
0F73 A1                         and c
0F74 20 01                      jr nz,L0F77
0F76 1C                         inc e
0F77 CB 01         L0F77:       rlc c
0F79 05                         dec b
0F7A 30 F4                      jr nc,L0F70
0F7C DD 23                      inc ix
0F7E 20 F0                      jr nz,L0F70
0F80 18 DE                      jr L0F60
0F82 ED 5B 59 5C                ld de,($5C59)
0F86 D5                         push de
0F87 7E            L0F87:       ld a,(hl)
0F88 23                         inc hl
0F89 12                         ld (de),a
0F8A 13                         inc de
0F8B FE 0D                      cp $0D
0F8D 20 F8                      jr nz,L0F87
0F8F EB                         ex de,hl
0F90 36 80                      ld (hl),$80
0F92 23                         inc hl
0F93 22 61 5C                   ld ($5C61),hl
0F96 22 63 5C                   ld ($5C63),hl
0F99 22 65 5C                   ld ($5C65),hl
0F9C E1                         pop hl
;
; IDE_BASIC: Execute a BASIC command line
; IN: HL=address of tokenized BASIC command line, terminated with $0d
; OUT(s): Fc=1
;     System variable ERR_NR contains generated BASIC error code-1
;     ($ff means BASIC command completed successfully)
;     Register status on return:
;     ......../.. same
;     AFBCDEHL/IX different
; NOTES:
;     This call must be made with the ROM2/RAM5/RAM2/RAM0 memory configuration rather
;     than the usual +3DOS configuration. The stack must be located between STKEND and
;     RAMTOP (the normal location for the stack during BASIC operation).
;     Any number of BASIC commands may be executed, separated by colons (:), and the
;     line must be terminated with an ENTER character ($0d).
;     If you intend to return to BASIC, don't forget to first clear the ERR_NR system
;     variable back to $ff (no error).
;     Additionally, note that a m/code program using IDE_BASIC should not be executed
;     using a variable assignment, eg:
;     LET variable=USR x
;     since this will cause unexpected effects if the BASIC statements executed by
;     IDE_BASIC have also performed any variable assignments.
;     This will not work for adding lines to a program (ie no line number should be
;     present).
;
0F9D EB            IdeBasic:    ex de,hl
0F9E 21 68 5B                   ld hl,$5B68
0FA1 CB C6                      set 0,(hl)
0FA3 FD 36 00 FF                ld (iy),$FF
0FA7 CD AD 27                   call L27AD
0FAA CD 00 3F                   call L3F00
0FAD C6 0A                      add a,$0A
0FAF CD D7 27                   call L27D7
0FB2 21 68 5B                   ld hl,$5B68
0FB5 CB 86                      res 0,(hl)
0FB7 C9                         ret

;
; IDE_INTEGER_VAR: Get or set NextBASIC integer variable
;
0FB8 79            IdeIntVar:   ld a,c
0FB9 FE 1A                      cp $1A
0FBB 3E 15                      ld a,$15
0FBD D0                         ret nc
0FBE E5                         push hl
0FBF 05                         dec b
0FC0 20 17                      jr nz,L0FD9
0FC2 21 00 33                   ld hl,$3300
0FC5 41                         ld b,c
0FC6 0E 00                      ld c,$00
0FC8 CB 38                      srl b
0FCA CB 19                      rr c
0FCC 09                         add hl,bc
0FCD C1                         pop bc
0FCE 79                         ld a,c
0FCF FE 40                      cp $40
0FD1 3E 15                      ld a,$15
0FD3 D0                         ret nc
0FD4 C5                         push bc
0FD5 06 00                      ld b,$00
0FD7 18 05                      jr L0FDE
0FD9 06 00         L0FD9:       ld b,$00
0FDB 21 64 32                   ld hl,$3264
0FDE 09            L0FDE:       add hl,bc
0FDF 09                         add hl,bc
0FE0 C1                         pop bc
0FE1 10 06                      djnz L0FE9
0FE3 CF                         rst $08
0FE4 07                         .defb $07
0FE5 55 28                      .defw $2855
0FE7 37                         scf
0FE8 C9                         ret
0FE9 CF            L0FE9:       rst $08
0FEA 07                         .defb $07
0FEB 60 28                      .defw $3860
0FED 37                         scf
0FEE C9                         ret

;
; IDE_RTC: Query the real-time-clock module
;
0FEF CF            IdeRtc:      rst $08
0FF0 00                         .defb $00
0FF1 F2 00                      .defw $00F2
0FF3 3E 3A                      ld a,$3A
0FF5 3F                         ccf
0FF6 C9                         ret

;
; IDE_DRIVER: Access the driver API
;
0FF7 CF            IdeDriver:   rst $08
0FF8 00                         .defb $00
0FF9 F5 00                      .defw $00F5
0FFB 3F                         ccf
0FFC C9                         ret

;
; IDE_MODE: Query NextBASIC display mode info, or change mode
;
0FFD A7            IdeMode:     and a
0FFE 28 30                      jr z,L1030
1000 3D                         dec a
1001 20 0E                      jr nz,L1011
1003 78                         ld a,b
1004 FE 03                      cp $03
1006 30 09                      jr nc,L1011
1008 FE 01                      cp $01
100A 20 09                      jr nz,L1015
100C 79                         ld a,c
100D FE 04                      cp $04
100F 38 0D                      jr c,L101E
1011 3E 15         L1011:       ld a,$15
1013 A7                         and a
1014 C9                         ret
1015 A7            L1015:       and a
1016 28 04                      jr z,L101C
1018 0E 01                      ld c,$01
101A 18 0D                      jr L1029
101C 0E FF         L101C:       ld c,$FF
101E C5            L101E:       push bc
101F AF            L101F:       xor a
1020 01 3B 12                   ld bc,$123B
1023 ED 79                      out (c),a
1025 32 7B 5B      L1025:       ld ($5B7B),a
1028 C1                         pop bc
1029 78            L1029:       ld a,b
102A 51                         ld d,c
102B CD 00 3F                   call L3F00
102E F2 13 01                   jp p,L0113
1031 3B                         dec sp
1032 24                         inc h
1033 3E 57                      ld a,$57
1035 ED 79                      out (c),a
1037 04                         inc b
1038 ED 50                      in d,(c)
103A 3E 10                      ld a,$10
103C ED 79                      out (c),a
103E 3A 7F 5C                   ld a,(GMODE)
1041 E6 0F                      and $0F
1043 F5                         push af
1044 D5                         push de
1045 21 20 16                   ld hl,$1620
1048 ED 5B 8D 5C                ld de,($5C8D)
104C 01 00 08                   ld bc,$0800
104F 51                         ld d,c
1050 28 27                      jr z,L1079
1052 C6 F2                      add a,$F2
1054 DD 67                      ld xh,a
1056 DD 2E 00                   ld xl,$00
1059 DD 5E 1F                   ld e,(ix+$1F)
105C DD 56 20                   ld d,(ix+$20)
105F DD 4E 25                   ld c,(ix+$25)
1062 DD 46 0F                   ld b,(ix+$0F)
1065 DD 6E 1C                   ld l,(ix+$1C)
1068 DD 66 12                   ld h,(ix+$12)
106B DD CB 19 76                bit 6,(ix+$19)
106F 28 08                      jr z,L1079
1071 26 20                      ld h,$20
1073 FE F3                      cp $F3
1075 20 02                      jr nz,L1079
1077 26 10                      ld h,$10
1079 F1            L1079:       pop af
107A ED 92 57                   nextreg $57,a
107D F1                         pop af
107E 37                         scf
107F C9                         ret

;
; IDE_TOKENISER: Convert BASIC between plain text & tokenised forms
;
1080 78            IdeToknsr:   ld a,b
1081 FE 02                      cp $02
1083 30 8C                      jr nc,L1011
1085 F5                         push af
1086 33                         inc sp
1087 3A 3C 5C                   ld a,($5C3C)
108A F5                         push af
108B 33                         inc sp
108C FD CB 02 BE                res 7,(iy+$02)
1090 CD AD 27                   call L27AD
1093 CD 18 3E                   call L3E18
1096 A7                         and a
1097 14                         inc d
1098 CD D7 27                   call L27D7
109B E3                         ex (sp),hl
109C FD 75 02                   ld (iy+$02),l
109F D5                         push de
10A0 F5                         push af
10A1 30 1B                      jr nc,L10BE
10A3 25                         dec h
10A4 28 18                      jr z,L10BE
10A6 2A 59 5C                   ld hl,($5C59)
10A9 ED 5B 5D 5C                ld de,($5C5D)
10AD 37                         scf
10AE ED 52                      sbc hl,de
10B0 30 0C                      jr nc,L10BE
10B2 EB                         ex de,hl
10B3 09                         add hl,bc
10B4 22 5D 5C                   ld ($5C5D),hl
10B7 2A 55 5C                   ld hl,($5C55)
10BA 09                         add hl,bc
10BB 22 55 5C                   ld ($5C55),hl
10BE F1            L10BE:       pop af
10BF D1                         pop de
10C0 E1                         pop hl
10C1 FD 36 00 FF                ld (iy),$FF
10C5 C9                         ret
;
; IDE_BROWSER: File browser
;
10C6 E5            IdeBrowser:  push hl
10C7 F5                         push af
10C8 3A B8 D5                   ld a,($D5B8)
10CB 2A E9 D5                   ld hl,($D5E9)
10CE 67                         ld h,a
10CF F1                         pop af
10D0 E3                         ex (sp),hl
10D1 CD 00 3E                   call CallRom0              ; Call ROM0 routine $2C2E
10D4 2E 2C                      .defb $2C2E
10D6 E3                         ex (sp),hl
10D7 F5                         push af
10D8 7C                         ld a,h
10D9 32 B8 D5                   ld ($D5B8),a
10DC 7D                         ld a,l
10DD 32 E9 D5                   ld ($D5E9),a
10E0 F1                         pop af
10E1 E1                         pop hl
10E2 C9                         ret
;
; Gets the stream infomration address.
; IN: A=stream index
; OUT: BC=stream vector
;      HL=address in the stream vector table
;
10E3 C6 03         GetStrInfo:  add a,$03                  ; The stream table contains 3 extra entries
10E5 FE 13                      cp $13                     ; Is the stream number between $00 and $0F?
10E7 30 0F                      jr nc,InvStream            ; No, sign the error
10E9 07                         rlca                       ; A := A * 2
10EA 21 10 5C                   ld hl,STRMS                ; HL := Start of the stream vectors
10ED 4F                         ld c,a                     
10EE 06 00                      ld b,$00
10F0 09                         add hl,bc                  ; HL := Pointer for the stream entry
10F1 4E                         ld c,(hl)                  
10F2 23                         inc hl
10F3 46                         ld b,(hl)                  ; BC := Stream entry
10F4 2B                         dec hl                     ; HL := LSB of the stream entry
10F5 37                         scf                        ; Sign success
10F6 C9                         ret                        ; Done.

; Restore BC and sign an invalid stream
;
10F7 C1            GetStrBc:    pop bc                     ; Restore BC

; Sign an invalid stream
;
10F8 3E 17         InvStream:   ld a,$17                   ; A := $17, Invalid stream
10FA A7                         and a                      ; Fc := 0, Error
10FB C9                         ret                        ; Done
;
; Move to the next stream table entry
;
10FC 23            L10FC:       inc hl                     ; Skip the stream routine LSB
10FD 23                         inc hl                     ; Skip the stream routine MSB
;
; Search for a stream table entry
; IN: C=stream name character
;     HL=Stream table
; OUT(s): Fc=1, HL points to the stream table entry
; OUT(f): Fc=0
;
10FE 7E            SeaChnEntry: ld a,(hl)                  ; Load the currenct stream table character
10FF 23                         inc hl                     ; Move to stream routine LSB
1100 A7                         and a                      ; End of the table?
1101 C8                         ret z                      ; Return, if so (Fc=0)
1102 B9                         cp c                       ; Marches the serached character?
1103 20 F7                      jr nz,L10FC                ; No, move to the next entry
1105 37                         scf                        ; Sign success
1106 C9                         ret                        ; Done
;
; Get value with screen mode check
; IN: H=Max value with double character size
;     L=Max value with normal character size
;     DE=Remaining specification string
;     BC=Remaining string length
; OUT(s): Fc=1, HL=checked value
; OUT(f): Fc=0
;
1107 3A 7F 5C      GetChkNum:   ld a,(GMODE)
110A E6 0F                      and $0F
110C FE 01                      cp $01                     ; Double size mode?
110E 20 01                      jr nz,L1111                ; No, skip
1110 6C                         ld l,h                     ; H shows the last available column width
1111 26 00         L1111:       ld h,$00                   ; At this point, L is the maximum column number
1113 E5                         push hl                    ; Save the value
1114 CD 24 11                   call GetNumCm              ; Get the column value from the string
1117 30 09                      jr nc,L1122                ; Sign error
1119 EB                         ex de,hl                   ; DE := column value, HL := string pointer
111A E3                         ex (sp),hl                 ; Save the string pointer to the stack, HL := Max column width
111B A7                         and a                      ; Fc := 0
111C ED 52                      sbc hl,de                  ; Check if the column number exceeds the maximum
111E 3F                         ccf                        ; Complement carry to show the ok/error state
111F E1                         pop hl                     ; Get back the string pointer
1120 EB                         ex de,hl                   ; DE := string pointer, HL := checked column value
1121 C9                         ret                        ; Done
1122 E1            L1122:       pop hl                     ; Pop the top of the stack
1123 C9                         ret                        ; Return with error (Fc=0)

; Gets a integer value from the current string with a "," lead
; IN: DE=start of the string
;     BC=length of the string
; OUT(s): Fc=0, HL=integer value
; OUT(f): Fc=1
;
1124 78            GetNumCm:    ld a,b                     ; Length is zero?
1125 B1                         or c
1126 C8                         ret z                      ; Return, if so
1127 1A                         ld a,(de)                  ; Get the next character
1128 FE 2C                      cp ","                     ; Is it a ","?
112A 37                         scf
112B 3F                         ccf
112C C0                         ret nz                     ; Return with error, if not
112D 13                         inc de                     ; Move to the next character
112E 0B                         dec bc                     ; Decrease string lenght

; Gets an integer value from the current string
; IN: DE=start of the string
;     BC=length of the string
; OUT(s): Fc=0, HL=integer value
; OUT(f): Fc=1
;
112F 21 00 00      GetNumber:   ld hl,$0000                ; HL := 0 (initial value)
1132 78            `ParseCh:    ld a,b                     
1133 B1                         or c                       ; Length is zero?
1134 37                         scf                        ; Sign invalid value
1135 C8                         ret z                      ; If zero length, return
1136 1A                         ld a,(de)                  ; Get the next character
1137 FE 20                      cp " "                     ; Is it a space?
1139 28 13                      jr z,`NextCh
113B D6 30                      sub "0"                    ; Character >= "0"?
113D D8                         ret c                      ; Sign error, if not
113E FE 0A                      cp $0A                     ; Character <= "9"
1140 3F                         ccf                        
1141 D8                         ret c                      ; Sign error, if not
1142 D5                         push de                    ; Save DE

; HL := HL * 10
;
1143 29                         add hl,hl                  
1144 54                         ld d,h
1145 5D                         ld e,l
1146 29                         add hl,hl
1147 29                         add hl,hl
1148 19                         add hl,de

; HL := HL + value read (between 0 and 9)
;
1149 16 00                      ld d,$00
114B 5F                         ld e,a
114C 19                         add hl,de
114D D1                         pop de                     ; Restore DE
114E 13            `NextCh:     inc de                     ; Move to the next character
114F 0B                         dec bc                     ; Decrement remaining length
1150 18 E0                      jr `ParseCh

; IDE_STREAM_OPEN: Open stream to a channel
; IN: A=stream number
;     DE=address of string specifying channel to open
;     BC=length of string specifying channel to open
; OUT(s):  Fc=1
; OUT(f):  Fc=0
;     A=+3 BASIC error code: $17=invalid stream, $0e=invalid filename
;
1152 C5            IdeStrmOpen: push bc                    ; Save BC
1153 CD E3 10                   call GetStrInfo
1156 30 9F                      jr nc,GetStrBc             ; Return if failed
1158 78                         ld a,b
1159 B1                         or c                       ; Check if stream address is 0 (closed)
115A 28 16                      jr z,L1172                 ; If so, jump to open it
;
; The stream is already open
;
115C E5                         push hl                    ; Save the stream table LSB
115D 2A 4F 5C                   ld hl,(CHANS)              ; HL := current channel data address
1160 09                         add hl,bc                  ; 
1161 23                         inc hl
1162 23                         inc hl
1163 23                         inc hl
1164 7E                         ld a,(hl)
1165 E1                         pop hl
1166 FE 4B                      cp "K"                     ; "K" (keyboard)?
1168 28 08                      jr z,L1172                 ; If so, go ahead
116A FE 53                      cp "S"                     ; "S" (screen)?
116C 28 04                      jr z,L1172                 ; If so, go ahead
116E FE 50                      cp "P"                     ; "P" (printer)?
1170 20 85                      jr nz,GetStrBc             ; If not, sign invalid stream
1172 C1            L1172:       pop bc                     ; Get the length of the channel specification
1173 E5                         push hl                    ; Save the stream table LSB 
1174 21 B2 11                   ld hl,CHAN_STD             ; Pointer to the standard channel descriptors
1177 78                         ld a,b
1178 B1                         or c                       ; Filename length is zero?
1179 28 32                      jr z,`InvFName             ; If so, sign this issue
117B 0B                         dec bc                     ; Check if BC = 1
117C 78                         ld a,b
117D B1                         or c
117E 03                         inc bc                     ; At this point Fz = 1, if length is 1
117F 1A                         ld a,(de)                  ; First character of the filename
1180 28 11                      jr z,`ChnChar              ; Jump, if length is 1
1182 21 CA 11                   ld hl,CHAN_EXT             ; Pointer to the extended channel descriptors
1185 13                         inc de                     ; Next char address
1186 1A                         ld a,(de)                  ; Get next char
1187 1B                         dec de                     ; Back to the first char
1188 FE 3E                      cp ">"                    
118A 3E 49                      ld a,"I"                   ;
118C 20 05                      jr nz,`ChnChar             ; If the second char is not ">", it's an "I"
118E 1A                         ld a,(de)                  ; Get the first channel char again
118F 13                         inc de                     ; Point to the second character
1190 13                         inc de                     ; Point to the third character
1191 0B                         dec bc               
1192 0B                         dec bc                     ; Decrease the remaining length with 2
1193 E6 DF         `ChnChar:    and $DF                    ; Convert to uppercase character (if letter at all)
1195 C5                         push bc                    ; Save the filename length
1196 4F                         ld c,a                     ; C := stream name (1 character)
1197 CD FE 10                   call SeaChnEntry           ; Search for the stream entey
119A C1                         pop bc                     ; Restore the filename length
119B 30 10                      jr nc,`InvFName            ; Not found, sign the error
119D 7E                         ld a,(hl)                  
119E 23                         inc hl
119F 66                         ld h,(hl)
11A0 6F                         ld l,a                     ; HL := stream routine
;
; When calling the stream routine, registers are these:
; HL=stream routine address
; DE=Pointer to the stream parameter string
; BC=Lenght of the stream parameter string
;
11A1 CD AC 11                   call CallHl                ; Open the channel by calling the stream routine
11A4 E1                         pop hl                     ; Restore HL (points to the stream table LSB)
11A5 30 07                      jr nc,`InvFName2           ; Opening ended with invalid filename  
11A7 73                         ld (hl),e                  ; Store the LSB value
11A8 23                         inc hl                     
11A9 72                         ld (hl),d                  ; Store the MSB value
11AA 37                         scf                        ; Sign success
11AB C9                         ret                        ; Done

; Call the subroutine pointed by HL
;
11AC E9            CallHl:      jp (hl)

; Sign an Invalid filename error
;
11AD C1            `InvFName:   pop bc                     ; Get the top of the stack
11AE 3E 0E         `InvFName2:  ld a,$0E                   ; A := $0E, Invalid filename error
11B0 A7                         and a                      ; Fc := 0, sign error
11B1 C9                         ret                        ; Done
; 
; Standard channel descriptors
;
11B2 4B            CHAN_STD:    .defb "K"                  ; Keyboard
11B3 BC 11                      .defw $11BC
11B5 53                         .defb "S"                  ; Screen
11B6 C0 11                      .defw $11C0
11B8 50                         .defb "P"                  ; Printer
11B9 C4 11                      .defw $11C4                
11BB 00                         .defb $00                  ; End of the table
;
; Open the "K" (keyboard) channel
;
11BC 1E 01                      ld e,$01
11BE 18 06                      jr L11C6
;
; Open the "S" (screen) channel
;
11C0 1E 06                      ld e,$06
11C2 18 02                      jr L11C6
;
; Open the "P" (printer) channel
;
11C4 1E 10                      ld e,$10
11C6 16 00         L11C6:       ld d,$00
11C8 37                         scf
11C9 C9                         ret
;
; Extended channel descriptor
;
11CA 49            CHAN_EXT:    .defb "I"                  ; File input
11CB EE 11                      .defw $11EE
11CD 4F                         .defb "O"                  ; File output
11CE E7 11                      .defb $11E7
11D0 55                         .defb "U"                  ; File update (input/output)
11D1 E0 11                      .defw $11E0
11D3 4D                         .defb "M"                  ; Memory input/output
11D4 59 12                      .defw $1259
11D6 56                         .defb "V"                  ; Variable input/output
11D7 94 12                      .defw $1294
11D9 57                         .defb "W"                  ; Windows input/output
11DA 33 13                      .defw OpenChW
11DC 44                         .defb "D"                  ; Driver (direction depends on the driver)
11DD DA 12                      .defw $12DA
11DF 00                         .defb $00
;
; Open the "U" (File update) channel
;
11E0 21 02 02                   ld hl,$0202
11E3 3E 03                      ld a,$03
11E5 18 0C                      jr L11F3
;
; Open the "O" (File output) channel
;
11E7 21 04 02                   ld hl,$0204
11EA 3E 02                      ld a,$02
11EC 18 05                      jr L11F3
;
; Open the "I" (File input) channel
;
11EE 21 02 00                   ld hl,$0002
11F1 3E 05                      ld a,$05
11F3 F5            L11F3:       push af
11F4 E5                         push hl
11F5 21 31 DA                   ld hl,$DA31
11F8 78                         ld a,b
11F9 A7                         and a
11FA 20 03                      jr nz,L11FF
11FC 41                         ld b,c
11FD 18 02                      jr L1201
11FF 06 FF         L11FF:       ld b,$FF
1201 EB            L1201:       ex de,hl
1202 7E            L1202:       ld a,(hl)
1203 23                         inc hl
1204 CD 87 15                   call L1587
1207 12                         ld (de),a
1208 13                         inc de
1209 CD 70 15                   call L1570
120C 10 F4                      djnz L1202
120E CD 87 15                   call L1587
1211 3E FF                      ld a,$FF
1213 12                         ld (de),a
1214 CD 70 15                   call L1570
1217 CD 87 15                   call L1587
121A CD F4 05                   call L05F4
121D CD 70 15                   call L1570
1220 38 03                      jr c,L1225
1222 E1                         pop hl
1223 E1                         pop hl
1224 C9                         ret
1225 21 31 DA      L1225:       ld hl,$DA31
1228 D1                         pop de
1229 F1                         pop af
122A 4F                         ld c,a
122B C5                         push bc
122C CD 87 15                   call L1587
122F CD 06 01                   call L0106
1232 CD 70 15                   call L1570
1235 C1                         pop bc
1236 D0                         ret nc
1237 C5                         push bc
1238 21 4C 12                   ld hl,$124C
123B 01 0E 00                   ld bc,$000E
123E 11 0D 00                   ld de,$000D
1241 CD 8E 14                   call L148E
1244 01 0D 00                   ld bc,$000D
1247 09                         add hl,bc
1248 C1                         pop bc
1249 70                         ld (hl),b
124A 37                         scf
124B C9                         ret
124C 4D                         ld c,l
124D 5B                         ld e,e
124E 4D                         ld c,l
124F 5B                         ld e,e
1250 46                         ld b,(hl)
1251 30 05                      jr nc,L1258
1253 27                         daa
1254 05                         dec b
1255 08                         ex af,af'
1256 05                         dec b
1257 0E 00                      ld c,$00
;
; Open the "M" (memory) channel
;
1259 CD 2F 11                   call GetNumber
125C E5                         push hl
125D CD 24 11                   call GetNumCm
1260 D1                         pop de
1261 D0                         ret nc
1262 78                         ld a,b
1263 B1                         or c
1264 C0                         ret nz
1265 7C                         ld a,h
1266 B5                         or l
1267 C8                         ret z
1268 D5                         push de
1269 E5                         push hl
126A 21 87 12                   ld hl,$1287
126D 01 13 00                   ld bc,$0013
1270 11 0D 00                   ld de,$000D
1273 CD 8E 14                   call L148E
1276 01 0D 00                   ld bc,$000D
1279 09                         add hl,bc
127A C1                         pop bc
127B 71                         ld (hl),c
127C 23                         inc hl
127D 70                         ld (hl),b
127E 23                         inc hl
127F 23                         inc hl
1280 23                         inc hl
1281 C1                         pop bc
1282 71                         ld (hl),c
1283 23                         inc hl
1284 70                         ld (hl),b
1285 37                         scf
1286 C9                         ret
1287 4D                         ld c,l
1288 5B                         ld e,e
1289 4D                         ld c,l
128A 5B                         ld e,e
128B 4D                         ld c,l
128C 33                         inc sp
128D 00                         nop
128E 9A                         sbc a,d
128F 04                         inc b
1290 9F                         sbc a,a
1291 04                         inc b
1292 13                         inc de
1293 00                         nop
;
; Open the "V" (variable) channel
;
1294 78                         ld a,b
1295 B1                         or c
1296 C8                         ret z
1297 62                         ld h,d
1298 6B                         ld l,e
1299 09                         add hl,bc
129A 2B                         dec hl
129B 7E                         ld a,(hl)
129C FE 24                      cp $24
129E 37                         scf
129F 3F                         ccf
12A0 C0                         ret nz
12A1 ED 36 10 00                add bc,$0010
12A5 ED 53 5F 5C                ld ($5C5F),de
12A9 C5                         push bc
12AA 21 CF 12                   ld hl,$12CF
12AD 11 0B 00                   ld de,$000B
12B0 CD 8E 14                   call L148E
12B3 C1                         pop bc
12B4 D5                         push de
12B5 ED 34 0B 00                add hl,$000B
12B9 71                         ld (hl),c
12BA 23                         inc hl
12BB 70                         ld (hl),b
12BC 23                         inc hl
12BD 23                         inc hl
12BE 23                         inc hl
12BF EB                         ex de,hl
12C0 ED 36 F0 FF                add bc,$FFF0
12C4 2A 5F 5C                   ld hl,($5C5F)
12C7 ED B0                      ldir
12C9 3E 28                      ld a,$28
12CB 12                         ld (de),a
12CC D1                         pop de
12CD 37                         scf
12CE C9                         ret
12CF 4D                         ld c,l
12D0 5B                         ld e,e
12D1 4D                         ld c,l
12D2 5B                         ld e,e
12D3 56                         ld d,(hl)
12D4 F7                         rst $30
12D5 3E E0                      ld a,$E0
12D7 3E 03                      ld a,$03
12D9 3F                         ccf
;
; Open the "D" (driver) channel
;
12DA 78                         ld a,b
12DB B1                         or c
12DC C8                         ret z
12DD 1A                         ld a,(de)
12DE 13                         inc de
12DF 0B                         dec bc
12E0 F5                         push af
12E1 21 00 00                   ld hl,$0000
12E4 78                         ld a,b
12E5 B1                         or c
12E6 28 1C                      jr z,L1304
12E8 1A                         ld a,(de)
12E9 13                         inc de
12EA 0B                         dec bc
12EB FE 3E                      cp $3E
12ED 28 16                      jr z,L1305
12EF FE 2C                      cp $2C
12F1 28 02                      jr z,L12F5
12F3 F1            L12F3:       pop af
12F4 C9                         ret
12F5 CD 2F 11      L12F5:       call GetNumber
12F8 E5                         push hl
12F9 21 00 00                   ld hl,$0000
12FC CD 24 11                   call GetNumCm
12FF 78                         ld a,b
1300 B1                         or c
1301 C1                         pop bc
1302 20 EF                      jr nz,L12F3
1304 EB            L1304:       ex de,hl
1305 EB            L1305:       ex de,hl
1306 50                         ld d,b
1307 59                         ld e,c
1308 F1                         pop af
1309 4F                         ld c,a
130A 06 F9                      ld b,$F9
130C C5                         push bc
130D CD CF 01                   call L01CF
1310 D1                         pop de
1311 D0                         ret nc
1312 57                         ld d,a
1313 D5                         push de
1314 21 2A 13                   ld hl,$132A
1317 01 07 00                   ld bc,$0007
131A 11 05 00                   ld de,$0005
131D CD 8E 14                   call L148E
1320 01 05 00                   ld bc,$0005
1323 09                         add hl,bc
1324 C1                         pop bc
1325 71                         ld (hl),c
1326 23                         inc hl
1327 70                         ld (hl),b
1328 37                         scf
1329 C9                         ret
132A 4D                         ld c,l
132B 5B                         ld e,e
132C 4D                         ld c,l
132D 5B                         ld e,e
132E 44                         ld b,h

; Sign error when returning from OpenChW (Fc=0 at this point)
; Pop two items from the stack
;
132F E1            `ChWErr1:    pop hl

; Sign error when returning from OpenChW (Fc=0 at this point)
; Pop one item from the stack
;
1330 E1            `ChWErr2:    pop hl

; Sign error when returning from OpenChW (Fc=0 at this point)
;
1331 E1            `ChWErr:     pop hl
1332 C9                         ret
;
; Open the "W" (windows) channel
;
1333 CD 2F 11      OpenChW:     call GetNumber             ; Get the first number (line)
1336 7C                         ld a,h
1337 A7                         and a
1338 C0                         ret nz                     ; return, if >255
1339 26 18                      ld h,$18                   ; HL := 24 (max numer of lines)
133B 3A 7F 5C                   ld a,(GMODE)               ;
133E E6 0F                      and $0F                    ; Low nibble
1340 FE 01                      cp $01                     ; Is it 1 (Double height mode)?
1342 20 02                      jr nz,`ChW1                ; 12 lines
1344 26 0C                      ld h,$0C                   ; HL := 12 (max number of lines)
1346 7D            `ChW1:       ld a,l                     ; Get the line number
1347 BC                         cp h                       ; Excceds the maximum?
1348 D0                         ret nc                     ; Yes, return with error
1349 E5                         push hl                    ; Save the line number
134A 21 1F 0F                   ld hl,$0F1F                ; Column value limit: 15 for double width, 31 for normal mode
134D CD 07 11                   call GetChkNum             ; Get column number
1350 30 DF                      jr nc,`ChWErr              ; Exit, if error
1352 7D                         ld a,l                     ; A := column number
1353 E1                         pop hl                     ; Restore the line number
1354 67                         ld h,a                     ; H := column number, L is already line number
1355 E5                         push hl                    ; Save line and column
1356 3E 0C                      ld a,$0C                   ; A := Max height in double size mode
1358 95                         sub l                      
1359 67                         ld h,a                     ; H := remaining height in double size mode 
135A 3E 18                      ld a,$18                   ; A := Max height in normal size mode
135C 95                         sub l
135D 6F                         ld l,a                     ; L := remaining height in normal size mode 
135E CD 07 11                   call GetChkNum             ; Get height number
1361 30 CE                      jr nc,`ChWErr              ; Exit, if error
1363 E3                         ex (sp),hl                 ; Save height to the stack, HL := line and column
1364 E5                         push hl                    ; Save line and column to the stack
1365 3E 20                      ld a,$20                   ; A := Max width in normal size mode
1367 94                         sub h
1368 6F                         ld l,a                     ; L := remaining width in normal size mode
1369 3E 10                      ld a,$10                   ; A := Max width in double size mode
136B 94                         sub h                     
136C 67                         ld h,a                     ; H := remaining height in normal size mode
136D CD 07 11                   call GetChkNum             ; Get width number
1370 7D                         ld a,l                     ; A := width
1371 E1                         pop hl                     ; Restore line and column number
1372 E3                         ex (sp),hl                 ; Save line and column to the stack, L = height
1373 67                         ld h,a                     ; H := width
1374 E5                         push hl                    ; Save height and width to the stack
1375 CD 24 11                   call GetNumCm              ; Get optional character size (in HL)
1378 3E 08                      ld a,$08                   ; Default is 8 pixels
137A 30 15                      jr nc,`ChW2                ; If not specified, use the default value
137C 7C                         ld a,h                     
137D A7                         and a                      ; Character size > 255?
137E 20 B0                      jr nz,`ChWErr2             ; Sign error, if so
1380 7D                         ld a,l                    
1381 FE 03                      cp $03                     ; Character size < 3?
1383 3F                         ccf
1384 30 AA                      jr nc,`ChWErr2             ; Sign error, if so
1386 FE 09                      cp $09                     ; Character size > 8?
1388 30 A6                      jr nc,`ChWErr2             ; Sign error, if so
138A F5                         push af                    ; Save character size to the stack
138B CD 24 11                   call GetNumCm              ; Get optional character set address
138E 38 14                      jr c,`ChW5                 ; Jump, if character set address is specified
1390 F1                         pop af                     ; Restore character size from the stack
1391 F5            `ChW2:       push af                    ; Save character size to the stack
1392 21 75 14                   ld hl,$1475                ; Character map table addresses
1395 D6 03                      sub $03                    ; Is the character size 3?
1397 28 05                      jr z,`ChW4                 ; Yes, use the current entry (HL)
1399 23            `ChW3:       inc hl                     
139A 23                         inc hl                     ; Move to the next entry
139B 3D                         dec a                      ; Found the character size entry?
139C 20 FB                      jr nz,`ChW3                ; No, iterate
139E 7E            `ChW4:       ld a,(hl)                  ; A := Character set table LSB
139F 23                         inc hl
13A0 66                         ld h,(hl)                  
13A1 6F                         ld l,a                     ; HL=Character set table address 
13A2 18 06                      jr `ChW6                   ; Move formward
13A4 7C            `ChW5:       ld a,h                     ; 
13A5 E6 C0                      and $C0                    ; Bit 8-11 of the address should be zero (4K pages)
13A7 28 86                      jr z,`ChWErr1              ; If not, sign error
13A9 25                         dec h                      ; Decrement H the stored address points to the virtual 0 character code
13AA 78            `ChW6:       ld a,b
13AB B1                         or c                       ; Do we have left any character from the input?
13AC 20 81                      jr nz,`ChWErr1             ; If so, sigh error
13AE E5                         push hl                    ; Save the character address to the stack
13AF 21 81 14                   ld hl,$1481
13B2 01 30 00                   ld bc,$0030                ; 48 bytes
13B5 11 0D 00                   ld de,$000D                ; 13 bytes to copy
13B8 CD 8E 14                   call L148E                 ; Init channel data
13BB 01 0D 00                   ld bc,$000D
13BE 09                         add hl,bc
13BF C1                         pop bc
13C0 71                         ld (hl),c
13C1 23                         inc hl
13C2 70                         ld (hl),b
13C3 23                         inc hl
13C4 F1                         pop af
13C5 77                         ld (hl),a
13C6 23                         inc hl
13C7 47                         ld b,a
13C8 AF                         xor a
13C9 37            L13C9:       scf
13CA 1F                         rra
13CB 10 FC                      djnz L13C9
13CD 77                         ld (hl),a
13CE 23                         inc hl
13CF C1                         pop bc
13D0 70                         ld (hl),b
13D1 23                         inc hl
13D2 71                         ld (hl),c
13D3 23                         inc hl
13D4 EB                         ex de,hl
13D5 E3                         ex (sp),hl
13D6 EB                         ex de,hl
13D7 D5                         push de
13D8 72                         ld (hl),d
13D9 23                         inc hl
13DA 73                         ld (hl),e
13DB 23                         inc hl
13DC 7B                         ld a,e
13DD EB                         ex de,hl
13DE 09                         add hl,bc
13DF EB                         ex de,hl
13E0 15                         dec d
13E1 1D                         dec e
13E2 72                         ld (hl),d
13E3 23                         inc hl
13E4 73                         ld (hl),e
13E5 23                         inc hl
13E6 87                         add a,a
13E7 87                         add a,a
13E8 87                         add a,a
13E9 F5                         push af
13EA 77                         ld (hl),a
13EB 23                         inc hl
13EC 7B                         ld a,e
13ED 3C                         inc a
13EE 87                         add a,a
13EF 87                         add a,a
13F0 87                         add a,a
13F1 77                         ld (hl),a
13F2 23                         inc hl
13F3 AF                         xor a
13F4 77                         ld (hl),a
13F5 23                         inc hl
13F6 77                         ld (hl),a
13F7 23                         inc hl
13F8 77                         ld (hl),a
13F9 23                         inc hl
13FA 11 F3 FF                   ld de,$FFF3
13FD EB                         ex de,hl
13FE 19                         add hl,de
13FF 4E                         ld c,(hl)
1400 68                         ld l,b
1401 26 00                      ld h,$00
1403 44                         ld b,h
1404 29                         add hl,hl
1405 29                         add hl,hl
1406 29                         add hl,hl
1407 3A 7F 5C                   ld a,(GMODE)
140A E6 0F                      and $0F
140C FE 09                      cp $09
140E F5                         push af
140F 3E 00                      ld a,$00
1411 20 01                      jr nz,L1414
1413 29                         add hl,hl
1414 A7            L1414:       and a
1415 ED 42                      sbc hl,bc
1417 3C                         inc a
1418 30 FA                      jr nc,L1414
141A 3D                         dec a
141B EB                         ex de,hl
141C 77                         ld (hl),a
141D 23                         inc hl
141E F1                         pop af
141F 36 08                      ld (hl),$08
1421 20 02                      jr nz,L1425
1423 36 10                      ld (hl),$10
1425 23            L1425:       inc hl
1426 77                         ld (hl),a
1427 23                         inc hl
1428 0E 00                      ld c,$00
142A A7                         and a
142B 28 2D                      jr z,L145A
142D FE 05                      cp $05
142F 30 2E                      jr nc,L145F
1431 F5                         push af
1432 C6 F2                      add a,$F2
1434 57                         ld d,a
1435 1E 20                      ld e,$20
1437 ED 57                      ld a,i
1439 F5                         push af
143A F3                         di
143B E5                         push hl
143C 01 3B 24                   ld bc,$243B
143F 3E 57                      ld a,$57
1441 ED 79                      out (c),a
1443 04                         inc b
1444 ED 68                      in l,(c)
1446 3E 10                      ld a,$10
1448 ED 79                      out (c),a
144A 1A                         ld a,(de)
144B 67                         ld h,a
144C ED 69                      out (c),l
144E 4C                         ld c,h
144F E1                         pop hl
1450 F1                         pop af
1451 E2 55 14                   jp po,L1455
1454 FB                         ei
1455 F1            L1455:       pop af
1456 C6 5E                      add a,$5E
1458 18 0B                      jr L1465
145A 3A 8D 5C      L145A:       ld a,($5C8D)
145D 18 0A                      jr L1469
145F CB 3F         L145F:       srl a
1461 CB 3F                      srl a
1463 C6 60                      add a,$60
1465 5F            L1465:       ld e,a
1466 16 5B                      ld d,$5B
1468 1A                         ld a,(de)
1469 77            L1469:       ld (hl),a
146A 23                         inc hl
146B 71                         ld (hl),c
146C 23                         inc hl
146D F1                         pop af
146E D1                         pop de
146F 72                         ld (hl),d
1470 23                         inc hl
1471 77                         ld (hl),a
1472 D1                         pop de
1473 37                         scf
1474 C9                         ret
;
; This table contains the character map entries for a particular character size (3-8)
;
1475 00 EC         CharMaps:    .defw $EC00                ; Character size: 3
1477 00 EC                      .defw $EC00                ; Character size: 4
1479 00 EF                      .defw $EF00                ; Character size: 5
147B 00 EF                      .defw $EF00                ; Character size: 6
147D 00 F7                      .defw $F700                ; Character size: 7
147F 00 FB                      .defw $FB00                ; Character size: 8
;
;
;
1481 4D 5B 4D 5B                .defb $4D, $5B, $4D, $5B
1485 57 5B 27 E0                .defb $57, $5B, $27, $E0
1489 11 9A 2B 30                .defb $11, $9A, $2B, $30
148d 00                         .defb $00
;
;
;
148E E5            L148E:       push hl                    ; Save the registers used here
148F D5                         push de
1490 C5                         push bc
1491 2A 53 5C                   ld hl,(PROG)               ; HL := Start of the BASIC program
1494 2B                         dec hl                     ; Get back one byte
1495 E5                         push hl                    ; Save that address
1496 D9                         exx                        ; Save registers, $0576 will do an "exx" again
1497 CD 00 3E                   call CallRom0              ; Call ROM0 routine $0576
149A 76 05                      .defb $0576
149C D1                         pop de                     ; DE := destination address
149D E1                         pop hl                     ; HL := bytes count
149E C1                         pop bc                     ; BC := table length
149F A7                         and a                      ; Fc = 0
14A0 ED 42                      sbc hl,bc                  ; HL := number of bytes to fill with zero
14A2 E3                         ex (sp),hl                 ; Save the number of bytes, HL := table start address
14A3 D5                         push de                    ; Save the destination addresses
14A4 ED B0                      ldir                       ; Copy the bytes from the table
14A6 E1                         pop hl                     ; HL := destination address
14A7 C1                         pop bc                     ; BC := number of bytes to fill with zero
14A8 78            L14A8:       ld a,b
14A9 B1                         or c
14AA 28 06                      jr z,L14B2                 ; Exit loop if all bytes filled
14AC AF                         xor a                      ; A := 0
14AD 12                         ld (de),a                  ; Fill the byte with zero
14AE 13                         inc de                     ; Next byte
14AF 0B                         dec bc                     ; Decrement the counter
14B0 18 F6                      jr L14A8                   ; Next iteration
14B2 E5            L14B2:       push hl                    ; Save the channel address
14B3 ED 5B 4F 5C                ld de,(CHANS)              ; 
14B7 A7                         and a
14B8 ED 52                      sbc hl,de
14BA 23                         inc hl
14BB EB                         ex de,hl
14BC E1                         pop hl
14BD C9                         ret
;
; IDE_STREAM_CLOSE: Close stream and attached channel
;
14BE CD E3 10      L14BE:       call GetStrInfo
14C1 D0                         ret nc
14C2 78                         ld a,b
14C3 B1                         or c
14C4 37                         scf
14C5 C8                         ret z
14C6 E5                         push hl
14C7 2A 4F 5C                   ld hl,(CHANS)
14CA 09                         add hl,bc
14CB 23                         inc hl
14CC 23                         inc hl
14CD 23                         inc hl
14CE 4E                         ld c,(hl)
14CF EB                         ex de,hl
14D0 21 FB 14                   ld hl,$14FB
14D3 CD FE 10                   call SeaChnEntry
14D6 D2 F8 10                   jp nc,InvStream
14D9 7E                         ld a,(hl)
14DA 23                         inc hl
14DB 66                         ld h,(hl)
14DC 6F                         ld l,a
14DD CD AC 11                   call CallHl
14E0 E1                         pop hl
14E1 3E 12                      ld a,$12
14E3 D0                         ret nc
14E4 01 00 00                   ld bc,$0000
14E7 11 E2 A3                   ld de,$A3E2
14EA EB                         ex de,hl
14EB 19                         add hl,de
14EC 38 07                      jr c,L14F5
14EE 01 22 15                   ld bc,$1522
14F1 09                         add hl,bc
14F2 4E                         ld c,(hl)
14F3 23                         inc hl
14F4 46                         ld b,(hl)
14F5 EB            L14F5:       ex de,hl
14F6 71                         ld (hl),c
14F7 23                         inc hl
14F8 70                         ld (hl),b
14F9 37                         scf
14FA C9                         ret
14FB 4B                         ld c,e
14FC F9                         ld sp,hl
14FD 14                         inc d
14FE 53                         ld d,e
14FF F9                         ld sp,hl
1500 14                         inc d
1501 50                         ld d,b
1502 F9                         ld sp,hl
1503 14                         inc d
1504 46                         ld b,(hl)
1505 22 15 4D                   ld ($4D15),hl
1508 33                         inc sp
1509 15                         dec d
150A 56                         ld d,(hl)
150B 33                         inc sp
150C 15                         dec d
150D 57                         ld d,a
150E 33                         inc sp
150F 15                         dec d
1510 44                         ld b,h
1511 47                         ld b,a
1512 15                         dec d
1513 00                         nop
1514 01 00 06                   ld bc,$0600
1517 00                         nop
1518 0B                         dec bc
1519 00                         nop
151A 01 00 01                   ld bc,$0100
151D 00                         nop
151E 06 00                      ld b,$00
1520 10 00                      djnz L1522
1522 21 09 00      L1522:       ld hl,$0009
1525 19                         add hl,de
1526 46                         ld b,(hl)
1527 D5                         push de
1528 CD 87 15                   call L1587
152B CD 09 01                   call L0109
152E CD 70 15                   call L1570
1531 D1                         pop de
1532 D0                         ret nc
1533 21 07 00                   ld hl,$0007
1536 19                         add hl,de
1537 4E                         ld c,(hl)
1538 23                         inc hl
1539 46                         ld b,(hl)
153A 1B            L153A:       dec de
153B 1B                         dec de
153C 1B                         dec de
153D 1B                         dec de
153E EB                         ex de,hl
153F D9                         exx
1540 CD 00 3E                   call CallRom0              ; Call ROM0 routine $053E
1543 3E 05                      .defw $053E
1545 37                         scf
1546 C9                         ret
1547 EB                         ex de,hl
1548 E5                         push hl
1549 23                         inc hl
154A 4E                         ld c,(hl)
154B 23                         inc hl
154C 56                         ld d,(hl)
154D 06 FA                      ld b,$FA
154F CD CF 01                   call L01CF
1552 D1                         pop de
1553 3E 24                      ld a,$24
1555 D0                         ret nc
1556 01 07 00                   ld bc,$0007
1559 18 DF                      jr L153A
;
; IDE_STREAM_OUT: Write byte to current stream
;
155B D9            L155B:       exx
155C 11 00 00                   ld de,$0000
155F CD 00 3E      L155F:       call CallRom0              ; Call ROM0 routine $03E5
1562 E5 03                      .defw $03E5
1564 C9                         ret
;
; IDE_STREAM_IN: Get byte from current stream
;
1565 11 02 00      L1565:       ld de,$0002
1568 18 F5                      jr L155F
;
; IDE_STREAM_PTR: Get or set pointer information for current stream
;
156A D9            L156A:       exx
156B 11 04 00                   ld de,$0004
156E 18 EF                      jr L155F
1570 ED 91 8E 0A   L1570:       nextreg $8E,$0A
1574 08                         ex af,af'
1575 F1                         pop af
1576 22 52 5B                   ld (TMPHL),hl
1579 2A 6A 5B                   ld hl,($5B6A)
157C ED 73 6A 5B                ld ($5B6A),sp
1580 F9                         ld sp,hl
1581 2A 52 5B                   ld hl,(TMPHL)
1584 F5                         push af
1585 08                         ex af,af'
1586 C9                         ret
1587 08            L1587:       ex af,af'
1588 F1                         pop af
1589 22 52 5B                   ld (TMPHL),hl
158C 2A 6A 5B                   ld hl,($5B6A)
158F ED 73 6A 5B                ld ($5B6A),sp
1593 F9                         ld sp,hl
1594 2A 52 5B                   ld hl,(TMPHL)
1597 F5                         push af
1598 08                         ex af,af'
1599 ED 91 8E 7A                nextreg $8E,$7A
159D C9                         ret

;
; IDE_WINDOW_LINEIN: Input line from current window stream
;
159E DD 2A 51 5C   IdeWLineIn:  ld ix,($5C51)
15A2 CD 00 3E                   call CallRom0              ; Call ROM0 routine $27D5
15A5 D5 27                      .defw $27D5
15A7 C9                         ret
;
; IDE_WINDOW_STRING: Output string to current window stream
;
15A8 DD 2A 51 5C   IdeWStr:     ld ix,($5C51)
15AC CD 00 3E                   call CallRom0              ; Call ROM0 routine $272D
15AF 2D 27                      .defw $272D                
15B1 C9                         ret
15B2 DD 7E 00      L15B2:       ld a,(ix)
15B5 FE 02                      cp $02
15B7 37                         scf
15B8 C8                         ret z
15B9 3E 3D                      ld a,$3D
15BB A7                         and a
15BC C9                         ret
;
; IDE_SWAP_POS: Get current block number in swap partition
;
15BD CD B2 15      IdeSwPos:    call L15B2
15C0 D0                         ret nc
15C1 DD 4E 0C                   ld c,(ix+$0C)
15C4 DD 46 0D                   ld b,(ix+$0D)
15C7 37                         scf
15C8 C9                         ret
;
; IDE_SWAP_MOVE: Set current block number in swap partition
;
15C9 CD B2 15      IdeSwMove:   call L15B2
15CC D0                         ret nc
15CD E5                         push hl
15CE DD 6E 0E                   ld l,(ix+$0E)
15D1 DD 66 0F                   ld h,(ix+$0F)
15D4 A7                         and a
15D5 ED 42                      sbc hl,bc
15D7 E1                         pop hl
15D8 3F                         ccf
15D9 3E 15                      ld a,$15
15DB D0                         ret nc
15DC DD 71 0C      L15DC:       ld (ix+$0C),c
15DF DD 70 0D                   ld (ix+$0D),b
15E2 37                         scf
15E3 C9                         ret
15E4 CD B2 15      L15E4:       call L15B2
15E7 D0                         ret nc
15E8 78                         ld a,b
15E9 F5                         push af
15EA E5                         push hl
15EB DD 5E 0C                   ld e,(ix+$0C)
15EE DD 56 0D                   ld d,(ix+$0D)
15F1 DD 6E 0E                   ld l,(ix+$0E)
15F4 DD 66 0F                   ld h,(ix+$0F)
15F7 A7                         and a
15F8 ED 52                      sbc hl,de
15FA 30 03                      jr nc,L15FF
15FC 11 00 00                   ld de,$0000
15FF D5            L15FF:       push de
1600 DD 46 0B                   ld b,(ix+$0B)
1603 CD ED 07                   call L07ED
1606 4F                         ld c,a
1607 E1                         pop hl
1608 23                         inc hl
1609 DD 75 0C                   ld (ix+$0C),l
160C DD 74 0D                   ld (ix+$0D),h
160F E1                         pop hl
1610 F1                         pop af
1611 47                         ld b,a
1612 37                         scf
1613 C9                         ret
;
; IDE_SWAP_IN: Read block from swap partition
;
1614 CD E4 15      IdeSwIn:     call L15E4
1617 D0                         ret nc
1618 C5                         push bc
1619 E5                         push hl
161A CD 7E 18                   call L187E
161D 30 69                      jr nc,L1688
161F 3E 52                      ld a,$52
1621 CD C3 18                   call L18C3
1624 30 62                      jr nc,L1688
1626 CD 1D 19                   call L191D
1629 E1                         pop hl
162A 20 57                      jr nz,L1683
162C C1                         pop bc
162D DD 56 0B                   ld d,(ix+$0B)
1630 78                         ld a,b
1631 CD 4C 3E                   call L3E4C
1634 C5                         push bc
1635 0E EB                      ld c,$EB
1637 1E 20         L1637:       ld e,$20
1639 ED A2         L1639:       ini
163B ED A2                      ini
163D ED A2                      ini
163F ED A2                      ini
1641 ED A2                      ini
1643 ED A2                      ini
1645 ED A2                      ini
1647 ED A2                      ini
1649 ED A2                      ini
164B ED A2                      ini
164D ED A2                      ini
164F ED A2                      ini
1651 ED A2                      ini
1653 ED A2                      ini
1655 ED A2                      ini
1657 ED A2                      ini
1659 1D                         dec e
165A C2 39 16                   jp nz,L1639
165D ED 78                      in a,(c)
165F 00                         nop
1660 ED 78                      in a,(c)
1662 00                         nop
1663 ED 78         L1663:       in a,(c)
1665 FE FF                      cp $FF
1667 28 FA                      jr z,L1663
1669 FE FE                      cp $FE
166B 20 16                      jr nz,L1683
166D 15                         dec d
166E 20 C7                      jr nz,L1637
1670 37                         scf
1671 F5            L1671:       push af
1672 3E 07                      ld a,$07
1674 CD 4C 3E                   call L3E4C
1677 DD CB 10 46                bit 0,(ix+$10)
167B E5                         push hl
167C CD 5A 19                   call L195A
167F E1                         pop hl
1680 F1                         pop af
1681 C1                         pop bc
1682 C9                         ret
1683 3E 00         L1683:       ld a,$00
1685 A7                         and a
1686 18 E9                      jr L1671
1688 E1            L1688:       pop hl
1689 18 E6                      jr L1671
;
; IDE_SWAP_OUT: Write block to swap partition
;
168B CD E4 15      IdeSwOut:    call L15E4
168E D0                         ret nc
168F DD 7E 0B                   ld a,(ix+$0B)
1692 F5            L1692:       push af
1693 D5                         push de
1694 CD 79 18                   call IdeSWrt
1697 D1                         pop de
1698 30 0C                      jr nc,L16A6
169A 13                         inc de
169B 7A                         ld a,d
169C B3                         or e
169D 20 01                      jr nz,L16A0
169F 0C                         inc c
16A0 F1            L16A0:       pop af
16A1 3D                         dec a
16A2 20 EE                      jr nz,L1692
16A4 37                         scf
16A5 C9                         ret
16A6 D1            L16A6:       pop de
16A7 C9                         ret
;
; IDE_SWAP_EX: Exchange block with swap partition (deprecated)
;
16A8 3E 3A         IdeSwEx:     ld a,$3A
16AA A7                         and a
16AB C9                         ret
;
; IDE_SWAP_OPEN: Open a swap partition
;
16AC CB 7F         IdeSwOpen:   bit 7,a
16AE CB BF                      res 7,a
16B0 F5                         push af
16B1 A7                         and a
16B2 28 02                      jr z,L16B6
16B4 FE 21                      cp $21
16B6 3E 15         L16B6:       ld a,$15
16B8 30 EC                      jr nc,L16A6
16BA F1                         pop af
16BB F5                         push af
16BC 28 55                      jr z,L1713
16BE 3E 02                      ld a,$02
16C0 CD 26 22                   call L2226
16C3 30 E1                      jr nc,L16A6
16C5 F1                         pop af
16C6 F5            L16C6:       push af
16C7 CD D5 23                   call L23D5
16CA DD 4E 07                   ld c,(ix+$07)
16CD DD 46 08                   ld b,(ix+$08)
16D0 20 1A                      jr nz,L16EC
16D2 ED 34 20 00                add hl,$0020
16D6 7E                         ld a,(hl)
16D7 FE 02                      cp $02
16D9 37                         scf
16DA 3F                         ccf
16DB 3E 09                      ld a,$09
16DD 20 24                      jr nz,L1703
16DF 0B                         dec bc
16E0 DD E5                      push ix
16E2 D1                         pop de
16E3 ED 35 01 00                add de,$0001
16E7 C5                         push bc
16E8 CD 6A 23                   call L236A
16EB C1                         pop bc
16EC F1            L16EC:       pop af
16ED F5                         push af
16EE 5F                         ld e,a
16EF 16 00                      ld d,$00
16F1 CD C2 17                   call L17C2
16F4 F1                         pop af
16F5 3D                         dec a
16F6 BD                         cp l
16F7 28 01                      jr z,L16FA
16F9 0B                         dec bc
16FA 3C            L16FA:       inc a
16FB CD 63 17                   call L1763
16FE DD E5                      push ix
1700 CD 05 06                   call L0605
1703 F5            L1703:       push af
1704 D4 F4 04                   call nc,L04F4
1707 F1                         pop af
1708 E1                         pop hl
1709 D0                         ret nc
170A DD E5                      push ix
170C D1                         pop de
170D 01 13 00                   ld bc,$0013
1710 ED B0                      ldir
1712 C9                         ret
1713 C5            L1713:       push bc
1714 21 18 20                   ld hl,$2018
1717 3E 09                      ld a,$09
1719 CD 99 1C                   call L1C99
171C 30 55                      jr nc,L1773
171E 05                         dec b
171F 3E 40                      ld a,$40
1721 3F                         ccf
1722 28 4F                      jr z,L1773
1724 21 70 FB                   ld hl,$FB70
1727 C5            L1727:       push bc
1728 E5                         push hl
1729 7E                         ld a,(hl)
172A 32 37 D8                   ld ($D837),a
172D 3E 02                      ld a,$02
172F 01 27 D8                   ld bc,$D827
1732 CD 26 22                   call L2226
1735 30 17                      jr nc,L174E
1737 3E 01                      ld a,$01
1739 CD C6 16                   call L16C6
173C 30 10                      jr nc,L174E
173E E1                         pop hl
173F D1                         pop de
1740 C1                         pop bc
1741 F1                         pop af
1742 F5                         push af
1743 C5                         push bc
1744 D5                         push de
1745 E5                         push hl
1746 CD 9B 17                   call IdeSwRsz
1749 38 10                      jr c,L175B
174B CD 76 17                   call IdeSwCls
174E E1            L174E:       pop hl
174F 01 0D 00                   ld bc,$000D
1752 09                         add hl,bc
1753 C1                         pop bc
1754 10 D1                      djnz L1727
1756 3E 40                      ld a,$40
1758 A7                         and a
1759 18 18                      jr L1773
175B E1            L175B:       pop hl
175C C1                         pop bc
175D C1                         pop bc
175E F1                         pop af
175F 37                         scf
1760 C9                         ret
1761 C1            L1761:       pop bc
1762 F1                         pop af
1763 DD 71 0E      L1763:       ld (ix+$0E),c
1766 DD 70 0F                   ld (ix+$0F),b
1769 DD 77 0B                   ld (ix+$0B),a
176C 01 00 00                   ld bc,$0000
176F C3 DC 15                   jp L15DC
1772 C1            L1772:       pop bc
1773 C1            L1773:       pop bc
1774 C1                         pop bc
1775 C9                         ret
;
; IDE_SWAP_CLOSE: Close a swap partition
;
1776 CD B2 15      IdeSwCls:    call L15B2
1779 D0                         ret nc
177A CD F4 04                   call L04F4
177D DD 36 00 00                ld (ix),$00
1781 37                         scf
1782 C9                         ret
1783 21 00 00      L1783:       ld hl,$0000
1786 57                         ld d,a
1787 3D                         dec a
1788 5F                         ld e,a
1789 FE 20                      cp $20
178B 3E 15                      ld a,$15
178D 30 E3                      jr nc,L1772
178F 7C                         ld a,h
1790 09            L1790:       add hl,bc
1791 CE 00                      adc a,$00
1793 15                         dec d
1794 20 FA                      jr nz,L1790
1796 19                         add hl,de
1797 8A                         adc a,d
1798 EB                         ex de,hl
1799 6F                         ld l,a
179A C9                         ret
;
; IDE_SWAP_RESIZE: Change block size of swap partition
;
179B 57            IdeSwRsz:    ld d,a
179C CD B2 15                   call L15B2
179F D0                         ret nc
17A0 7A                         ld a,d
17A1 F5                         push af
17A2 C5                         push bc
17A3 CD 83 17                   call L1783
17A6 DD 7E 09                   ld a,(ix+$09)
17A9 BD                         cp l
17AA 38 10                      jr c,L17BC
17AC 20 B3                      jr nz,L1761
17AE DD 7E 08                   ld a,(ix+$08)
17B1 BA                         cp d
17B2 38 08                      jr c,L17BC
17B4 20 AB                      jr nz,L1761
17B6 DD 7E 07                   ld a,(ix+$07)
17B9 BB                         cp e
17BA 30 A5                      jr nc,L1761
17BC C1            L17BC:       pop bc
17BD C1                         pop bc
17BE 3E 15                      ld a,$15
17C0 A7                         and a
17C1 C9                         ret
17C2 78            L17C2:       ld a,b
17C3 21 00 00                   ld hl,$0000
17C6 06 10                      ld b,$10
17C8 A7                         and a
17C9 CB 11         L17C9:       rl c
17CB 17                         rla
17CC ED 6A                      adc hl,hl
17CE ED 52                      sbc hl,de
17D0 30 01                      jr nc,L17D3
17D2 19                         add hl,de
17D3 10 F4         L17D3:       djnz L17C9
17D5 CB 11                      rl c
17D7 17                         rla
17D8 2F                         cpl
17D9 47                         ld b,a
17DA 79                         ld a,c
17DB 2F                         cpl
17DC 4F                         ld c,a
17DD C9                         ret
17DE 79            L17DE:       ld a,c
17DF FE 02                      cp $02
17E1 3E 41                      ld a,$41
17E3 D0                         ret nc
17E4 0C                         inc c
17E5 0D                         dec c
17E6 21 00 F7                   ld hl,$F700
17E9 CD EB 18                   call L18EB
17EC 30 39                      jr nc,L1827
17EE A7                         and a
17EF 28 39                      jr z,L182A
17F1 2A 06 F7                   ld hl,($F706)
17F4 7D                         ld a,l
17F5 E6 03                      and $03
17F7 6C                         ld l,h
17F8 67                         ld h,a
17F9 3A 08 F7                   ld a,($F708)
17FC 07                         rlca
17FD ED 6A                      adc hl,hl
17FF 07                         rlca
1800 ED 6A                      adc hl,hl
1802 23                         inc hl
1803 ED 4B 09 F7                ld bc,($F709)
1807 79                         ld a,c
1808 E6 03                      and $03
180A CB 10                      rl b
180C 17                         rla
180D 4F                         ld c,a
180E 3A 05 F7                   ld a,($F705)
1811 E6 0F                      and $0F
1813 81                         add a,c
1814 D6 07                      sub $07
1816 11 00 00                   ld de,$0000
1819 29            L1819:       add hl,hl
181A EB                         ex de,hl
181B ED 6A                      adc hl,hl
181D EB                         ex de,hl
181E 3D                         dec a
181F 20 F8                      jr nz,L1819
1821 06 00                      ld b,$00
1823 0E 80         L1823:       ld c,$80
1825 37                         scf
1826 C9                         ret
1827 3E 00         L1827:       ld a,$00
1829 C9                         ret
182A 2A 08 F7      L182A:       ld hl,($F708)
182D 7C                         ld a,h
182E 65                         ld h,l
182F 6F                         ld l,a
1830 3A 07 F7                   ld a,($F707)
1833 E6 3F                      and $3F
1835 11 01 00                   ld de,$0001
1838 19                         add hl,de
1839 8A                         adc a,d
183A 29                         add hl,hl
183B 8F                         adc a,a
183C 29                         add hl,hl
183D 8F                         adc a,a
183E 5C                         ld e,h
183F 65                         ld h,l
1840 6A                         ld l,d
1841 57                         ld d,a
1842 06 02                      ld b,$02
1844 30 DD                      jr nc,L1823
1846 1B                         dec de
1847 2B                         dec hl
1848 18 D9                      jr L1823
;
; IDE_SECTOR_READ: Low-level sector read
;
184A 78            IdeSRead:    ld a,b
184B CB BF                      res 7,a
184D C5            L184D:       push bc
184E D5                         push de
184F E5                         push hl
1850 CD 7E 18                   call L187E
1853 DD E3                      ex (sp),ix
1855 30 16                      jr nc,L186D
1857 F5                         push af
1858 E6 7F                      and $7F
185A CD 4C 3E                   call L3E4C
185D F1                         pop af
185E F5                         push af
185F CB 7F                      bit 7,a
1861 28 06                      jr z,L1869
1863 F1                         pop af
1864 CD 61 19                   call L1961
1867 18 04                      jr L186D
1869 F1            L1869:       pop af
186A CD 2C 19                   call L192C
186D DD E1         L186D:       pop ix
186F F5                         push af
1870 3E 07                      ld a,$07
1872 CD 4C 3E                   call L3E4C
1875 F1                         pop af
1876 D1                         pop de
1877 C1                         pop bc
1878 C9                         ret
;
; IDE_SECTOR_WRITE: Low-level sector write
;
1879 78            IdeSWrt:     ld a,b
187A CB FF                      set 7,a
187C 18 CF                      jr L184D
187E 06 00         L187E:       ld b,$00
1880 DD 6E 07                   ld l,(ix+$07)
1883 DD 66 08                   ld h,(ix+$08)
1886 A7                         and a
1887 ED 52                      sbc hl,de
1889 DD 6E 09                   ld l,(ix+$09)
188C DD 66 0A                   ld h,(ix+$0A)
188F ED 42                      sbc hl,bc
1891 30 04                      jr nc,L1897
1893 3E 02                      ld a,$02
1895 A7                         and a
1896 C9                         ret
1897 DD 6E 01      L1897:       ld l,(ix+$01)
189A DD 66 02                   ld h,(ix+$02)
189D 19                         add hl,de
189E EB                         ex de,hl
189F DD 6E 03                   ld l,(ix+$03)
18A2 DD 66 04                   ld h,(ix+$04)
18A5 ED 4A                      adc hl,bc
18A7 DD CB 10 4E                bit 1,(ix+$10)
18AB 20 0A                      jr nz,L18B7
18AD 65                         ld h,l
18AE 6A                         ld l,d
18AF 53                         ld d,e
18B0 1E 00                      ld e,$00
18B2 EB                         ex de,hl
18B3 29                         add hl,hl
18B4 EB                         ex de,hl
18B5 ED 6A                      adc hl,hl
18B7 DD CB 10 46   L18B7:       bit 0,(ix+$10)
18BB 37                         scf
18BC C9                         ret
18BD 26 00         L18BD:       ld h,$00
18BF 2E 00         L18BF:       ld l,$00
18C1 55                         ld d,l
18C2 5D                         ld e,l
18C3 06 FF         L18C3:       ld b,$FF
18C5 4F            L18C5:       ld c,a
18C6 3E FE                      ld a,$FE
18C8 28 02                      jr z,L18CC
18CA 3E FD                      ld a,$FD
18CC D3 E7         L18CC:       out ($E7),a
18CE DB EB                      in a,($EB)
18D0 79                         ld a,c
18D1 0E EB                      ld c,$EB
18D3 ED 79                      out (c),a
18D5 7C                         ld a,h
18D6 ED 79                      out (c),a
18D8 7D                         ld a,l
18D9 ED 79                      out (c),a
18DB 7A                         ld a,d
18DC ED 79                      out (c),a
18DE 7B                         ld a,e
18DF ED 79                      out (c),a
18E1 78                         ld a,b
18E2 ED 79                      out (c),a
18E4 CD 0F 19                   call L190F
18E7 A7                         and a
18E8 C0                         ret nz
18E9 37                         scf
18EA C9                         ret
18EB E5            L18EB:       push hl
18EC F5                         push af
18ED CD C4 19                   call L19C4
18F0 F1                         pop af
18F1 D5                         push de
18F2 3E 49                      ld a,$49
18F4 CD BD 18                   call L18BD
18F7 D1                         pop de
18F8 E1                         pop hl
18F9 30 12                      jr nc,L190D
18FB CD 1D 19                   call L191D
18FE 28 03                      jr z,L1903
1900 A7                         and a
1901 18 0A                      jr L190D
1903 06 12         L1903:       ld b,$12
1905 0E EB                      ld c,$EB
1907 ED A2         L1907:       ini
1909 20 FC                      jr nz,L1907
190B 37                         scf
190C 7A                         ld a,d
190D 18 3F         L190D:       jr L194E
190F 01 32 00      L190F:       ld bc,$0032
1912 DB EB         L1912:       in a,($EB)
1914 FE FF                      cp $FF
1916 C0                         ret nz
1917 10 F9                      djnz L1912
1919 0D                         dec c
191A 20 F6                      jr nz,L1912
191C C9                         ret
191D 1E 0A         L191D:       ld e,$0A
191F CD 0F 19      L191F:       call L190F
1922 FE FE                      cp $FE
1924 28 05                      jr z,L192B
1926 38 03                      jr c,L192B
1928 1D                         dec e
1929 20 F4                      jr nz,L191F
192B C9            L192B:       ret
192C 3E 51         L192C:       ld a,$51
192E CD C3 18                   call L18C3
1931 3E 00         L1931:       ld a,$00
1933 30 19                      jr nc,L194E
1935 CD 1D 19                   call L191D
1938 28 03                      jr z,L193D
193A A7                         and a
193B 18 F4                      jr L1931
193D DD E5         L193D:       push ix
193F E1                         pop hl
1940 01 EB 00                   ld bc,$00EB
1943 ED B2                      inir
1945 ED B2                      inir
1947 DB EB                      in a,($EB)
1949 00                         nop
194A 00                         nop
194B DB EB                      in a,($EB)
194D 37                         scf
194E F5            L194E:       push af
194F DB EB                      in a,($EB)
1951 3E FF                      ld a,$FF
1953 D3 E7                      out ($E7),a
1955 00                         nop
1956 DB EB                      in a,($EB)
1958 F1                         pop af
1959 C9                         ret
195A 3E 4C         L195A:       ld a,$4C
195C CD BD 18                   call L18BD
195F 18 ED                      jr L194E
1961 F5            L1961:       push af
1962 3E 58                      ld a,$58
1964 CD C3 18                   call L18C3
1967 30 3F                      jr nc,L19A8
1969 3E FE                      ld a,$FE
196B D3 EB                      out ($EB),a
196D 01 EB 00                   ld bc,$00EB
1970 DD E5                      push ix
1972 E1                         pop hl
1973 ED B3                      otir
1975 ED B3                      otir
1977 3E FF                      ld a,$FF
1979 D3 EB                      out ($EB),a
197B 00                         nop
197C 00                         nop
197D D3 EB                      out ($EB),a
197F CD 0F 19                   call L190F
1982 E6 1F                      and $1F
1984 FE 05                      cp $05
1986 20 20                      jr nz,L19A8
1988 CD 0F 19      L1988:       call L190F
198B A7                         and a
198C 28 FA                      jr z,L1988
198E F1                         pop af
198F 3E 4D                      ld a,$4D
1991 E5                         push hl
1992 CD BD 18                   call L18BD
1995 E1                         pop hl
1996 30 11                      jr nc,L19A9
1998 DB EB                      in a,($EB)
199A A7                         and a
199B 37                         scf
199C 28 0E                      jr z,L19AC
199E E6 23                      and $23
19A0 3E 01                      ld a,$01
19A2 20 08                      jr nz,L19AC
19A4 3E 03                      ld a,$03
19A6 18 04                      jr L19AC
19A8 F1            L19A8:       pop af
19A9 3E 00         L19A9:       ld a,$00
19AB A7                         and a
19AC 18 A0         L19AC:       jr L194E
;
; IDE_INTERFACE: Initialise card interfaces
;
19AE 01 00 02      IdeIntf:     ld bc,$0200
19B1 3E 02         L19B1:       ld a,$02
19B3 90                         sub b
19B4 21 90 E0                   ld hl,$E090
19B7 C5                         push bc
19B8 CD EB 18                   call L18EB
19BB C1                         pop bc
19BC 38 01                      jr c,L19BF
19BE 0D                         dec c
19BF 0C            L19BF:       inc c
19C0 10 EF                      djnz L19B1
19C2 79                         ld a,c
19C3 C9                         ret
19C4 F5            L19C4:       push af
19C5 CD 5A 19                   call L195A
19C8 F1                         pop af
19C9 F5                         push af
19CA 3E 40                      ld a,$40
19CC 21 00 00                   ld hl,$0000
19CF 54                         ld d,h
19D0 5D                         ld e,l
19D1 06 95                      ld b,$95
19D3 CD C5 18                   call L18C5
19D6 3D                         dec a
19D7 20 4B                      jr nz,L1A24
19D9 01 78 00                   ld bc,$0078
19DC F1            L19DC:       pop af
19DD F5                         push af
19DE C5                         push bc
19DF 3E 48                      ld a,$48
19E1 21 00 00                   ld hl,$0000
19E4 11 AA 01                   ld de,$01AA
19E7 06 87                      ld b,$87
19E9 CD C5 18                   call L18C5
19EC C1                         pop bc
19ED CB 57                      bit 2,a
19EF 26 00                      ld h,$00
19F1 20 1A                      jr nz,L1A0D
19F3 3D                         dec a
19F4 20 30                      jr nz,L1A26
19F6 DB EB                      in a,($EB)
19F8 67                         ld h,a
19F9 00                         nop
19FA DB EB                      in a,($EB)
19FC 6F                         ld l,a
19FD 00                         nop
19FE DB EB                      in a,($EB)
1A00 E6 0F                      and $0F
1A02 57                         ld d,a
1A03 DB EB                      in a,($EB)
1A05 BB                         cp e
1A06 20 1E                      jr nz,L1A26
1A08 15                         dec d
1A09 20 3F                      jr nz,L1A4A
1A0B 26 40                      ld h,$40
1A0D F1            L1A0D:       pop af
1A0E F5                         push af
1A0F E5                         push hl
1A10 3E 77                      ld a,$77
1A12 CD BD 18                   call L18BD
1A15 E1                         pop hl
1A16 F1                         pop af
1A17 F5                         push af
1A18 E5                         push hl
1A19 3E 69                      ld a,$69
1A1B CD BF 18                   call L18BF
1A1E E1                         pop hl
1A1F 38 0C                      jr c,L1A2D
1A21 3D                         dec a
1A22 28 E9                      jr z,L1A0D
1A24 18 24         L1A24:       jr L1A4A
1A26 10 B4         L1A26:       djnz L19DC
1A28 0D                         dec c
1A29 20 B1                      jr nz,L19DC
1A2B 18 1D                      jr L1A4A
1A2D F1            L1A2D:       pop af
1A2E F5                         push af
1A2F CD 4F 1A                   call L1A4F
1A32 30 16                      jr nc,L1A4A
1A34 57                         ld d,a
1A35 28 10                      jr z,L1A47
1A37 F1                         pop af
1A38 F5                         push af
1A39 3E 50                      ld a,$50
1A3B 11 00 02                   ld de,$0200
1A3E 63                         ld h,e
1A3F 6B                         ld l,e
1A40 CD C3 18                   call L18C3
1A43 30 05                      jr nc,L1A4A
1A45 16 01                      ld d,$01
1A47 37            L1A47:       scf
1A48 18 01                      jr L1A4B
1A4A A7            L1A4A:       and a
1A4B C1            L1A4B:       pop bc
1A4C C3 4E 19                   jp L194E
1A4F 3E 7A         L1A4F:       ld a,$7A
1A51 CD BD 18                   call L18BD
1A54 D0                         ret nc
1A55 16 C0                      ld d,$C0
1A57 DB EB                      in a,($EB)
1A59 A2                         and d
1A5A 67                         ld h,a
1A5B DB EB                      in a,($EB)
1A5D 6F                         ld l,a
1A5E 00                         nop
1A5F DB EB                      in a,($EB)
1A61 5F                         ld e,a
1A62 00                         nop
1A63 DB EB                      in a,($EB)
1A65 7C                         ld a,h
1A66 92                         sub d
1A67 37                         scf
1A68 C9                         ret
1A69 CD 4F 1A      L1A69:       call L1A4F
1A6C D0                         ret nc
1A6D C8                         ret z
1A6E A7                         and a
1A6F C9                         ret
;
; IDE_VERSION: Get IDEDOS version number
;
1A70 11 09 01      IdeVer:      ld de,$0109
1A73 37                         scf
1A74 C9                         ret

;
; IDE_MOUNT: Unmount/remount SD cards
;
1A75 FE 01         IdeMount:    cp $01
1A77 28 72                      jr z,L1AEB
1A79 A7                         and a
1A7A 3E 15                      ld a,$15
1A7C C0                         ret nz
1A7D 06 10                      ld b,$10
1A7F C5            L1A7F:       push bc
1A80 05                         dec b
1A81 CD 09 01                   call L0109
1A84 C1                         pop bc
1A85 CD E1 1A                   call L1AE1
1A88 10 F5                      djnz L1A7F
1A8A DD 21 6C E4                ld ix,$E46C
1A8E 06 14                      ld b,$14
1A90 C5            L1A90:       push bc
1A91 DD E5                      push ix
1A93 CD DC 00                   call L00DC
1A96 DD E1                      pop ix
1A98 01 13 00                   ld bc,$0013
1A9B DD 09                      add ix,bc
1A9D C1                         pop bc
1A9E 10 F0                      djnz L1A90
1AA0 06 41                      ld b,$41
1AA2 C5            L1AA2:       push bc
1AA3 68                         ld l,b
1AA4 01 00 00                   ld bc,$0000
1AA7 CD F7 00                   call L00F7
1AAA C1                         pop bc
1AAB CD E1 1A                   call L1AE1
1AAE 28 0C                      jr z,L1ABC
1AB0 3C                         inc a
1AB1 20 09                      jr nz,L1ABC
1AB3 C5                         push bc
1AB4 68                         ld l,b
1AB5 CD F4 00                   call L00F4
1AB8 C1                         pop bc
1AB9 CD E1 1A                   call L1AE1
1ABC 04            L1ABC:       inc b
1ABD 78                         ld a,b
1ABE FE 51                      cp $51
1AC0 20 E0                      jr nz,L1AA2
1AC2 06 41                      ld b,$41
1AC4 C5            L1AC4:       push bc
1AC5 68                         ld l,b
1AC6 CD F4 00                   call L00F4
1AC9 C1                         pop bc
1ACA CD E1 1A                   call L1AE1
1ACD 04                         inc b
1ACE 78                         ld a,b
1ACF FE 51                      cp $51
1AD1 20 F1                      jr nz,L1AC4
1AD3 06 01                      ld b,$01
1AD5 CF                         rst $08
1AD6 00                         .defb $00
1AD7 8A 31                      .defw $318A
1AD9 06 01                      ld b,$001
1ADB CF                         rst $08
1ADC 00                         .defb $00
1ADD 67 31                      .defw $3167
;
; IDE_INIT: Initialise IDEDOS
;
1ADF 37            IdeInit:     scf
1AE0 C9                         ret
1AE1 D8            L1AE1:       ret c
1AE2 FE 1D                      cp $1D
1AE4 C8                         ret z
1AE5 FE 38                      cp $38
1AE7 C8                         ret z
1AE8 A7                         and a
1AE9 E1                         pop hl
1AEA C9                         ret
1AEB 21 8A 5B      L1AEB:       ld hl,$5B8A
1AEE 11 33 DA                   ld de,$DA33
1AF1 01 75 00                   ld bc,$0075
1AF4 ED B0                      ldir
1AF6 ED 73 31 DA                ld ($DA31),sp
1AFA 31 FF 5B                   ld sp,$5BFF
1AFD 57                         ld d,a
1AFE 21 07 20                   ld hl,$2007
1B01 CF                         rst $08
1B02 00                         .defb $00
1B03 1D 00                      .defw $001D
1B05 5F                         ld e,a
1B06 23                         inc hl
1B07 CF                         rst $08
1B08 00                         .defb $00
1B09 1D 00                      .defw $001D
1B0B 2F                         cpl
1B0C BB                         cp e
1B0D 28 02                      jr z,L1B11
1B0F 3E 02                      ld a,$02
1B11 F5            L1B11:       push af
1B12 D5                         push de
1B13 AF                         xor a
1B14 21 A0 DB                   ld hl,$DBA0
1B17 11 A1 DB                   ld de,$DBA1
1B1A 01 F9 07                   ld bc,$07F9
1B1D 77                         ld (hl),a
1B1E ED B0                      ldir
1B20 21 F7 E3                   ld hl,$E3F7
1B23 11 F8 E3                   ld de,$E3F8
1B26 01 19 11                   ld bc,$1119
1B29 77                         ld (hl),a
1B2A ED B0                      ldir
1B2C 3D                         dec a
1B2D 0E 2C                      ld c,$2C
1B2F 21 00 E3                   ld hl,$E300
1B32 11 01 E3                   ld de,$E301
1B35 C5                         push bc
1B36 77                         ld (hl),a
1B37 ED B0                      ldir
1B39 C1                         pop bc
1B3A 21 6D E3                   ld hl,$E36D
1B3D 11 6E E3                   ld de,$E36E
1B40 77                         ld (hl),a
1B41 ED B0                      ldir
1B43 0E 1F                      ld c,$1F
1B45 21 CA E3                   ld hl,$E3CA
1B48 11 CB E3                   ld de,$E3CB
1B4B 77                         ld (hl),a
1B4C ED B0                      ldir
1B4E CD A3 00                   call L00A3
1B51 21 00 23                   ld hl,$2300
1B54 11 01 23                   ld de,$2301
1B57 01 2C 0E                   ld bc,$0E2C
1B5A CF                         rst $08
1B5B 00                         .defb $00
1B5C DB 04                      .defw $04DB
1B5E 21 00 23                   ld hl,$2300
1B61 11 01 23                   ld de,$2301
1B64 01 2F 00                   ld bc,$002F
1B67 3D                         dec a
1B68 CF                         rst $08
1B69 00                         .defb $00
1B6A DC 04                      .defw $04DC
1B6C 21 F0 37                   ld hl,$37F0
1B6F 11 F1 37                   ld de,$37F1
1B72 01 0C 08                   ld bc,$080C
1B75 CF                         rst $08
1B76 0D                         .defb $0D
1B77 DB 04                      .defw $04DB
1B79 21 00 23                   ld hl,$2300
1B7C 11 00 00                   ld de,$0000
1B7F CF                         rst $08
1B80 00                         .defb $00
1B81 66 01                      .defw $0166
1B83 21 43 00                   ld hl,$0043
1B86 CD EA 1B                   call L1BEA
1B89 F1                         pop af
1B8A E5                         push hl
1B8B F5                         push af
1B8C A7                         and a
1B8D CC F3 1C                   call z,L1CF3
1B90 21 02 23                   ld hl,$2302
1B93 11 4D 02                   ld de,$024D
1B96 CF                         rst $08
1B97 00                         .defb $00
1B98 66 01                      .defw $0166
1B9A F1                         pop af
1b9B CD C0 1C                   call L1CC0
1B9E 21 4D 04                   ld hl,$044D
1BA1 06 01                      ld b,$01
1BA3 CD EC 1B                   call L1BEC
1BA6 E1                         pop hl
1BA7 26 05                      ld h,$05
1BA9 CD EA 1B                   call L1BEA
1BAC 21 03 20                   ld hl,$2003
1BAF 3E 09                      ld a,$09
1BB1 CD 99 1C                   call L1C99
1BB4 30 11                      jr nc,L1BC7
1BB6 05                         dec b
1BB7 28 0E                      jr z,L1BC7
1BB9 C5                         push bc
1BBA 11 0C 20                   ld de,$200C
1BBD CD 13 1C                   call L1C13
1BC0 C1                         pop bc
1BC1 11 0F 20                   ld de,$200F
1BC4 CD 13 1C                   call L1C13
1BC7 F1            L1BC7:       pop af
1BC8 21 33 DA                   ld hl,$DA33
1BCB 11 8A 5B                   ld de,$5B8A
1BCE 01 75 00                   ld bc,$0075
1BD1 ED B0                      ldir
1BD3 ED 7B 31 DA                ld sp,($DA31)
1BD7 C6 41                      add a,$41
1BD9 CD 2D 01                   call L012D
1BDC 38 05                      jr c,L1BE3
1BDE 3E 43                      ld a,$43
1BE0 CD 2D 01                   call L012D
1BE3 32 79 5B      L1BE3:       ld ($5B79),a
1BE6 32 7A 5B                   ld ($5B7A),a
1BE9 C9                         ret
1BEA 06 02         L1BEA:       ld b,$02
1BEC C5            L1BEC:       push bc
1BED 01 00 00                   ld bc,$0000
1BF0 C5            L1BF0:       push bc
1BF1 E5                         push hl
1BF2 7C                         ld a,h
1BF3 CD F1 00                   call L00F1
1BF6 E1                         pop hl
1BF7 C1                         pop bc
1BF8 30 0B                      jr nc,L1C05
1BFA C5                         push bc
1BFB E5                         push hl
1BFC CD 6B 1C                   call L1C6B
1BFF E1                         pop hl
1C00 C1                         pop bc
1C01 2C            L1C01:       inc l
1C02 03            L1C02:       inc bc
1C03 18 EB                      jr L1BF0
1C05 FE 09         L1C05:       cp $09
1C07 28 F9                      jr z,L1C02
1C09 0B                         dec bc
1C0A FE 3E                      cp $3E
1C0C 28 F3                      jr z,L1C01
1C0E C1                         pop bc
1C0F 24                         inc h
1C10 10 DA                      djnz L1BEC
1C12 C9                         ret
1C13 21 6C FB      L1C13:       ld hl,$FB6C
1C16 C5            L1C16:       push bc
1C17 D5                         push de
1C18 E5                         push hl
1C19 CD B4 1C                   call L1CB4
1C1C 20 43                      jr nz,L1C61
1C1E 23                         inc hl
1C1F 7E                         ld a,(hl)
1C20 23                         inc hl
1C21 CB BF                      res 7,a
1C23 FE 41                      cp $41
1C25 38 3A                      jr c,L1C61
1C27 FE 51                      cp $51
1C29 30 36                      jr nc,L1C61
1C2B 4F                         ld c,a
1C2C 23                         inc hl
1C2D 23                         inc hl
1C2E 23                         inc hl
1C2F 11 12 20                   ld de,$2012
1C32 E5                         push hl
1C33 CD B4 1C                   call L1CB4
1C36 E1                         pop hl
1C37 28 08                      jr z,L1C41
1C39 11 15 20                   ld de,$2015
1C3C CD B4 1C                   call L1CB4
1C3F 20 20                      jr nz,L1C61
1C41 E1            L1C41:       pop hl
1C42 E5                         push hl
1C43 11 33 D8                   ld de,$D833
1C46 06 0B                      ld b,$0B
1C48 7E            L1C48:       ld a,(hl)
1C49 23                         inc hl
1C4A CB BF                      res 7,a
1C4C 12                         ld (de),a
1C4D 13                         inc de
1C4E 10 F8                      djnz L1C48
1C50 3E FF                      ld a,$FF
1C52 12                         ld (de),a
1C53 69                         ld l,c
1C54 3E FF                      ld a,$FF
1C56 01 27 D8                   ld bc,$D827
1C59 E5                         push hl
1C5A CD F1 00                   call L00F1
1C5D E1                         pop hl
1C5E DC 6B 1C                   call c,L1C6B
1C61 E1            L1C61:       pop hl
1C62 D1                         pop de
1C63 ED 34 0D 00                add hl,$000D
1C67 C1                         pop bc
1C68 10 AC                      djnz L1C16
1C6A C9                         ret
1C6B E5            L1C6B:       push hl
1C6C 7D                         ld a,l
1C6D C6 DF                      add a,$DF
1C6F 01 00 01                   ld bc,$0100
1C72 67                         ld h,a
1C73 69                         ld l,c
1C74 11 90 E0                   ld de,$E090
1C77 D5                         push de
1C78 3E 09                      ld a,$09
1C7A CF                         rst $08
1C7B 00                         .defb $00
1C7C 69 07                      .defw $0769
1C7E E1                         pop hl
1C7F 7E                         ld a,(hl)
1C80 2F                         cpl
1C81 23                         inc hl
1C82 BE                         cp (hl)
1C83 23                         inc hl
1C84 37                         scf
1C85 3F                         ccf
1C86 E5                         push hl
1C87 CC 0A 05                   call z,L050A
1C8A E1                         pop hl
1C8B C1                         pop bc
1C8C D8                         ret c
1C8D 79                         ld a,c
1C8E D6 41                      sub $41
1C90 36 2F                      ld (hl),$2F
1C92 23                         inc hl
1C93 36 FF                      ld (hl),$FF
1C95 2B                         dec hl
1C96 C3 0A 05                   jp L050A
1C99 CD 2C 1E      L1C99:       call L1E2C
1C9C E5                         push hl
1C9D 21 5F FB                   ld hl,$FB5F
1CA0 11 60 FB                   ld de,$FB60
1CA3 01 0C 00                   ld bc,$000C
1CA6 70                         ld (hl),b
1CA7 ED B0                      ldir
1CA9 E1                         pop hl
1CAA 11 5F FB                   ld de,$FB5F
1CAD 01 21 40                   ld bc,$4021
1CB0 AF                         xor a
1CB1 C3 1E 01                   jp L011E
1CB4 06 03         L1CB4:       ld b,$03
1CB6 CB BE         L1CB6:       res 7,(hl)
1CB8 1A                         ld a,(de)
1CB9 BE                         cp (hl)
1CBA C0                         ret nz
1CBB 13                         inc de
1CBC 23                         inc hl
1CBD 10 F7                      djnz L1CB6
1CBF C9                         ret
1CC0 F5                         push af
1CC1 CD 3C 01                   call L013C
1CC4 11 80 00                   ld de,$0080
1CC7 F1                         pop af
1CC8 A7                         and a
1CC9 ED 52                      sbc hl,de
1CCB 28 01                      jr z,L1CCE
1CCD AF                         xor a
1CCE 21 80 00      L1CCE:       ld hl,$0080
1CD1 11 00 00                   ld de,$0000
1CD4 D5                         push de
1CD5 CD A2 24                   call L24A2
1CD8 D1                         pop de
1CD9 CD EF 05                   call L05EF
1CDC 21 58 E4                   ld hl,$E458
1CDF 11 6C E4                   ld de,$E46C
1CE2 3E 05                      ld a,$05
1CE4 CD 07 1F                   call L1F07
1CE7 21 62 E4                   ld hl,$E462
1CEA 11 7F E4                   ld de,$E47F
1CED 3E 06                      ld a,$06
1CEF CD 07 1F                   call L1F07
1CF2 C9                         ret
1CF3 21 DC 1F      L1CF3:       ld hl,$1FDC
1CF6 3E 0B                      ld a,$0B
1CF8 CD 23 1E                   call L1E23
1CFB E5                         push hl
1CFC 3E 10                      ld a,$10
1CFE CD 37 0E                   call L0E37
1D01 E1                         pop hl
1D02 D2 E7 1D                   jp nc,L1DE7
1D05 CD 18 3E                   call L3E18
1D08 03                         inc bc
1D09 00                         nop
1D0A 21 27 D8                   ld hl,$D827
1D0D CD 7D 1E                   call L1E7D
1D10 21 21 20                   ld hl,$2021
1D13 3E 0C                      ld a,$0C
1D15 11 C2 0E                   ld de,$0EC2
1D18 CD D8 1D                   call L1DD8
1D1B 21 02 C0                   ld hl,$C002
1D1E 11 40 31                   ld de,$3140
1D21 01 C0 0E                   ld bc,$0EC0
1D24 3E 00                      ld a,$00
1D26 CD CA 1D                   call L1DCA
1D29 21 00 C0                   ld hl,$C000
1D2C 11 00 07                   ld de,$0700
1D2F E5                         push hl
1D30 D5                         push de
1D31 CD 07 1E                   call L1E07
1D34 C1                         pop bc
1D35 E1                         pop hl
1D36 E5                         push hl
1D37 11 00 20                   ld de,$2000
1D3A CD C8 1D                   call L1DC8
1D3D E1                         pop hl
1D3E 11 80 05                   ld de,$0580
1D41 E5                         push hl
1D42 D5                         push de
1D43 CD 07 1E                   call L1E07
1D46 C1                         pop bc
1D47 E1                         pop hl
1D48 E5                         push hl
1D49 11 80 31                   ld de,$3180
1D4C CD C8 1D                   call L1DC8
1D4F E1                         pop hl
1D50 11 00 14                   ld de,$1400
1D53 E5                         push hl
1D54 D5                         push de
1D55 CD 07 1E                   call L1E07
1D58 C1                         pop bc
1D59 E1                         pop hl
1D5A E5                         push hl
1D5B 11 00 23                   ld de,$2300
1D5E 3E 0C                      ld a,$0C
1D60 CD CA 1D                   call L1DCA
1D63 E1                         pop hl
1D64 11 F8 0B                   ld de,$0BF8
1D67 E5                         push hl
1D68 D5                         push de
1D69 CD 07 1E                   call L1E07
1D6C C1                         pop bc
1D6D E1                         pop hl
1D6E E5                         push hl
1D6F C5                         push bc
1D70 11 00 20                   ld de,$2000
1D73 3E 0D                      ld a,$0D
1D75 CD CA 1D                   call L1DCA
1D78 D1                         pop de
1D79 E1                         pop hl
1D7A E5                         push hl
1D7B D5                         push de
1D7C CD 07 1E                   call L1E07
1D7F C1                         pop bc
1D80 E1                         pop hl
1D81 E5                         push hl
1D82 11 F8 2B                   ld de,$2BF8
1D85 3E 0D                      ld a,$0D
1D87 CD CA 1D                   call L1DCA
1D8A E1                         pop hl
1D8B 11 00 15                   ld de,$1500
1D8E E5                         push hl
1D8F D5                         push de
1D90 CD 07 1E                   call L1E07
1D93 C1                         pop bc
1D94 E1                         pop hl
1D95 E5                         push hl
1D96 11 00 20                   ld de,$2000
1D99 3E 0A                      ld a,$0A
1D9B CD CA 1D                   call L1DCA
1D9E E1                         pop hl
1D9F 11 40 11                   ld de,$1140
1DA2 D5                         push de
1DA3 CD 07 1E                   call L1E07
1DA6 CD CF 1D                   call L1DCF
1DA9 C1                         pop bc
1DAA 11 00 20                   ld de,$2000
1DAD 3E 07                      ld a,$07
1DAF CD CA 1D                   call L1DCA
1DB2 21 2D 20                   ld hl,$202D
1DB5 3E 07                      ld a,$07
1DB7 06 C9                      ld b,$C9
1DB9 11 00 02                   ld de,$0200
1DBC CD F2 1D                   call L1DF2
1DBF CD CF 1D                   call L1DCF
1DC2 11 00 27                   ld de,$2700
1DC5 01 00 02                   ld bc,$0200
1DC8 3E 01         L1DC8:       ld a,$01
1DCA CF            L1DCA:       rst $08
1DCB 00                         .defb $00
1DCC 03 07                      .defw $0703
1DCE C9                         ret
;
;
;
1DCF 06 00         L1DCF:       ld b,$00
1DD1 CD 09 01                   call L0109
1DD4 21 00 C0                   ld hl,$C000
1DD7 C9                         ret
1DD8 06 00         L1DD8:       ld b,$00
1DDA CD F2 1D                   call L1DF2
1DDD ED 5B 00 C0                ld de,($C000)
1DE1 21 27 D8                   ld hl,$D827
1DE4 DA 7D 1E                   jp c,L1E7D
1DE7 E5            L1DE7:       push hl
1DE8 21 AA 20                   ld hl,$20AA
1DEB CD CD 1E                   call L1ECD
1DEE E1                         pop hl
1DEF C3 B0 1E                   jp L1EB0
1DF2 C5            L1DF2:       push bc
1DF3 D5                         push de
1DF4 CD 2C 1E                   call L1E2C
1DF7 0C                         inc c
1DF8 11 02 00                   ld de,$0002
1DFB CD 06 01                   call L0106
1DFE D1                         pop de
1DFF 21 01 C0                   ld hl,$C001
1E02 C1                         pop bc
1E03 70                         ld (hl),b
1E04 2B                         dec hl
1E05 70                         ld (hl),b
1E06 D0                         ret nc
1E07 01 07 00      L1E07:       ld bc,$0007
1E0A CD 12 01                   call L0112
1E0D D8                         ret c
1E0E FE 19                      cp $19
1E10 37                         scf
1E11 C8                         ret z
1E12 A7                         and a
1E13 C9                         ret
1E14 21 BD 1F      L1E14:       ld hl,$1FBD
1E17 ED 31                      add hl,a
1E19 CB 47                      bit 0,a
1E1B 3E 08                      ld a,$08
1E1D 28 04                      jr z,L1E23
1E1F 3C                         inc a
1E20 21 E7 1F                   ld hl,$1FE7
1E23 E5            L1E23:       push hl
1E24 21 6C 20                   ld hl,$206C
1E27 01 11 00                   ld bc,$0011
1E2A 18 07                      jr L1E33
1E2C E5            L1E2C:       push hl
1E2D 21 52 20                   ld hl,$2052
1E30 01 0C 00                   ld bc,$000C
1E33 11 27 D8      L1E33:       ld de,$D827
1E36 ED B0                      ldir
1E38 E1                         pop hl
1E39 4F                         ld c,a
1E3A ED B0                      ldir
1E3C 3E FF                      ld a,$FF
1E3E 12                         ld (de),a
1E3F 21 27 D8                   ld hl,$D827
1E42 C9                         ret
;
; Check ZX Spectrum Next Core Version
; Verifies that the core version is compatible (3.01.10 or higher).
; If incompatible, displays error message and halts with red border.
; Called from ROM0 initialization at $032A.
; Entry: None
; Exit: Returns if core >= 3.01.10, otherwise halts with error
;
1E43 AF            ChkCoreVer:  xor a                      ; A = $00 (nextreg $00 = Machine ID)
1E44 CD 0B 0E                   call RdNextReg             ; Read nextreg $00
1E47 FE 08                      cp $08                     ; Is it $08 (ZX Spectrum Next)?
1E49 28 17                      jr z,L1E62                 ; If yes, skip version check (assume compatible)
1E4B 3E 01                      ld a,$01                   ; A = $01 (nextreg $01 = Core version major)
1E4D CD 0B 0E                   call RdNextReg             ; Read nextreg $01
1E50 67                         ld h,a                     ; H = major version
1E51 3E 0E                      ld a,$0E                   ; A = $0E (nextreg $0E = Core version minor)
1E53 CD 0B 0E                   call RdNextReg             ; Read nextreg $0E
1E56 6F                         ld l,a                     ; L = minor version (HL = version)
1E57 01 0A 31                   ld bc,$310A                ; BC = $310A (version 3.01.10)
1E5A A7                         and a                      ; Clear carry
1E5B ED 42                      sbc hl,bc                  ; HL = HL - BC (compare versions)
1E5D 21 8D 20                   ld hl,$208D                ; HL = "Core 3.01.10 needed" message
1E60 38 4E                      jr c,L1EB0                 ; If core < 3.01.10, show error and halt
1E62 21 B9 1E      L1E62:       ld hl,$1EB9                ; HL = $1EB9 (ROM signature checker code to copy to RAM)
1E65 11 27 ED                   ld de,$ED27                ; DE = $ED27 (destination in upper RAM)
1E68 01 14 00                   ld bc,$0014                ; BC = $0014 (20 bytes)
1E6B ED B0                      ldir                       ; Copy 20 bytes of code to RAM
1E6D CD 27 ED                   call LED27                 ; Call copied code in RAM
1E70 21 F0 1F                   ld hl,$1FF0                ; HL = $1FF0 ("enNxtmmc.rom" message)
1E73 28 08                      jr z,L1E7D                 ; If Z, check version further
1E75 CD CD 1E                   call L1ECD                 ; Display message
1E78 21 A1 20                   ld hl,$20A1                ; HL = " invalid" message
1E7B 18 33                      jr L1EB0                   ; Show error and halt
1E7D E5            L1E7D:       push hl
1E7E 21 08 02                   ld hl,$0208
1E81 A7                         and a
1E82 ED 52                      sbc hl,de
1E84 E1                         pop hl
1E85 C8                         ret z
1E86 E5                         push hl
1E87 21 BF 20                   ld hl,$20BF
1E8A CD CD 1E                   call L1ECD
1E8D EB                         ex de,hl
1E8E 06 04                      ld b,$04
1E90 7C            L1E90:       ld a,h
1E91 ED 23                      swapnib
1E93 E6 0F                      and $0F
1E95 C6 30                      add a,$30
1E97 FE 3A                      cp $3A                     ; Is it > '9'?
1E99 38 02                      jr c,L1E9D                 ; If <= '9', skip adjustment
1E9B C6 27                      add a,$27                  ; Adjust for hex 'A'-'F'
1E9D CD 00 3E      L1E9D:       call CallRom0              ; Call ROM0 routine $0010 (print char)
1EA0 10 00                      .defw $0010
1EA2 29            L1EA2:       add hl,hl                  ; Shift HL left 4 bits (next nibble)
1EA3 29                         add hl,hl
1EA4 29                         add hl,hl
1EA5 29                         add hl,hl
1EA6 10 E8                      djnz L1E90                 ; Loop 4 times for 4 hex digits
1EA8 3E 20                      ld a,$20                   ; A = space character
1EAA CD 00 3E                   call CallRom0              ; Call ROM0 $0010 (print space)
1EAD 10 00                      .defw $0010
1EAF E1            L1EAF:       pop hl                     ; Restore HL (error message)
1EB0 CD CD 1E      L1EB0:       call L1ECD                 ; Display error message
1EB3 3E 02                      ld a,$02                   ; A = $02 (red)
1EB5 D3 FE                      out ($FE),a                ; Set border to red
1EB7 18 FE         L1EB7:       jr L1EB7                   ; Halt: infinite loop
;
; Code Block Copied to RAM at $ED27 (20 bytes)
; This code checks ROM signature by reading from flash memory at $0004-$0007.
; Returns Z flag set if signature matches $5644 (expected ROM signature).
;
1EB9 3E 80                      .defb $3E,$80              ; ld a,$80
1EBB D3 E3                      .defb $D3,$E3              ; out ($E3),a - Enable flash read mode
1EBD 2A 04 00                   .defb $2A,$04,$00          ; ld hl,($0004) - Read signature word 1
1EC0 ED 5B 06 00                .defb $ED,$5B,$06,$00      ; ld de,($0006) - Read signature word 2
1EC4 AF                         .defb $AF                  ; xor a - A = $00
1EC5 D3 E3                      .defb $D3,$E3              ; out ($E3),a - Disable flash read mode
1EC7 01 44 56                   .defb $01,$44,$56          ; ld bc,$5644 - Expected signature
1ECA ED 42                      .defb $ED,$42              ; sbc hl,bc - Compare HL with BC
1ECC C9                         .defb $C9                  ; ret - Return (Z if match)
1ECD D5            L1ECD:       push de
1ECE 11 90 E0                   ld de,$E090
1ED1 01 00 02                   ld bc,$0200
1ED4 D5                         push de
1ED5 ED B0                      ldir
1ED7 E1                         pop hl
1ED8 CD 00 3E                   call CallRom0              ; Call ROM0 routine $081D
1EDB 1D 08                      .defw $081D
1EDD D1                         pop de
1EDE C9                         ret
1EDF ED 91 8E 7A                nextreg $8E,$7A
1EE3 21 F1 1E                   ld hl,$1EF1
1EE6 11 27 ED                   ld de,$ED27
1EE9 01 16 00                   ld bc,$0016
1EEC ED B0                      ldir
1EEE C3 27 ED                   jp LED27
1EF1 3E 81                      ld a,$81
1EF3 D3 E3                      out ($E3),a
1EF5 3E C9                      ld a,$C9
1EF7 32 09 20                   ld ($2009),a
1EFA 3E 80                      ld a,$80
1EFC D3 E3                      out ($E3),a
1EFE 3E C9                      ld a,$C9
1F00 32 00 3D                   ld ($3D00),a
1F03 AF                         xor a
1F04 D3 E3                      out ($E3),a
1F06 C9                         ret
1F07 D5            L1F07:       push de
1F08 E5                         push hl
1F09 21 77 1F                   ld hl,$1F77
1F0C 01 10 00                   ld bc,$0010
1F0F ED B0                      ldir
1F11 D1                         pop de
1F12 DD E3                      ex (sp),ix
1F14 D5                         push de
1F15 CD D5 07                   call L07D5
1F18 D1                         pop de
1F19 DD E3                      ex (sp),ix
1F1B D5                         push de
1F1C 21 82 1F                   ld hl,$1F82
1F1F 01 08 00                   ld bc,$0008
1F22 ED B0                      ldir
1F24 EB                         ex de,hl
1F25 C1                         pop bc
1F26 D1                         pop de
1F27 D5                         push de
1F28 C5                         push bc
1F29 73                         ld (hl),e
1F2A 23                         inc hl
1F2B 72                         ld (hl),d
1F2C F5                         push af
1F2D 21 7D 20                   ld hl,$207D
1F30 CD B5 00                   call L00B5
1F33 C1                         pop bc
1F34 30 07                      jr nc,L1F3D
1F36 3A 22 F7                   ld a,($F722)
1F39 FE 01                      cp $01
1F3B 28 1A                      jr z,L1F57
1F3D E1            L1F3D:       pop hl
1F3E DD E3                      ex (sp),ix
1F40 DD CB 01 FE                set 7,(ix+$01)
1F44 DD E3                      ex (sp),ix
1F46 E5                         push hl
1F47 78                         ld a,b
1F48 21 7D 20                   ld hl,$207D
1F4B CD B5 00                   call L00B5
1F4E 30 1F                      jr nc,L1F6F
1F50 3A 22 F7                   ld a,($F722)
1F53 FE 01                      cp $01
1F55 20 18                      jr nz,L1F6F
1F57 D1            L1F57:       pop de
1F58 21 32 F7                   ld hl,$F732
1F5B 01 08 00                   ld bc,$0008
1F5E ED B0                      ldir
1F60 DD E3                      ex (sp),ix
1F62 DD 7E 10                   ld a,(ix+$10)
1F65 E6 01                      and $01
1F67 C6 05                      add a,$05
1F69 CD 65 07                   call L0765
1F6C DD E1                      pop ix
1F6E C9                         ret
1F6F AF            L1F6F:       xor a
1F70 E1                         pop hl
1F71 77                         ld (hl),a
1F72 23                         inc hl
1F73 77                         ld (hl),a
1F74 E1                         pop hl
1F75 77                         ld (hl),a
1F76 C9                         ret
1F77 01 00 00                   ld bc,$0000
;
; Zero bytes ($08)
;
1F7A                            .fillb $08,$00
1F82 01 00 02                   ld bc,$0200
1F85 80                         add a,b
1F86 00                         nop
1F87 01 00 00                   ld bc,$0000

;
; IDE_PARTITIONS: Get number of open partitions
;
1F8A 4F            IdeParts:    ld c,a
1F8B DD 21 6C E4                ld ix,$E46C
1F8F 06 14                      ld b,$14
1F91 1E 00                      ld e,$00
1F93 63                         ld h,e
1F94 6B                         ld l,e
1F95 DD 7E 00      L1F95:       ld a,(ix)
1F98 A7                         and a
1F99 28 1D                      jr z,L1FB8
1F9B DD 7E 10                   ld a,(ix+$10)
1F9E E6 01                      and $01
1FA0 B9                         cp c
1FA1 20 09                      jr nz,L1FAC
1FA3 DD 7E 11                   ld a,(ix+$11)
1FA6 DD B6 12                   or (ix+$12)
1FA9 28 01                      jr z,L1FAC
1FAB 1C                         inc e
1FAC D5            L1FAC:       push de
1FAD 11 13 00                   ld de,$0013
1FB0 DD 19                      add ix,de
1FB2 D1                         pop de
1FB3 10 E0                      djnz L1F95
1FB5 7B                         ld a,e
1FB6 37                         scf
1FB7 C9                         ret
1FB8 DD E5         L1FB8:       push ix
1FBA E1                         pop hl
1FBB 18 EF                      jr L1FAC
1FBD 7A                         ld a,d
1FBE 78                         ld a,b
1FBF 38 30                      jr c,L1FF1
1FC1 2E 72                      ld l,$72
1FC3 6F                         ld l,a
1FC4 6D                         ld l,l
1FC5 7A                         ld a,d
1FC6 78                         ld a,b
1FC7 38 31                      jr c,L1FFA
1FC9 2E 72                      ld l,$72
1FCB 6F                         ld l,a
1FCC 6D                         ld l,l
1FCD 31 32 38                   ld sp,$3832
1FD0 2E 72                      ld l,$72
1FD2 6F                         ld l,a
1FD3 6D                         ld l,l
1FD4 FF                         rst $38
1FD5 34                         inc (hl)
1FD6 38 2E                      jr c,L2006
1FD8 72                         ld (hl),d
1FD9 6F                         ld l,a
1FDA 6D                         ld l,l
1FDB FF                         rst $38
1FDC 65                         ld h,l
1FDD 6E                         ld l,(hl)
1FDE 41                         ld b,c
1FDF 6C                         ld l,h
1FE0 74                         ld (hl),h
1FE1 5A                         ld e,d
1FE2 58                         ld e,b
1FE3 2E 72                      ld l,$72
1FE5 6F                         ld l,a
1FE6 6D                         ld l,l
1FE7 31 32 38                   ld sp,$3832
1FEA 2D                         dec l
1FEB 32 2E 72                   ld ($722E),a
1FEE 6F                         ld l,a
1FEF 6D                         ld l,l
1FF0 65                         ld h,l
1FF1 6E            L1FF1:       ld l,(hl)
1FF2 4E                         ld c,(hl)
1FF3 78                         ld a,b
1FF4 74                         ld (hl),h
1FF5 6D                         ld l,l
1FF6 6D                         ld l,l
1FF7 63                         ld h,e
1FF8 2E 72                      ld l,$72
1FFA 6F            L1FFA:       ld l,a
1FFB 6D                         ld l,l
1FFC FF                         rst $38
1FFD 4D                         ld c,l
1FFE 6F                         ld l,a
1FFF 75                         ld (hl),l
2000 6E                         ld l,(hl)
2001 74                         ld (hl),h
2002 3D                         dec a
2003 3F                         ccf
2004 3F                         ccf
2005 3F                         ccf
2006 2D            L2006:       dec l
2007 3F                         ccf
2008 2E 3F                      ld l,$3F
200A 3F                         ccf
200B 3F                         ccf
200C 44                         ld b,h
200D 52                         ld d,d
200E 56                         ld d,(hl)
200F 43                         ld b,e
2010 50                         ld d,b
2011 4D                         ld c,l
2012 50                         ld d,b
2013 33                         inc sp
2014 44                         ld b,h
2015 44                         ld b,h
2016 53                         ld d,e
2017 4B                         ld c,e
2018 53                         ld d,e
2019 57                         ld d,a
201A 50                         ld d,b
201B 2D                         dec l
201C 3F                         ccf
201D 2E 50                      ld l,$50
201F 33                         inc sp
2020 53                         ld d,e
2021 65                         ld h,l
2022 6E                         ld l,(hl)
2023 53                         ld d,e
2024 79                         ld a,c
2025 73                         ld (hl),e
2026 74                         ld (hl),h
2027 65                         ld h,l
2028 6D                         ld l,l
2029 2E 73                      ld l,$73
202B 79                         ld a,c
202C 73                         ld (hl),e
202D 72                         ld (hl),d
202E 74                         ld (hl),h
202F 63                         ld h,e
2030 2E 73                      ld l,$73
2032 79                         ld a,c
2033 73                         ld (hl),e
2034 EF                         rst $28
2035 22 63 3A                   ld ($3A63),hl
2038 2F                         cpl
2039 6E                         ld l,(hl)
203A 65                         ld h,l
203B 78                         ld a,b
203C 74                         ld (hl),h
203D 7A                         ld a,d
203E 78                         ld a,b
203F 6F                         ld l,a
2040 73                         ld (hl),e
2041 2F                         cpl
2042 61                         ld h,c
2043 75                         ld (hl),l
2044 74                         ld (hl),h
2045 6F                         ld l,a
2046 65                         ld h,l
2047 78                         ld a,b
2048 65                         ld h,l
2049 63                         ld h,e
204A 2E 31                      ld l,$31
204C 73                         ld (hl),e
204D 74                         ld (hl),h
204E 22 0D EF                   ld ($EF0D),hl
2051 22 63 3A                   ld ($3A63),hl
2054 2F                         cpl
2055 6E                         ld l,(hl)
2056 65                         ld h,l
2057 78                         ld a,b
2058 74                         ld (hl),h
2059 7A                         ld a,d
205A 78                         ld a,b
205B 6F                         ld l,a
205C 73                         ld (hl),e
205D 2F                         cpl
205E 61                         ld h,c
205F 75                         ld (hl),l
2060 74                         ld (hl),h
2061 6F                         ld l,a
2062 65                         ld h,l
2063 78                         ld a,b
2064 65                         ld h,l
2065 63                         ld h,e
2066 2E 62                      ld l,$62
2068 61                         ld h,c
2069 73                         ld (hl),e
206A 22 0D 63                   ld ($630D),hl
206D 3A 2F 6D                   ld a,($6D2F)
2070 61                         ld h,c
2071 63                         ld h,e
2072 68                         ld l,b
2073 69                         ld l,c
2074 6E                         ld l,(hl)
2075 65                         ld h,l
2076 73                         ld (hl),e
2077 2F                         cpl
2078 6E                         ld l,(hl)
2079 65                         ld h,l
207A 78                         ld a,b
207B 74                         ld (hl),h
207C 2F                         cpl
207D 50                         ld d,b
207E 4C                         ld c,h
207F 55                         ld d,l
2080 53                         ld d,e
2081 49                         ld c,c
2082 44                         ld b,h
2083 45                         ld b,l
2084 44                         ld b,h
2085 4F                         ld c,a
2086 53                         ld d,e
2087 20 20                      jr nz,L20A9
2089 20 20                      jr nz,L20AB
208B 20 20                      jr nz,L20AD
208D 43 6F 72 65 20 33 2E 30   .defm "Core 3.01.10 needed"
2095 31 2E 31 30 20 6E 65 65
209D 64 65 64
20A0 FF                         .defb $FF                  ; String terminator
;
20A1 20 69 6E 76 61 6C 69 64   .defm " invalid"
20A9 FF            L20A9:       .defb $FF                  ; String terminator
;
20AA 45 72 72 6F 72 20 72 65   .defm "Error reading file:"
20B2 61 64 69 6E 67 20 66 69
20BA 6C 65 3A
20BD 0D                         .defb $0D                  ; Carriage return
20BE FF                         .defb $FF                  ; String terminator
;
20BF 56 65 72 73 69 6F 6E 20   .defm "Version mismatch:"
20C7 6D 69 73 6D 61 74 63 68
20CF 3A
20D0 0D                         .defb $0D                  ; Carriage return
20D1 FF                         .defb $FF                  ; String terminator
;
20D2 65 6E 4E 65 78 74 5A 58   .defm "enNextZX.rom"
20DA 2E 72 6F 6D
20DE 0D                         .defb $0D                  ; Carriage return
20DF FF                         .defb $FF                  ; String terminator

;
; DOS_REF_XDPB: Point at XDPB for low level disk access
;
20E0 E6 DF         DosRefXdpb:  and $DF
20E6 D6 41                      sub $41
20E8 3F                         ccf
20E9 30 0F                      jr nc,L20FA
20EB FE 10                      cp $10
20ED 30 0B                      jr nc,L20FA
20EF CD FD 20                   call L20FD
20F2 C5                         push bc
20F3 DD E1                      pop ix
20F5 7E                         ld a,(hl)
20F6 23                         inc hl
20F7 B6                         or (hl)
20F8 C6 FF                      add a,$FF
20FA 3E 16         L20FA:       ld a,$16
20FC C9                         ret
20FD 5F            L20FD:       ld e,a
20FE 16 30                      ld d,$30
2100 ED 30                      mul d,e
2102 ED 35 E8 E5                add de,$E5E8
2106 87                         add a,a
2107 21 A0 E2                   ld hl,$E2A0
210A ED 31                      add hl,a
210C 01 C0 E2      L210C:       ld bc,$E2C0
210F A7                         and a
2110 C8                         ret z
2111 01 2D E3                   ld bc,$E32D
2114 FE 02                      cp $02
2116 C8                         ret z
2117 01 9A E3                   ld bc,$E39A
211A FE 18                      cp $18
211C C8                         ret z
211D 42                         ld b,d
211E 4B                         ld c,e
211F C9            L211F:       ret
2120 7A                         ld a,d
2121 FE 05                      cp $05
2123 30 2E         L2123:       jr nc,L2153
2125 21 44 E8                   ld hl,$E844
2128 FE 04                      cp $04
212A 28 04                      jr z,L2130
212C 3E 41         L212C:       ld a,$41
212E A7                         and a
212F C9                         ret
2130 7E            L2130:       ld a,(hl)
2131 A7                         and a
2132 FA 2C 21                   jp m,L212C
2135 3E 3B         L2135:       ld a,$3B
2137 C0                         ret nz
2138 7B                         ld a,e
2139 C6 41                      add a,$41
213B 77                         ld (hl),a
213C ED 34 E4 FF   L213C:       add hl,$FFE4
2140 E5                         push hl
2141 7B                         ld a,e
2142 CD FD 20                   call L20FD
2145 E3                         ex (sp),hl
2146 50                         ld d,b
2147 59                         ld e,c
2148 D5                         push de
2149 01 30 00                   ld bc,$0030
214C ED B0                      ldir
214E D1                         pop de
214F E1                         pop hl
2150 C3 F1 21                   jp L21F1
2153 C5            L2153:       push bc
2154 D5                         push de
2155 7B                         ld a,e
2156 CD FD 20                   call L20FD
2159 D1                         pop de
215A E3                         ex (sp),hl
215B C5                         push bc
215C D5                         push de
215D 44                         ld b,h
215E 4D                         ld c,l
215F 7A                         ld a,d
2160 A7                         and a
2161 F2 70 21                   jp p,L2170
2164 3E 03                      ld a,$03
2166 CD 2F 23                   call L232F
2169 38 22                      jr c,L218D
216B A7            L216B:       and a
216C D1                         pop de
216D D1                         pop de
216E D1                         pop de
216F C9                         ret
2170 21 12 F7      L2170:       ld hl,$F712
2173 CD C4 00                   call L00C4
2176 30 F3                      jr nc,L216B
2178 3A 22 F7                   ld a,($F722)
217B FE 03                      cp $03
217D 3E 09                      ld a,$09
217F 20 EA                      jr nz,L216B
2181 F1                         pop af
2182 F5                         push af
2183 C5                         push bc
2184 CD 40 07                   call IdePrtOpen
2187 C1                         pop bc
2188 30 E1                      jr nc,L216B
218A 21 32 F7                   ld hl,$F732
218D F1            L218D:       pop af
218E D1                         pop de
218F D5                         push de
2190 F5                         push af
2191 01 1C 00                   ld bc,$001C
2194 ED B0                      ldir
2196 EB                         ex de,hl
2197 C1                         pop bc
2198 79                         ld a,c
2199 C6 41                      add a,$41
219B 77                         ld (hl),a
219C 23                         inc hl
219D 78                         ld a,b
219E E6 7F                      and $7F
21A0 77                         ld (hl),a
21A1 23                         inc hl
21A2 06 0C                      ld b,$0C
21A4 36 00         L21A4:       ld (hl),$00
21A6 23                         inc hl
21A7 10 FB                      djnz L21A4
21A9 36 96                      ld (hl),$96
21AB 23                         inc hl
21AC 36 2E                      ld (hl),$2E
21AE 23                         inc hl
21AF 36 98                      ld (hl),$98
21B1 23                         inc hl
21B2 36 2E                      ld (hl),$2E
21B4 23                         inc hl
21B5 36 E3                      ld (hl),$E3
21B7 23                         inc hl
21B8 36 2E                      ld (hl),$2E
21BA ED 34 EC FF                add hl,$FFEC
21BE 7E                         ld a,(hl)
21BF E6 30                      and $30
21C1 ED 34 F4 FF                add hl,$FFF4
21C5 B6                         or (hl)
21C6 DD 77 05                   ld (ix+$05),a
21C9 ED 34 05 00                add hl,$0005
21CD 7E                         ld a,(hl)
21CE DD 77 06                   ld (ix+$06),a
21D1 DD E5                      push ix
21D3 E1                         pop hl
21D4 E5                         push hl
21D5 51                         ld d,c
21D6 1E 13                      ld e,$13
21D8 ED 30                      mul d,e
21DA ED 35 6E 37                add de,$376E
21DE 01 13 00                   ld bc,$0013
21E1 CF                         rst $08
21E2 0C                         .defb $0C
21E3 DD 04                      .defw $04DD
21E5 D1                         pop de
21E6 E1                         pop hl
21E7 E5                         push hl
21E8 ED 34 28 00                add hl,$0028
21EC 73                         ld (hl),e
21ED 23                         inc hl
21EE 72                         ld (hl),d
21EF D1                         pop de
21F0 E1                         pop hl
21F1 73            L21F1:       ld (hl),e
21F2 23                         inc hl
21F3 72                         ld (hl),d
21F4 EB                         ex de,hl
21F5 11 2F F7                   ld de,$F72F
21F8 D5                         push de
21F9 01 0F 00                   ld bc,$000F
21FC ED B0                      ldir
21FE ED 34 0B 00                add hl,$000B
2202 7E                         ld a,(hl)
2203 E6 40                      and $40
2205 23                         inc hl
2206 B6                         or (hl)
2207 23                         inc hl
2208 12                         ld (de),a
2209 13                         inc de
220A ED A0                      ldi
220C E1                         pop hl
220D 01 16 00                   ld bc,$0016
2210 1B                         dec de
2211 1A                         ld a,(de)
2212 D6 41                      sub $41
2214 57                         ld d,a
2215 59                         ld e,c
2216 ED 30                      mul d,e
2218 ED 35 70 38                add de,$3870
221C 0E 11                      ld c,$11
221E CF                         rst $08
221F 0D                         .defb $0D
2220 DD 04                      .defw $04DD
2222 37                         scf
2223 C9                         ret
;
;
;
2224 3E 03         L2224:       ld a,$03
2226 C5            L2226:       push bc
2227 21 00 F7                   ld hl,$F700
222A 11 01 F7                   ld de,$F701
222D 01 12 00                   ld bc,$0012
2230 70                         ld (hl),b
2231 ED B0                      ldir
2233 32 00 F7                   ld ($F700),a
2236 E1                         pop hl
2237 E5                         push hl
2238 7E            L2238:       ld a,(hl)
2239 FE FF                      cp $FF
223B 28 14                      jr z,L2251
223D 23                         inc hl
223E FE 2E                      cp $2E
2240 20 F6                      jr nz,L2238
2242 E5            L2242:       push hl
2243 7E            L2243:       ld a,(hl)
2244 23                         inc hl
2245 FE FF                      cp $FF
2247 28 07                      jr z,L2250
2249 FE 2E                      cp $2E
224B 20 F6                      jr nz,L2243
224D F1                         pop af
224E 18 F2                      jr L2242
2250 E1            L2250:       pop hl
2251 06 03         L2251:       ld b,$03
2253 7E            L2253:       ld a,(hl)
2254 FE FF                      cp $FF
2256 28 0D                      jr z,L2265
2258 23                         inc hl
2259 FE 61                      cp $61
225B 38 0A                      jr c,L2267
225D FE 7B                      cp $7B
225F 30 06                      jr nc,L2267
2261 E6 DF                      and $DF
2263 18 02                      jr L2267
2265 3E 20         L2265:       ld a,$20
2267 12            L2267:       ld (de),a
2268 13                         inc de
2269 10 E8                      djnz L2253
226B CD F4 05                   call L05F4
226E E1                         pop hl
226F D0                         ret nc
2270 E5                         push hl
2271 CF                         rst $08
2272 00                         .defb $00
2273 4F 03                      .defw $034F
2275 E1                         pop hl
2276 E6 0F                      and $0F
2278 4F                         ld c,a
2279 C5                         push bc
227A 0E 01                      ld c,$01
227C 11 02 00                   ld de,$0002
227F CD 06 01                   call L0106
2282 C1                         pop bc
2283 D0                         ret nc
2284 C5                         push bc
2285 CD 39 01                   call L0139
2288 C1                         pop bc
2289 30 20                      jr nc,L22AB
228B 22 0B F7                   ld ($F70B),hl
228E ED 53 0D F7                ld ($F70D),de
2292 C5                         push bc
2293 78                         ld a,b
2294 21 17 F7                   ld hl,$F717
2297 11 02 00                   ld de,$0002
229A CF                         rst $08
229B 00                         .defb $00
229C 4F 34                      .defw $344F
229E C1                         pop bc
229F F5                         push af
22A0 32 10 F7                   ld ($F710),a
22A3 F6 80                      or $80
22A5 32 16 F7                   ld ($F716),a
22A8 F1                         pop af
22A9 3E 09                      ld a,$09
22AB F5            L22AB:       push af
22AC C5                         push bc
22AD D5                         push de
22AE CD 09 01                   call L0109
22B1 D1                         pop de
22B2 C1                         pop bc
22B3 F1                         pop af
22B4 D0                         ret nc
22B5 1D                         dec e
22B6 3E 4A                      ld a,$4A
22B8 3F                         ccf
22B9 C0                         ret nz
22BA 2A 1B F7                   ld hl,($F71B)
22BD 7C                         ld a,h
22BE B5                         or l
22BF 3E 09                      ld a,$09
22C1 C8                         ret z
22C2 2B                         dec hl
22C3 22 07 F7                   ld ($F707),hl
22C6 79                         ld a,c
22C7 32 1B F7                   ld ($F71B),a
22CA ED 5B 17 F7                ld de,($F717)
22CE 2A 19 F7                   ld hl,($F719)
22D1 3A 10 F7                   ld a,($F710)
22D4 CB 4F                      bit 1,a
22D6 20 0B                      jr nz,L22E3
22D8 5A                         ld e,d
22D9 55                         ld d,l
22DA 6C                         ld l,h
22DB 26 00                      ld h,$00
22DD CB 3D                      srl l
22DF CB 1A                      rr d
22E1 CB 1B                      rr e
22E3 ED 53 01 F7   L22E3:       ld ($F701),de
22E7 22 03 F7                   ld ($F703),hl
22EA DD 21 1C F7                ld ix,$F71C
22EE DD 36 10 80                ld (ix+$10),$80
22F2 01 00 00                   ld bc,$0000
22F5 50                         ld d,b
22F6 59                         ld e,c
22F7 CF                         rst $08
22F8 00                         .defb $00
22F9 94 13                      .defw $1394
22FB 3E 3C                      ld a,$3C
22FD 3F                         ccf
22FE D0                         ret nc
22FF 22 11 F7                   ld ($F711),hl
2302 E5                         push hl
2303 DD 21 00 F7                ld ix,$F700
2307 21 5F F7                   ld hl,$F75F
230A 01 00 07                   ld bc,$0700
230D 51                         ld d,c
230E 59                         ld e,c
230F CD AC 00                   call L00AC
2312 21 5F F9                   ld hl,$F95F
2315 01 00 07                   ld bc,$0700
2318 11 01 00                   ld de,$0001
231B DC AC 00                   call c,L00AC
231E D1                         pop de
231F D0                         ret nc
2320 21 16 F7                   ld hl,$F716
2323 01 06 00                   ld bc,$0006
2326 CF                         rst $08
2327 00                         .defb $00
2328 DD 04                      .defw $04DD
232A 01 5F F7                   ld bc,$F75F
232D 37                         scf
232E C9                         ret
232F F5            L232F:       push af
2330 CD D5 23                   call L23D5
2333 20 3F                      jr nz,L2374
2335 C1                         pop bc
2336 3E 09         L2336:       ld a,$09
2338 37                         scf
2339 3F                         ccf
233A C0                         ret nz
233B ED 34 20 00                add hl,$0020
233F 7E                         ld a,(hl)
2340 B8                         cp b
2341 20 F3                      jr nz,L2336
2343 ED 34 E4 FF                add hl,$FFE4
2347 E5            L2347:       push hl
2348 DD E5                      push ix
234A CD 05 06                   call L0605
234D E1                         pop hl
234E D1                         pop de
234F D0                         ret nc
2350 D5                         push de
2351 DD E5                      push ix
2353 D1                         pop de
2354 01 13 00                   ld bc,$0013
2357 ED B0                      ldir
2359 E1                         pop hl
235A E5                         push hl
235B ED 34 1B 00                add hl,$001B
235F CB E6                      set 4,(hl)
2361 CB 6E                      bit 5,(hl)
2363 E1                         pop hl
2364 37                         scf
2365 C0                         ret nz
2366 ED 35 EE FF                add de,$FFEE
236A 06 04         L236A:       ld b,$04
236C EB            L236C:       ex de,hl
236D 34                         inc (hl)
236E EB                         ex de,hl
236F 13                         inc de
2370 C0                         ret nz
2371 10 F9                      djnz L236C
2373 C9                         ret
2374 F1            L2374:       pop af
2375 FE 03                      cp $03
2377 20 BD                      jr nz,L2336
2379 11 09 24                   ld de,$2409
237C CD F0 23                   call L23F0
237F 28 08                      jr z,L2389
2381 11 01 24                   ld de,$2401
2384 CD F0 23                   call L23F0
2387 20 AD                      jr nz,L2336
2389 ED 34 31 00   L2389:       add hl,$0031
238D 7E                         ld a,(hl)
238E 3D                         dec a
238F 20 A5                      jr nz,L2336
2391 ED 34 E9 00                add hl,$00E9
2395 7E                         ld a,(hl)
2396 E6 C0                      and $C0
2398 20 16                      jr nz,L23B0
239A ED 34 E6 00                add hl,$00E6
239E 54                         ld d,h
239F 5D                         ld e,l
23A0 06 0A                      ld b,$0A
23A2 1A                         ld a,(de)
23A3 4F                         ld c,a
23A4 1A            L23A4:       ld a,(de)
23A5 13                         inc de
23A6 B9                         cp c
23A7 20 10                      jr nz,L23B9
23A9 10 F9                      djnz L23A4
23AB 21 28 27                   ld hl,$2728
23AE 18 09                      jr L23B9
23B0 07            L23B0:       rlca
23B1 21 32 27                   ld hl,$2732
23B4 30 03                      jr nc,L23B9
23B6 21 3C 27                   ld hl,$273C
23B9 DD E5         L23B9:       push ix
23BB DD 21 2F F7                ld ix,$F72F
23BF CD 28 26                   call DdLXdpb
23C2 DD E1                      pop ix
23C4 21 00 30                   ld hl,$3000
23C7 22 49 F7                   ld ($F749),hl
23CA 26 80                      ld h,$80
23CC 22 3A F7                   ld ($F73A),hl
23CF 21 2F F7                   ld hl,$F72F
23D2 C3 47 23                   jp L2347
23D5 60            L23D5:       ld h,b
23D6 69                         ld l,c
23D7 06 04                      ld b,$04
23D9 11 FD 23                   ld de,$23FD
23DC CD F2 23                   call L23F2
23DF C0                         ret nz
23E0 E5                         push hl
23E1 3E 1F                      ld a,$1F
23E3 01 FF 02                   ld bc,$02FF
23E6 86            L23E6:       add a,(hl)
23E7 23                         inc hl
23E8 0D                         dec c
23E9 20 FB                      jr nz,L23E6
23EB 10 F9                      djnz L23E6
23ED BE                         cp (hl)
23EE E1                         pop hl
23EF C9                         ret
23F0 06 08         L23F0:       ld b,$08
23F2 E5            L23F2:       push hl
23F3 1A            L23F3:       ld a,(de)
23F4 BE                         cp (hl)
23F5 13                         inc de
23F6 23                         inc hl
23F7 20 02                      jr nz,L23FB
23F9 10 F8                      djnz L23F3
23FB E1            L23FB:       pop hl
23FC C9                         ret
23FD 50                         ld d,b
23FE 33                         inc sp
23FF 44                         ld b,h
2400 1A                         ld a,(de)
2401 4D                         ld c,l
2402 56                         ld d,(hl)
2403 20 2D                      jr nz,L2432
2405 20 43                      jr nz,L244A
2407 50                         ld d,b
2408 43                         ld b,e
2409 45                         ld b,l
240A 58                         ld e,b
240B 54                         ld d,h
240C 45                         ld b,l
240D 4E                         ld c,(hl)
240E 44                         ld b,h
240F 45                         ld b,l
2410 44                         ld b,h
2411 DD E5                      push ix
2413 F5                         push af
2414 C6 41                      add a,$41
2416 E5                         push hl
2417 CD EA 05                   call L05EA
241A E1                         pop hl
241B D1                         pop de
241C DD E1                      pop ix
241E D0                         ret nc
241F 7A                         ld a,d
2420 C6 41                      add a,$41
2422 06 00                      ld b,$00
2424 70                         ld (hl),b
2425 23                         inc hl
2426 70                         ld (hl),b
2427 21 44 E8                   ld hl,$E844
242A BE                         cp (hl)
242B 20 01                      jr nz,L242E
242D 70                         ld (hl),b
242E DD 6E 28      L242E:       ld l,(ix+$28)
2431 DD 66 29                   ld h,(ix+$29)
2434 7C                         ld a,h
2435 B5                         or l
2436 37                         scf
2437 C8                         ret z
2438 70                         ld (hl),b
2439 C9                         ret
243A C6 41                      add a,$41
243C 50                         ld d,b
243D 59                         ld e,c
243E 21 44 E8                   ld hl,$E844
2441 BE                         cp (hl)
2442 21 A3 27                   ld hl,$27A3
2445 01 0A 00                   ld bc,$000A
2448 20 07                      jr nz,L2451
244A 7E            L244A:       ld a,(hl)
244B D6 30                      sub $30
244D ED B0                      ldir
244F 37                         scf
2450 C9                         ret
2451 DD E5         L2451:       push ix
2453 D5                         push de
2454 D6 41                      sub $41
2456 CD FD 20                   call L20FD
2459 C5                         push bc
245A DD E1                      pop ix
245C 3E FF                      ld a,$FF
245E DD CB 1B 66                bit 4,(ix+$1B)
2462 20 39                      jr nz,L249D
2464 DD 5E 28                   ld e,(ix+$28)
2467 DD 56 29                   ld d,(ix+$29)
246A D5                         push de
246B DD E1                      pop ix
246D DD 7E 10                   ld a,(ix+$10)
2470 E6 01                      and $01
2472 C6 05                      add a,$05
2474 DD 4E 11                   ld c,(ix+$11)
2477 DD 46 12                   ld b,(ix+$12)
247A C5                         push bc
247B F5                         push af
247C 21 12 F7                   ld hl,$F712
247F CD C4 00                   call L00C4
2482 E1                         pop hl
2483 C1                         pop bc
2484 D1                         pop de
2485 30 17                      jr nc,L249E
2487 7C                         ld a,h
2488 C6 30                      add a,$30
248A 12                         ld (de),a
248B 13                         inc de
248C 3E 3E                      ld a,$3E
248E 12                         ld (de),a
248F 13                         inc de
2490 C5                         push bc
2491 7C                         ld a,h
2492 21 12 F7                   ld hl,$F712
2495 01 10 00                   ld bc,$0010
2498 ED B0                      ldir
249A EB                         ex de,hl
249B 36 FF                      ld (hl),$FF
249D C1            L249D:       pop bc
249E DD E1         L249E:       pop ix
24A0 37                         scf
24A1 C9                         ret
24A2 F5            L24A2:       push af
24A3 E5                         push hl
24A4 21 15 25                   ld hl,$2515
24A7 11 43 E8                   ld de,$E843
24AA 01 15 00                   ld bc,$0015
24AD ED B0                      ldir
24AF E1                         pop hl
24B0 F1                         pop af
24B1 E5                         push hl
24B2 DD 21 28 E8                ld ix,$E828
24B6 21 0D 25                   ld hl,$250D
24B9 11 EF E3                   ld de,$E3EF
24BC 01 08 00                   ld bc,$0008
24BF ED B0                      ldir
24C1 D1                         pop de
24C2 F5                         push af
24C3 7B                         ld a,e
24C4 FE 04                      cp $04
24C6 38 34                      jr c,L24FC
24C8 82                         add a,d
24C9 32 F1 E3                   ld ($E3F1),a
24CC 7A                         ld a,d
24CD 32 F4 E3                   ld ($E3F4),a
24D0 F1                         pop af
24D1 A7                         and a
24D2 20 0B                      jr nz,L24DF
24D4 7A            L24D4:       ld a,d
24D5 D5                         push de
24D6 CF                         rst $08
24D7 0D                         .defb $0D
24D8 2D 36                      .defw $362D
24SA D1                         pop de
24DB 14                         inc d
24DC 1D                         dec e
24DD 20 F5                      jr nz,L24D4
24DF 21 EF E3      L24DF:       ld hl,$E3EF
24E2 CD 6A 26                   call DdLPdb
24E5 21 F1 E3                   ld hl,$E3F1
24E8 11 76 3E                   ld de,$3E76
24EB 01 01 00                   ld bc,$0001
24EE CF                         rst $08
24EF 0D                         .defb $0D
24F0 DD 04                      .defw $04DD
24F2 DD CB 1C 7E                bit 7,(ix+$1C)
24F6 37                         scf
24F7 C8                         ret z
24F8 DD 34 1C                   inc (ix+$1C)
24FB C9                         ret
;
;
;
24FC F1            L24FC:       pop af
24FD DD 6E 1C                   ld l,(ix+$1C)
2500 DD E5                      push ix
2502 CD F4 00                   call L00F4
2505 DD E1                      pop ix
2507 DD 36 1C FF                ld (ix+$1C),$FF
250B 37                         scf
250C C9                         ret
250D 00                         nop
250E 00                         nop
250F 00                         nop
2510 01 02 00                   ld bc,$0002
2513 03                         inc bc
2514 00                         nop
2515 08                         ex af,af'
2516 00                         nop
2517 FF                         rst $38
;
; Zero bytes ($0C)
;
2518                            .fillb $0C,$00
2524 96                         sub (hl)
2525 2E 96                      ld l,$96
2527 2E 96                      ld l,$96
2529 2E 37                      ld l,$37
;
; DOS_INITIALISE: Initialise +3DOS
;
252A C9            DosInit:     ret
;
; DOS_VERSION: Get +3DOS issue and version numbers
;
252C AF            DosVersion:  xor a
252D 06 01                      ld b,$01
252F 90                         sub b
2530 3E 00                      ld a,$00
2532 47                         ld b,a
2533 4F                         ld c,a
2534 11 01 01                   ld de,$0101
2537 21 69 00                   ld hl,$0069
253A 37                         scf
253B C9                         ret

;
; DOS_BOOT: Boot an operating system or other program
;
253C 3E 41         DosBoot:     ld a,$41
253E 06 07                      ld b,$07
2540 21 90 E0                   ld hl,$E090
2543 E5                         push hl
2544 CF                         rst $08
2545 0D                         .defb $0D
2546 A5 34                      .defw $34A5
2548 E1                         pop hl
2549 D0                         ret nc
254A E5                         push hl
254B AF                         xor a
254C 47                         ld b,a
254D 1E 02                      ld e,$02
254F 86            L254F:       add a,(hl)
2550 23                         inc hl
2551 10 FC                      djnz L254F
2553 1D                         dec e
2554 20 F9                      jr nz,L254F
2556 E1                         pop hl
2557 EE 03                      xor $03
2559 3E 23                      ld a,$23
255B C0                         ret nz
255C F3                         di
255D 3E 06                      ld a,$06
255F ED 92 54                   nextreg $54,a
2562 3C                         inc a
2563 ED 92 55                   nextreg $55,a
2566 11 00 BE                   ld de,$BE00
2569 01 00 02                   ld bc,$0200
256C ED B0                      ldir
256E ED 91 8E 3A                nextreg $8E,$3A
2572 31 00 FE                   ld sp,$FE00
2575 3E 03                      ld a,$03
2577 32 5C 5B                   ld ($5B5C),a
257A 3C                         inc a
257B 32 67 5B                   ld ($5B67),a
257E CD 14 0E                   call L0E14
2581 21 94 25                   ld hl,$2594
2584 11 FB FD                   ld de,$FDFB
2587 01 05 00                   ld bc,$0005
258A ED B0                      ldir
258C 01 FD 1F                   ld bc,$1FFD
258F 3E 07                      ld a,$07
2591 C3 FB FD                   jp LFDFB
2594 ED 79                      out (c),a
2596 C3 10 FE                   jp LFE10

;
; DOS_RESERVED: Reserved (invalid)
;
2599 3E 3A         DosInvalid:  ld a,$3A
259B A7                         and a
259C C9                         ret

;
; DD_INTERFACE: Is the floppy disk driver interface present?
;
259D 37            DdIntf:      scf
259E C9                         ret

;
; DOS_SET_MESSAGE: Enable/disable error messages
;
259F 21 00 00      DosSetMsg:  ld hl,$0000
25A2 C9                         ret
25A3 DD 7E 19      L25A3:       ld a,(ix+$19)
25A6 F6 06                      or $06
25A8 CD DB 25                   call L25DB
25AB 7B                         ld a,e
25AC DD 86 14                   add a,(ix+$14)
25AF 5F                         ld e,a
25B0 D5                         push de
25B1 2A 19 E4                   ld hl,($E419)
25B4 7C                         ld a,h
25B5 B5                         or l
25B6 C4 5C 27                   call nz,L275C
25B9 7B                         ld a,e
25BA 32 0A E4                   ld ($E40A),a
25BD DD 6E 0F                   ld l,(ix+$0F)
25C0 63                         ld h,e
25C1 22 0B E4                   ld ($E40B),hl
25C4 DD 7E 17                   ld a,(ix+$17)
25C7 32 0D E4                   ld ($E40D),a
25CA 60                         ld h,b
25CB 6A                         ld l,d
25CC 22 08 E4                   ld ($E408),hl
25CF 3E 09                      ld a,$09
25D1 32 05 E4                   ld ($E405),a
25D4 21 0E E4                   ld hl,$E40E
25D7 36 FF                      ld (hl),$FF
25D9 D1                         pop de
25DA C9                         ret
25DB 22 01 E4      L25DB:       ld ($E401),hl
25DE 6F                         ld l,a
25DF 78                         ld a,b
25E0 32 00 E4                   ld ($E400),a
25E3 CD F4 25                   call L25F4
25E6 61                         ld h,c
25E7 22 06 E4                   ld ($E406),hl
25EA DD 6E 15                   ld l,(ix+$15)
25ED DD 66 16                   ld h,(ix+$16)
25F0 22 03 E4                   ld ($E403),hl
25F3 C9                         ret
25F4 DD 7E 11      L25F4:       ld a,(ix+$11)
25F7 E6 7F                      and $7F
25F9 06 00                      ld b,$00
25FB C8                         ret z
25FC 3D                         dec a
25FD 20 08                      jr nz,L2607
25FF 7A                         ld a,d
2600 1F                         rra
2601 57                         ld d,a
2602 78                         ld a,b
2603 17                         rla
2604 47                         ld b,a
2605 18 0C                      jr L2613
2607 7A            L2607:       ld a,d
2608 DD 96 12                   sub (ix+$12)
260B 38 06                      jr c,L2613
260D DD 96 12                   sub (ix+$12)
2610 2F                         cpl
2611 57                         ld d,a
2612 04                         inc b
2613 78            L2613:       ld a,b
2614 87                         add a,a
2615 87                         add a,a
2616 B1                         or c
2617 4F                         ld c,a
2618 C9                         ret

;
; DD_SET_DRIVE: Set drive (not documented in API)
;
2619 B7            DdEncode:    or a
261A 20 03                      jr nz,L261F
261C 21 00 00                   ld hl,$0000
261F ED 5B 19 E4   L261F:       ld de,($E419)
2623 22 19 E4                   ld ($E419),hl
2626 EB                         ex de,hl
2627 C9                         ret

;
; DD_L_XDPB: Initialise an XDPB from a disk specification
;
2628 E5            DdLXdpb:     push hl
2629 C5                         push bc
262A 7E                         ld a,(hl)
262B 06 41                      ld b,$41
262D 3D                         dec a
262E 28 07                      jr z,L2637
2630 06 C1                      ld b,$C1
2632 3D                         dec a
2633 28 02                      jr z,L2637
2635 06 01                      ld b,$01
2637 DD 70 14      L2637:       ld (ix+$14),b
263A 23                         inc hl
263B 7E                         ld a,(hl)
263C DD 77 11                   ld (ix+$11),a
263F 23                         inc hl
2640 7E                         ld a,(hl)
2641 DD 77 12                   ld (ix+$12),a
;
;
;
2644 23                         inc hl
2645 7E                         ld a,(hl)
2646 DD 77 13                   ld (ix+$13),a
2649 23                         inc hl
264A 46                         ld b,(hl)
264B 23                         inc hl
264C 23                         inc hl
264D 23                         inc hl
264E 23                         inc hl
264F 7E                         ld a,(hl)
2650 DD 77 17                   ld (ix+$17),a
2653 23                         inc hl
2654 7E                         ld a,(hl)
2655 DD 77 18                   ld (ix+$18),a
2658 21 80 00                   ld hl,$0080
265B CD 67 27                   call L2767
265E DD 75 15                   ld (ix+$15),l
2661 DD 74 16                   ld (ix+$16),h
2664 DD 36 19 60                ld (ix+$19),$60
2668 C1                         pop bc
2669 E1                         pop hl

;
; DD_L_DPB: Initialise a DPB from a disk specification
;
266A C5            DdLPdb:      push bc
266B E5                         push hl
266C EB                         ex de,hl
266D 21 04 00                   ld hl,$0004
2670 19                         add hl,de
2671 7E                         ld a,(hl)
2672 DD 77 0F                   ld (ix+$0F),a
2675 F5                         push af
2676 CD 5D 27                   call L275D
2679 DD 77 10                   ld (ix+$10),a
267C 2B                         dec hl
267D 6E                         ld l,(hl)
267E 26 00                      ld h,$00
2680 C1                         pop bc
2681 CD 67 27                   call L2767
2684 DD 75 00                   ld (ix),l
2687 DD 74 01                   ld (ix+$01),h
268A 21 06 00                   ld hl,$0006
268D 19                         add hl,de
268E 7E                         ld a,(hl)
268F DD 77 02                   ld (ix+$02),a
2692 4F                         ld c,a
2693 E5                         push hl
2694 CD 5D 27                   call L275D
2697 DD 77 03                   ld (ix+$03),a
269A 2B                         dec hl
269B 5E                         ld e,(hl)
269C DD 73 0D                   ld (ix+$0D),e
269F DD 36 0E 00                ld (ix+$0E),$00
26A3 2B                         dec hl
26A4 2B                         dec hl
26A5 46                         ld b,(hl)
26A6 2B                         dec hl
26A7 56                         ld d,(hl)
26A8 2B                         dec hl
26A9 7E                         ld a,(hl)
26AA 6A                         ld l,d
26AB 26 00                      ld h,$00
26AD 54                         ld d,h
26AE E6 7F                      and $7F
26B0 28 01                      jr z,L26B3
26B2 29                         add hl,hl
26B3 ED 52         L26B3:       sbc hl,de
26B5 EB                         ex de,hl
26B6 21 00 00                   ld hl,$0000
26B9 19            L26B9:       add hl,de
26BA 10 FD                      djnz L26B9
26BC 79                         ld a,c
26BD DD 96 0F                   sub (ix+$0F)
26C0 47                         ld b,a
26C1 CD 6E 27                   call L276E
26C4 2B                         dec hl
26C5 DD 75 05                   ld (ix+$05),l
26C8 DD 74 06                   ld (ix+$06),h
26CB 06 03                      ld b,$03
26CD 7C                         ld a,h
26CE B7                         or a
26CF 28 01                      jr z,L26D2
26D1 04                         inc b
26D2 79            L26D2:       ld a,c
26D3 90                         sub b
26D4 CD 5D 27                   call L275D
26D7 DD 77 04                   ld (ix+$04),a
26DA D1                         pop de
26DB E5                         push hl
26DC 06 02                      ld b,$02
26DE CD 6E 27                   call L276E
26E1 23                         inc hl
26E2 23                         inc hl
26E3 E3                         ex (sp),hl
26E4 13                         inc de
26E5 1A                         ld a,(de)
26E6 B7                         or a
26E7 20 08                      jr nz,L26F1
26E9 29                         add hl,hl
26EA 7C                         ld a,h
26EB 3C                         inc a
26EC FE 02                      cp $02
26EE 30 01                      jr nc,L26F1
26F0 3C                         inc a
26F1 47            L26F1:       ld b,a
26F2 21 00 00                   ld hl,$0000
26F5 37            L26F5:       scf
26F6 CB 1C                      rr h
26F8 CB 1D                      rr l
26FA 10 F9                      djnz L26F5
26FC DD 74 09                   ld (ix+$09),h
26FF DD 75 0A                   ld (ix+$0A),l
2702 26 00                      ld h,$00
2704 6F                         ld l,a
2705 41                         ld b,c
2706 04                         inc b
2707 04                         inc b
2708 CD 67 27                   call L2767
270B E5                         push hl
270C 2B                         dec hl
270D DD 75 07                   ld (ix+$07),l
2710 DD 74 08                   ld (ix+$08),h
2713 06 02                      ld b,$02
2715 CD 6E 27                   call L276E
2718 23                         inc hl
2719 DD 75 0B                   ld (ix+$0B),l
271C DD 74 0C                   ld (ix+$0C),h
271F E1                         pop hl
2720 29                         add hl,hl
2721 29                         add hl,hl
2722 D1                         pop de
2723 C1                         pop bc
2724 0A                         ld a,(bc)
2725 37                         scf
2726 C1                         pop bc
2727 C9                         ret
2728 00                         nop
2729 00                         nop
272A 28 09                      jr z,L2735
272C 02                         ld (bc),a
272D 01 03 02                   ld bc,$0203
2730 2A 52 01                   ld hl,($0152)
2733 00                         nop
2734 28 09                      jr z,L273F
2736 02                         ld (bc),a
2737 02                         ld (bc),a
2738 03                         inc bc
2739 02                         ld (bc),a
273A 2A 52 02                   ld hl,($0252)
273D 00                         nop
273E 28 09                      jr z,L2749
2740 02                         ld (bc),a
2741 00                         nop
2742 03                         inc bc
2743 02                         ld (bc),a
2744 2A 52 03                   ld hl,($0352)
2747 81                         add a,c
2748 50                         ld d,b
2749 09            L2749:       add hl,bc
274A 02                         ld (bc),a
274B 01 04 04                   ld bc,$0404
274E 2A 52 
;
; DD_WRITE_TRACK:  (deprecated)
;
2750 C5            DdTrackWrt:  push bc
2751 0E 01                      ld c,$01
2753 CD 78 27                   call DdTrackRead
2756 C1                         pop bc
2757 E6 60                      and $60
2759 C8                         ret z
275A 37                         scf
275B C9                         ret
275C E9            L275C:       jp (hl)
275D B7            L275D:       or a
275E C8                         ret z
275F 47                         ld b,a
2760 3E 01                      ld a,$01
2762 87            L2762:       add a,a
2763 10 FD                      djnz L2762
2765 3D                         dec a
2766 C9                         ret
2767 78            L2767:       ld a,b
2768 B7                         or a
2769 C8                         ret z
276A 29            L276A:       add hl,hl
276B 10 FD                      djnz L276A
276D C9                         ret
276E 78            L276E:       ld a,b
276F B7                         or a
2770 C8                         ret z
2771 CB 3C         L2771:       srl h
2773 CB 1D                      rr l
2775 10 FA                      djnz L2771
2777 C9                         ret

;
; DD_READ_TRACK: Read a track (deprecated)
;
2778 79            DdTrackRead: ld a,c
2779 E6 01                      and $01
277B 4F                         ld c,a
277C 3A DB E2                   ld a,($E2DB)
277F 28 03                      jr z,L2784
2781 3A 48 E3                   ld a,($E348)
2784 E6 20         L2784:       and $20
2786 B1                         or c
2787 37                         scf
2788 C9                         ret

;
; DD_READ_SECTOR: Read a sector
;
2789 CD A3 25      DdReadSect:  call L25A3
278C D5                         push de
278D C5                         push bc
278E 21 00 E4                   ld hl,$E400
2791 CF                         rst $08
2792 0C                         .defb $0C
2793 CC 30                      .defw $30CC
2795 C1                         pop bc
2796 D1                         pop de
2797 23                         inc hl
2798 7E                         ld a,(hl)
2799 A9                         xor c
279A 37                         scf
279B C8                         ret z
279C AF                         xor a
279D C9                         ret

;
; DD_ENCODE: Set intercept routine for copy protection
;
279E CF            DdLRead:     rst $08
279F 0C                         .defb $0C
27A0 CC 30                      .defw $30CC
27A2 C9                         ret
;
;
;
27A3 34                         inc (hl)
27A4 3E 52                      ld a,$52
27A6 41                         ld b,c
27A7 4D                         ld c,l
27A8 64                         ld h,h
27A9 69                         ld l,c
27AA 73                         ld (hl),e
27AB 6B                         ld l,e
27AC FF                         rst $38
27AD DD E1         L27AD:       pop ix
27AF E5                         push hl
27B0 D5                         push de
27B1 2A 3D 5C                   ld hl,($5C3D)
27B4 E5                         push hl
27B5 2A 6C 5B                   ld hl,($5B6C)
27B8 E5                         push hl
27B9 2A 0B 5C                   ld hl,($5C0B)
27BC E5                         push hl
27BD 26 3E                      ld h,$3E
27BF E5                         push hl
27C0 C5                         push bc
27C1 3E 2F                      ld a,$2F
27C3 CD 00 3F                   call L3F00
27C6 40                         ld b,b
27C7 3A C1 21                   ld a,($21C1)
27CA 13                         inc de
27CB 00                         nop
27CC 39                         add hl,sp
27CD 5E                         ld e,(hl)
27CE 23                         inc hl
27CF 56                         ld d,(hl)
27D0 23                         inc hl
27D1 7E                         ld a,(hl)
27D2 23                         inc hl
27D3 66                         ld h,(hl)
27D4 6F                         ld l,a
27D5 DD E9                      jp (ix)
27D7 E5            L27D7:       push hl
27D8 D5                         push de
27D9 C5                         push bc
27DA F5                         push af
27DB 21 0B 00                   ld hl,$000B
27DE 39                         add hl,sp
27DF CD 00 3F                   call L3F00
27E2 C8                         ret z
27E3 3A 23 23                   ld a,($2323)
27E6 5E                         ld e,(hl)
27E7 23                         inc hl
27E8 56                         ld d,(hl)
27E9 23                         inc hl
27EA ED 53 0B 5C                ld ($5C0B),de
27EE 5E                         ld e,(hl)
27EF 23                         inc hl
27F0 56                         ld d,(hl)
27F1 23                         inc hl
27F2 ED 53 6C 5B                ld ($5B6C),de
27F6 5E                         ld e,(hl)
27F7 23                         inc hl
27F8 56                         ld d,(hl)
27F9 23                         inc hl
27FA ED 53 3D 5C                ld ($5C3D),de
27FE ED 34 04 00                add hl,$0004
2802 F1                         pop af
2803 C1                         pop bc
2804 D1                         pop de
2805 E3                         ex (sp),hl
2806 D9                         exx
2807 E1                         pop hl
2808 DD E1                      pop ix
280A F9                         ld sp,hl
280B D9                         exx
280C FD CB 01 FE                set 7,(iy+$01)
2810 DD E9                      jp (ix)
;
; DOS_DELETE: Delete a file
;
2812 E5            DosDelete:   push hl
2813 CD 1D 02                   call L021D
2816 E1                         pop hl
2817 D0                         ret nc
2818 11 00 F7                   ld de,$F700
281B CD 67 28                   call L2867
281E DC 1D 02                   call c,L021D
2821 37                         scf
2822 C9                         ret
;
; DOS_RENAME: Rename a file
;
2823 E5            DosRename:   push hl
2824 D5                         push de
2825 11 00 F7                   ld de,$F700
2828 CD 6D 28                   call L286D
282B E1                         pop hl
282C E5                         push hl
282D D5                         push de
282E 11 00 FB                   ld de,$FB00
2831 DC 6D 28                   call c,L286D
2834 E1                         pop hl
2835 2B                         dec hl
2836 7E                         ld a,(hl)
2837 FE 2F                      cp $2F
2839 20 0D                      jr nz,L2848
283B 36 FF                      ld (hl),$FF
283D EB                         ex de,hl
283E 2B                         dec hl
283F 7E                         ld a,(hl)
2840 FE 7D                      cp $7D
2842 20 04                      jr nz,L2848
2844 2B                         dec hl
2845 2B                         dec hl
2846 36 FF                      ld (hl),$FF
2848 D1            L2848:       pop de
2849 E1                         pop hl
284A F5                         push af
284B CD 98 05                   call L0598
284E C1                         pop bc
284F D0                         ret nc
2850 C5                         push bc
2851 21 00 FB                   ld hl,$FB00
2854 CD DD 28                   call L28DD
2857 F1                         pop af
2858 E5                         push hl
2859 3E 03                      ld a,$03
285B CC B1 01                   call z,EntIdePath
285E D1                         pop de
285F 21 00 F7                   ld hl,$F700
2862 CD 98 05                   call L0598
2865 37                         scf
2866 C9                         ret
2867 11 00 F7      L2867:       ld de,$F700
286A A7                         and a
286B 18 19                      jr L2886
286D D5            L286D:       push de
286E E5                         push hl
286F CF                         rst $08
2870 00                         .defb $00
2871 4F 03                      .defw $034F
2873 CF                         rst $08
2874 00                         .defb $00
2875 18 02                      .defw $0218
2877 C1                         pop bc
2878 D1                         pop de
2879 D0            L2879:       ret nc
287A D5                         push de
287B C5                         push bc
287C 37                         scf
287D F2 84 28                   jp p,L2884
2880 CF                         rst $08
2881 00                         .defb $00
2882 23 1C                      .defw $1C23
2884 E1            L2884:       pop hl
2885 D1                         pop de
2886 D5            L2886:       push de
2887 F5                         push af
2888 E5                         push hl
2889 21 07 29                   ld hl,$2907
288C 01 15 00                   ld bc,$0015
288F ED B0                      ldir
2891 E1                         pop hl
2892 D5                         push de
2893 E5                         push hl
2894 7E            L2894:       ld a,(hl)
2895 12                         ld (de),a
2896 23                         inc hl
2897 13                         inc de
2898 FE 3A                      cp $3A
289A 28 08                      jr z,L28A4
289C FE 2F                      cp $2F
289E 28 04                      jr z,L28A4
28A0 FE 5C                      cp $5C
28A2 20 02                      jr nz,L28A6
28A4 C1            L28A4:       pop bc
28A5 E5                         push hl
28A6 3C            L28A6:       inc a
28A7 20 EB                      jr nz,L2894
28A9 E1                         pop hl
28AA E3                         ex (sp),hl
28AB E5                         push hl
28AC 3E 01                      ld a,$01
28AE CD B1 01                   call EntIdePath
28B1 E1                         pop hl
28B2 D1                         pop de
28B3 30 24                      jr nc,L28D9
28B5 7E            L28B5:       ld a,(hl)
28B6 FE 3A                      cp $3A
28B8 20 02                      jr nz,L28BC
28BA 36 5F                      ld (hl),$5F
28BC 23            L28BC:       inc hl
28BD 3C                         inc a
28BE 20 F5                      jr nz,L28B5
28C0 2B                         dec hl
28C1 F1                         pop af
28C2 F5                         push af
28C3 38 13                      jr c,L28D8
28C5 1A            L28C5:       ld a,(de)
28C6 77                         ld (hl),a
28C7 23                         inc hl
28C8 13                         inc de
28C9 3C                         inc a
28CA 20 F9                      jr nz,L28C5
28CC 2B                         dec hl
28CD 36 2E                      ld (hl),$2E
28CF 23                         inc hl
28D0 36 7B                      ld (hl),$7B
28D2 23                         inc hl
28D3 36 7D                      ld (hl),$7D
28D5 23                         inc hl
28D6 36 FF                      ld (hl),$FF
28D8 37            L28D8:       scf
28D9 EB            L28D9:       ex de,hl
28DA C1                         pop bc
28DB E1                         pop hl
28DC C9                         ret
28DD E5            L28DD:       push hl
28DE 23                         inc hl
28DF 23                         inc hl
28E0 23                         inc hl
28E1 7E            L28E1:       ld a,(hl)
28E2 FE 2F                      cp $2F
28E4 28 0B                      jr z,L28F1
28E6 FE 5C                      cp $5C
28E8 28 07                      jr z,L28F1
28EA 23            L28EA:       inc hl
28EB 3C                         inc a
28EC 20 F3                      jr nz,L28E1
28EE E1                         pop hl
28EF 37                         scf
28F0 C9                         ret
28F1 36 FF         L28F1:       ld (hl),$FF
28F3 E3                         ex (sp),hl
28F4 E5                         push hl
28F5 3E 02                      ld a,$02
28F7 CD B1 01                   call EntIdePath
28FA E1                         pop hl
28FB E3                         ex (sp),hl
28FC 36 2F                      ld (hl),$2F
28FE 38 EA                      jr c,L28EA
2900 FE 18                      cp $18
2902 28 E6                      jr z,L28EA
2904 D1                         pop de
2905 A7                         and a
2906 C9                         ret
2907 43                         ld b,e
2908 3A 2F 4E                   ld a,($4E2F)
290B 45                         ld b,l
290C 58                         ld e,b
290D 54                         ld d,h
290E 5A                         ld e,d
290F 58                         ld e,b
2910 4F                         ld c,a
2911 53                         ld d,e
2912 2F                         cpl
2913 4D                         ld c,l
2914 45                         ld b,l
2915 54                         ld d,h
2916 41                         ld b,c
2917 44                         ld b,h
2918 41                         ld b,c
2919 54                         ld d,h
291A 41                         ld b,c
291B 2F                         cpl
;
; Zero bytes ($13E0)
;
291C                            .fillb $13E0,$00

; Turn on ROM3
;

3CFC ED 91 8E 03   Rom3In:      nextreg $8E,$03
;
; Zero bytes ($100)
;
3D00                            .fillb $100,$00

; Call ROM0 routine. The address to call is specified in the stack.
;
3E00 ED 43 54 5B   CallRom0:    ld (TMPBC),bc
3E04 E3                         ex (sp),hl
3E05 4E                         ld c,(hl)
3E06 23                         inc hl
3E07 46                         ld b,(hl)
3E08 23                         inc hl
3E09 E3                         ex (sp),hl
3E0A ED 8A 3E 13                push $3E13
3E0E C5                         push bc
3E0F ED 4B 54 5B   L3E0F:       ld bc,(TMPBC)
;
; When a ROM2 routine called from ROM0 returns, this address is used. The nextreg
; statement switches back to ROM0. The next statement in ROM0 is a ret, and that 
; returns to the caller in ROM0.
;
3E13 ED 91 8E 00   RETT0:       nextreg $8E,$00
3E17 C9                         ret
;
;
;
3E18 ED 43 54 5B   L3E18:       ld (TMPBC),bc
3E1C E3                         ex (sp),hl
3E1D 4E                         ld c,(hl)
3E1E 23                         inc hl
3E1F 46                         ld b,(hl)
3E20 23                         inc hl
3E21 E3                         ex (sp),hl
3E22 ED 8A 3E 13                push $3E13
3E26 ED 8A 00 7B                push $007B
3E2A C5                         push bc
3E2B ED 8A 00 7B                push $007B
3E2F C3 0F 3E                   jp L3E0F
3E32 ED 43 54 5B                ld (TMPBC),bc
3E36 E3                         ex (sp),hl
3E37 4E                         ld c,(hl)
3E38 23                         inc hl
3E39 46                         ld b,(hl)
3E3A 23                         inc hl
3E3B E3                         ex (sp),hl
3E3C ED 8A 3F 13                push $3F13
3E40 ED 8A 00 7B                push $007B
3E44 C5                         push bc
3E45 ED 8A 00 7B                push $007B
3E49 C3 0F 3F                   jp L3F0F
3E4C E5            L3E4C:       push hl
3E4D C5                         push bc
3E4E 2E 56                      ld l,$56
3E50 01 3B 24                   ld bc,$243B
3E53 ED 69                      out (c),l
3E55 04                         inc b
3E56 ED 68                      in l,(c)
3E58 87                         add a,a
3E59 ED 92 56                   nextreg $56,a
3E5C 3C                         inc a
3E5D ED 92 57                   nextreg $57,a
3E60 7D                         ld a,l
3E61 CB 3F                      srl a
3E63 C1                         pop bc
3E64 E1                         pop hl
3E65 C9                         ret
;
; Zero bytes ($19A)
;
3E66                            .fillb $19A,$00
3F00 ED 43 54 5B   L3F00:       ld (TMPBC),bc
3F04 E3                         ex (sp),hl
3F05 4E                         ld c,(hl)
3F06 23                         inc hl
3F07 46                         ld b,(hl)
3F08 23                         inc hl
3F09 E3                         ex (sp),hl
3F0A ED 8A 3F 13                push $3F13
3F0E C5                         push bc
3F0F ED 4B 54 5B   L3F0F:       ld bc,(TMPBC)
3F13 ED 91 8E 01                nextreg $8E,$01
3F17 C9                         ret
;
; RST $08:
;
3F18 22 52 5B      L3F18:       ld (TMPHL),hl              ; Save HL
3F1B F5                         push af                    
3F1C E1                         pop hl
3F1D 22 56 5B                   ld ($5B56),hl              ; Save AF
3F20 E1                         pop hl                     ; HL := RST $08 return address
3F21 D5                         push de                    ; Save DE
3F22 7E                         ld a,(hl)                  ; A := (RetAddr)
3F23 23                         inc hl  
3F24 5E                         ld e,(hl)                  ; E := (RetAddr + 1)
3F25 23                         inc hl
3F26 56                         ld d,(hl)                  ; D := (RetAddr + 2)
3F27 23                         inc hl                 
3F28 E3                         ex (sp),hl                 ; Return address from RST $08: initial + 3
3F29 EB                         ex de,hl
3F2A E5            L3F2A:       push hl                    ; Push the address to call
3F2B 67                         ld h,a
3F2C ED 57                      ld a,i
3F2E 7C                         ld a,h
3F2F E1                         pop hl
3F30 F3                         di

;
;
;
3F31 F5            L3F31:       push af                    ; Save used registers
3F32 FD E5                      push iy
3F34 F5                         push af                    ; Save the last AF value
3F35 AF                         xor a                      ; A := 0, reset carry
3F36 D3 E3                      out ($E3),a                ; Map back ROM for $0000-$1fff
3F38 F1                         pop af                     ; Restore AF
3F39 ED 8A 04 48                push $0448                 ; Next return will use $448 in DivMMC ROM

; After this jump ROM3 gets paged in. PC reaches $3d00, so maps in the DivMMC ROM and DivMMC RAM Bank 0.
; Though $3D00 in ROM3 contains a nop, DivMMC RAM is set to contain a RET. As a result, the $0448 entry 
; point in the DivMMC ROM is used.
;
3F3D C3 FC 3C                   jp Rom3In                  ; Switch to ROM3
;
; ???
;
3F40 FD E1                      pop iy
3F42 E3                         ex (sp),hl
3F43 F5                         push af
3F44 CB 55                      bit 2,l
3F46 28 01                      jr z,L3F49
3F48 FB                         ei
3F49 F1            L3F49:       pop af
3F4A E1                         pop hl
3F4B C9                         ret
;
; Zero bytes ($B4)
;
3F4C                            .fillb $B4,$00
