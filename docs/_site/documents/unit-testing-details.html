<!DOCTYPE html>
<html lang="en-US">

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link rel="stylesheet" type="text/css" media="screen" href="/kliveide/assets/css/semantic.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/kliveide/assets/css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,400i,700,700i" rel="stylesheet">

    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Detailed Syntax | Klive IDE</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Detailed Syntax" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In the following section, I will use a kind of abstract syntax notation to describe the grammar of the SpectNetIde test language. Bold characters mark terminal symbols (keywords and other tokens), while italic strings ara non-terminal symbols. The ? after a symbol means that it’s optional. A * means zero, one, or more occurrence. + means one or more occurrence. The | character separates options, exactly one of them can be used. The language uses parantheses to specify groups of tokens." />
<meta property="og:description" content="In the following section, I will use a kind of abstract syntax notation to describe the grammar of the SpectNetIde test language. Bold characters mark terminal symbols (keywords and other tokens), while italic strings ara non-terminal symbols. The ? after a symbol means that it’s optional. A * means zero, one, or more occurrence. + means one or more occurrence. The | character separates options, exactly one of them can be used. The language uses parantheses to specify groups of tokens." />
<link rel="canonical" href="http://localhost:4000/kliveide/documents/unit-testing-details" />
<meta property="og:url" content="http://localhost:4000/kliveide/documents/unit-testing-details" />
<meta property="og:site_name" content="Klive IDE" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-05T00:00:00+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Detailed Syntax","dateModified":"2019-01-05T00:00:00+01:00","datePublished":"2019-01-05T00:00:00+01:00","url":"http://localhost:4000/kliveide/documents/unit-testing-details","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/kliveide/documents/unit-testing-details"},"description":"In the following section, I will use a kind of abstract syntax notation to describe the grammar of the SpectNetIde test language. Bold characters mark terminal symbols (keywords and other tokens), while italic strings ara non-terminal symbols. The ? after a symbol means that it’s optional. A * means zero, one, or more occurrence. + means one or more occurrence. The | character separates options, exactly one of them can be used. The language uses parantheses to specify groups of tokens.","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <!-- Header -->
    <div class="ui vertical stripe segment with-header-back">
      <div class="ui container high">
        <h1 class="ui header">Klive IDE</h1>
        <h3 class="ui header">Full-fledged ZX Spectrum IDE with Electron, VS Code</h2>
      </div>
    </div>

    <!-- Menu -->
    <div class="ui vertical stripe segment with-menu-back">
      <div class="ui container">
        <div class="ui menu with-menu-back">
          <a class="item" href="/kliveide/">Home</a>
          <a class=" item" href="/kliveide/getting-started/install-kliveide.html">Getting Started</a>
          <a class=" active  item" href="/kliveide/documents/main-features.html">Documents</a>
          <a class="item" href="/kliveide/spectrum/basic-toc.html">ZX Spectrum</a>
          <a class="item" target="_blank" href="https://github.com/Dotneteer/kliveide">GitHub</a>
        </div>
      </div>
    </div>

    <div class="ui vertical stripe segment with-content-back">
      <div class="ui container">
        <div class="ui grid">
          <div class="three wide computer sixteen wide mobile column">
            <div class="document-list">
              
              
              
              
              
                
                  
                  
                  
                  
                  <div class="document-category  collapsed " onclick="handleClick(this)">
                    <span class="category-name">Z80 Assembler</span>
                    <div class="extender  collapsed ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  hidden ">
                  
                    
                  
                    
                    <a id="main-features" class="" href="/kliveide/documents/main-features#article">Main Features</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="how-assembler-works" class="" href="/kliveide/documents/how-assembler-works#article">How the assembler works</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                    <a id="language-structure" class="" href="/kliveide/documents/language-structure#article">Language structure</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="labels" class="" href="/kliveide/documents/labels-and-symbols#article">Labels and Symbols</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="expressions" class="" href="/kliveide/documents/expressions#article">Expressions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="instructions" class="" href="/kliveide/documents/z80-instructions#article">Z80 Instructions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="pragmas" class="" href="/kliveide/documents/pragmas#article">Pragmas</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="statements" class="" href="/kliveide/documents/statements#article">Statements</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="macros" class="" href="/kliveide/documents/macros#article">Macros</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="directives" class="" href="/kliveide/documents/directives#article">Directives</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="modules" class="" href="/kliveide/documents/modules#article">Modules</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="structs" class="" href="/kliveide/documents/structs#article">Structures</a>
                      
                      
                      
                    
                  
                    
                    <a id="assembler-output" class="" href="/kliveide/documents/assembler-output#article">Assembler Output</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                  <div class="document-category  collapsed " onclick="handleClick(this)">
                    <span class="category-name">Tool Commands</span>
                    <div class="extender  collapsed ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  hidden ">
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="tool-overview" class="" href="/kliveide/documents/tool-overview#article">Overview</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="memory-commands" class="" href="/kliveide/documents/common-commands#article">Common Commands</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="memory-section-commands" class="" href="/kliveide/documents/memory-section-commands#article">Disassembly: Memory Sections</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="annotation-commands" class="" href="/kliveide/documents/annotation-commands#article">Disassembly: Annotations</a>
                      
                      
                      
                    
                  
                    
                    <a id="breakpoint-commands" class="" href="/kliveide/documents/breakpoint-commands#article">Disassembly: Breakpoints</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="miscellaneous-commands" class="" href="/kliveide/documents/miscellaneous-commands#article">Disassembly: Miscellaneous</a>
                      
                      
                      
                    
                  
                    
                    <a id="watch-commands" class="" href="/kliveide/documents/tape-explorer-commands#article">Tape Explorer Commands</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="watch-commands" class="" href="/kliveide/documents/watch-commands#article">Watch Commands</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="watch-expressions" class="" href="/kliveide/documents/watch-expressions#article">Watch Expressions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                    <a id="watch-samples" class="" href="/kliveide/documents/watch-samples#article">Watch Samples</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                  <div class="document-category  collapsed " onclick="handleClick(this)">
                    <span class="category-name">Scripting</span>
                    <div class="extender  collapsed ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  hidden ">
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-overview" class="" href="/kliveide/documents/scripting-overview#article">Overview</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-object-model" class="" href="/kliveide/documents/scripting-object-model#article">Scripting Object Model</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-vms" class="" href="/kliveide/documents/scripting-vms#article">Managing Virtual machines</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-z80" class="" href="/kliveide/documents/scripting-z80#article">Scripting the Z80 CPU</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-screen" class="" href="/kliveide/documents/scripting-screen#article">Scripting the Screen</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-memory" class="" href="/kliveide/documents/scripting-memory#article">Scripting the Memory</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-audio" class="" href="/kliveide/documents/scripting-audio#article">Scripting the Audio</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                  <div class="document-category  expanded " onclick="handleClick(this)">
                    <span class="category-name">Unit Testing</span>
                    <div class="extender  expanded ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  displayed ">
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="unit-testing-basics" class="" href="/kliveide/documents/unit-testing-basics#article">Syntax Basics</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="unit-testing-expressions" class="" href="/kliveide/documents/unit-testing-expressions#article">Expressions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="unit-testing-details" class=" active " href="/kliveide/documents/unit-testing-details#article">Detailed Syntax</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="unit-testing-process" class="" href="/kliveide/documents/unit-testing-process#article">The Testing Process</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
            </div>
          </div>
          <div class="thirteen wide computer sixteen wide mobile column with-main-back">
            <div id="#article" class="main-title-area">
              <h1>Unit Testing &raquo; Detailed Syntax</h1>
            </div>
            <div class="main-content-area">
              <p>In the following section, I will use a kind of abstract syntax notation to describe the grammar of the 
SpectNetIde test language. Bold characters mark terminal symbols (keywords and other tokens), while 
italic strings ara non-terminal symbols. The <code class="highlighter-rouge">?</code> after a symbol means that it’s optional. A <code class="highlighter-rouge">*</code> 
means zero, one, or more occurrence. <code class="highlighter-rouge">+</code> means one or more occurrence. The <code class="highlighter-rouge">|</code> character separates options, exactly one of them can be used.
The language uses parantheses to specify groups of tokens.</p>

<h2 id="compilation-units">Compilation Units</h2>

<p>Each file is a compilation unit that contains zero, one, or more test sets:</p>

<p><em><code class="highlighter-rouge">compileUnit:</code></em> <em><code class="highlighter-rouge">testSet*</code></em></p>

<h2 id="test-sets">Test Sets</h2>

<p><em><code class="highlighter-rouge">testSet:</code>** 
    <strong>testset</strong> *<code class="highlighter-rouge">identifier</code></em> <strong>{</strong><br />
    <em><strong>sp48mode</strong> *<code class="highlighter-rouge">?</code></em><br />
    <em><code class="highlighter-rouge">sourceContext</code></em><br />
    <em><code class="highlighter-rouge">callstub?</code></em><br />
    <em><code class="highlighter-rouge">dataBlock?</code></em><br />
    <em><code class="highlighter-rouge">initSettings?</code></em><br />
    <em><code class="highlighter-rouge">testBlock*</code></em><br />
    <strong>}</strong></p>

<h3 id="using-sp48mode">Using sp48mode</h3>

<p>When you work with Spectrum 128K, Spectrum ++, or Spectrum Next, you can specify that you intend to
start the Spectrum virtual machine in Spectrum 48K mode:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testset Introduction
{
    sp48mode;
    source "../Z80CodeFiles/CodeSamples.z80asm";
    // ...
}
</code></pre></div></div>

<p>In this mode, you can be sure that the Spectrum 48K ROM is paged into the <code class="highlighter-rouge">#0000</code>-<code class="highlighter-rouge">#3FFF</code> address range,
and memory paging is forbidden —, and thus, the test behaves exactly as if it were run on a Spectrum 48K model.</p>

<h3 id="the-source-context">The Source Context</h3>

<p><em><code class="highlighter-rouge">sourceContext:</code></em>	 <strong>source</strong> <em><code class="highlighter-rouge">string</code></em> <em><code class="highlighter-rouge">(</code></em> <strong>symbols</strong> <em><code class="highlighter-rouge">identifier+)?</code></em> <strong>;</strong></p>

<p>Each test set is named with a unique identifier. The only mandatory element of a <strong>testset</strong> declaration is 
the source context that names the source file used within the test set. You can add optional conditional symbols
that to compile the source code. Here are a few samples:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testset MyFirstSet
{
    source "../Z80CodeFiles/CodeSamples.z80asm";
}

testset MySecondSet
{
    source "../Z80CodeFiles/CodeSamples.z80asm" symbols DEBUG SP128;
}
</code></pre></div></div>

<p>Both test sets use the <code class="highlighter-rouge">../Z80CodeFiles/CodeSamples.z80asm</code> source code file (path relative to the test file).
Nonetheless, <code class="highlighter-rouge">MySecondSet</code> passes the <code class="highlighter-rouge">DEBUG</code> and <code class="highlighter-rouge">SP128</code> pre-defined symbols to the Z80 Assembler.</p>

<p>The test engine recognizes the symbols you declare in the source context. For example, if you has a <code class="highlighter-rouge">MyRoutine</code> 
symbol in the source code, you can use it within the test file. The compiler will understand it, and replaces the
symbol with its value.</p>

<h3 id="the-callstub-option">The Callstub Option</h3>

<p><em><code class="highlighter-rouge">callstub:</code></em>	<strong>callstub</strong> <em><code class="highlighter-rouge">expr</code></em> <strong>;</strong></p>

<p>This option defines the address to use for a three-byte call stub when running unit tests. You will learn about 
this option later when I treat the semantics of test execution.</p>

<h3 id="defining-data-blocks">Defining Data Blocks</h3>

<p>A test set’s data block is to define values and byte array patterns that represent a block of the memory. Data block 
entries have unique identifiers you can use in the tests to reference them.</p>

<p><em><code class="highlighter-rouge">dataBlock:</code></em>	<strong>data</strong> <strong>{</strong> <em><code class="highlighter-rouge">dataBlockBody*</code></em> <strong>}</strong> <strong>;</strong><em><code class="highlighter-rouge">?</code></em><br />
<em><code class="highlighter-rouge">dataBlockBody:</code></em> <em><code class="highlighter-rouge">valueDef</code></em> | <em><code class="highlighter-rouge">memPattern</code></em> 
<em><code class="highlighter-rouge">valueDef:</code></em>	<em><code class="highlighter-rouge">identifier</code></em> <strong>:</strong> <em><code class="highlighter-rouge">expr</code></em> <strong>;</strong><br />
<em><code class="highlighter-rouge">memPattern:</code></em> <em><code class="highlighter-rouge">identifier</code></em> <strong>{</strong> <em><code class="highlighter-rouge">memPatternBody+</code></em> <strong>}</strong> | <em><code class="highlighter-rouge">identifier</code></em> <strong>:</strong> <em><code class="highlighter-rouge">text</code></em><br />
<em><code class="highlighter-rouge">memPatternBody:</code></em> <em><code class="highlighter-rouge">(byteSet</code></em> | <em><code class="highlighter-rouge">wordSet</code></em> | <em><code class="highlighter-rouge">text)</code></em><br />
<em><code class="highlighter-rouge">byteSet:</code></em> ( <strong>byte</strong><em><code class="highlighter-rouge">?</code></em>) <em><code class="highlighter-rouge">expr</code></em> ( <strong>,</strong> <em><code class="highlighter-rouge">expr</code></em>)<em><code class="highlighter-rouge">*</code></em> <strong>;</strong><br />
<em><code class="highlighter-rouge">wordSet:</code></em> ( <strong>word</strong><em><code class="highlighter-rouge">?</code></em>) <em><code class="highlighter-rouge">expr</code></em> ( <strong>,</strong> <em><code class="highlighter-rouge">expr</code></em>)<em><code class="highlighter-rouge">*</code></em> <strong>;</strong><br />
<em><code class="highlighter-rouge">text:</code></em> ( <strong>text</strong> *<code class="highlighter-rouge">?*</code> ) *<code class="highlighter-rouge">string*</code> <strong>;</strong></p>

<p>As the abstract syntax notation shows, it’s pretty easy to define values:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data
{
     four: 1 + 3;
     helloWorld: "hello";
}
</code></pre></div></div>

<p>Here, the <code class="highlighter-rouge">four</code> identifier represents the constant 4; <code class="highlighter-rouge">helloWorld</code> represents an array of 5 bytes, each 
byte stands for the corresponding character.</p>

<p>You can define more complex byte arrays with the <code class="highlighter-rouge">byte</code>, <code class="highlighter-rouge">word</code>, and optional <code class="highlighter-rouge">text</code> keywords:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data
{
    myMemBlock
    {
        byte #12, #34, #36;
        word #AC38, #23;
        "012"; 
    }
}
</code></pre></div></div>

<p>Here, <code class="highlighter-rouge">myMemblock</code> is a 10 bytes long array with these values:
#12, #34, #36, #38, #AC, #23, #00, #30, #31, #32.</p>

<blockquote>
  <p>Observe, words are stored in LSB/MSB order. The word #23 is two bytes: #23 and #00.</p>
</blockquote>

<h3 id="test-set-initialization-settings">Test Set Initialization Settings</h3>

<p>Before running tests, you can initialize a test set by assigning values to Z80 registers, 
setting or reseting flags, copying values into the memory.</p>

<p><em><code class="highlighter-rouge">initSettings:</code></em>	<strong>init</strong> <strong>{</strong> <em><code class="highlighter-rouge">assignment+</code></em> <strong>}</strong><br />
<em><code class="highlighter-rouge">assignment:</code></em> ( <em><code class="highlighter-rouge">regAssignment</code></em> | <em><code class="highlighter-rouge">flagStatus</code></em> | <em><code class="highlighter-rouge">memAssignment</code></em> ) <strong>;</strong><br />
<em><code class="highlighter-rouge">regAssignment:</code></em>  <em><code class="highlighter-rouge">registerSpec</code></em> <strong>:</strong> <em><code class="highlighter-rouge">expr</code></em><br />
<em><code class="highlighter-rouge">registerSpec:</code></em> <strong>a</strong> | <strong>A</strong> | <strong>b</strong> | <strong>B</strong> | <strong>c</strong> | <strong>C</strong> | <strong>d</strong> | <strong>D</strong><br />
    | <strong>e</strong> | <strong>E</strong>	| <strong>h</strong> | <strong>H</strong> | <strong>l</strong> | <strong>L</strong> | <strong>xl</strong> | <strong>XL</strong><br />
    | <strong>xh</strong> | <strong>XH</strong> |	<strong>yl</strong> | <strong>YL</strong> | <strong>yh</strong> | <strong>YH</strong> |	<strong>ixl</strong>| <strong>IXL</strong> | <strong>IXl</strong><br />
    | <strong>ixh</strong>| <strong>IXH</strong> | <strong>IXh</strong> | <strong>iyl</strong> | <strong>IYL</strong> | <strong>IYl</strong> | <strong>iyh</strong> | <strong>IYH</strong> | <strong>IYh</strong><br />
    | <strong>i</strong> | <strong>I</strong> | <strong>r</strong> | <strong>R</strong> | <strong>bc</strong> | <strong>BC</strong> |	<strong>de</strong> | <strong>DE</strong><br />
    | <strong>hl</strong> | <strong>HL</strong> | <strong>sp</strong> | <strong>SP</strong> | <strong>ix</strong> | <strong>IX</strong> | <strong>iy</strong> | <strong>IY</strong><br />
    | <strong>af’</strong> | <strong>AF’</strong> | <strong>bc’</strong> | <strong>BC’</strong>	| <strong>de’</strong> | <strong>DE’</strong> | <strong>hl’</strong> | <strong>HL’</strong><br />
<em><code class="highlighter-rouge">flagStatus:</code></em> <strong>.z</strong> | <strong>.Z</strong> | <strong>.nz</strong> | <strong>.NZ</strong> |	<strong>.c</strong> | <strong>.C</strong> | <strong>.nc</strong> | <strong>.NC</strong><br />
    | <strong>.pe</strong> | <strong>.PE</strong> | <strong>.po</strong> | <strong>.PO</strong>	| <strong>.p</strong> | <strong>.P</strong> | <strong>.m</strong> | <strong>.M</strong><br />
    | <strong>.n</strong>| <strong>.N</strong> | <strong>.a</strong> | <strong>.A</strong> | <strong>.h</strong> | <strong>.H</strong> | <strong>.nh</strong> | <strong>.NH</strong><br />
    | <strong>.3</strong> | <strong>.n3</strong> | <strong>.N3</strong> | <strong>.5</strong> | <strong>.n5</strong>| <strong>.N5</strong><br />
<em><code class="highlighter-rouge">memAssignment:</code></em>	 <strong>[</strong> <em><code class="highlighter-rouge">expr</code></em> <strong>]</strong> <strong>:</strong> <em><code class="highlighter-rouge">expr</code></em> ( <strong>:</strong> <em><code class="highlighter-rouge">expr</code></em>)<em><code class="highlighter-rouge">?</code></em></p>

<p>Here is a short sample:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>init
{
    bc: 0;
    hl: CustomBuffer;
    .z;
    .nc;
    [#4000]: myLogoArray;
}
</code></pre></div></div>

<p>This <code class="highlighter-rouge">init</code> declaration sets the valuu of the <strong>BC</strong> and <strong>HL</strong> register pairs to <code class="highlighter-rouge">0</code>, and <code class="highlighter-rouge">CustomBuffer</code>, respectively.
The Zero flag is set, while Carry is reset. The declaration copies the contents of the <code class="highlighter-rouge">myLogoArray</code> to the <code class="highlighter-rouge">#4000</code> address.</p>

<p>With an alternative <code class="highlighter-rouge">memAssignment</code> syntax, you can declare the length of a byte array before copying it into the memory.
For example, the following code snippet copies only the first 32 bytes to the <code class="highlighter-rouge">#4000</code> address:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>init
{
    [#4000]: myLogoArray:32;
}
</code></pre></div></div>

<h2 id="test-blocks">Test Blocks</h2>

<p>You can declare default and parameterized test cases within test blocks:</p>

<p><em><code class="highlighter-rouge">testBlock:</code></em>	<strong>test</strong> <em><code class="highlighter-rouge">identifier</code></em> <strong>{</strong><br />
    ( <strong>category</strong> <em><code class="highlighter-rouge">identifier</code></em> <strong>;</strong>) <em><code class="highlighter-rouge">?</code></em><br />
    <em><code class="highlighter-rouge">testOptions?</code></em><br />
    <em><code class="highlighter-rouge">setupCode?</code></em><br />
    <em><code class="highlighter-rouge">testParams?</code></em><br />
    <em><code class="highlighter-rouge">testCase*</code></em><br />
    <em><code class="highlighter-rouge">arrange?*</code></em><br />
    <em><code class="highlighter-rouge">act</code></em><br />
    <em><code class="highlighter-rouge">assert?</code></em><br />
    <em><code class="highlighter-rouge">cleanupCode?</code></em><br />
    <strong>}</strong></p>

<p>Each test must have a uniuque indentifier, and may declare a category, which is reserved for future extension. Of course,
multiple tests may have the same category. The only required part of a test is the <code class="highlighter-rouge">act</code> declaration that describes what code
to run within the test.</p>

<h3 id="test-options">Test Options</h3>

<p>Tests may have options the engine uses when running them:</p>

<p><em><code class="highlighter-rouge">testOptions:</code></em> <strong>with</strong> <em><code class="highlighter-rouge">testOption</code></em> ( <strong>,</strong> <em><code class="highlighter-rouge">testOption</code></em>)<em><code class="highlighter-rouge">*</code></em> <strong>;</strong><br />
<em><code class="highlighter-rouge">testOption:</code></em> <strong>timeout</strong> <em><code class="highlighter-rouge">expr</code></em> | <strong>di</strong> | <strong>ei</strong></p>

<p>The timeout option sets the timeout value for the specified test. When it expires, the engine aborts the test, and thus 
you can even create code with infinite loops, it does not freezes the test engine.</p>

<blockquote>
  <p>The default timeout value in 100 milliseconds.</p>
</blockquote>

<p>With the <code class="highlighter-rouge">ei</code> and <code class="highlighter-rouge">di</code> options you can enable or disable interrupts explicitly before running any code. These 
options are just helpers. For tighter control, use the <code class="highlighter-rouge">EI</code> and <code class="highlighter-rouge">DI</code> Z80 instructions explicitly in your code.</p>

<blockquote>
  <p>By default, interrupts are enabled.</p>
</blockquote>

<p>The following options run a test case with 40 milliseconds of timeout and disable the interrupt before starting the code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>with timeout 40, di;
</code></pre></div></div>

<h3 id="running-code-in-tests">Running Code in Tests</h3>

<p>You can declare three kinds of code to run in a single test. Setup code runs once before each test cases, Cleanup code once 
after all cases completed (either successfully or failed). The Act code runs for every test cases.</p>

<p><em><code class="highlighter-rouge">setupCode:</code></em> <strong>setup</strong> <em><code class="highlighter-rouge">invokeCode</code></em> <strong>;</strong><br />
<em><code class="highlighter-rouge">act:</code></em> <strong>act</strong> <em><code class="highlighter-rouge">invokeCode</code></em> <strong>;</strong><br />
<em><code class="highlighter-rouge">cleanupCode:</code></em> <strong>cleanup</strong> <em><code class="highlighter-rouge">invokeCode</code></em> <strong>;</strong><br />
<em><code class="highlighter-rouge">invokeCode:</code></em> <strong>call</strong> <em><code class="highlighter-rouge">expr</code></em> | <strong>start</strong> <em><code class="highlighter-rouge">expr</code></em> ( <strong>stop</strong> <em><code class="highlighter-rouge">expr</code></em> | <strong>halt</strong> )</p>

<p>You have three ways to invoke code:</p>
<ul>
  <li><strong><code class="highlighter-rouge">call</code></strong> uses the Z80 <code class="highlighter-rouge">CALL</code> instruction to call the code with the specified address. Your code should have 
a <code class="highlighter-rouge">RET</code> instruction. When the code successfully executes the <code class="highlighter-rouge">RET</code> statement, the engine completes the test code.</li>
  <li>With the <strong><code class="highlighter-rouge">start</code></strong> and <strong><code class="highlighter-rouge">stop</code></strong> combination, you can explicitly specify a start and a stop address. The engine jumps
to the start address, and completes the test code as soon as it reaches the stop address. It does not executes the instruction
at the stop address.</li>
  <li>With the <strong><code class="highlighter-rouge">start</code></strong> and <strong><code class="highlighter-rouge">halt</code></strong> combination the test engine starts the code at the specified address, and completes it
when it reaches a <code class="highlighter-rouge">HALT</code> statement.</li>
</ul>

<h3 id="test-parameters-and-test-cases">Test Parameters and Test Cases</h3>

<p>You can define parameterized test cases. You name test parameters, and test cases declare values to substitute a
particular parameter:</p>

<p><em><code class="highlighter-rouge">testParams:</code></em> <strong>params</strong> <em><code class="highlighter-rouge">identifier</code></em> ( <strong>,</strong> <em><code class="highlighter-rouge">identifier</code></em>) <em><code class="highlighter-rouge">*</code></em> <strong>;</strong><br />
<em><code class="highlighter-rouge">testCase:</code></em> <strong>case</strong> <em><code class="highlighter-rouge">expr</code></em> ( <strong>,</strong> <em><code class="highlighter-rouge">expr</code></em>) <em><code class="highlighter-rouge">*</code></em> <strong>;</strong></p>

<p>Of course, the number of parameters and expressions after the <code class="highlighter-rouge">case</code> keyword must match for each test cases.</p>

<blockquote>
  <p>Soon, you will see a complete sample that demonstrates these concepts.</p>
</blockquote>

<h3 id="arrange-declarations">Arrange Declarations</h3>

<p>Each test block has an <code class="highlighter-rouge">arrange</code> declaration that runs before the engine invokes the <code class="highlighter-rouge">act</code> code of a test case.
It has the same assignment syntax, as the <code class="highlighter-rouge">init</code> construct of a test set:</p>

<p><em><code class="highlighter-rouge">arrange:</code></em> <strong>arrange</strong> <strong>{</strong> <em><code class="highlighter-rouge">assignment+</code></em> <strong>}</strong></p>

<h3 id="assertions">Assertions</h3>

<p>After the test code ran, you can run assertions. Assertions are a list of Boolean expressions, and the test engine 
evaluates them in their declaration order. All of them should be true to make the test case successful:</p>

<p><em><code class="highlighter-rouge">assert:</code></em> <strong>assert</strong> <strong>{</strong> ( <em><code class="highlighter-rouge">expr</code></em> <strong>;</strong>)*<code class="highlighter-rouge">+*</code> <strong>}</strong></p>

<p>You can use special assertion expressions:</p>

<p><em><code class="highlighter-rouge">addrSpec:</code></em> <strong>[</strong> <em><code class="highlighter-rouge">expr</code></em> ( <strong>..</strong> <em><code class="highlighter-rouge">expr</code></em>) <em><code class="highlighter-rouge">?</code></em> <strong>]</strong><br />
<em><code class="highlighter-rouge">reachSpec:</code></em> <strong>&lt;.</strong> <em><code class="highlighter-rouge">expr</code></em> ( <strong>..</strong> <em><code class="highlighter-rouge">expr</code></em>) <em><code class="highlighter-rouge">?</code></em> <strong>.&gt;</strong><br />
<em><code class="highlighter-rouge">memReadSpec:</code></em> <strong>&lt;|</strong> <em><code class="highlighter-rouge">expr</code></em> ( <strong>..</strong> <em><code class="highlighter-rouge">expr</code></em>) <em><code class="highlighter-rouge">?</code></em> <strong>|&gt;</strong><br />
<em><code class="highlighter-rouge">memWriteSpec:</code></em> <strong>&lt;||</strong> <em><code class="highlighter-rouge">expr</code></em> ( <strong>..</strong> <em><code class="highlighter-rouge">expr</code></em>) <em><code class="highlighter-rouge">?</code></em> <strong>||&gt;</strong></p>

<p>These assertions retrieves a byte array. This may contain only a single byte (only one address specified)
or a sequence of bytes (both a start address and an inclusive end address is specified).</p>

<p>An <code class="highlighter-rouge">addrSpec</code> retrives the contenst of memory specified by the address range. Each byte in the array is the
copy of the corresponding memory address.</p>

<p>In the <code class="highlighter-rouge">reachSpec</code> byte array each byte indicates if the test’s control flow reached that address 
(the instruction at that address was executed) with a Boolean value. Similarly, the arrays retrieved by 
<code class="highlighter-rouge">memReadSpec</code> and <code class="highlighter-rouge">memWriteSpec</code> indicate if the specified memory address was read, or written, respectively.</p>

<p>Let’s see an example of using these assertions:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testset Introduction
{
    source "../Z80CodeFiles/CodeSamples.z80asm";
    data
    {
        str100: "00100";
        str1000:  "001000";
        str12345: "12345";
        str11211: "11211";
        str23456: "23456";
    }

    test BufferIncEachByteWorks
    {
        params value, result;
        case str100, str11211;
        case str12345, str23456;
        case str1000, str11211;
        arrange
        {
            hl: ConversionBuffer;
            b: 5;
            [ConversionBuffer]:value;
        }

        act call IncLoop;

        assert
        {
            [ConversionBuffer..ConversionBuffer+4] == result;
            &lt;. IncLoop .&gt;;
            &lt;| ConversionBuffer .. ConversionBuffer + 4 |&gt;;
            &lt;|| ConversionBuffer .. ConversionBuffer + 4 ||&gt;;
        }
    }
}
</code></pre></div></div>

<p>Here, the <code class="highlighter-rouge">IncLoop</code> method accepts a bufferr address in <strong>HL</strong> and 
a byte count in <strong>B</strong>. <code class="highlighter-rouge">IncLoop</code> increments each byte by 1 within the
buffer. As you can see, the assert section checks these conditions:</p>
<ul>
  <li>The contents of the conversion buffer is the one specified in <code class="highlighter-rouge">result</code>.</li>
  <li>The code executions reaches the <code class="highlighter-rouge">IncLoop</code> address.</li>
  <li>The contents of the buffer (5 bytes starting from <code class="highlighter-rouge">ConversionBuffer</code>) is read.</li>
  <li>The contents of the buffer is written.</li>
</ul>

<h3 id="test-sample">Test Sample</h3>

<p>Here is a short sample that demonstrates the concepts you learned:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testset Introduction
{
    source "../Z80CodeFiles/CodeSamples.z80asm";

    test AddAAndBCallWorksAsExpected
    {
        params parA, parB, parExpected;
        case 1, 2, 3;
        case 2, 3, 5;
        case 6, 8, 14;

        arrange
        {
            a: parA;
            b: parB;
        }

        act call AddAAndB;

        assert 
        {
            a == parExpected;
        }
    }

    test AddAAndBWithStartWorksAsExpected
    {
        arrange
        {
            a: 3;
            b: 5;
        }

        act start AddAAndBWithStop stop StopPoint;

        assert 
        {
            a == 8;
        }
    }
}
</code></pre></div></div>

<p>The code file behind this test is the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Start:
	.org #8000

; You can invoke this test with 'call AddAAndB'
AddAAndB:
    add a,b
    ret

; You can invoke this test with 'start AddAAndBWithStop stop StopPoint'
AddAAndBWithStop:
    add a,b
StopPoint:
    nop
</code></pre></div></div>

<p>The first test, <code class="highlighter-rouge">AddAAndBCallWorksAsExpected</code>, has three test cases with parameters <code class="highlighter-rouge">parA</code>, <code class="highlighter-rouge">parB</code>, 
and <code class="highlighter-rouge">parExpected</code>, respectively. The engine executes each test case with these steps:</p>
<ul>
  <li>Sets the <strong>A</strong> and <strong>B</strong> CPU registers with the current value of <code class="highlighter-rouge">parA</code> and <code class="highlighter-rouge">parB</code>. For the first case, 
these are 1, and 2. The second case runs with 2, and 3.</li>
  <li>Calls the <code class="highlighter-rouge">AddAAndB</code> subroutine, that executes the <code class="highlighter-rouge">add a,b</code> instruction, and then completes the 
call with <code class="highlighter-rouge">RET</code></li>
  <li>Checks if the content of <strong>A</strong> equals with the expected result, as declared in <code class="highlighter-rouge">parExpected</code>.</li>
</ul>

<p>The second test has only a default case. It sets up <strong>A</strong> and <strong>B</strong> explicitly in the <code class="highlighter-rouge">arrange</code> section 
and checks the result in <code class="highlighter-rouge">assert</code>. You can observe that it does not call into the code, instead, it the test 
jumps to the <code class="highlighter-rouge">AddAAndBWithStop</code> address, and completes when it reaches <code class="highlighter-rouge">StopPoint</code>.</p>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer  -->
    <div class="ui vertical stripe segment with-header-back">
        <footer class="ui container">
          <p>&copy; Istvan Novak, 2020</p>
        </footer>
      </div>
  
    <!-- Floating return to top button -->
    <a href="javascript:" id="return-to-top">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    
    <!-- Floating go to previous button -->
    <a href="/kliveide/documents/unit-testing-expressions#article" id="go-to-prev">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" transform="rotate(-90)">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    
    
    <!-- Floating go to next button -->
    <a href="/kliveide/documents/unit-testing-process#article" id="go-to-next">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" transform="rotate(90)">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    

    <script>
      window.addEventListener("scroll", function(){
        var scrolled = window.pageYOffset > 50;
        document.getElementById("return-to-top").style.display = scrolled ? "block" : "none";
        var prevEl = document.getElementById("go-to-prev");
        if (prevEl) prevEl.style.display = scrolled ? "block" : "none";
        var nextEl = document.getElementById("go-to-next");
        if (nextEl) nextEl.style.display = scrolled ? "block" : "none";
      });
      var intervalId = 0;
      var $scrollButton = document.querySelector('#return-to-top');
      function scrollStep() {
        if (window.pageYOffset === 0) {
          clearInterval(intervalId);
        }
        window.scroll(0, window.pageYOffset - 50);
      }
      function scrollToTop() {
        intervalId = setInterval(scrollStep, 6.66);
      }
      $scrollButton.addEventListener('click', scrollToTop);

      function handleClick(arg) {
        var nextEl = arg.nextElementSibling;
        var extEl = arg.children[1];
        if (arg.classList.contains("expanded")) {
          arg.classList.remove("expanded");
          arg.classList.add("collapsed");
          extEl.classList.remove("expanded");
          extEl.classList.add("collapsed");
          nextEl.classList.remove("displayed")
          nextEl.classList.add("hidden")
        } else {
          arg.classList.remove("collapsed");
          arg.classList.add("expanded");
          extEl.classList.remove("collapsed");
          extEl.classList.add("expanded");
          nextEl.classList.remove("hidden")
          nextEl.classList.add("displayed")
        }
      }
    </script>

    
  </body>
</html>