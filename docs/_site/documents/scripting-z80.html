<!DOCTYPE html>
<html lang="en-US">

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link rel="stylesheet" type="text/css" media="screen" href="/kliveide/assets/css/semantic.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/kliveide/assets/css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,400i,700,700i" rel="stylesheet">

    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Scripting the Z80 CPU | Klive IDE</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Scripting the Z80 CPU" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The CpuZ80 class" />
<meta property="og:description" content="The CpuZ80 class" />
<link rel="canonical" href="http://localhost:4000/kliveide/documents/scripting-z80" />
<meta property="og:url" content="http://localhost:4000/kliveide/documents/scripting-z80" />
<meta property="og:site_name" content="Klive IDE" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-04T00:00:00+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Scripting the Z80 CPU","dateModified":"2019-01-04T00:00:00+01:00","datePublished":"2019-01-04T00:00:00+01:00","url":"http://localhost:4000/kliveide/documents/scripting-z80","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/kliveide/documents/scripting-z80"},"description":"The CpuZ80 class","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <!-- Header -->
    <div class="ui vertical stripe segment with-header-back">
      <div class="ui container high">
        <h1 class="ui header">Klive IDE</h1>
        <h3 class="ui header">Full-fledged ZX Spectrum IDE with Electron, VS Code</h2>
      </div>
    </div>

    <!-- Menu -->
    <div class="ui vertical stripe segment with-menu-back">
      <div class="ui container">
        <div class="ui menu with-menu-back">
          <a class="item" href="/kliveide/">Home</a>
          <a class=" item" href="/kliveide/getting-started/install-kliveide.html">Getting Started</a>
          <a class=" active  item" href="/kliveide/documents/main-features.html">Documents</a>
          <a class="item" href="/kliveide/spectrum/basic-toc.html">ZX Spectrum</a>
          <a class="item" target="_blank" href="https://github.com/Dotneteer/kliveide">GitHub</a>
        </div>
      </div>
    </div>

    <div class="ui vertical stripe segment with-content-back">
      <div class="ui container">
        <div class="ui grid">
          <div class="three wide computer sixteen wide mobile column">
            <div class="document-list">
              
              
              
              
              
                
                  
                  
                  
                  
                  <div class="document-category  collapsed " onclick="handleClick(this)">
                    <span class="category-name">Z80 Assembler</span>
                    <div class="extender  collapsed ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  hidden ">
                  
                    
                  
                    
                    <a id="main-features" class="" href="/kliveide/documents/main-features#article">Main Features</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="how-assembler-works" class="" href="/kliveide/documents/how-assembler-works#article">How the assembler works</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                    <a id="language-structure" class="" href="/kliveide/documents/language-structure#article">Language structure</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="labels" class="" href="/kliveide/documents/labels-and-symbols#article">Labels and Symbols</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="expressions" class="" href="/kliveide/documents/expressions#article">Expressions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="instructions" class="" href="/kliveide/documents/z80-instructions#article">Z80 Instructions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="pragmas" class="" href="/kliveide/documents/pragmas#article">Pragmas</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="statements" class="" href="/kliveide/documents/statements#article">Statements</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="macros" class="" href="/kliveide/documents/macros#article">Macros</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="directives" class="" href="/kliveide/documents/directives#article">Directives</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="modules" class="" href="/kliveide/documents/modules#article">Modules</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="structs" class="" href="/kliveide/documents/structs#article">Structures</a>
                      
                      
                      
                    
                  
                    
                    <a id="assembler-output" class="" href="/kliveide/documents/assembler-output#article">Assembler Output</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                  <div class="document-category  collapsed " onclick="handleClick(this)">
                    <span class="category-name">Tool Commands</span>
                    <div class="extender  collapsed ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  hidden ">
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="tool-overview" class="" href="/kliveide/documents/tool-overview#article">Overview</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="memory-commands" class="" href="/kliveide/documents/common-commands#article">Common Commands</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="memory-section-commands" class="" href="/kliveide/documents/memory-section-commands#article">Disassembly: Memory Sections</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="annotation-commands" class="" href="/kliveide/documents/annotation-commands#article">Disassembly: Annotations</a>
                      
                      
                      
                    
                  
                    
                    <a id="breakpoint-commands" class="" href="/kliveide/documents/breakpoint-commands#article">Disassembly: Breakpoints</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="miscellaneous-commands" class="" href="/kliveide/documents/miscellaneous-commands#article">Disassembly: Miscellaneous</a>
                      
                      
                      
                    
                  
                    
                    <a id="watch-commands" class="" href="/kliveide/documents/tape-explorer-commands#article">Tape Explorer Commands</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="watch-commands" class="" href="/kliveide/documents/watch-commands#article">Watch Commands</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="watch-expressions" class="" href="/kliveide/documents/watch-expressions#article">Watch Expressions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                    <a id="watch-samples" class="" href="/kliveide/documents/watch-samples#article">Watch Samples</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                  <div class="document-category  expanded " onclick="handleClick(this)">
                    <span class="category-name">Scripting</span>
                    <div class="extender  expanded ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  displayed ">
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-overview" class="" href="/kliveide/documents/scripting-overview#article">Overview</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-object-model" class="" href="/kliveide/documents/scripting-object-model#article">Scripting Object Model</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-vms" class="" href="/kliveide/documents/scripting-vms#article">Managing Virtual machines</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-z80" class=" active " href="/kliveide/documents/scripting-z80#article">Scripting the Z80 CPU</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-screen" class="" href="/kliveide/documents/scripting-screen#article">Scripting the Screen</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-memory" class="" href="/kliveide/documents/scripting-memory#article">Scripting the Memory</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="scripting-audio" class="" href="/kliveide/documents/scripting-audio#article">Scripting the Audio</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                  <div class="document-category  collapsed " onclick="handleClick(this)">
                    <span class="category-name">Unit Testing</span>
                    <div class="extender  collapsed ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  hidden ">
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="unit-testing-basics" class="" href="/kliveide/documents/unit-testing-basics#article">Syntax Basics</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="unit-testing-expressions" class="" href="/kliveide/documents/unit-testing-expressions#article">Expressions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="unit-testing-details" class="" href="/kliveide/documents/unit-testing-details#article">Detailed Syntax</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="unit-testing-process" class="" href="/kliveide/documents/unit-testing-process#article">The Testing Process</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
            </div>
          </div>
          <div class="thirteen wide computer sixteen wide mobile column with-main-back">
            <div id="#article" class="main-title-area">
              <h1>Scripting &raquo; Scripting the Z80 CPU</h1>
            </div>
            <div class="main-content-area">
              <h1 id="the-cpuz80-class">The CpuZ80 class</h1>

<p>This class represents the Z80 CPU of a Spectrum virtual machine. Using this class you can get and 
set the value of each register, register pair, flag, and other state holders. The class also provides
a few contol methods and events that are raised at different stages of the CPU’s execution cycle.</p>

<p><strong>Namespace</strong>: <code class="highlighter-rouge">Spect.Net.SpectrumEmu.Scripting</code><br />
<strong>Assembly</strong>: <code class="highlighter-rouge">Spect.Net.SpectrumEmu</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public sealed class CpuZ80
</code></pre></div></div>

<h1 id="register-properties">Register properties</h1>

<p>The class has separate properties for all 8-bit registers and 16-bit register pairs of the CPU. 
An 8-bit register’s value is represented with a <code class="highlighter-rouge">System.Byte</code>, while a 16-bit register pair’s value
with a <code class="highlighter-rouge">System.UInt16</code> instance.</p>

<h2 id="8-bit-registers">8-bit registers</h2>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">A</code></td>
      <td>Accummulator</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">B</code></td>
      <td>Register <strong>B</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">C</code></td>
      <td>Register <strong>C</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">D</code></td>
      <td>Register <strong>D</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">E</code></td>
      <td>Register <strong>E</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">H</code></td>
      <td>Register <strong>H</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">L</code></td>
      <td>Register <strong>L</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">F</code></td>
      <td>Flags register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">I</code></td>
      <td>Interrupt Page Address Register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">R</code></td>
      <td>Memory Refresh Register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">XH</code></td>
      <td>Higher 8 bits of the IX index register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">XL</code></td>
      <td>Lower 8 bits of the IX index register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">YH</code></td>
      <td>Higher 8 bits of the IY index register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">YL</code></td>
      <td>Lower 8 bits of the IY index register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">WZh</code></td>
      <td>Higher 8 bits of the internal WZ register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">WZl</code></td>
      <td>Lower 8 bits of the internal WZ register</td>
    </tr>
  </tbody>
</table>

<h2 id="16-bit-register-pairs">16-bit register pairs</h2>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">AF</code></td>
      <td>Register pair <strong>AF</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">BC</code></td>
      <td>Register pair <strong>BC</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DE</code></td>
      <td>Register pair <strong>DE</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">HL</code></td>
      <td>Register pair <strong>HL</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">_AF_</code></td>
      <td>Register pair <strong>AF’</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">_BC_</code></td>
      <td>Register pair <strong>BC’</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">_DE_</code></td>
      <td>Register pair <strong>DE’</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">_HL_</code></td>
      <td>Register pair <strong>HL’</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">PC</code></td>
      <td>Program Counter Register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">SP</code></td>
      <td>Stack Pointer Register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">IR</code></td>
      <td>I/R 8-bit registers as a register pair</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">IX</code></td>
      <td>Index register <strong>IX</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">IY</code></td>
      <td>Index register <strong>IY</strong></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">WZ</code></td>
      <td>The internal <strong>WZ</strong> register</td>
    </tr>
  </tbody>
</table>

<h2 id="z80-cpu-flags">Z80 CPU flags</h2>

<p>With these properties, you can query the individual flags of the <strong>F</strong> register. These properties
retrieve a <code class="highlighter-rouge">System.Boolean</code> value.</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">SFlag</code></td>
      <td><strong>S</strong> (Sign) Flag</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">ZFlag</code></td>
      <td><strong>Z</strong> (Zero) Flag</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">R5Flag</code></td>
      <td><strong>R5</strong> Flag, Bit 5 of the <strong>F</strong> register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">HFlag</code></td>
      <td><strong>H</strong> (Half Carry) Flag</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">R3Flag</code></td>
      <td><strong>R3</strong> Flag, Bit 3 of the <strong>F</strong> register</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">PVFlag</code></td>
      <td><strong>P/V</strong> (Parity/Overflow) Flag</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">NFlag</code></td>
      <td><strong>N</strong> (Add/Subtract) Flag</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">CFlag</code></td>
      <td><strong>C</strong> (Carry) Flag</td>
    </tr>
  </tbody>
</table>

<h1 id="cpu-state-properties">CPU state properties</h1>

<p>There are various properties that indicate the internal state of the CPU</p>

<h2 id="tacts">Tacts</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public long Tacts { get; }
</code></pre></div></div>

<p>Gets the current T-state tacts of the CPU — the clock cycles since 
the CPU was powered on/reset last time</p>

<h2 id="iff1">IFF1</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public bool IFF1 { get; }
</code></pre></div></div>

<p>Interrupt Enable Flip-Flop #1. Disables interrupts from being accepted.</p>

<h2 id="iff2">IFF2</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public bool IFF2 { get; }
</code></pre></div></div>

<p>Interrupt Enable Flip-Flop #2. Temporary storage location for IFF1.</p>

<h2 id="interruptmode">InterruptMode</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public byte InterruptMode { get; }
</code></pre></div></div>

<p>Gets the current Interrupt mode (<code class="highlighter-rouge">IM 0</code>, <code class="highlighter-rouge">IM 1</code>, or <code class="highlighter-rouge">IM 2</code>)</p>

<h2 id="isinterruptblocked">IsInterruptBlocked</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public bool IsInterruptBlocked { get; }
</code></pre></div></div>

<p>Indicates that the CPU internally blocks the interrupts, even if the maskable interrupt is enabled.
When the CPU is within processing a multi-byte statement, this flag is set.</p>

<h2 id="isinopexecution">IsInOpExecution</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public bool IsInOpExecution { get; }
</code></pre></div></div>

<p>Indicates that the CPU still needs to read more bytes to decode a multi-byte operation.</p>

<h2 id="maskableinterruptmodeentered">MaskableInterruptModeEntered</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public bool MaskableInterruptModeEntered { get; }
</code></pre></div></div>

<p>Indicates that the instructions the CPU is executing are the part of the maskable interrupt method.</p>

<h1 id="control-methods">Control methods</h1>

<p>The <code class="highlighter-rouge">CpuZ80</code> class provides a few control operation that you can use in the scripts.</p>

<h2 id="reset">Reset()</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void Reset()
</code></pre></div></div>

<p>Issues a Reset (<code class="highlighter-rouge">RST</code>) signal to the CPU.</p>

<h2 id="disableinterrupt">DisableInterrupt()</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void DisableInterrupt()
</code></pre></div></div>

<p>Disables the maskable interrupt.</p>

<h2 id="enableinterrupt">EnableInterrupt()</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void EnableInterrupt()
</code></pre></div></div>

<p>Enables the maskable interrupt.</p>

<h1 id="operation-tracking">Operation tracking</h1>

<p>The <code class="highlighter-rouge">CpuZ80</code> class allows you to track the addresses the CPU executes an operation for.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public AddressTrackingState OperationTrackingState { get; }
</code></pre></div></div>

<p>The <code class="highlighter-rouge">OperationTrackingState</code> property’s value is an <a href="/kliveide/documents/scripting-z80.html#the-addresstrackingstate-class"><code class="highlighter-rouge">AddressTrackingState</code></a> 
instance. It provides a bit for each memory address in the <code class="highlighter-rouge">#0000</code>-<code class="highlighter-rouge">#FFFF</code> range to check if the 
particular byte in the memory has been read as a part of CPU’s M1 machine cycle.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void ResetOperationTracking()
</code></pre></div></div>

<p>The <code class="highlighter-rouge">ResetOperationTracking()</code> method resets the <code class="highlighter-rouge">OperationTrackingState</code> property as if no 
operations had been executed.</p>

<p>The following sampe demonstrates how you can use these members of <code class="highlighter-rouge">CpuZ80</code> to check which instructions
have been executed. (This code snippet is an extract for a unit test of <strong>SpectNetIde</strong>.)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[TestMethod]
public async Task OperationTrackingWorks()
{
    // --- Arrange
    var sm = SpectrumVmFactory.CreateSpectrum48Pal();
    sm.Breakpoints.AddBreakpoint(0x11CB);
    sm.StartDebug();
    await sm.CompletionTask;
    var pcBefore = sm.Cpu.PC;
    sm.ExecutionCompletionReason.ShouldBe(ExecutionCompletionReason.BreakpointReached);
    sm.MachineState.ShouldBe(VmState.Paused);

    // --- Act
    sm.Cpu.ResetOperationTracking();
    sm.Breakpoints.ClearAllBreakpoints();
    sm.Breakpoints.AddBreakpoint(0x11CE);
    sm.StartDebug();
    await sm.CompletionTask;
    var pcAfter = sm.Cpu.PC;

    // --- Assert
    pcBefore.ShouldBe((ushort)0x11CB);
    pcAfter.ShouldBe((ushort)0x11CE);
    sm.Cpu.OperationTrackingState.TouchedAny(0x0000, 0x11CA).ShouldBeFalse();
    sm.Cpu.OperationTrackingState[0x11CB].ShouldBeTrue();
    sm.Cpu.OperationTrackingState[0x11CC].ShouldBeTrue();
    sm.Cpu.OperationTrackingState[0x11CD].ShouldBeTrue();
    sm.Cpu.OperationTrackingState.TouchedAny(0x11CE, 0xFFFF).ShouldBeFalse();
}
</code></pre></div></div>

<h1 id="z80-cpu-events">Z80 CPU events</h1>

<p>The <code class="highlighter-rouge">CpuZ80</code> class provides about a dozen events that you can use in script.</p>

<h2 id="interruptexecuting">InterruptExecuting</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler InterruptExecuting
</code></pre></div></div>

<p>This event is raised just before a maskable interrupt is about to execute.</p>

<h2 id="nmiexecuting">NmiExecuting</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler NmiExecuting
</code></pre></div></div>

<p>This event is raised just before a non-maskable interrupt is about to execute.</p>

<h2 id="memoryreading">MemoryReading</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;AddressEventArgs&gt; MemoryReading
</code></pre></div></div>

<p>This event is raised just before the memory is being read. The event argument (<code class="highlighter-rouge">AddressEventArgs</code>) 
has a property, <code class="highlighter-rouge">Address</code> that tells the memory address going to be read.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public ushort Address { get; }
</code></pre></div></div>

<blockquote>
  <p>When this operation is being executed, the contents of the memory has not been read yet.</p>
</blockquote>

<h2 id="memoryread">MemoryRead</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;AddressAndDataEventArgs&gt; MemoryRead
</code></pre></div></div>

<p>This event is raised right after the memory has been read. The event argument (<code class="highlighter-rouge">AddressAndDataEventArgs</code>) 
contains these properties:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public ushort Address { get; }
public byte Data { get; }
</code></pre></div></div>

<p>The <code class="highlighter-rouge">Address</code> keeps the address read, <code class="highlighter-rouge">Data</code> holds the data byte resulted from the read operation.</p>

<h2 id="memorywriting">MemoryWriting</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;AddressAndDataEventArgs&gt; MemoryWriting
</code></pre></div></div>

<p>This event is raised just before the memory is being written. The <code class="highlighter-rouge">Address</code> and <code class="highlighter-rouge">Data</code> properties of the
event argument (<code class="highlighter-rouge">AddressAndDataEventArgs</code>) contain the memory address, and the data byte to write, 
respectively.</p>

<h2 id="memorywritten">MemoryWritten</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;AddressAndDataEventArgs&gt; MemoryWritten
</code></pre></div></div>

<p>This event is raised just after the memory has been written. The <code class="highlighter-rouge">Address</code> and <code class="highlighter-rouge">Data</code> properties of the
event argument (<code class="highlighter-rouge">AddressAndDataEventArgs</code>) contain the memory address, and the data byte written, 
respectively.</p>

<h2 id="portreading">PortReading</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;AddressEventArgs&gt; PortReading
</code></pre></div></div>

<p>This event is raised just before a port is being read. The event argument (<code class="highlighter-rouge">AddressEventArgs</code>) 
has a property, <code class="highlighter-rouge">Address</code> that tells the port address going to be read.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public ushort Address { get; }
</code></pre></div></div>

<blockquote>
  <p>When this operation is being executed, the port has not been read yet.</p>
</blockquote>

<h2 id="portread">PortRead</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;AddressAndDataEventArgs&gt; PortRead
</code></pre></div></div>

<p>This event is raised just after a port has been read. The event argument (<code class="highlighter-rouge">AddressAndDataEventArgs</code>) 
contains these properties:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public ushort Address { get; }
public byte Data { get; }
</code></pre></div></div>

<p>The <code class="highlighter-rouge">Address</code> keeps the address of the port read, <code class="highlighter-rouge">Data</code> holds the data byte resulted from the read operation.</p>

<h2 id="portwriting">PortWriting</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;AddressAndDataEventArgs&gt; PortWriting
</code></pre></div></div>

<p>This event is raised just before a port is being written. The <code class="highlighter-rouge">Address</code> and <code class="highlighter-rouge">Data</code> properties of the
event argument (<code class="highlighter-rouge">AddressAndDataEventArgs</code>) contain the port address, and the data byte to write, 
respectively.</p>

<h2 id="portwritten">PortWritten</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;AddressAndDataEventArgs&gt; PortWritten
</code></pre></div></div>

<p>This event is raised just after a port has been written. The <code class="highlighter-rouge">Address</code> and <code class="highlighter-rouge">Data</code> properties of the
event argument (<code class="highlighter-rouge">AddressAndDataEventArgs</code>) contain the port address, and the data byte written, 
respectively.</p>

<h2 id="operationexecuting">OperationExecuting</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;Z80InstructionExecutionEventArgs&gt; OperationExecuting
</code></pre></div></div>

<p>This event is raised just before a Z80 operation is being executed. The event arguments
instance (<a href="Z80InstructionExecutionEventArgs.md"><code class="highlighter-rouge">Z80InstructionExecutionEventArgs</code></a>) provides 
properties you can check the operation being executed.</p>

<blockquote>
  <p>When this event is raised, the CPU might not have read all operation code bytes, just those one that
are enough to decode the type of operation to execute. If the operation contains arguments that are
part of the operation code, those are not yet read.<br />
For example when this event is signed, the opcode part for <code class="highlighter-rouge">#80</code> <code class="highlighter-rouge">LD A,#80</code>, or the #23 opcode part
of <code class="highlighter-rouge">LD (IX+#23),C</code> operation is not read.</p>
</blockquote>

<h2 id="operationexecuted">OperationExecuted</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public event EventHandler&lt;Z80InstructionExecutionEventArgs&gt; OperationExecuted
</code></pre></div></div>

<p>This event is raised just after a Z80 operation has been executed. The event arguments
instance (<a href="Z80InstructionExecutionEventArgs.md"><code class="highlighter-rouge">Z80InstructionExecutionEventArgs</code></a>) provides 
properties you can check the operation executed.</p>

<blockquote>
  <p>When this event is raised, the full operation is already read.</p>
</blockquote>

<h2 id="operationexecuting-and-operationexecuted-sample">OperationExecuting and OperationExecuted sample</h2>

<p>To demonstrate the difference between these events, the following sample code snippets (extracts from
<strong>SpectNetIde</strong> unit tests) provide more details.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[TestMethod]
public async Task OperationExecutingIsInvoked()
{
    // --- Arrange
    var sm = SpectrumVmFactory.CreateSpectrum48Pal();
    sm.CachedVmStateFolder = STATE_FOLDER;
    await sm.StartAndRunToMain(true);
    var events = new List&lt;Z80InstructionExecutionEventArgs&gt;();

    // --- Act
    var entryAddress = sm.InjectCode(@"
        .org #8000
        di;              8000: No prefix
        bit 3,a;         8001: CB prefix
        ld a,(ix+2);     8003: DD prefix
        ld a,(iy+6);     8006: FD prefix
        bit 2,(ix+2);    8009: DD CB prefixes
        bit 2,(iy+6);    800D: FD CB prefixes
        in d,(c);        8011: ED prefix
        ret
    ");
    sm.Cpu.OperationExecuting += (s, e) =&gt; { events.Add(e); };
    sm.CallCode(entryAddress);
    await sm.CompletionTask;

    // --- Assert
    var sampleIndex = events.Count - 1 - 7; // -1 for the RET operation, -7 for the 7 operations
    var op = events[sampleIndex];
    op.PcBefore.ShouldBe((ushort)0x8000);
    op.Instruction.SequenceEqual(new byte[] { 0xF3 }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0xF3);
    op.PcAfter.ShouldBeNull();

    op = events[sampleIndex + 1];
    op.PcBefore.ShouldBe((ushort)0x8001);
    op.Instruction.SequenceEqual(new byte []{ 0xCB, 0x5F}).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x5F);
    op.PcAfter.ShouldBeNull();

    op = events[sampleIndex + 2];
    op.PcBefore.ShouldBe((ushort)0x8003);
    op.Instruction.SequenceEqual(new byte[] { 0xDD, 0x7E }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x7E);
    op.PcAfter.ShouldBeNull();

    op = events[sampleIndex + 3];
    op.PcBefore.ShouldBe((ushort)0x8006);
    op.Instruction.SequenceEqual(new byte[] { 0xFD, 0x7E }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x7E);
    op.PcAfter.ShouldBeNull();

    op = events[sampleIndex + 4];
    op.PcBefore.ShouldBe((ushort)0x8009);
    op.Instruction.SequenceEqual(new byte[] { 0xDD, 0xCB, 0x56 }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x56);
    op.PcAfter.ShouldBeNull();

    op = events[sampleIndex + 5];
    op.PcBefore.ShouldBe((ushort)0x800D);
    op.Instruction.SequenceEqual(new byte[] { 0xFD, 0xCB, 0x56 }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x56);
    op.PcAfter.ShouldBeNull();

    op = events[sampleIndex + 6];
    op.PcBefore.ShouldBe((ushort)0x8011);
    op.Instruction.SequenceEqual(new byte[] { 0xED, 0x50 }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x50);
    op.PcAfter.ShouldBeNull();
}
</code></pre></div></div>

<p>You can check that the <code class="highlighter-rouge">Instruction</code> property is tested against the partial opcode.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[TestMethod]
public async Task OperationExecutedIsInvoked()
{
    // --- Arrange
    var sm = SpectrumVmFactory.CreateSpectrum48Pal();
    sm.CachedVmStateFolder = STATE_FOLDER;
    await sm.StartAndRunToMain(true);
    var events = new List&lt;Z80InstructionExecutionEventArgs&gt;();

    // --- Act
    var entryAddress = sm.InjectCode(@"
        .org #8000
        di;              8000: No prefix
        bit 3,a;         8001: CB prefix
        ld a,(ix+2);     8003: DD prefix
        ld a,(iy+6);     8006: FD prefix
        bit 2,(ix+2);    8009: DD CB prefixes
        bit 2,(iy+6);    800D: FD CB prefixes
        in d,(c);        8011: ED prefix
        ret
    ");
    sm.Cpu.OperationExecuted += (s, e) =&gt; { events.Add(e); };
    sm.CallCode(entryAddress);
            await sm.CompletionTask;

    // --- Assert
    var sampleIndex = events.Count - 1 - 7; 
        // -1 for the RET operation, -7 for the 7 operations
    var op = events[sampleIndex];
    op.PcBefore.ShouldBe((ushort)0x8000);
    op.Instruction.SequenceEqual(new byte[] { 0xF3 }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0xF3);
    op.PcAfter.ShouldBe((ushort)0x8001);

    op = events[sampleIndex + 1];
    op.PcBefore.ShouldBe((ushort)0x8001);
    op.Instruction.SequenceEqual(new byte[] { 0xCB, 0x5F }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x5F);
    op.PcAfter.ShouldBe((ushort)0x8003);

    op = events[sampleIndex + 2];
    op.PcBefore.ShouldBe((ushort)0x8003);
    op.Instruction.SequenceEqual(new byte[] { 0xDD, 0x7E, 0x02}).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x7E);
    op.PcAfter.ShouldBe((ushort)0x8006);

    op = events[sampleIndex + 3];
    op.PcBefore.ShouldBe((ushort)0x8006);
    op.Instruction.SequenceEqual(new byte[] { 0xFD, 0x7E, 0x06 }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x7E);
    op.PcAfter.ShouldBe((ushort)0x8009);

    op = events[sampleIndex + 4];
    op.PcBefore.ShouldBe((ushort)0x8009);
    op.Instruction.SequenceEqual(new byte[] { 0xDD, 0xCB, 0x56, 0x02 }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x56);
    op.PcAfter.ShouldBe((ushort)0x800D);

    op = events[sampleIndex + 5];
    op.PcBefore.ShouldBe((ushort)0x800D);
    op.Instruction.SequenceEqual(new byte[] { 0xFD, 0xCB, 0x56, 0x06 }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x56);
    op.PcAfter.ShouldBe((ushort)0x8011);

    op = events[sampleIndex + 6];
    op.PcBefore.ShouldBe((ushort)0x8011);
    op.Instruction.SequenceEqual(new byte[] { 0xED, 0x50 }).ShouldBeTrue();
    op.OpCode.ShouldBe((byte)0x50);
    op.PcAfter.ShouldBe((ushort)0x8013);
}
</code></pre></div></div>

<p>Here, the <code class="highlighter-rouge">Instruction</code> property is checked against the entire opcode.</p>

<h1 id="the-addresstrackingstate-class">The AddressTrackingState class</h1>

<p>This class represents tracking information regarding memory. The scripting engine 
(<a href="/kliveide/documents/scripting-vms.html#the-spectrumvm-class"><code class="highlighter-rouge">SpectrumVm</code></a> and <a href="/kliveide/documents/scripting-z80.html#the-cpuz80-class"><code class="highlighter-rouge">CpuZ80</code></a> classes) use this type to track 
operation execution, memory reads and memory writes.</p>

<p>This class stores a flag for each memory address in the <code class="highlighter-rouge">#0000</code>-<code class="highlighter-rouge">#FFFF</code> range. A false value 
means that the tracking event has not been signed for that particular address. The true value
says that the tracking event has happened.</p>

<p>For example, when you start the Spectrum virtual machine, after executing the first 
instruction (<code class="highlighter-rouge">DI</code>), the flag for #0000 is set to true, but all the others remains false.</p>

<p><strong>Namespace</strong>: <code class="highlighter-rouge">Spect.Net.SpectrumEmu.Scripting</code><br />
<strong>Assembly</strong>: <code class="highlighter-rouge">Spect.Net.SpectrumEmu</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public sealed class AddressTrackingState
</code></pre></div></div>

<h2 id="thisushort">this[ushort]</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public bool this[ushort address] { get; }
</code></pre></div></div>

<p>Gets the status bit of the specified <em><code class="highlighter-rouge">address</code></em>.</p>

<h2 id="touchedallushort-ushort">TouchedAll(ushort, ushort)</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public bool TouchedAll(ushort startAddr, ushort endAddr)
</code></pre></div></div>

<p>Checks if all tracking flag is set between <em><code class="highlighter-rouge">startAddr</code></em> and <em><code class="highlighter-rouge">endAddr</code></em>.
Both addresses are inclusive. Returns true, if all flag is set; otherwise, false.</p>

<h2 id="touchedanyushort-ushort">TouchedAny(ushort, ushort)</h2>

<pre><code class="language-CSharp">public bool TouchedAny(ushort startAddr, ushort endAddr)
</code></pre>

<p>Checks if any tracking flag is set between <em><code class="highlighter-rouge">startAddr</code></em> and <em><code class="highlighter-rouge">endAddr</code></em> at all.
Both addresses are inclusive. Returns true, if any of the flags is set; otherwise, false.</p>

<h1 id="the-z80instructionexecutioneventargs-class">The Z80InstructionExecutionEventArgs class</h1>

<p>This class provides event arguments the the <code class="highlighter-rouge">OperationExecuting</code> and <code class="highlighter-rouge">OperationExecuted</code> 
events of the <a href="CpuZ80.md"><code class="highlighter-rouge">CpuZ80</code></a> class.</p>

<h2 id="pcbefore">PcBefore</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public ushort PcBefore { get; }
</code></pre></div></div>

<p>The value of PC before the execution.</p>

<h2 id="instruction">Instruction</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public IList&lt;byte&gt; Instruction { get; }
</code></pre></div></div>

<p>The opcode bytes available at the time of event. For example, if the operation is <code class="highlighter-rouge">LD A,(IX+2)</code>,
this list contains <code class="highlighter-rouge">#DD</code> and <code class="highlighter-rouge">#7E</code> for the <code class="highlighter-rouge">OperationExecuting</code> event, but <code class="highlighter-rouge">#DD</code>, <code class="highlighter-rouge">#7E</code>, 
and <code class="highlighter-rouge">#02</code> for the <code class="highlighter-rouge">OperationExecuted</code> event.</p>

<h2 id="opcode">OpCode</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public byte OpCode { get; }
</code></pre></div></div>

<p>The main operation code. For example, if the operation is <code class="highlighter-rouge">LD A,(IX+2)</code>, this value is <code class="highlighter-rouge">#7E</code> from
the entire operation opcode (<code class="highlighter-rouge">#DD</code> <code class="highlighter-rouge">#7E</code> <code class="highlighter-rouge">#02</code>).</p>

<h2 id="pcafter">PcAfter</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public ushort? PcAfter { get; }
</code></pre></div></div>

<p>The value of PC after the operation has been executed. It is null during <code class="highlighter-rouge">OerationExecuting</code>.</p>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer  -->
    <div class="ui vertical stripe segment with-header-back">
        <footer class="ui container">
          <p>&copy; Istvan Novak, 2020</p>
        </footer>
      </div>
  
    <!-- Floating return to top button -->
    <a href="javascript:" id="return-to-top">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    
    <!-- Floating go to previous button -->
    <a href="/kliveide/documents/scripting-vms#article" id="go-to-prev">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" transform="rotate(-90)">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    
    
    <!-- Floating go to next button -->
    <a href="/kliveide/documents/scripting-screen#article" id="go-to-next">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" transform="rotate(90)">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    

    <script>
      window.addEventListener("scroll", function(){
        var scrolled = window.pageYOffset > 50;
        document.getElementById("return-to-top").style.display = scrolled ? "block" : "none";
        var prevEl = document.getElementById("go-to-prev");
        if (prevEl) prevEl.style.display = scrolled ? "block" : "none";
        var nextEl = document.getElementById("go-to-next");
        if (nextEl) nextEl.style.display = scrolled ? "block" : "none";
      });
      var intervalId = 0;
      var $scrollButton = document.querySelector('#return-to-top');
      function scrollStep() {
        if (window.pageYOffset === 0) {
          clearInterval(intervalId);
        }
        window.scroll(0, window.pageYOffset - 50);
      }
      function scrollToTop() {
        intervalId = setInterval(scrollStep, 6.66);
      }
      $scrollButton.addEventListener('click', scrollToTop);

      function handleClick(arg) {
        var nextEl = arg.nextElementSibling;
        var extEl = arg.children[1];
        if (arg.classList.contains("expanded")) {
          arg.classList.remove("expanded");
          arg.classList.add("collapsed");
          extEl.classList.remove("expanded");
          extEl.classList.add("collapsed");
          nextEl.classList.remove("displayed")
          nextEl.classList.add("hidden")
        } else {
          arg.classList.remove("collapsed");
          arg.classList.add("expanded");
          extEl.classList.remove("collapsed");
          extEl.classList.add("expanded");
          nextEl.classList.remove("hidden")
          nextEl.classList.add("displayed")
        }
      }
    </script>

    
  </body>
</html>