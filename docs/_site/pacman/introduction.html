<!DOCTYPE html>
<html lang="en-US">

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link rel="stylesheet" type="text/css" media="screen" href="/kliveide/assets/css/semantic.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/kliveide/assets/css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,400i,700,700i" rel="stylesheet">

    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Decrypting the loader | Klive IDE</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Decrypting the loader" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this series of articles, I demonstrate how easy it is to discover or re-engineer ZX Spectrum games with SpectNetIDE. I have chosen Pac-man as an example." />
<meta property="og:description" content="In this series of articles, I demonstrate how easy it is to discover or re-engineer ZX Spectrum games with SpectNetIDE. I have chosen Pac-man as an example." />
<link rel="canonical" href="http://localhost:4000/kliveide/pacman/introduction" />
<meta property="og:url" content="http://localhost:4000/kliveide/pacman/introduction" />
<meta property="og:site_name" content="Klive IDE" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-02T00:00:00+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Decrypting the loader","dateModified":"2019-01-02T00:00:00+01:00","datePublished":"2019-01-02T00:00:00+01:00","url":"http://localhost:4000/kliveide/pacman/introduction","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/kliveide/pacman/introduction"},"description":"In this series of articles, I demonstrate how easy it is to discover or re-engineer ZX Spectrum games with SpectNetIDE. I have chosen Pac-man as an example.","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <!-- Header -->
    <div class="ui vertical stripe segment with-header-back">
      <div class="ui container high">
        <h1 class="ui header">Klive IDE</h1>
        <h3 class="ui header">Full-fledged ZX Spectrum IDE with Electron, VS Code</h2>
      </div>
    </div>

    <!-- Menu -->
    <div class="ui vertical stripe segment with-menu-back">
      <div class="ui container">
        <div class="ui menu with-menu-back">
          <a class="item" href="/kliveide/">Home</a>
          <a class=" item" href="/kliveide/getting-started/install-kliveide.html">Getting Started</a>
          <a class=" item" href="/kliveide/documents/main-features.html">Documents</a>
          <a class=" active item" href="/kliveide/spectrum/basic-toc.html">ZX Spectrum</a>
          <a class="item" target="_blank" href="https://github.com/Dotneteer/kliveide">GitHub</a>
        </div>
      </div>
    </div>

    <div class="ui vertical stripe segment with-content-back">
      <div class="ui container">
        <div class="ui grid">
          <div class="three wide computer sixteen wide mobile column">
            <div class="document-list">
              
              
              
              
              
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                  <div class="document-category  collapsed " onclick="handleClick(this)">
                    <span class="category-name">Spectrum48 BASIC</span>
                    <div class="extender  collapsed ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  hidden ">
                  
                    
                  
                    
                  
                    
                    <a id="basic-toc" class="" href="/kliveide/spectrum/basic-toc#article">Table of Contents</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch1" class="" href="/kliveide/spectrum/basic-ch1#article">Introduction</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch2" class="" href="/kliveide/spectrum/basic-ch2#article">Basic programming concepts</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch3" class="" href="/kliveide/spectrum/basic-ch3#article">Decisions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch4" class="" href="/kliveide/spectrum/basic-ch4#article">Looping</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch5" class="" href="/kliveide/spectrum/basic-ch5#article">Subroutines</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch6" class="" href="/kliveide/spectrum/basic-ch6#article">READ, DATA, RESTORE</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="basic-ch7" class="" href="/kliveide/spectrum/basic-ch7#article">Expressions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="basic-ch8" class="" href="/kliveide/spectrum/basic-ch8#article">Strings</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="basic-ch9" class="" href="/kliveide/spectrum/basic-ch9#article">Functions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="basic-ch10" class="" href="/kliveide/spectrum/basic-ch10#article">Mathematical functions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch11" class="" href="/kliveide/spectrum/basic-ch11#article">Random numbers</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch12" class="" href="/kliveide/spectrum/basic-ch12#article">Arrays</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch13" class="" href="/kliveide/spectrum/basic-ch13#article">Conditions</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch14" class="" href="/kliveide/spectrum/basic-ch14#article">The character set</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch15" class="" href="/kliveide/spectrum/basic-ch15#article">More about PRINT and INPUT</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch16" class="" href="/kliveide/spectrum/basic-ch16#article">Colours</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch17" class="" href="/kliveide/spectrum/basic-ch17#article">Graphics</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch18" class="" href="/kliveide/spectrum/basic-ch18#article">Motion</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch19" class="" href="/kliveide/spectrum/basic-ch19#article">BEEP</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch20" class="" href="/kliveide/spectrum/basic-ch20#article">Tape Storage</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch21" class="" href="/kliveide/spectrum/basic-ch21#article">The ZX Printer</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch22" class="" href="/kliveide/spectrum/basic-ch22#article">Other Equipment</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch23" class="" href="/kliveide/spectrum/basic-ch23#article">IN and OUT</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch24" class="" href="/kliveide/spectrum/basic-ch24#article">The memory</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch25" class="" href="/kliveide/spectrum/basic-ch25#article">The system variables</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch26" class="" href="/kliveide/spectrum/basic-ch26#article">Using machine code</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appa" class="" href="/kliveide/spectrum/basic-appa#article">Appendix A: The character set</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appc1" class="" href="/kliveide/spectrum/basic-appc1#article">Appendix C1: A description of the ZX Spectrum for reference</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appb" class="" href="/kliveide/spectrum/basic-appb#article">Appendix B: Reports</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appd" class="" href="/kliveide/spectrum/basic-appd#article">Appendix D: Example programs</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appc2" class="" href="/kliveide/spectrum/basic-appc2#article">Appendix C2: The BASIC</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appe" class="" href="/kliveide/spectrum/basic-appe#article">Appendix E: Binary and hexadecimal</a>
                      
                      
                      
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                  <div class="document-category  expanded " onclick="handleClick(this)">
                    <span class="category-name">Pac-Man Discovery</span>
                    <div class="extender  expanded ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  displayed ">
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="introduction" class=" active " href="/kliveide/pacman/introduction#article">Decrypting the loader</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                
            </div>
          </div>
          <div class="thirteen wide computer sixteen wide mobile column with-main-back">
            <div id="#article" class="main-title-area">
              <h1>Pac-Man Discovery &raquo; Decrypting the loader</h1>
            </div>
            <div class="main-content-area">
              <p>In this series of articles, I demonstrate how easy it is to discover or re-engineer ZX Spectrum games with SpectNetIDE. I have chosen Pac-man as an example.</p>

<h2 id="creating-the-initial-project">Creating the Initial Project</h2>

<p>To prepare the initial project, follow these steps.</p>

<ol>
  <li>Start the Visual Studio IDE (with SpectNetIDE already installed)</li>
  <li>Create a new ZX Spectrum Code Discovery project. In the <strong>New Project</strong> dialog name it <code class="highlighter-rouge">PacManDiscovery</code> and click OK. Select the <strong>ZX Spectrum 48K PAL - Normal Speed</strong> model.</li>
  <li>Download the <code class="highlighter-rouge">Pac-Man.tzx</code> file into a temporary folder from <a href="/kliveide/samples/tapefiles/Pac-Man.tzx">here</a>. Right-click the <code class="highlighter-rouge">TapeFiles</code> folder in Solution Explorer, and choose the Add | Existing file item. Navigate to the previously downloaded file, and add it to the folder.</li>
  <li>Right-click <code class="highlighter-rouge">Pac-Man.tzx</code> and select the <strong>Set as default tape file</strong> command.</li>
  <li>Click the <code class="highlighter-rouge">Welcome.tzx</code> file and press the Delete key to remove this file from the project.</li>
</ol>

<p><img src="/kliveide/assets/images/pacman/initial-project.png" alt="PacMan" /></p>

<p>Start the ZX Spectrum emulator, and issue a <code class="highlighter-rouge">LOAD ""</code> command. The command will load and start the Pac-Man game.</p>

<blockquote>
  <p><strong>Note</strong>: These tutorials explain you the basics of <a href="/kliveide/getting-started/create-zx-spectrum-48k-project.html">starting the emulator</a> and <a href="/kliveide/getting-started/fast-load.html">fast loading</a> tape files.</p>
</blockquote>

<p><img src="/kliveide/assets/images/pacman/pacman-runs.png" alt="PacMan" /></p>

<p>Now, you are ready to start discovering the internals of the game.</p>

<h2 id="discovering-the-pac-mantzx-file">Discovering the Pac-Man.tzx File</h2>

<p><strong>SpectNetIDE</strong> allows you to look into the structure of <strong>.TZX</strong> and <strong>.TAP</strong> files. Double click the <code class="highlighter-rouge">Pac-Man.tzx</code> node in Solution Explorer to look into its details:</p>

<p><img src="/kliveide/assets/images/pacman/pacman-in-explorer.png" alt="PacMan" /></p>

<p>This dialog shows the Tape File Explorer window with the structure of <code class="highlighter-rouge">Pac-Man.tzx</code>. The left pane shows the data blocks of the file; the right pane displays the contents of the selected block. As the figure indicates, Pac-Man contains three <em>Standard Speed</em> data blocks. The first is the program header:</p>

<p><img src="/kliveide/assets/images/pacman/pacman-program-header.png" alt="PacMan" /></p>

<p>The second block is the BASIC program that autostarts Pac-Man. Its code immediately calls into a machine code that starts at a mysterious address:</p>

<p><img src="/kliveide/assets/images/pacman/pacman-autostart.png" alt="PacMan" /></p>

<blockquote>
  <p><strong>Note</strong>: You do not see the BASIC program instantly when you select the block. Move the mouse over the Data label, and click it to turn to the BASIC code view.</p>
</blockquote>

<p>So what is the result of the <code class="highlighter-rouge">PEEK 23635 + 256 * PEEK 23636 + 91</code> operation? The 23635 address stores the <code class="highlighter-rouge">PROG</code> system variable in two bytes, which retrieves the start address of the BASIC program in the memory. So, this expression shows that the machine code starts from the 92nd byte of the BASIC code that loads into the memory.</p>

<h2 id="obtaining-the-loader-code">Obtaining the Loader Code</h2>

<p>How can we obtain the loader code? <strong>SpectNetIDE</strong> makes it easy.</p>

<p>By examining the <strong>.TZX</strong> file the first data block tells that the autoloader code (including the BASIC) is 153 bytes long. With these steps, we can get the machine code between offset 91 and 152:</p>

<ol>
  <li>Stop the virtual machine.</li>
  <li>Open the Z80 Disassembly window and set a breakpoint at #05e2 with the <code class="highlighter-rouge">SB 05E2</code> command.</li>
  <li>Start the virtual machine with the Start Debugging (F5) command.</li>
  <li>Type the <code class="highlighter-rouge">LOAD ""</code> command to start loading Pac-Man.</li>
  <li>The machine will pause at #05E2 when the first data block is loaded, you can see the current breakpoint in the Z80 Disassembly window.</li>
  <li>While either the ZX Spectrum Emulator or the Z80 Disassembly window has the focus, press F5, and wait for the next pause. Now, the autoload code is already the memory.</li>
  <li>Open the ZX Spectrum Memory window, and use the <code class="highlighter-rouge">G 5C53</code> command to navigate to the <code class="highlighter-rouge">PROG</code> system variable:</li>
</ol>

<p><img src="/kliveide/assets/images/pacman/memory-with-prog-value.png" alt="PacMan" /></p>

<p>As the figure shows, the value of the <code class="highlighter-rouge">PROG</code> variable is #5CCB. We know that the loader code can be found between offset 91 and 152, so it is between #5D26 and #5D63.</p>

<p>Let’s disassemble that code with these steps:</p>

<ol>
  <li>Execute the <code class="highlighter-rouge">RD</code> command in the Z80 Disassembly view to re-disassembly the code freshly loaded in the RAM.</li>
  <li>Use the <code class="highlighter-rouge">MD 5D26 5D64</code> command to tell the disassembler to display the range (note, the end address is exclusive) as Z80 instructions, and not as <code class="highlighter-rouge">.defb</code> pragmas.</li>
  <li>With the <code class="highlighter-rouge">G 5D26</code> command, navigate to the beginning of the code.</li>
</ol>

<p>You can see the loader code in the disassembly view:</p>

<p><img src="/kliveide/assets/images/pacman/loader-disassembly.png" alt="PacMan" /></p>

<p>We can create a <code class="highlighter-rouge">.z80asm</code> file from the disassembly and add it to the project for future examination. Issue the <code class="highlighter-rouge">X 5D26 5D64</code> command in the disassembly view. The command pops up the Export Disassembly window:</p>

<p><img src="/kliveide/assets/images/pacman/export-loader.png" alt="PacMan" /></p>

<p>Change the default file name to <code class="highlighter-rouge">AutoLoad.z80asm</code> and click Export. SpectNetIDE adds the disassembly export to the project:</p>

<p><img src="/kliveide/assets/images/pacman/autoload-in-se.png" alt="PacMan" /></p>

<p>Now, you can click <code class="highlighter-rouge">AutoLoad.z80asm</code> to re-engineer its contents.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  .org #5D26

; External symbols

  di
  im 1
  ld d,yh
  ld e,yl
  ld b,#25
  ex de,hl
  ld de,#0019
  add hl,de
  ld e,(hl)
  inc hl
  ld d,(hl)
  ld xh,d
  ld xl,e
  ld a,(ix+#7F)
  ld hl,#0035
  add hl,de
  push hl
L5D43:
  xor (hl)
  ld (hl),a
  inc hl
  djnz L5D43
  and (hl)
  ret nz
  ld (hl),a
L5D4B:
  xor (ix+#7F)
  ld (ix+#7F),a
  inc ix
  djnz L5D4B
  add ix,de
  ex (sp),hl
  scf
  jp (ix)
  in a,(#FE)
  rra
  and #20
  ld c,a
  cp a
  jp (ix)
</code></pre></div></div>

<p>I analyzed this code; it was easy to decipher. I used the SpectNetIDE debugger to execute the code step-by-step. The comments tell you how it works:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  .org #5D26

; External symbols

  di             ; Disable the interrupt
  im 1           ; Use interrupt mode 1 
  ld d,yh        ; DE := IY
  ld e,yl        ; DE point to the ERR_NR system variable (#5C3A)
  ld b,#25       ; B := #25 (37), later we'll use it as a counter
  ex de,hl       ; HL = IY
  ld de,#0019    
  add hl,de      ; HL points to the PROG variable (#5C53)
  ld e,(hl)
  inc hl
  ld d,(hl)      ; DE points to the start of the BASIC program (#5CCB)
  ld xh,d        
  ld xl,e        ; IX points to the start of the BASIC program (#5CCB)
  ld a,(ix+#7F)  ; Get the byte from offset #7F (from #5D4A). A=#77 
  ld hl,#0035
  add hl,de      ; Modify HL so that it points to #5D00
  push hl        ; Push #5D00 to the stack (RET NZ later will jump here)
`loop:
  xor (hl)       ; This loop "decrypts" the code between #5d00-#5d24
  ld (hl),a      ; it XORs each byte with #77, so actually rewrites
  inc hl         ; the code
  djnz `loop
  and (hl)       ; As the contents (HL) [at this point HL=#5D25] is #F6
  ret nz         ; This RET NZ jumps to #5D00
DECRYPT_CODE
  .defb #77      ; Decryption code
</code></pre></div></div>

<p>This program contains a small encrypted routine that loads the last block from tape and starts it. The code above uses a decryption code (#77) to XOR this 37 bytes long code, that spans from #5D00 to #5D24, right before this loader section. After decrypting the loader code, it jumps to #5D00 and initiates loading the actual game, including the screen. You can see that the bytes after the #5D4B are not used at all.</p>

<p>Here is the decrypted loader. I obtained it with the same techniques (the <code class="highlighter-rouge">SB</code>,  <code class="highlighter-rouge">MD</code>, <code class="highlighter-rouge">RS</code>, and <code class="highlighter-rouge">X</code> disassembly commands) as the previous code part. Before allowing the loader to run, I added a breakpoint to #5D00 and then exported the disassembly of the #5D00-#5D25 memory section.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  .org #5D00

  ld xh,#40         
  ld xl,#00          ; IX=#4000, load start address
  ld d,xh            
  ld e,xl            ; DE=#4000
  ld hl,#5DA6        
  ld (iy+#03),l
  ld (iy+#04),h      ; Sets the ERR_SP system variable to #5DA6.
                     ; If any error (e.g. Load error) occurs, the execution
                     ; returns to that address
  ld sp,#5D7C        ; SP points to the new stack
                     ; The code will return to the address at #5D7C
                     ; after the last datablock is loaded.
  ex de,hl
  ld xl,e
  ld a,xl
  ex de,hl           ; DE (#4000) contains the length of the data to load
  ld xl,#00          ; IX (#4000) points to the start address
  and a              ; A=#A6, it will be used as the header's type value
  ccf                ; sets the carry flag to indicate LOAD operation
  ex af,af'          ; Saves A and the carry flag to AF'
  jp L055A           ; Jumps into the LD_BYTES subroutine
                     ; That routine loads #4000 bytes from address #4000
                     ; and overwrites this code.
                     ; When load completes, the code returns to the address
                     ; stored at #5D7C
</code></pre></div></div>

<h2 id="determining-the-start-address">Determining the Start Address</h2>

<p>The last piece of the puzzle is to guess out the entry address of the game.
As the second part of the loader shows, the Stack Pointer is set to #5D7C before the last block is loaded. It means that the loader method will “return” to the address that is stored at #5D7C.</p>

<p>With the tape explorer, we can get this address. The ZX Spectrum tape block contains a header byte, then the data block, and a checksum byte. The load address of the data block is #4000, so the #1D7D and #1D7E offsets store the address we’re looking, as the first data byte is the header type.</p>

<p>And here it is: <strong>#7394</strong></p>

<p><img src="/kliveide/assets/images/pacman/start-address-obtained.png" alt="PacMan" /></p>

<p>As a last check, I set a breakpoint to that address before allowing the final code block to load. The debugger stopped, and I could follow how it started initializing the game.</p>

<p><em>Stay tuned, the story continues…</em></p>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer  -->
    <div class="ui vertical stripe segment with-header-back">
        <footer class="ui container">
          <p>&copy; Istvan Novak, 2020</p>
        </footer>
      </div>
  
    <!-- Floating return to top button -->
    <a href="javascript:" id="return-to-top">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    
    <!-- Floating go to previous button -->
    <a href="/kliveide/spectrum/basic-appe#article" id="go-to-prev">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" transform="rotate(-90)">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    
    

    <script>
      window.addEventListener("scroll", function(){
        var scrolled = window.pageYOffset > 50;
        document.getElementById("return-to-top").style.display = scrolled ? "block" : "none";
        var prevEl = document.getElementById("go-to-prev");
        if (prevEl) prevEl.style.display = scrolled ? "block" : "none";
        var nextEl = document.getElementById("go-to-next");
        if (nextEl) nextEl.style.display = scrolled ? "block" : "none";
      });
      var intervalId = 0;
      var $scrollButton = document.querySelector('#return-to-top');
      function scrollStep() {
        if (window.pageYOffset === 0) {
          clearInterval(intervalId);
        }
        window.scroll(0, window.pageYOffset - 50);
      }
      function scrollToTop() {
        intervalId = setInterval(scrollStep, 6.66);
      }
      $scrollButton.addEventListener('click', scrollToTop);

      function handleClick(arg) {
        var nextEl = arg.nextElementSibling;
        var extEl = arg.children[1];
        if (arg.classList.contains("expanded")) {
          arg.classList.remove("expanded");
          arg.classList.add("collapsed");
          extEl.classList.remove("expanded");
          extEl.classList.add("collapsed");
          nextEl.classList.remove("displayed")
          nextEl.classList.add("hidden")
        } else {
          arg.classList.remove("collapsed");
          arg.classList.add("expanded");
          extEl.classList.remove("collapsed");
          extEl.classList.add("expanded");
          nextEl.classList.remove("hidden")
          nextEl.classList.add("displayed")
        }
      }
    </script>

    
  </body>
</html>