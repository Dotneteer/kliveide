<!DOCTYPE html>
<html lang="en-US">

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link rel="stylesheet" type="text/css" media="screen" href="/kliveide/assets/css/semantic.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/kliveide/assets/css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,400i,700,700i" rel="stylesheet">

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Using machine code | Klive IDE</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Using machine code" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CHAPTER 26: Using machine code" />
<meta property="og:description" content="CHAPTER 26: Using machine code" />
<link rel="canonical" href="http://localhost:4000/kliveide/spectrum/basic-ch26" />
<meta property="og:url" content="http://localhost:4000/kliveide/spectrum/basic-ch26" />
<meta property="og:site_name" content="Klive IDE" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-01T00:00:00+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"http://localhost:4000/kliveide/spectrum/basic-ch26","headline":"Using machine code","dateModified":"2019-01-01T00:00:00+01:00","datePublished":"2019-01-01T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/kliveide/spectrum/basic-ch26"},"description":"CHAPTER 26: Using machine code","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <!-- Header -->
    <div class="ui vertical stripe segment with-header-back">
      <div class="ui container high">
        <h1 class="ui header">Klive IDE</h1>
        <h3 class="ui header">Full-fledged ZX Spectrum IDE with Electron, VS Code</h2>
      </div>
    </div>

    <!-- Menu -->
    <div class="ui vertical stripe segment with-menu-back">
      <div class="ui container">
        <div class="ui menu with-menu-back">
          <a class="item" href="/kliveide/">Home</a>
          <a class=" item" href="/kliveide/getting-started/install-kliveide.html">Getting Started</a>
          <a class=" item" href="/kliveide/documents/main-features.html">Documents</a>
          <a class=" active item" href="/kliveide/spectrum/basic-toc.html">ZX Spectrum</a>
          <a class="item" target="_blank" href="https://github.com/Dotneteer/kliveide">GitHub</a>
        </div>
      </div>
    </div>

    <div class="ui vertical stripe segment with-content-back">
      <div class="ui container">
        <div class="ui grid">
          <div class="three wide computer sixteen wide mobile column">
            <div class="document-list">
              
              
              
              
              
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                  <div class="document-category  expanded " onclick="handleClick(this)">
                    <span class="category-name">Spectrum48 BASIC</span>
                    <div class="extender  expanded ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  displayed ">
                  
                    
                  
                    
                  
                    
                    <a id="basic-toc" class="" href="/kliveide/spectrum/basic-toc#article">Table of Contents</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch1" class="" href="/kliveide/spectrum/basic-ch1#article">Introduction</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch2" class="" href="/kliveide/spectrum/basic-ch2#article">Basic programming concepts</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch3" class="" href="/kliveide/spectrum/basic-ch3#article">Decisions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch4" class="" href="/kliveide/spectrum/basic-ch4#article">Looping</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch5" class="" href="/kliveide/spectrum/basic-ch5#article">Subroutines</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch6" class="" href="/kliveide/spectrum/basic-ch6#article">READ, DATA, RESTORE</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="basic-ch7" class="" href="/kliveide/spectrum/basic-ch7#article">Expressions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="basic-ch8" class="" href="/kliveide/spectrum/basic-ch8#article">Strings</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="basic-ch9" class="" href="/kliveide/spectrum/basic-ch9#article">Functions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                    <a id="basic-ch10" class="" href="/kliveide/spectrum/basic-ch10#article">Mathematical functions</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                    <a id="basic-ch11" class="" href="/kliveide/spectrum/basic-ch11#article">Random numbers</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch12" class="" href="/kliveide/spectrum/basic-ch12#article">Arrays</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch13" class="" href="/kliveide/spectrum/basic-ch13#article">Conditions</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch14" class="" href="/kliveide/spectrum/basic-ch14#article">The character set</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch15" class="" href="/kliveide/spectrum/basic-ch15#article">More about PRINT and INPUT</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch16" class="" href="/kliveide/spectrum/basic-ch16#article">Colours</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch17" class="" href="/kliveide/spectrum/basic-ch17#article">Graphics</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch18" class="" href="/kliveide/spectrum/basic-ch18#article">Motion</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch19" class="" href="/kliveide/spectrum/basic-ch19#article">BEEP</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch20" class="" href="/kliveide/spectrum/basic-ch20#article">Tape Storage</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch21" class="" href="/kliveide/spectrum/basic-ch21#article">The ZX Printer</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch22" class="" href="/kliveide/spectrum/basic-ch22#article">Other Equipment</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch23" class="" href="/kliveide/spectrum/basic-ch23#article">IN and OUT</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch24" class="" href="/kliveide/spectrum/basic-ch24#article">The memory</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch25" class="" href="/kliveide/spectrum/basic-ch25#article">The system variables</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-ch26" class=" active " href="/kliveide/spectrum/basic-ch26#article">Using machine code</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appa" class="" href="/kliveide/spectrum/basic-appa#article">Appendix A: The character set</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appc1" class="" href="/kliveide/spectrum/basic-appc1#article">Appendix C1: A description of the ZX Spectrum for reference</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appb" class="" href="/kliveide/spectrum/basic-appb#article">Appendix B: Reports</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appd" class="" href="/kliveide/spectrum/basic-appd#article">Appendix D: Example programs</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appc2" class="" href="/kliveide/spectrum/basic-appc2#article">Appendix C2: The BASIC</a>
                      
                      
                      
                    
                  
                    
                    <a id="basic-appe" class="" href="/kliveide/spectrum/basic-appe#article">Appendix E: Binary and hexadecimal</a>
                      
                      
                      
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                  <div class="document-category  collapsed " onclick="handleClick(this)">
                    <span class="category-name">Pac-Man Discovery</span>
                    <div class="extender  collapsed ">
                      <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" >
                        <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z" />
                      </svg>
                    </div>
                  </div>
                  <div class="article-names  hidden ">
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                    <a id="introduction" class="" href="/kliveide/pacman/introduction#article">Decrypting the loader</a>
                      
                      
                      
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                  </div>
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                
                  
                  
                  
                  
                
            </div>
          </div>
          <div class="thirteen wide computer sixteen wide mobile column with-main-back">
            <div id="#article" class="main-title-area">
              <h1>Spectrum48 BASIC &raquo; Using machine code</h1>
            </div>
            <div class="main-content-area">
              <h1 id="chapter-26-using-machine-code">CHAPTER 26: Using machine code</h1>

<h2 id="summary">Summary</h2>

<ul>
  <li><strong>USR with numeric argument</strong></li>
</ul>

<p>This chapter is written for those who understand Z80 machine code, the set of instructions that the Z80 processor chip uses. If you do not, but would like to,
there are plenty of books about it. You want to get one called something along the lines of “<em>Z80 Machine code</em> [or assembly language] <em>for the absolute
beginner</em>”, and if it mentions the Spectrum, so much the better.</p>

<p>These programs are normally written in assembly language, which, although cryptic, are not too difficult to understand with practice. (You can see the
assembly language instructions in Appendix A.) However, to run them on the computer you need to code the program into a sequence of bytes in this form it
is called machine code. This translation is usually done by the computer itself, using a program called an assembler. There is no assembler built in to the
Spectrum, but you may well be able to buy one on cassette. Failing that, you will have to do the translation yourself, provided that the program is not too
long.</p>

<p>Let’s take as an example the program</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ld bc, 99
ret
</code></pre></div></div>

<p>which loads the bc register pair with 99. This translates into the four machine code bytes 1, 99, 0 (for ld bc, 99) and 201 (for ret). (If you look up 1 and 201
in Appendix A, you will find ld bc, NN - where NN stands for any two byte number - and ret.)</p>

<p>When you have got your machine code program, the next step is to get it into the computer. (An assembler would probably do this automatically.) You need to
decide whereabouts in memory to put it, and the best thing is to make extra space for it between the BASIC area and the user defined graphics.</p>

<p>Suppose, for instance, that you have a 16K Spectrum. To start off with, the top end of RAM has</p>

<p><img src="/kliveide/assets/images/basic/image25.gif" alt="Image25" /></p>

<p>If you type</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CLEAR 32499
</code></pre></div></div>

<p>this will give you a space of 100 (for good measure) bytes starting at address 32500.</p>

<p><img src="/kliveide/assets/images/basic/image26.gif" alt="Image26" /></p>

<p>To put in the machine code program, you would run a BASIC program something like</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10 LET a=32500
20 READ n: POKE a,n
30 LETa=a+1:GOTO20
40 DATA 1,99,0,201
</code></pre></div></div>

<p>(This will stop with report <strong>E Out of DATA</strong> when it has filled in the four bytes you specified.)</p>

<p>To run the machine code, you use the function <strong>USR</strong> but this time with a numeric argument, the starting address. Its result is the value of the bc register on
return from the machine code program, so if you do</p>

<p><strong>PRINT USR 32500</strong></p>

<p>you get the answer 99.</p>

<p>The return address to the BASIC is stacked in the usual way, so return is by a Z80 ret instruction. You should not use the iy and i registers in a machine code
routine.</p>

<p>You can save your machine code program easily enough with</p>

<p><strong>SAVE</strong> “some name” <strong>CODE 32500,4</strong></p>

<p>On the face of it, there is no way of saving it so that when loaded it automatically runs itself, but you can get round this by using a BASIC program.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10 LOAD "" CODE 32500,4
20 PRINT USR 32500
</code></pre></div></div>

<p>Do first</p>

<p><strong>SAVE</strong> “some name” <strong>LINE</strong></p>

<p>and then</p>

<p><strong>SAVE “xxxx” **CODE</strong> 32500,4**</p>

<p><strong>LOAD</strong> “some name”</p>

<p>will then load and automatically run the BASIC program, and the BASIC program will load and run the machine code.</p>


            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer  -->
    <div class="ui vertical stripe segment with-header-back">
        <footer class="ui container">
          <p>&copy; Istvan Novak, 2020</p>
        </footer>
      </div>
  
    <!-- Floating return to top button -->
    <a href="javascript:" id="return-to-top">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    
    <!-- Floating go to previous button -->
    <a href="/kliveide/spectrum/basic-ch25#article" id="go-to-prev">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" transform="rotate(-90)">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    
    
    <!-- Floating go to next button -->
    <a href="/kliveide/spectrum/basic-appa#article" id="go-to-next">
      <span>
        <svg width="32" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16" transform="rotate(90)">
          <path d="M10 10l-1.5 1.5L5 7.75 1.5 11.5 0 10l5-5z"/>
        </svg>
      </span>
    </a>
    

    <script>
      window.addEventListener("scroll", function(){
        var scrolled = window.pageYOffset > 50;
        document.getElementById("return-to-top").style.display = scrolled ? "block" : "none";
        var prevEl = document.getElementById("go-to-prev");
        if (prevEl) prevEl.style.display = scrolled ? "block" : "none";
        var nextEl = document.getElementById("go-to-next");
        if (nextEl) nextEl.style.display = scrolled ? "block" : "none";
      });
      var intervalId = 0;
      var $scrollButton = document.querySelector('#return-to-top');
      function scrollStep() {
        if (window.pageYOffset === 0) {
          clearInterval(intervalId);
        }
        window.scroll(0, window.pageYOffset - 50);
      }
      function scrollToTop() {
        intervalId = setInterval(scrollStep, 6.66);
      }
      $scrollButton.addEventListener('click', scrollToTop);

      function handleClick(arg) {
        var nextEl = arg.nextElementSibling;
        var extEl = arg.children[1];
        if (arg.classList.contains("expanded")) {
          arg.classList.remove("expanded");
          arg.classList.add("collapsed");
          extEl.classList.remove("expanded");
          extEl.classList.add("collapsed");
          nextEl.classList.remove("displayed")
          nextEl.classList.add("hidden")
        } else {
          arg.classList.remove("collapsed");
          arg.classList.add("expanded");
          extEl.classList.remove("collapsed");
          extEl.classList.add("expanded");
          nextEl.classList.remove("hidden")
          nextEl.classList.add("displayed")
        }
      }
    </script>

    
  </body>
</html>